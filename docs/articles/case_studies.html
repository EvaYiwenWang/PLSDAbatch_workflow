<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Case Studies • PLSDAbatch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Case Studies">
<meta property="og:description" content="PLSDAbatch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PLSDAbatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/case_studies.html">Case Studies</a>
    </li>
    <li>
      <a href="../articles/simulation_study.html">Simulation Study</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Case Studies</h1>
                        <h4 class="author">Yiwen (Eva) Wang</h4>
                        <h4 class="author">Melbourne Integrative Genomics, School of Mathematics and Statistics, The University of Melbourne, Australia</h4>
                        <h4 class="author"><a href="mailto:yiwenw5@student.unimelb.edu.au">yiwenw5@student.unimelb.edu.au</a></h4>
            
            <h4 class="date">04 January, 2021</h4>
      
      
      <div class="hidden name"><code>case_studies.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>We analysed three 16S rRNA gene sequencing datasets at the operational taxonomic unit (OTU). The count data were filtered to alleviate sparsity, then transformed with Centered Log Ratio (CLR), a pragmatic way to handle both uneven library sizes and compositional structure as <span class="citation">(Susin et al. <a href="#ref-susin2020variable">2020</a>)</span>. CLR also converts skewed data towards a Gaussian-like distribution.</p>
</div>
<div id="packages-installation-and-loading" class="section level1">
<h1 class="hasAnchor">
<a href="#packages-installation-and-loading" class="anchor"></a>Packages installation and loading</h1>
<p>Install then load the following packages:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">PLSDAbatch</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.mixOmics.org">mixOmics</a></span><span class="op">)</span> <span class="co">#pca, plsda, tune.splsda</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sva</span><span class="op">)</span> <span class="co">#ComBat</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://bioinf.wehi.edu.au/limma">limma</a></span><span class="op">)</span> <span class="co">#removeBatchEffect</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cran.r-project.org">vegan</a></span><span class="op">)</span> <span class="co">#RDA</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/hms-dbmi/UpSetR">UpSetR</a></span><span class="op">)</span> <span class="co">#upset</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/talgalili/gplots">gplots</a></span><span class="op">)</span> <span class="co">#venn</span></code></pre></div>
</div>
<div id="example-datasets" class="section level1">
<h1 class="hasAnchor">
<a href="#example-datasets" class="anchor"></a>Example datasets</h1>
<div id="sponge-a--aerophoba" class="section level2">
<h2 class="hasAnchor">
<a href="#sponge-a--aerophoba" class="anchor"></a>Sponge A. aerophoba</h2>
<p>This study investigated the relationship between metabolite concentration and microbial abundance on specific sponge tissues <span class="citation">(Sacristán-Soriano et al. <a href="#ref-sacristan2011exploring">2011</a>)</span>. The dataset includes the relative abundance of 24 OTUs and 32 samples collected from two tissue types (Ectosome vs. Choanosome) and processed on two separate denaturing gradient gels in electrophoresis. The tissue variation is the effect of interest, while the gel variation is the batch effect.</p>
<p>Load the data as follows:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'sponge_data'</span><span class="op">)</span>
<span class="va">sponge.x</span> <span class="op">&lt;-</span> <span class="va">sponge_data</span><span class="op">$</span><span class="va">X.clr</span>
<span class="va">sponge.trt</span> <span class="op">&lt;-</span> <span class="va">sponge_data</span><span class="op">$</span><span class="va">Y.trt</span>
<span class="va">sponge.batch</span> <span class="op">&lt;-</span> <span class="va">sponge_data</span><span class="op">$</span><span class="va">Y.bat</span></code></pre></div>
<p>"sponge_data" contains three objects:</p>
<p><strong>sponge.x</strong>: The CLR transformed microbial metagenome data, a data matrix with 32 samples (rows) and 24 OTUs (columns).</p>
<p><strong>sponge.trt</strong>: A factor indicates tissue types (Ectosome vs. Choanosom).</p>
<p><strong>sponge.batch</strong>: A factor indicates batch groups (Gel1 vs. Gel2)</p>
<div id="diagnostic-plots-principal-component-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostic-plots-principal-component-analysis" class="anchor"></a>Diagnostic plots: principal component analysis</h3>
<p>Principal Component Analysis (PCA) is an unsupervised method used to explore the data variance structure by reducing its dimensions to a few principal components (PC) that explain the greatest variation in the data. If batch effects account for the largest proportion of variance in the data, we expect a separation of the samples from different batches on the first component.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.pca.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">sponge.x</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">sponge.batch.shape</span> <span class="op">&lt;-</span> <span class="va">sponge.batch</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.before</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-3-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the sponge data, 21% of the total data variance was explained by the first principal component, which highlighted a strong difference of samples across different tissues (effect of interest). The batch variation accounted for 19% of the total variance in the second component. Thus in this study, batch effects are slightly weaker than the treatment effects.</p>
</div>
<div id="batch-correction" class="section level3">
<h3 class="hasAnchor">
<a href="#batch-correction" class="anchor"></a>Batch correction</h3>
<div id="removebatcheffect" class="section level4">
<h4 class="hasAnchor">
<a href="#removebatcheffect" class="anchor"></a>removeBatchEffect</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span> <span class="co"># full model</span>
<span class="va">sponge.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">sponge.x</span><span class="op">)</span>, 
                                  batch <span class="op">=</span> <span class="va">sponge.batch</span>, 
                                  design <span class="op">=</span> <span class="va">sponge.mod</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>removeBatchEffect</strong>.</p>
</div>
<div id="combat" class="section level4">
<h4 class="hasAnchor">
<a href="#combat" class="anchor"></a>ComBat</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html">ComBat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">sponge.x</span><span class="op">)</span>, 
                          batch <span class="op">=</span> <span class="va">sponge.batch</span>, 
                          mod <span class="op">=</span> <span class="va">sponge.mod</span>, 
                          par.prior <span class="op">=</span> <span class="cn">F</span>, prior.plots <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>ComBat</strong>.</p>
</div>
<div id="plsda-batch" class="section level4">
<h4 class="hasAnchor">
<a href="#plsda-batch" class="anchor"></a>PLSDA-batch</h4>
<p><strong>The optimal number of components</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.trt.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plsda.html">plsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sponge.x</span>, Y <span class="op">=</span> <span class="va">sponge.trt</span>, ncomp <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">sponge.trt.tune</span><span class="op">$</span><span class="va">explained_variance</span> <span class="co">#1</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 0.20207840 0.08409582 0.14275445 0.08019116 0.04516682 
## 
## $Y
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 1.00000000 0.11980397 0.03939307 0.02354395 0.01092769</code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.batch.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sponge.x</span>, 
                                 Y.trt <span class="op">=</span> <span class="va">sponge.trt</span>, Y.bat <span class="op">=</span> <span class="va">sponge.batch</span>,
                                 ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">sponge.batch.tune</span><span class="op">$</span><span class="va">explained_variance.bat</span> <span class="co">#1</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 0.23733292 0.08412656 0.09436462 0.06814398 0.05649485 
## 
## $Y
## comp 1 comp 2 comp 3 comp 4 comp 5 
##      1      1      1      1      1</code></pre>
<p>To correct the data with <strong>PLSDA-batch</strong>, we need to specify the optimal number of components associated with either treatment (<strong>ncomp.trt</strong>) or batch effects (<strong>ncomp.bat</strong>). To choose these parameters, we estimated the explained variance in the outcome (<strong>sponge.trt</strong>) on each treatment component ($Y) and similarly for the batch associated outcome (<strong>sponge.batch</strong>) and components. We chose the optimal number of components that explain 100% variance in <strong>Y</strong>, either <strong>Y.trt</strong> or <strong>Y.bat</strong>. The remainder components should only explain some (unknown) noise. For sponge data, the optimal number of components associated with either treatment or batch effects are all <strong>1</strong>.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sponge.x</span>, 
                                          Y.trt <span class="op">=</span> <span class="va">sponge.trt</span>, Y.bat <span class="op">=</span> <span class="va">sponge.batch</span>, 
                                          ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">sponge.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">sponge.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
</div>
<div id="splsda-batch" class="section level4">
<h4 class="hasAnchor">
<a href="#splsda-batch" class="anchor"></a>sPLSDA-batch</h4>
<p><strong>The optimal number of variables to select per component</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">777</span><span class="op">)</span>
<span class="va">sponge.test.keepX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">24</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">sponge.trt.tune.v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/tune.splsda.html">tune.splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sponge.x</span>, Y <span class="op">=</span> <span class="va">sponge.trt</span>, 
                                 ncomp <span class="op">=</span> <span class="fl">1</span>, test.keepX <span class="op">=</span> <span class="va">sponge.test.keepX</span>, 
                                 validation <span class="op">=</span> <span class="st">'Mfold'</span>, folds <span class="op">=</span> <span class="fl">4</span>, nrepeat <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">sponge.trt.tune.v</span><span class="op">$</span><span class="va">choice.keepX</span> <span class="co">#1</span></code></pre></div>
<p>To correct the data with <strong>sPLSDA-batch</strong>, in addition to the number of components, we also need to specify the optimal number of variables to select on each treatment component (<strong>keepX.trt</strong>). For this purpose, we calculated the Balanced classification Error Rate (BER) = <span class="math inline">\(\frac{\sum_{c=1}^{C}\frac{F_c}{T_c + F_c}}{C}\)</span>), where <span class="math inline">\(F_c\)</span> and <span class="math inline">\(T_c\)</span> represent the number of false and truly classified samples in the treatment group <span class="math inline">\(c, c = 1,2\)</span>, where <span class="math inline">\(C\)</span> represents the total number of treatment groups <span class="citation">(Tharwat <a href="#ref-tharwat2018classification">2018</a>)</span>. The BER was evaluated through repeated cross-validation with <strong>4</strong> folds and <strong>50</strong> repeats using the "maximum" prediction distance as described in <span class="citation">(Rohart et al. <a href="#ref-rohart2017mixomics">2017</a>)</span> on a proposed grid of numbers of variables to select on each treatment component (<strong>sponge.test.keepX</strong>). The number of variables with the lowest BER has the strongest association with the treatment information. For sponge data, <strong>keepX.trt</strong> = 1.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">sponge.x</span>, 
                                           Y.trt <span class="op">=</span> <span class="va">sponge.trt</span>, Y.bat <span class="op">=</span> <span class="va">sponge.batch</span>, 
                                           ncomp.trt <span class="op">=</span> <span class="fl">1</span>, keepX.trt <span class="op">=</span> <span class="fl">1</span>, 
                                           ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">sponge.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">sponge.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
</div>
</div>
<div id="evaluation" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluation" class="anchor"></a>Evaluation</h3>
<div id="pca" class="section level4">
<h4 class="hasAnchor">
<a href="#pca" class="anchor"></a>PCA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.pca.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">sponge.rbe</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">sponge.pca.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">sponge.combat</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">sponge.pca.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">sponge.plsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">sponge.pca.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">sponge.splsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">sponge.xlim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.5</span>,<span class="fl">4.5</span><span class="op">)</span>
<span class="va">sponge.ylim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.5</span>,<span class="fl">4.5</span><span class="op">)</span>
<span class="va">cex</span> <span class="op">=</span> <span class="fl">2</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.before</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">sponge.xlim</span>, ylim <span class="op">=</span> <span class="va">sponge.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-10-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.rbe</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'removeBatchEffect correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">sponge.xlim</span>, ylim <span class="op">=</span> <span class="va">sponge.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-10-2.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.combat</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'ComBat correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, legend <span class="op">=</span> <span class="cn">T</span>, 
          legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">sponge.xlim</span>, ylim <span class="op">=</span> <span class="va">sponge.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-10-3.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.plsda_batch</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'PLSDA-batch correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">sponge.xlim</span>, ylim <span class="op">=</span> <span class="va">sponge.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-10-4.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">sponge.pca.splsda_batch</span>, group <span class="op">=</span> <span class="va">sponge.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">sponge.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'sPLSDA-batch correction (sponge)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">sponge.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Tissue'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">sponge.xlim</span>, ylim <span class="op">=</span> <span class="va">sponge.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-10-5.png" width="60%" style="display: block; margin: auto;"></p>
<p>After batch correction, the difference between batches became barely distinct, except for ComBat corrected data where a clear separation of the samples from two batches for the Choanosome tissue could still be observed. The variance explained by the first principal component that separated the different tissue types was increased in all of the corrected data, with PLSDA-batch resulting in the highest proportion of variance (24%).</p>
</div>
<div id="rda" class="section level4">
<h4 class="hasAnchor">
<a href="#rda" class="anchor"></a>RDA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first scale the data</span>
<span class="va">sponge.x.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">sponge.x</span><span class="op">)</span>
<span class="va">sponge.rbe.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">sponge.rbe</span><span class="op">)</span>
<span class="va">sponge.combat.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">sponge.combat</span><span class="op">)</span>
<span class="va">sponge.plsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">sponge.plsda_batch</span><span class="op">)</span>
<span class="va">sponge.splsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">sponge.splsda_batch</span><span class="op">)</span>

<span class="va">sponge.corrected.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">sponge.x.s</span>, 
                              removeBatchEffect <span class="op">=</span> <span class="va">sponge.rbe.s</span>, 
                              ComBat <span class="op">=</span> <span class="va">sponge.combat.s</span>, 
                              `PLSDA-batch` <span class="op">=</span> <span class="va">sponge.plsda_batch.s</span>, 
                              `sPLSDA-batch` <span class="op">=</span> <span class="va">sponge.splsda_batch.s</span><span class="op">)</span>


<span class="va">sponge.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Treatment <span class="op">=</span> <span class="cn">NA</span>, Intersection <span class="op">=</span> <span class="cn">NA</span>, 
                                 Batch <span class="op">=</span> <span class="cn">NA</span>,  Residuals <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>

<span class="va">Bat_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">sponge.batch</span>, Treatment <span class="op">=</span> <span class="va">sponge.trt</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sponge.corrected.list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">rda.res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html">varpart</a></span><span class="op">(</span><span class="va">sponge.corrected.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, 
                    data <span class="op">=</span> <span class="va">Bat_Trt.factors</span><span class="op">)</span>
  <span class="va">sponge.rda.prop.df</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.res</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">sponge.rda.prop.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sponge.corrected.list</span><span class="op">)</span>

<span class="va">sponge.rda.prop.df</span><span class="op">[</span><span class="va">sponge.rda.prop.df</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>

<span class="va">sponge.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">sponge.rda.prop.df</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">sponge.rda.prop.df</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-11-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>We next focused on estimating the proportion of explained variance by treatment and batch effects globally for the batch corrected data. The different methods preserved similar proportion of treatment variance and removed all batch variance, with the exception of ComBat that still retained 1.5% of batch variance.</p>
</div>
<div id="scatter-plot" class="section level4">
<h4 class="hasAnchor">
<a href="#scatter-plot" class="anchor"></a>Scatter plot</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># before</span>
<span class="va">sponge.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.trt.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">sponge.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.bat.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># removeBatchEffect</span>
<span class="va">sponge.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.trt.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">sponge.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.bat.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># ComBat</span>
<span class="va">sponge.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.trt.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">sponge.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.bat.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>



<span class="co"># PLSDA-batch</span>
<span class="va">sponge.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.trt.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">sponge.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.bat.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># sPLSDA-batch</span>
<span class="va">sponge.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.trt.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">sponge.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sponge.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">sponge.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">sponge.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">sponge.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sponge.r2.bat.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># plot</span>
<span class="va">xlabs</span> <span class="op">=</span> <span class="st">'R2(variable, tissue)'</span>
<span class="va">ylabs</span> <span class="op">=</span> <span class="st">'R2(variable, batch)'</span>
<span class="va">edgex</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">edgey</span> <span class="op">=</span> <span class="fl">0.8</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sponge.r2.trt.before</span>, <span class="va">sponge.r2.bat.before</span>, 
     main <span class="op">=</span> <span class="st">'Before correction'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sponge.r2.trt.rbe</span>, <span class="va">sponge.r2.bat.rbe</span>, 
     main <span class="op">=</span> <span class="st">'removeBatchEffect'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sponge.r2.trt.combat</span>, <span class="va">sponge.r2.bat.combat</span>, 
     main <span class="op">=</span> <span class="st">'ComBat'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sponge.r2.trt.plsda_batch</span>, <span class="va">sponge.r2.bat.plsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'PLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sponge.r2.trt.splsda_batch</span>, <span class="va">sponge.r2.bat.splsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'sPLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-12-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The <span class="math inline">\(R^2\)</span> values represent the variance explained by batch or treatment effects for each variable estimated with one-way ANOVA. All methods performed similarly, with an exception of ComBat which still included one variable with a large proportion of batch variance.</p>
</div>
<div id="alignment-scores" class="section level4">
<h4 class="hasAnchor">
<a href="#alignment-scores" class="anchor"></a>Alignment scores</h4>
<p>The alignment scores complement the PCA results especially when batch effect removal is difficult to assess on PCA sample plots.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sponge.var</span> <span class="op">=</span> <span class="fl">0.95</span>
<span class="va">sponge.k</span> <span class="op">=</span> <span class="fl">3</span>

<span class="va">sponge.scores</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">sponge.x</span>, <span class="va">sponge.batch</span>, <span class="va">sponge.var</span>, 
                    <span class="va">sponge.k</span>, ncomp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">sponge.rbe</span>, <span class="va">sponge.batch</span>, <span class="va">sponge.var</span>, 
                    <span class="va">sponge.k</span>, ncomp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">sponge.combat</span>, <span class="va">sponge.batch</span>, <span class="va">sponge.var</span>, 
                    <span class="va">sponge.k</span>, ncomp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">sponge.plsda_batch</span>, <span class="va">sponge.batch</span>, <span class="va">sponge.var</span>, 
                    <span class="va">sponge.k</span>, ncomp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">sponge.splsda_batch</span>, <span class="va">sponge.batch</span>, <span class="va">sponge.var</span>, 
                    <span class="va">sponge.k</span>, ncomp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">sponge.scores.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>scores <span class="op">=</span> <span class="va">sponge.scores</span>, 
                               methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>,
                                                     <span class="st">'removeBatchEffect'</span>,
                                                     <span class="st">'ComBat'</span>, 
                                                     <span class="st">'PLSDA-batch'</span>,
                                                     <span class="st">'sPLSDA-batch'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                                   levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span>, 
                                              <span class="st">'PLSDA-batch'</span>, 
                                              <span class="st">'ComBat'</span>, 
                                              <span class="st">'removeBatchEffect'</span>, 
                                              <span class="st">'Before correction'</span><span class="op">)</span><span class="op">)</span>


<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">methods</span>, y <span class="op">=</span> <span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                y <span class="op">=</span> <span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">/</span><span class="fl">2</span>, 
                label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">sponge.scores.df</span><span class="op">$</span><span class="va">scores</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, 
            size <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">'Alignment Scores'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">''</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-13-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Based on alignment scores, we observed that the samples across different batches were better mixed after batch correction with different methods than before. The data corrected using PLSDA-batch and sPLSDA-batch had higher alignment scores than using removeBatchEffect and ComBat, indicating a better performance in removing batch variation. The ComBat corrected data had the lowest alignment score, which was consistent with PCA that the data still had residual batch variation remaining.</p>
</div>
</div>
</div>
<div id="anaerobic-digestion" class="section level2">
<h2 class="hasAnchor">
<a href="#anaerobic-digestion" class="anchor"></a>Anaerobic digestion</h2>
<p>This study explored the microbial indicators that could improve the efficacy of anaerobic digestion (AD) bioprocess and prevent its failure <span class="citation">(Chapleur et al. <a href="#ref-chapleur2016increasing">2016</a>)</span>. The microbiota was profiled under various conditions. The dataset includes 231 OTUs and 75 samples treated with two different ranges of phenol concentration (effects of interest). These samples were processed at five different dates, which constituted the batch effect to remove.</p>
<p>Load the data as follows:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'AD_data'</span><span class="op">)</span>
<span class="va">ad.x</span> <span class="op">&lt;-</span> <span class="va">AD_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">X.clr</span>
<span class="va">ad.trt</span> <span class="op">&lt;-</span> <span class="va">AD_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">Y.trt</span>
<span class="va">ad.batch</span> <span class="op">&lt;-</span> <span class="va">AD_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">Y.bat</span>
<span class="va">ad.taxa</span> <span class="op">&lt;-</span> <span class="va">AD_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">taxa</span></code></pre></div>
<p>For "AD_data", we have an extra object:</p>
<p><strong>ad.taxa</strong>: The taxonomic information of each OTU in <strong>ad.x</strong> matrix.</p>
<div id="diagnostic-plots-principal-component-analysis-1" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostic-plots-principal-component-analysis-1" class="anchor"></a>Diagnostic plots: principal component analysis</h3>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.pca.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">ad.x</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">ad.batch.shape</span> <span class="op">&lt;-</span> <span class="va">ad.batch</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span>, <span class="fl">2</span>,<span class="fl">17</span>,<span class="fl">4</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.before</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-15-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the AD data, 16% of the total data variance was explained by the first principal component, which highlighted a strong difference of samples sequenced at 14/04/2016 and the other dates (the batch effect). The treatment variation is mostly on the second component. Thus in this study, batch effects are stronger than the treatment effects.</p>
</div>
<div id="batch-correction-1" class="section level3">
<h3 class="hasAnchor">
<a href="#batch-correction-1" class="anchor"></a>Batch correction</h3>
<div id="removebatcheffect-1" class="section level4">
<h4 class="hasAnchor">
<a href="#removebatcheffect-1" class="anchor"></a>removeBatchEffect</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span> <span class="co"># full model</span>
<span class="va">ad.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">ad.x</span><span class="op">)</span>, 
                              batch <span class="op">=</span> <span class="va">ad.batch</span>, 
                              design <span class="op">=</span> <span class="va">ad.mod</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>removeBatchEffect</strong>.</p>
</div>
<div id="combat-1" class="section level4">
<h4 class="hasAnchor">
<a href="#combat-1" class="anchor"></a>ComBat</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html">ComBat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">ad.x</span><span class="op">)</span>, 
                      batch <span class="op">=</span> <span class="va">ad.batch</span>, 
                      mod <span class="op">=</span> <span class="va">ad.mod</span>, 
                      par.prior <span class="op">=</span> <span class="cn">F</span>, prior.plots <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>ComBat</strong>.</p>
</div>
<div id="plsda-batch-1" class="section level4">
<h4 class="hasAnchor">
<a href="#plsda-batch-1" class="anchor"></a>PLSDA-batch</h4>
<p><strong>The optimal number of components</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.trt.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plsda.html">plsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, ncomp <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">ad.trt.tune</span><span class="op">$</span><span class="va">explained_variance</span> <span class="co">#1</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 0.14482929 0.08830005 0.05824682 0.08489088 0.03165643 
## 
## $Y
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 1.00000000 0.34131668 0.18435285 0.08323639 0.06585199</code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.batch.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, 
                             Y.trt <span class="op">=</span> <span class="va">ad.trt</span>, Y.bat <span class="op">=</span> <span class="va">ad.batch</span>,
                             ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">ad.batch.tune</span><span class="op">$</span><span class="va">explained_variance.bat</span> <span class="co">#4</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4     comp 5     comp 6     comp 7 
## 0.14017050 0.10961662 0.07910858 0.04575263 0.03404049 0.02890628 0.02896192 
##     comp 8     comp 9    comp 10 
## 0.02153840 0.01834095 0.01425454 
## 
## $Y
##     comp 1     comp 2     comp 3     comp 4     comp 5     comp 6     comp 7 
## 0.25032597 0.25937398 0.23152335 0.25877670 0.23428008 0.24764822 0.26338150 
##     comp 8     comp 9    comp 10 
## 0.23798138 0.01670882 0.25901906</code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ad.batch.tune</span><span class="op">$</span><span class="va">explained_variance.bat</span><span class="op">$</span><span class="va">Y</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>To correct the AD data with <strong>PLSDA-batch</strong>, we specified <strong>1</strong> as the optimal number of components associated with treatment effects, and <strong>4</strong> as with batch effects based on the 100% variance explained in the outcome.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, 
                                      Y.trt <span class="op">=</span> <span class="va">ad.trt</span>, Y.bat <span class="op">=</span> <span class="va">ad.batch</span>, 
                                      ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">ad.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">ad.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
</div>
<div id="splsda-batch-1" class="section level4">
<h4 class="hasAnchor">
<a href="#splsda-batch-1" class="anchor"></a>sPLSDA-batch</h4>
<p><strong>The optimal number of variables to select per component</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">777</span><span class="op">)</span>
<span class="va">ad.test.keepX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">231</span>, <span class="fl">50</span><span class="op">)</span>, <span class="fl">231</span><span class="op">)</span>
<span class="va">ad.trt.tune.v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/tune.splsda.html">tune.splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                             ncomp <span class="op">=</span> <span class="fl">1</span>, test.keepX <span class="op">=</span> <span class="va">ad.test.keepX</span>, 
                             validation <span class="op">=</span> <span class="st">'Mfold'</span>, folds <span class="op">=</span> <span class="fl">4</span>, nrepeat <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">ad.trt.tune.v</span><span class="op">$</span><span class="va">choice.keepX</span> <span class="co">#50</span></code></pre></div>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, 
                                       Y.trt <span class="op">=</span> <span class="va">ad.trt</span>, Y.bat <span class="op">=</span> <span class="va">ad.batch</span>, 
                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, keepX.trt <span class="op">=</span> <span class="fl">50</span>, 
                                       ncomp.bat <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">ad.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">ad.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
<p>To correct the AD data with <strong>sPLSDA-batch</strong>, in addition to the number of components, we also specified <strong>keepX.trt</strong> = 50 as the optimal number of variables to select on each treatment component using BER.</p>
</div>
</div>
<div id="evaluation-1" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluation-1" class="anchor"></a>Evaluation</h3>
<div id="pca-1" class="section level4">
<h4 class="hasAnchor">
<a href="#pca-1" class="anchor"></a>PCA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.pca.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">ad.rbe</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">ad.pca.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">ad.combat</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">ad.pca.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">ad.plsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">ad.pca.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">ad.splsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">ad.xlim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">13</span>,<span class="fl">15</span><span class="op">)</span>
<span class="va">ad.ylim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">12</span>,<span class="fl">12</span><span class="op">)</span>
<span class="va">cex</span> <span class="op">=</span> <span class="fl">2</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.before</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">ad.xlim</span>, ylim <span class="op">=</span> <span class="va">ad.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-22-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.rbe</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'removeBatchEffect correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">ad.xlim</span>, ylim <span class="op">=</span> <span class="va">ad.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-22-2.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.combat</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'ComBat correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, legend <span class="op">=</span> <span class="cn">T</span>, 
          legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">ad.xlim</span>, ylim <span class="op">=</span> <span class="va">ad.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-22-3.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.plsda_batch</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'PLSDA-batch correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">ad.xlim</span>, ylim <span class="op">=</span> <span class="va">ad.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-22-4.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">ad.pca.splsda_batch</span>, group <span class="op">=</span> <span class="va">ad.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">ad.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'sPLSDA-batch correction (AD)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">ad.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">ad.xlim</span>, ylim <span class="op">=</span> <span class="va">ad.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-22-5.png" width="60%" style="display: block; margin: auto;"></p>
<p>After batch correction, the difference between batches became barely distinct. The data variance explained by the first principal component that separated the different treatments was increased in all of the corrected data, with PLSDA-batch resulting in the highest proportion of variance (19%).</p>
</div>
<div id="rda-1" class="section level4">
<h4 class="hasAnchor">
<a href="#rda-1" class="anchor"></a>RDA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first scale the data</span>
<span class="va">ad.x.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">ad.x</span><span class="op">)</span>
<span class="va">ad.rbe.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">ad.rbe</span><span class="op">)</span>
<span class="va">ad.combat.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">ad.combat</span><span class="op">)</span>
<span class="va">ad.plsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">ad.plsda_batch</span><span class="op">)</span>
<span class="va">ad.splsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">ad.splsda_batch</span><span class="op">)</span>

<span class="va">ad.corrected.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">ad.x.s</span>, 
                          removeBatchEffect <span class="op">=</span> <span class="va">ad.rbe.s</span>, 
                          ComBat <span class="op">=</span> <span class="va">ad.combat.s</span>, 
                          `PLSDA-batch` <span class="op">=</span> <span class="va">ad.plsda_batch.s</span>, 
                          `sPLSDA-batch` <span class="op">=</span> <span class="va">ad.splsda_batch.s</span><span class="op">)</span>


<span class="va">ad.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Treatment <span class="op">=</span> <span class="cn">NA</span>, Intersection <span class="op">=</span> <span class="cn">NA</span>, 
                             Batch <span class="op">=</span> <span class="cn">NA</span>,  Residuals <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>

<span class="va">Bat_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">ad.batch</span>, Treatment <span class="op">=</span> <span class="va">ad.trt</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ad.corrected.list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">rda.res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html">varpart</a></span><span class="op">(</span><span class="va">ad.corrected.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, 
                    data <span class="op">=</span> <span class="va">Bat_Trt.factors</span><span class="op">)</span>
  <span class="va">ad.rda.prop.df</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.res</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">ad.rda.prop.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ad.corrected.list</span><span class="op">)</span>

<span class="va">ad.rda.prop.df</span><span class="op">[</span><span class="va">ad.rda.prop.df</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>

<span class="va">ad.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">ad.rda.prop.df</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">ad.rda.prop.df</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-23-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>In the AD data, we observed a small amount of intersection (0.7%) between batch and treatment associated variance due to the unbalanced batch <span class="math inline">\(\times\)</span> treatment design. As the intersection was small, unweighted PLSDA-batch and sPLSDA-batch were still applicable, and thus the weighted version was not used. PLSDA-batch preserved the largest proportion of variance explained by treatment effects, and also the largest proportion of intersectional variance. sPLSDA-batch corrected data led to a slightly higher proportion of treatment variance and an undetectable intersectional variance than the other two univariate methods.</p>
</div>
<div id="scatter-plot-1" class="section level4">
<h4 class="hasAnchor">
<a href="#scatter-plot-1" class="anchor"></a>Scatter plot</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># before</span>
<span class="va">ad.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.trt.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">ad.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.bat.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># removeBatchEffect</span>
<span class="va">ad.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.trt.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">ad.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.bat.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># ComBat</span>
<span class="va">ad.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.trt.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">ad.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.bat.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>



<span class="co"># PLSDA-batch</span>
<span class="va">ad.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.trt.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">ad.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.bat.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># sPLSDA-batch</span>
<span class="va">ad.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.trt.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ad.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">ad.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ad.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">ad.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">ad.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ad.r2.bat.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># plot</span>
<span class="va">xlabs</span> <span class="op">=</span> <span class="st">'R2(variable, treatment)'</span>
<span class="va">ylabs</span> <span class="op">=</span> <span class="st">'R2(variable, batch)'</span>
<span class="va">edgex</span> <span class="op">=</span> <span class="fl">0.65</span>
<span class="va">edgey</span> <span class="op">=</span> <span class="fl">1</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ad.r2.trt.before</span>, <span class="va">ad.r2.bat.before</span>, 
     main <span class="op">=</span> <span class="st">'Before correction'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ad.r2.trt.rbe</span>, <span class="va">ad.r2.bat.rbe</span>, 
     main <span class="op">=</span> <span class="st">'removeBatchEffect'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ad.r2.trt.combat</span>, <span class="va">ad.r2.bat.combat</span>, 
     main <span class="op">=</span> <span class="st">'ComBat'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ad.r2.trt.plsda_batch</span>, <span class="va">ad.r2.bat.plsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'PLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ad.r2.trt.splsda_batch</span>, <span class="va">ad.r2.bat.splsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'sPLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-24-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The corrected data from ComBat still included a few variables with a large proportion of batch variance. When considering the sum of all variables, removeBatchEffect removed slightly more batch variance but preserved less treatment variance than our proposed approaches.</p>
</div>
<div id="alignment-scores-1" class="section level4">
<h4 class="hasAnchor">
<a href="#alignment-scores-1" class="anchor"></a>Alignment scores</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.var</span> <span class="op">=</span> <span class="fl">0.95</span>
<span class="va">ad.k</span> <span class="op">=</span> <span class="fl">8</span>

<span class="va">ad.scores</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">ad.x</span>, <span class="va">ad.batch</span>, <span class="va">ad.var</span>, <span class="va">ad.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">ad.rbe</span>, <span class="va">ad.batch</span>, <span class="va">ad.var</span>, <span class="va">ad.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">ad.combat</span>, <span class="va">ad.batch</span>, <span class="va">ad.var</span>, <span class="va">ad.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">ad.plsda_batch</span>, <span class="va">ad.batch</span>, <span class="va">ad.var</span>, <span class="va">ad.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">ad.splsda_batch</span>, <span class="va">ad.batch</span>, <span class="va">ad.var</span>, <span class="va">ad.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">ad.scores.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>scores <span class="op">=</span> <span class="va">ad.scores</span>, 
                           methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>,
                                                 <span class="st">'removeBatchEffect'</span>,
                                                 <span class="st">'ComBat'</span>, 
                                                 <span class="st">'PLSDA-batch'</span>,
                                                 <span class="st">'sPLSDA-batch'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">ad.scores.df</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">ad.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span>, 
                                          <span class="st">'PLSDA-batch'</span>, 
                                          <span class="st">'ComBat'</span>, 
                                          <span class="st">'removeBatchEffect'</span>, 
                                          <span class="st">'Before correction'</span><span class="op">)</span><span class="op">)</span>


<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ad.scores.df</span><span class="op">$</span><span class="va">methods</span>, y <span class="op">=</span> <span class="va">ad.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ad.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                y <span class="op">=</span> <span class="va">ad.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">/</span><span class="fl">2</span>, 
                label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ad.scores.df</span><span class="op">$</span><span class="va">scores</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">'Alignment Scores'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">''</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.85</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Based on alignment scores, we observed that the samples across different batches were better mixed after batch correction with different methods than before. The data corrected using PLSDA-batch and sPLSDA-batch had higher alignment scores than using removeBatchEffect and ComBat, indicating a better performance in removing batch variation. Among corrected datasets, the ComBat corrected data had the lowest alignment score.</p>
</div>
<div id="variable-selection" class="section level4">
<h4 class="hasAnchor">
<a href="#variable-selection" class="anchor"></a>Variable selection</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.x</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                           ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">ad.splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.rbe</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                        ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">ad.splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.combat</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                           ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">ad.splsda.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.plsda_batch</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                                ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">ad.splsda.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">ad.splsda_batch</span>, Y <span class="op">=</span> <span class="va">ad.trt</span>, 
                                 ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">50</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>

<span class="va">ad.select.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">ad.splsda.before</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">ad.select.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">ad.splsda.rbe</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">ad.select.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">ad.splsda.combat</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">ad.select.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">ad.splsda.plsda_batch</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">ad.select.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">ad.splsda.splsda_batch</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>

<span class="va">ad.splsda.select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">ad.select.before</span>,
                         `removeBatchEffect` <span class="op">=</span> <span class="va">ad.select.rbe</span>,
                         ComBat <span class="op">=</span> <span class="va">ad.select.combat</span>,
                         `PLSDA-batch` <span class="op">=</span> <span class="va">ad.select.plsda_batch</span>,
                         `sPLSDA-batch` <span class="op">=</span> <span class="va">ad.select.splsda_batch</span><span class="op">)</span>

<span class="va">ad.splsda.upsetR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/fromList.html">fromList</a></span><span class="op">(</span><span class="va">ad.splsda.select</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/upset.html">upset</a></span><span class="op">(</span><span class="va">ad.splsda.upsetR</span>, main.bar.color <span class="op">=</span> <span class="st">'gray36'</span>,
      sets.bar.color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span><span class="op">:</span><span class="fl">22</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span>, matrix.color <span class="op">=</span> <span class="st">'gray36'</span>,
      order.by <span class="op">=</span> <span class="st">'freq'</span>, empty.intersections <span class="op">=</span> <span class="st">'on'</span>,
      queries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'Before correction'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, 
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'removeBatchEffect'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'ComBat'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'PLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-26-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">###############################</span>
<span class="co"># without original data</span>
<span class="va">ad.splsda.select2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`removeBatchEffect` <span class="op">=</span> <span class="va">ad.select.rbe</span>,
                         ComBat <span class="op">=</span> <span class="va">ad.select.combat</span>,
                         `PLSDA-batch` <span class="op">=</span> <span class="va">ad.select.plsda_batch</span>,
                         `sPLSDA-batch` <span class="op">=</span> <span class="va">ad.select.splsda_batch</span><span class="op">)</span>

<span class="va">ad.splsda.upsetR2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/fromList.html">fromList</a></span><span class="op">(</span><span class="va">ad.splsda.select2</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/upset.html">upset</a></span><span class="op">(</span><span class="va">ad.splsda.upsetR2</span>, main.bar.color <span class="op">=</span> <span class="st">'gray36'</span>,
      sets.bar.color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span><span class="op">)</span>, matrix.color <span class="op">=</span> <span class="st">'gray36'</span>,
      order.by <span class="op">=</span> <span class="st">'freq'</span>, empty.intersections <span class="op">=</span> <span class="st">'on'</span>,
      queries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'removeBatchEffect'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'ComBat'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'PLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-26-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>We applied sPLSDA to select 20% of the total number of OTUs in the data. We then compared the OTU selections before and after batch effect correction with different methods.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ad.splsda.select.overlap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gplots/man/venn.html">venn</a></span><span class="op">(</span><span class="va">ad.splsda.select</span>, show.plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">ad.inters.splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">ad.splsda.select.overlap</span>, <span class="st">'intersections'</span><span class="op">)</span>
<span class="va">ad.inters.splsda.taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">ad.inters.splsda</span>, 
                                FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">ad.taxa</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">ad.inters.splsda.taxa</span>, 
               file <span class="op">=</span> <span class="st">"GeneratedData/ADselected_50_splsda.txt"</span><span class="op">)</span></code></pre></div>
<p>We also saved the taxonomic information of intersectional OTUs into a txt file.</p>
</div>
</div>
</div>
<div id="high-fat-high-sugar-diet" class="section level2">
<h2 class="hasAnchor">
<a href="#high-fat-high-sugar-diet" class="anchor"></a>High fat high sugar diet</h2>
<p>This study aimed to investigate the effect of high fat high sugar (HFHS) diet on the mouse microbiome <span class="citation">(Susin et al. <a href="#ref-susin2020variable">2020</a>)</span>. This dataset includes 419 OTUs and 54 samples treated with two types of diets (HFHS vs. normal) and housed in two different facilities (TRI and PACE). The diet variation is the treatment effect, while the facility variation constitutes the potential batch effect. The actual batch effect in this dataset is weak, and enables to assess whether batch correction methods are able to preserve treatment variation in this context.</p>
<p>Load the data as follows:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">'HFHS_data'</span><span class="op">)</span>
<span class="va">hfhs.x</span> <span class="op">&lt;-</span> <span class="va">HFHS_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">X.clr</span>
<span class="va">hfhs.trt</span> <span class="op">&lt;-</span> <span class="va">HFHS_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">Y.trt</span>
<span class="va">hfhs.batch</span> <span class="op">&lt;-</span> <span class="va">HFHS_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">Y.bat</span>
<span class="va">hfhs.taxa</span> <span class="op">&lt;-</span> <span class="va">HFHS_data</span><span class="op">$</span><span class="va">EgData</span><span class="op">$</span><span class="va">taxa</span></code></pre></div>
<div id="diagnostic-plots-principal-component-analysis-2" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostic-plots-principal-component-analysis-2" class="anchor"></a>Diagnostic plots: principal component analysis</h3>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.pca.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">hfhs.x</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">hfhs.batch.shape</span> <span class="op">&lt;-</span> <span class="va">hfhs.batch</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">19</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.before</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-29-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the HFHS data, 40% of the total data variance was explained by the first principal component, which highlighted a strong difference of samples treated with HFHS and normal diets (the treatment effect). We did not observe any batch variation.</p>
</div>
<div id="batch-correction-2" class="section level3">
<h3 class="hasAnchor">
<a href="#batch-correction-2" class="anchor"></a>Batch correction</h3>
<div id="removebatcheffect-2" class="section level4">
<h4 class="hasAnchor">
<a href="#removebatcheffect-2" class="anchor"></a>removeBatchEffect</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span> <span class="co"># full model</span>
<span class="va">hfhs.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">hfhs.x</span><span class="op">)</span>, 
                                batch <span class="op">=</span> <span class="va">hfhs.batch</span>, 
                                design <span class="op">=</span> <span class="va">hfhs.mod</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>removeBatchEffect</strong>.</p>
</div>
<div id="combat-2" class="section level4">
<h4 class="hasAnchor">
<a href="#combat-2" class="anchor"></a>ComBat</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html">ComBat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">hfhs.x</span><span class="op">)</span>, 
                        batch <span class="op">=</span> <span class="va">hfhs.batch</span>, 
                        mod <span class="op">=</span> <span class="va">hfhs.mod</span>, 
                        par.prior <span class="op">=</span> <span class="cn">F</span>, prior.plots <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We corrected the data using <strong>ComBat</strong>.</p>
</div>
<div id="plsda-batch-2" class="section level4">
<h4 class="hasAnchor">
<a href="#plsda-batch-2" class="anchor"></a>PLSDA-batch</h4>
<p><strong>The optimal number of components</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.trt.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plsda.html">plsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, ncomp <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">hfhs.trt.tune</span><span class="op">$</span><span class="va">explained_variance</span> <span class="co">#1</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4     comp 5 
## 0.39617384 0.05282050 0.05787826 0.03715006 0.03058348 
## 
## $Y
##      comp 1      comp 2      comp 3      comp 4      comp 5 
## 1.000000000 0.026871404 0.010196873 0.005078078 0.002684480</code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.batch.tune</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, 
                               Y.trt <span class="op">=</span> <span class="va">hfhs.trt</span>, Y.bat <span class="op">=</span> <span class="va">hfhs.batch</span>,
                               ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="va">hfhs.batch.tune</span><span class="op">$</span><span class="va">explained_variance.bat</span> <span class="co">#1</span></code></pre></div>
<pre><code>## $X
##     comp 1     comp 2     comp 3     comp 4 
## 0.08937858 0.09894620 0.04924016 0.04703057 
## 
## $Y
##    comp 1    comp 2    comp 3    comp 4 
## 1.0000000 0.9989806 0.9920635 0.9989806</code></pre>
<p>To correct the HFHS data with <strong>PLSDA-batch</strong>, we specified <strong>1</strong> as the optimal number of components associated with either treatment or batch effects based on the 100% variance explained in the outcome.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, 
                                        Y.trt <span class="op">=</span> <span class="va">hfhs.trt</span>, Y.bat <span class="op">=</span> <span class="va">hfhs.batch</span>, 
                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">hfhs.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">hfhs.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
</div>
<div id="splsda-batch-2" class="section level4">
<h4 class="hasAnchor">
<a href="#splsda-batch-2" class="anchor"></a>sPLSDA-batch</h4>
<p><strong>The optimal number of variables to select per component</strong></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">777</span><span class="op">)</span>
<span class="va">hfhs.test.keepX</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">120</span>, <span class="fl">300</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">350</span>, <span class="fl">419</span>, <span class="fl">50</span><span class="op">)</span>, <span class="fl">419</span><span class="op">)</span>
<span class="va">hfhs.trt.tune.v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/tune.splsda.html">tune.splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                               ncomp <span class="op">=</span> <span class="fl">1</span>, test.keepX <span class="op">=</span> <span class="va">hfhs.test.keepX</span>, 
                               validation <span class="op">=</span> <span class="st">'Mfold'</span>, folds <span class="op">=</span> <span class="fl">4</span>, nrepeat <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="va">hfhs.trt.tune.v</span><span class="op">$</span><span class="va">choice.keepX</span> <span class="co">#10</span></code></pre></div>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, 
                                         Y.trt <span class="op">=</span> <span class="va">hfhs.trt</span>, Y.bat <span class="op">=</span> <span class="va">hfhs.batch</span>, 
                                         ncomp.trt <span class="op">=</span> <span class="fl">1</span>, keepX.trt <span class="op">=</span> <span class="fl">10</span>, 
                                         ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">hfhs.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">hfhs.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></code></pre></div>
<p>To correct the HFHS data with <strong>sPLSDA-batch</strong>, in addition to the number of components, we also specified <strong>keepX.trt</strong> = 10 as the optimal number of variables to select on each treatment component using BER.</p>
</div>
</div>
<div id="evaluation-2" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluation-2" class="anchor"></a>Evaluation</h3>
<div id="pca-2" class="section level4">
<h4 class="hasAnchor">
<a href="#pca-2" class="anchor"></a>PCA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.pca.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">hfhs.rbe</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">hfhs.pca.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">hfhs.combat</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">hfhs.pca.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">hfhs.pca.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/pca.html">pca</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch</span>, ncomp <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="va">hfhs.xlim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">22</span>,<span class="fl">17</span><span class="op">)</span>
<span class="va">hfhs.ylim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">23</span>,<span class="fl">20</span><span class="op">)</span>

<span class="va">cex</span> <span class="op">=</span> <span class="fl">2</span>

<span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.before</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'Before batch effect correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">hfhs.xlim</span>, ylim <span class="op">=</span> <span class="va">hfhs.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-36-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.rbe</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'removeBatchEffect correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">hfhs.xlim</span>, ylim <span class="op">=</span> <span class="va">hfhs.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-36-2.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.combat</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'ComBat correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, legend <span class="op">=</span> <span class="cn">T</span>, 
          legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">hfhs.xlim</span>, ylim <span class="op">=</span> <span class="va">hfhs.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-36-3.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.plsda_batch</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'PLSDA-batch correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">hfhs.xlim</span>, ylim <span class="op">=</span> <span class="va">hfhs.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-36-4.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/plotIndiv.html">plotIndiv</a></span><span class="op">(</span><span class="va">hfhs.pca.splsda_batch</span>, group <span class="op">=</span> <span class="va">hfhs.trt</span>, 
          pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">hfhs.batch.shape</span><span class="op">)</span><span class="op">)</span>, 
          title <span class="op">=</span> <span class="st">'sPLSDA-batch correction (HFHS)'</span>, ind.names <span class="op">=</span> <span class="cn">F</span>, 
          legend <span class="op">=</span> <span class="cn">T</span>, legend.title.pch <span class="op">=</span> <span class="st">'Batch'</span>, pch.levels <span class="op">=</span> <span class="va">hfhs.batch</span>, 
          col.per.group <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="st">'Treatment'</span>, cex <span class="op">=</span> <span class="va">cex</span>, 
          xlim <span class="op">=</span> <span class="va">hfhs.xlim</span>, ylim <span class="op">=</span> <span class="va">hfhs.ylim</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-36-5.png" width="60%" style="display: block; margin: auto;"></p>
<p>When batch variation was not observed on a PCA plot before batch correction, the proportion of variance explained by the first principal component (related to treatment effects) before and after batch correction was similar, indicating that treatment variation was preserved. Thus, batch correction methods are still relevant in the case where no batch effect is present.</p>
</div>
<div id="rda-2" class="section level4">
<h4 class="hasAnchor">
<a href="#rda-2" class="anchor"></a>RDA</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first scale the data</span>
<span class="va">hfhs.x.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hfhs.x</span><span class="op">)</span>
<span class="va">hfhs.rbe.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hfhs.rbe</span><span class="op">)</span>
<span class="va">hfhs.combat.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hfhs.combat</span><span class="op">)</span>
<span class="va">hfhs.plsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch</span><span class="op">)</span>
<span class="va">hfhs.splsda_batch.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch</span><span class="op">)</span>

<span class="va">hfhs.corrected.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">hfhs.x.s</span>, 
                            removeBatchEffect <span class="op">=</span> <span class="va">hfhs.rbe.s</span>, 
                            ComBat <span class="op">=</span> <span class="va">hfhs.combat.s</span>, 
                            `PLSDA-batch` <span class="op">=</span> <span class="va">hfhs.plsda_batch.s</span>, 
                            `sPLSDA-batch` <span class="op">=</span> <span class="va">hfhs.splsda_batch.s</span><span class="op">)</span>


<span class="va">hfhs.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Treatment <span class="op">=</span> <span class="cn">NA</span>, Intersection <span class="op">=</span> <span class="cn">NA</span>, 
                               Batch <span class="op">=</span> <span class="cn">NA</span>,  Residuals <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>

<span class="va">Bat_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">hfhs.batch</span>, Treatment <span class="op">=</span> <span class="va">hfhs.trt</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">hfhs.corrected.list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">rda.res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html">varpart</a></span><span class="op">(</span><span class="va">hfhs.corrected.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, 
                    data <span class="op">=</span> <span class="va">Bat_Trt.factors</span><span class="op">)</span>
  <span class="va">hfhs.rda.prop.df</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.res</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">hfhs.rda.prop.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">hfhs.corrected.list</span><span class="op">)</span>

<span class="va">hfhs.rda.prop.df</span><span class="op">[</span><span class="va">hfhs.rda.prop.df</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>

<span class="va">hfhs.rda.prop.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">hfhs.rda.prop.df</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">hfhs.rda.prop.df</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-37-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>In the HFHS data where no batch variation was observed on the PCA plot, we still detected 1.8% of the variance explained by batch effects. The differences of preserved treatment variance and removed batch variance from the different corrected data were small.</p>
</div>
<div id="scatter-plot-2" class="section level4">
<h4 class="hasAnchor">
<a href="#scatter-plot-2" class="anchor"></a>Scatter plot</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># before</span>
<span class="va">hfhs.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">hfhs.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.x.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.x.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.bat.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.bat.before</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># removeBatchEffect</span>
<span class="va">hfhs.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">hfhs.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.rbe.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.rbe.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.bat.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.bat.rbe</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># ComBat</span>
<span class="va">hfhs.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">hfhs.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.combat.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.combat.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.bat.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.bat.combat</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>



<span class="co"># PLSDA-batch</span>
<span class="va">hfhs.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">hfhs.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.bat.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.bat.plsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># sPLSDA-batch</span>
<span class="va">hfhs.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.trt</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">hfhs.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch.s</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">fit.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch.s</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">hfhs.batch</span><span class="op">)</span>
  <span class="va">fit.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/summary.html">summary</a></span><span class="op">(</span><span class="va">fit.res</span><span class="op">)</span>
  <span class="va">hfhs.r2.bat.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">hfhs.r2.bat.splsda_batch</span>, <span class="va">fit.summary</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># plot</span>
<span class="va">xlabs</span> <span class="op">=</span> <span class="st">'R2(variable, treatment)'</span>
<span class="va">ylabs</span> <span class="op">=</span> <span class="st">'R2(variable, batch)'</span>
<span class="va">edgex</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">edgey</span> <span class="op">=</span> <span class="fl">0.6</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.before</span>, <span class="va">hfhs.r2.bat.before</span>, 
     main <span class="op">=</span> <span class="st">'Before correction'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.rbe</span>, <span class="va">hfhs.r2.bat.rbe</span>, 
     main <span class="op">=</span> <span class="st">'removeBatchEffect'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.combat</span>, <span class="va">hfhs.r2.bat.combat</span>, 
     main <span class="op">=</span> <span class="st">'ComBat'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.plsda_batch</span>, <span class="va">hfhs.r2.bat.plsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'PLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hfhs.r2.trt.splsda_batch</span>, <span class="va">hfhs.r2.bat.splsda_batch</span>, 
     main <span class="op">=</span> <span class="st">'sPLSDA-batch'</span>, xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>,
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>  </code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-38-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>Combat corrected data included one variable with a large proportion of batch variance. Compared to our proposed approaches, removeBatchEffect removed more batch variance.</p>
</div>
<div id="alignment-scores-2" class="section level4">
<h4 class="hasAnchor">
<a href="#alignment-scores-2" class="anchor"></a>Alignment scores</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.var</span> <span class="op">=</span> <span class="fl">0.95</span>
<span class="va">hfhs.k</span> <span class="op">=</span> <span class="fl">5</span>


<span class="va">hfhs.scores</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">hfhs.x</span>, <span class="va">hfhs.batch</span>, <span class="va">hfhs.var</span>, <span class="va">hfhs.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">hfhs.rbe</span>, <span class="va">hfhs.batch</span>, <span class="va">hfhs.var</span>, <span class="va">hfhs.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">hfhs.combat</span>, <span class="va">hfhs.batch</span>, <span class="va">hfhs.var</span>, <span class="va">hfhs.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">hfhs.plsda_batch</span>, <span class="va">hfhs.batch</span>, <span class="va">hfhs.var</span>, <span class="va">hfhs.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/alignment_score.html">alignment_score</a></span><span class="op">(</span><span class="va">hfhs.splsda_batch</span>, <span class="va">hfhs.batch</span>, <span class="va">hfhs.var</span>, <span class="va">hfhs.k</span>, ncomp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">hfhs.scores.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>scores <span class="op">=</span> <span class="va">hfhs.scores</span>, 
                             methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>,
                                                   <span class="st">'removeBatchEffect'</span>,
                                                   <span class="st">'ComBat'</span>, 
                                                   <span class="st">'PLSDA-batch'</span>,
                                                   <span class="st">'sPLSDA-batch'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                                 levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span>, 
                                            <span class="st">'PLSDA-batch'</span>, 
                                            <span class="st">'ComBat'</span>, 
                                            <span class="st">'removeBatchEffect'</span>, 
                                            <span class="st">'Before correction'</span><span class="op">)</span><span class="op">)</span>


<span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_col</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">methods</span>, y <span class="op">=</span> <span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">methods</span>, 
                y <span class="op">=</span> <span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">scores</span><span class="op">/</span><span class="fl">2</span>, 
                label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">hfhs.scores.df</span><span class="op">$</span><span class="va">scores</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">coord_flip</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">'Alignment Scores'</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">''</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-39-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>In the case of an undetected batch effect, such as the HFHS data, the corrected data from PLSDA-batch and sPLSDA-batch had lower alignment scores than those from removeBatchEffect and ComBat. However, the other assessment measures we used suggested that our methods removed sufficient batch variation. Therefore, it is possible that PLSDA-batch and sPLSDA-batch removed more sampling noise, leading to a decrease in total variance of the corrected data and more emphasis on batch variance. In the case of weak batch effect, the alignment scores may not be fully appropriate.</p>
</div>
<div id="variable-selection-1" class="section level4">
<h4 class="hasAnchor">
<a href="#variable-selection-1" class="anchor"></a>Variable selection</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.x</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                             ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">hfhs.splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.rbe</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                          ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">hfhs.splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.combat</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                             ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">hfhs.splsda.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.plsda_batch</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                                  ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">hfhs.splsda.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">hfhs.splsda_batch</span>, Y <span class="op">=</span> <span class="va">hfhs.trt</span>, 
                                   ncomp <span class="op">=</span> <span class="fl">3</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>

<span class="va">hfhs.select.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">hfhs.splsda.before</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">hfhs.select.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">hfhs.splsda.rbe</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">hfhs.select.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">hfhs.splsda.combat</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">hfhs.select.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">hfhs.splsda.plsda_batch</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>
<span class="va">hfhs.select.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/selectVar.html">selectVar</a></span><span class="op">(</span><span class="va">hfhs.splsda.splsda_batch</span>, comp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">name</span>

<span class="va">hfhs.splsda.select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">hfhs.select.before</span>,
                           `removeBatchEffect` <span class="op">=</span> <span class="va">hfhs.select.rbe</span>,
                           ComBat <span class="op">=</span> <span class="va">hfhs.select.combat</span>,
                           `PLSDA-batch` <span class="op">=</span> <span class="va">hfhs.select.plsda_batch</span>,
                           `sPLSDA-batch` <span class="op">=</span> <span class="va">hfhs.select.splsda_batch</span><span class="op">)</span>

<span class="va">hfhs.splsda.upsetR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/fromList.html">fromList</a></span><span class="op">(</span><span class="va">hfhs.splsda.select</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/upset.html">upset</a></span><span class="op">(</span><span class="va">hfhs.splsda.upsetR</span>, main.bar.color <span class="op">=</span> <span class="st">'gray36'</span>,
      sets.bar.color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span><span class="op">:</span><span class="fl">22</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span>, matrix.color <span class="op">=</span> <span class="st">'gray36'</span>,
      order.by <span class="op">=</span> <span class="st">'freq'</span>, empty.intersections <span class="op">=</span> <span class="st">'on'</span>,
      queries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'Before correction'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, 
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'removeBatchEffect'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'ComBat'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'PLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-40-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">###############################</span>
<span class="co"># without original data</span>

<span class="va">hfhs.splsda.select2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`removeBatchEffect` <span class="op">=</span> <span class="va">hfhs.select.rbe</span>,
                           ComBat <span class="op">=</span> <span class="va">hfhs.select.combat</span>,
                           `PLSDA-batch` <span class="op">=</span> <span class="va">hfhs.select.plsda_batch</span>,
                           `sPLSDA-batch` <span class="op">=</span> <span class="va">hfhs.select.splsda_batch</span><span class="op">)</span>

<span class="va">hfhs.splsda.upsetR2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/fromList.html">fromList</a></span><span class="op">(</span><span class="va">hfhs.splsda.select2</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/pkg/UpSetR/man/upset.html">upset</a></span><span class="op">(</span><span class="va">hfhs.splsda.upsetR2</span>, main.bar.color <span class="op">=</span> <span class="st">'gray36'</span>,
      sets.bar.color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span><span class="op">:</span><span class="fl">22</span><span class="op">)</span><span class="op">)</span>, matrix.color <span class="op">=</span> <span class="st">'gray36'</span>,
      order.by <span class="op">=</span> <span class="st">'freq'</span>, empty.intersections <span class="op">=</span> <span class="st">'on'</span>,
      queries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'removeBatchEffect'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'ComBat'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'PLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">24</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,
                     <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">intersects</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">'sPLSDA-batch'</span><span class="op">)</span>, 
                          color <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>, active <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="case_studies_files/figure-html/unnamed-chunk-40-2.png" width="100%" style="display: block; margin: auto;"></p>
<p>We applied sPLSDA to select 20% of the total number of OTUs in the data. We then compared the OTU selections before and after batch effect correction with different methods.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hfhs.splsda.select.overlap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gplots/man/venn.html">venn</a></span><span class="op">(</span><span class="va">hfhs.splsda.select</span>, show.plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">hfhs.inters.splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">hfhs.splsda.select.overlap</span>, <span class="st">'intersections'</span><span class="op">)</span>
<span class="va">hfhs.inters.splsda.taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">hfhs.inters.splsda</span>, 
                                  FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">hfhs.taxa</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="va">hfhs.inters.splsda.taxa</span>, 
               file <span class="op">=</span> <span class="st">"GeneratedData/HFHSselected_50_splsda.txt"</span><span class="op">)</span></code></pre></div>
<p>We also saved the taxonomic information of intersectional OTUs into a txt file.</p>
</div>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-chapleur2016increasing">
<p>Chapleur, Olivier, Céline Madigou, Raphaël Civade, Yohan Rodolphe, Laurent Mazéas, and Théodore Bouchez. 2016. “Increasing Concentrations of Phenol Progressively Affect Anaerobic Digestion of Cellulose and Associated Microbial Communities.” <em>Biodegradation</em> 27 (1). Springer: 15–27.</p>
</div>
<div id="ref-rohart2017mixomics">
<p>Rohart, Florian, Benoît Gautier, Amrit Singh, and Kim-Anh Lê Cao. 2017. “MixOmics: An R Package for ‘Omics Feature Selection and Multiple Data Integration.” <em>PLoS Computational Biology</em> 13 (11). Public Library of Science: e1005752.</p>
</div>
<div id="ref-sacristan2011exploring">
<p>Sacristán-Soriano, Oriol, Bernard Banaigs, Emilio O Casamayor, and Mikel A Becerro. 2011. “Exploring the Links Between Natural Products and Bacterial Assemblages in the Sponge Aplysina Aerophoba.” <em>Appl. Environ. Microbiol.</em> 77 (3). Am Soc Microbiol: 862–70.</p>
</div>
<div id="ref-susin2020variable">
<p>Susin, Antoni, Yiwen Wang, Kim-Anh Lê Cao, and M Luz Calle. 2020. “Variable Selection in Microbiome Compositional Data Analysis.” <em>NAR Genomics and Bioinformatics</em> 2 (2). Oxford University Press: lqaa029.</p>
</div>
<div id="ref-tharwat2018classification">
<p>Tharwat, Alaa. 2018. “Classification Assessment Methods.” <em>Applied Computing and Informatics</em>. Elsevier.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Yiwen Wang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
