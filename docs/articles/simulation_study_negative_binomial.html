<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batch Effects Management in Simulation Studies (Negative Binomial Distribution) • PLSDAbatch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Batch Effects Management in Simulation Studies (Negative Binomial Distribution)">
<meta property="og:description" content="PLSDAbatch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PLSDAbatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/brief_vignette.html">PLSDA-batch Vignette</a>
    </li>
    <li>
      <a href="../articles/case_studies.html">Batch Effects Management in Case Studies</a>
    </li>
    <li>
      <a href="../articles/simulation_study_Gaussian.html">Batch Effects Management in Simulation Studies (Gaussian Distribution)</a>
    </li>
    <li>
      <a href="../articles/simulation_study_negative_binomial.html">Batch Effects Management in Simulation Studies (Negative Binomial Distribution)</a>
    </li>
    <li>
      <a href="../articles/supp_case_studies.html">Supplementary Materials for Batch Effects Management in Case Studies</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Batch Effects Management in Simulation Studies
(Negative Binomial Distribution)</h1>
                        <h4 data-toc-skip class="author">Yiwen (Eva)
Wang</h4>
                        <h4 data-toc-skip class="author">Agricultural
Genomics Institute at Shenzhen, Chinese Academy of Agricultural
Sciences, Shenzhen, China</h4>
                        <h4 data-toc-skip class="author"><a href="mailto:wangyiwen@caas.cn" class="email">wangyiwen@caas.cn</a></h4>
            
            <h4 data-toc-skip class="date">10 November, 2022</h4>
      
      
      <div class="hidden name"><code>simulation_study_negative_binomial.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Microbiome data are multivariate with inherent correlation structure
between microbial variables. The data are over-dispersed with a
distribution close to a negative binomial distribution <span class="citation">(<a href="#ref-mcmurdie2014waste" role="doc-biblioref">McMurdie and Holmes 2014</a>; <a href="#ref-quinn2018understanding" role="doc-biblioref">Quinn et al.
2018</a>)</span>. Inspired by <span class="citation">(<a href="#ref-hawinkel2019broken" role="doc-biblioref">Hawinkel et al.
2019</a>)</span>, we simulated data from multivariate negative binomial
distribution achieved with quantile-quantile transformation between
multivariate normal and negative binomial distributions. To add
treatment and batch effects, we used matrix factorisation to simulate
the mean for modelling negative binomial distribution as a matrix <span class="math display">\[\Theta = \begin{bmatrix}
\theta_{11} &amp; ...  &amp; \theta_{1M}\\
...&amp; ... &amp; ... \\
\theta_{1N} &amp; ... &amp; \theta_{NM}
\end{bmatrix}\]</span> for <span class="math inline">\(N\)</span>
samples and <span class="math inline">\(M\)</span> microbial variables
as follows:</p>
<p><span class="math display">\[\Theta =
exp(x_{(trt)}^{\top}\beta^{(trt)} + x_{(batch)}^{\top}\beta^{(batch)} +
\epsilon)\]</span></p>
<p>where <span class="math inline">\(x_{(trt)}\)</span> and <span class="math inline">\(x_{(batch)}\)</span> represent the design vectors
of treatment and batch effects respectively for each sample. <span class="math inline">\(\beta^{(trt)}\)</span> and <span class="math inline">\(\beta^{(batch)}\)</span> represent the regression
coefficients of treatment and batch effects for each microbial variable,
and <span class="math inline">\(\beta^{(trt)}_{j} \in
N(\mu_{(trt)},\sigma_{(trt)}^{2})\)</span>, <span class="math inline">\(\beta^{(batch)}_{j} \in
N(\mu_{(batch)},\sigma_{(batch)}^{2})\)</span>. <span class="math inline">\(\epsilon\)</span> contains the random noise that
is independent and identically distributed (i.i.d) and <span class="math inline">\(\epsilon_{ij} \in N(0,\delta^{2})\)</span>, in
which <span class="math inline">\(i = 1,2,...,N\)</span> samples, <span class="math inline">\(j = 1,2,..,M\)</span> variables.</p>
<p>The probability matrix <span class="math display">\[P =
\begin{bmatrix}
p_{11} &amp; ...  &amp; p_{1M}\\
...&amp; ... &amp; ... \\
p_{1N} &amp; ... &amp; p_{NM}
\end{bmatrix}\]</span> for modelling negative binomial distribution is
calculated as</p>
<p><span class="math display">\[p_{ij} = \frac{r}{r +
\theta_{ij}}\]</span> where <span class="math inline">\(p_{ij}\)</span>
and <span class="math inline">\(\theta_{ij}\)</span> represent the
probability of success in each trial and the mean for negative binomial
distribution of sample <span class="math inline">\(i\)</span> and
microbial variable <span class="math inline">\(j\)</span>, and <span class="math inline">\(r\)</span> is the dispersion parameter
representing the number of successes.</p>
<p>We then simulated a data matrix based on multivariate normal
distribution with mean <span class="math inline">\(0\)</span> and
correlation matrix <span class="math inline">\(\Sigma\)</span>:</p>
<p><span class="math display">\[X^{normal} = N(0, \Sigma)\]</span></p>
<p>where the correlation matrix <span class="math inline">\(\Sigma\)</span> was simulated with the strategy
adapted from <span class="citation">(<a href="#ref-mcgregor2020mdine" role="doc-biblioref">McGregor, Labbe, and Greenwood 2020</a>)</span> as
follows: We first generated a lower-triangular matrix <span class="math inline">\(L\)</span>, in which the diagonal elements follow
<span class="math inline">\(Unif(1.5, 2.5)\)</span>, and the other
elements <span class="math inline">\(Unif(-1.5, 1.5)\)</span>. We
randomly set the elements outside the diagonal of <span class="math inline">\(L\)</span> to zero with probability <span class="math inline">\(0.7\)</span>. A precision matrix, which is the
inverse of covariance matrix was created as <span class="math inline">\(R^{-1} = LL^{\top}\)</span>. The corresponding
correlation matrix <span class="math inline">\(\Sigma\)</span> to <span class="math inline">\(R\)</span> was then obtained. These parameters
were set according to <span class="citation">(<a href="#ref-mcgregor2020mdine" role="doc-biblioref">McGregor, Labbe, and
Greenwood 2020</a>)</span>.</p>
<p>Thereafter we used Cumulative Distribution Function (CDF) to achieve
quantile-quantile transformation as:</p>
<p><span class="math display">\[CDF(x^{normal}_{ij}) =
CDF(x^{nb}_{ij})\]</span></p>
<p>where <span class="math inline">\(CDF(x^{normal}_{ij})\)</span>
represents the cumulative probability of <span class="math inline">\(x^{normal}_{ij}\)</span> for sample <span class="math inline">\(i\)</span> and variable <span class="math inline">\(j\)</span> that belongs to matrix <span class="math inline">\(X^{normal}\)</span> from multivariate normal
distribution. <span class="math inline">\(CDF(x^{nb}_{ij})\)</span>
represents the cumulative probability of each <span class="math inline">\(x^{nb}_{ij}\)</span> in matrix <span class="math inline">\(X^{nb}\)</span> from negative binomial
distribution.</p>
<p>Based on the cumulative probability, we can simulate a data matrix
<span class="math inline">\(X^{nb}\)</span> with multivariate negative
binomial distribution:</p>
<p><span class="math display">\[X^{nb} = NB(r, P, \Sigma)\]</span></p>
<p>where <span class="math inline">\(r\)</span> represents the
dispersion parameter, <span class="math inline">\(P\)</span> represents
the probability matrix and <span class="math inline">\(\Sigma\)</span>
the correlation matrix explaining the dependence structure between
microbial variables.</p>
<p>We simulated datasets with different parameters including amount of
batch and treatment effects (<span class="math inline">\(\mu_{(batch)}\)</span>, <span class="math inline">\(\mu_{(trt)}\)</span>) and variability among
variables (<span class="math inline">\(\sigma_{(batch)}\)</span>, <span class="math inline">\(\sigma_{(trt)}\)</span>), number of variables with
batch and/or treatment effects (<span class="math inline">\(M^{(batch)}\)</span>, <span class="math inline">\(M^{(trt)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span>), balanced and
unbalanced batch <span class="math inline">\(\times\)</span> treatment
designs, as summarised in the table below.</p>
<p><strong>Table 1: Summary of simulation scenarios (Negative Binomial
distribution).</strong> For a given choice of parameters reported in
this table, each simulation was repeated 50 times. <span class="math inline">\(M^{(trt)}, M^{(batch)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span> represent the
number of variables with treatment, batch, or both effects respectively.
Simulation 6 includes parameters likely to represent real data according
to our experience in analysing microbiome datasets.</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="12%">
<col width="10%">
<col width="12%">
<col width="11%">
<col width="13%">
<col width="11%">
<col width="11%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="center">Parameters</th>
<th align="center"><span class="math inline">\(\mu_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\mu_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt \ \&amp; \
batch)}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Simulation 1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">{1,4,8}</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simulation 2</td>
<td align="center">{3,5,7}</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simulation 3</td>
<td align="center">3</td>
<td align="center">{1,2,4}</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simulation 4</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">{30,60,100,150}</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simulation 5</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">{30,60,100,150}</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simulation 6</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">{0,18,30,42,60}</td>
</tr>
</tbody>
</table>
<p>The microbial variables with treatment or batch effects were randomly
indexed in the data with non-zero <span class="math inline">\(\beta^{(trt)}\)</span> or <span class="math inline">\(\beta^{(batch)}\)</span>. The background noise
<span class="math inline">\(\epsilon_{ij}\)</span> was randomly sampled
from <span class="math inline">\(N(0,0.2^{2})\)</span>, reflecting real
microbiome datasets.</p>
<p>We also simulated datasets with different number of batch groups:</p>
<ol style="list-style-type: decimal">
<li>Two batch groups: Each dataset included 300 variables and 40 samples
grouped according to two treatments (trt1 and trt2) and two batches
(batch1 and batch2).<br>
</li>
<li>Three batch groups: Each dataset included 300 variables and 36
samples grouped according to two treatments (trt1 and trt2) and three
batches (batch1, batch2 and batch3).</li>
</ol>
<p>In addition, we simulated a ground-truth dataset that only included
treatment effects and background noise without batch effects to evaluate
batch effect correction methods.</p>
<p>Our simulations generate over-dispersed count data with batch and
treatment effects as well as correlation structure among variables, but
without any compositional structure. We therefore only applied natural
log transformation to the simulated data prior to analysis.</p>
<p>In these simulation scenarios, for PLSDA-batch we set <span class="math inline">\(C-1\)</span> (or <span class="math inline">\(B-1\)</span>) components associated with treatment
(or batch) effects (where <span class="math inline">\(C\)</span> and
<span class="math inline">\(B\)</span> represent the total number of
treatment and batch groups respectively) as <span class="math inline">\(C-1\)</span> (<span class="math inline">\(B-1\)</span>) components are likely to explain
100% variance in <span class="math inline">\(Y\)</span>. The number of
variables with a true treatment effect (<span class="math inline">\(M^{(trt)}\)</span>) is set as the optimal number
to select on each treatment component in sPLSDA-batch.</p>
</div>
<div class="section level2">
<h2 id="packages-installation-and-loading">Packages installation and loading<a class="anchor" aria-label="anchor" href="#packages-installation-and-loading"></a>
</h2>
<p>Install then load the following packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PLSDAbatch</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.mixOmics.org" class="external-link">mixOmics</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sva</span><span class="op">)</span> <span class="co">#ComBat</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioinf.wehi.edu.au/limma" class="external-link">limma</a></span><span class="op">)</span> <span class="co">#removeBatchEffect</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vegandevs/vegan" class="external-link">vegan</a></span><span class="op">)</span> <span class="co">#RDA</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://expasy.org/tools/pROC/" class="external-link">pROC</a></span><span class="op">)</span> <span class="co">#roc</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulations-two-batch-groups">Simulations (two batch groups)<a class="anchor" aria-label="anchor" href="#simulations-two-batch-groups"></a>
</h2>
<div class="section level3">
<h3 id="balanced-batch-times-treatment-design">Balanced batch <span class="math inline">\(\times\)</span> treatment
design<a class="anchor" aria-label="anchor" href="#balanced-batch-times-treatment-design"></a>
</h3>
<p>The balanced batch <span class="math inline">\(\times\)</span>
treatment experimental design included 10 samples from two batches
respectively in each treatment group.</p>
<p><strong>Table 2: Balanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation
study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">40</span></span>
<span><span class="va">p_total</span> <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">=</span> <span class="fl">100</span> </span>
<span><span class="va">p_bat_relevant</span> <span class="op">=</span> <span class="fl">200</span> </span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                                            intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                            residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                       ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                           ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># auc (splsda)</span></span>
<span><span class="va">auc_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">data.cor.res</span> <span class="op">=</span> <span class="fu"><a href="../reference/corStruct.html">corStruct</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">300</span>, zero_prob <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nitr</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_mnegbinom.html">simData_mnegbinom</a></span><span class="op">(</span>batch.group <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  mean.batch <span class="op">=</span> <span class="fl">7</span>, </span>
<span>                                  sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                  mean.trt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                                  sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                  mean.bg <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  sd.bg <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                  N <span class="op">=</span> <span class="fl">40</span>, </span>
<span>                                  p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                  p_trt_relevant <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                  p_bat_relevant <span class="op">=</span> <span class="fl">200</span>, </span>
<span>                                  percentage_overlap_samples <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  data.cor <span class="op">=</span> <span class="va">data.cor.res</span><span class="op">$</span><span class="va">data.cor</span>, </span>
<span>                                  disp <span class="op">=</span> <span class="fl">10</span>, prob_zero <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">raw_count</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">raw_count_clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  </span>
<span>  <span class="co">## log transformation</span></span>
<span>  <span class="va">data_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">data_log_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count_clean</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  </span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Original ###</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">data_log</span></span>
<span>  </span>
<span>  <span class="co">### Clean data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">data_log_clean</span></span>
<span>  </span>
<span>  <span class="co">#####</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'sample'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'otu'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.before_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">true.response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">true.response</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">before.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.before_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">before.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.before_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.before_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span><span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span><span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">clean.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.clean_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">clean.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.clean_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.clean_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rbe.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.rbe_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">rbe.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.rbe_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> </span>
<span>                                                  <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">combat.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.combat_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">combat.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.combat_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.combat_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span><span class="op">)</span>, </span>
<span>                                     coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.plsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.plsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.plsda_batch</span><span class="op">*</span><span class="va">recall_limma.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.plsda_batch</span>, </span>
<span>                               <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.plsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.plsda_batch</span></span>
<span>  <span class="va">r2.batch.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.plsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.plsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.plsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">plsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.plsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                <span class="va">plsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.plsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                        Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.splsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.splsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.splsda_batch</span><span class="op">*</span><span class="va">recall_limma.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.splsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.splsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.splsda_batch</span></span>
<span>  <span class="va">r2.batch.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.splsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.splsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.splsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">splsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.splsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">splsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.splsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### SVA ###</span></span>
<span>  <span class="va">X.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/num.sv.html" class="external-link">num.sv</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, mod <span class="op">=</span> <span class="va">X.mod</span>, method <span class="op">=</span> <span class="st">'leek'</span><span class="op">)</span></span>
<span>  <span class="va">X.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/sva.html" class="external-link">sva</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod</span>, <span class="va">X.mod0</span>, n.sv <span class="op">=</span> <span class="va">X.sva.n</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X.mod.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod0</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/f.pvalue.html" class="external-link">f.pvalue</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod.batch</span>, <span class="va">X.mod0.batch</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">X.sva.p</span>, method <span class="op">=</span> <span class="st">'fdr'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">otu.sig.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X.sva.p.adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.sva</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.sva</span><span class="op">*</span><span class="va">recall_limma.sva</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">+</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `PLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.plsda_batch</span>,</span>
<span>                            `sPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.splsda_batch</span>,</span>
<span>                            SVA <span class="op">=</span> <span class="va">precision_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `PLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.plsda_batch</span>,</span>
<span>                         `sPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.splsda_batch</span>,</span>
<span>                         SVA <span class="op">=</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `PLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.plsda_batch</span>,</span>
<span>                     `sPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.splsda_batch</span>,</span>
<span>                     SVA <span class="op">=</span> <span class="va">F1_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># auc (splsda)</span></span>
<span>  <span class="va">auc_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">auc.before_splsda</span>, </span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="va">auc.clean_splsda</span>, </span>
<span>                       `removeBatchEffect` <span class="op">=</span> <span class="va">auc.rbe_splsda</span>, </span>
<span>                       ComBat <span class="op">=</span> <span class="va">auc.combat_splsda</span>, </span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="va">auc.plsda_batch_splsda</span>, </span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="va">auc.splsda_batch_splsda</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># print(i)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="figures">Figures<a class="anchor" aria-label="anchor" href="#figures"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%"><p class="caption">
Figure 1: Simulation studies (two batch groups): comparison of explained
variance before and after batch effect correction for the balanced batch
× treatment design.
</p>
</div>
<p>Efficient batch effect correction methods should generate data with a
null proportion of variance explained by batch effects, and a proportion
of variance explained by treatment that is larger compared to the
original data, as shown in the figure above original data and
ground-truth data.</p>
<p>For a balanced batch <span class="math inline">\(\times\)</span>
treatment design, we observed no intersection shared between treatment
and batch variance, as expected. All methods successfully removed batch
variance and preserved (or slightly increased) treatment variance
(sPLSDA-batch), with the exception of ComBat where a very small amount
of batch variance remained.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co">## boxplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Treatment only'</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Batch only'</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'Treatment &amp; batch'</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p_total</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'No effect'</span></span>
<span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gclass</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment &amp; batch'</span>, </span>
<span>                                    <span class="st">'Treatment only'</span>, </span>
<span>                                    <span class="st">'Batch only'</span>, </span>
<span>                                    <span class="st">'No effect'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">before.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clean.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, </span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                              type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                   each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rbe.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                 each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">combat.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.plsdab</span><span class="op">)</span>, </span>
<span>                                           <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.plsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                         each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">splsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.splsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.splsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.ggp</span>, <span class="va">clean.r2.df.ggp</span>,</span>
<span>                       <span class="va">rbe.r2.df.ggp</span>, <span class="va">combat.r2.df.ggp</span>,</span>
<span>                       <span class="va">plsda_batch.r2.df.ggp</span>, <span class="va">splsda_batch.r2.df.ggp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                               <span class="st">'Ground-truth data'</span>, </span>
<span>                               <span class="st">'removeBatchEffect'</span>, </span>
<span>                               <span class="st">'ComBat'</span>,</span>
<span>                               <span class="st">'PLSDA-batch'</span>, </span>
<span>                               <span class="st">'sPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-5-1.png" alt="Figure 2: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%"><p class="caption">
Figure 2: Simulation studies (two batch groups): R2 values for each
microbial variable before and after batch effect correction for the
balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co">## barplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">before.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rbe.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combat.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.plsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.plsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">splsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.splsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.splsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.bp</span>, <span class="va">clean.r2.df.bp</span>,</span>
<span>                      <span class="va">rbe.r2.df.bp</span>, <span class="va">combat.r2.df.bp</span>,</span>
<span>                      <span class="va">plsda_batch.r2.df.bp</span>, <span class="va">splsda_batch.r2.df.bp</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                              <span class="st">'Ground-truth data'</span>, </span>
<span>                              <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>,</span>
<span>                              <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-6-1.png" alt="Figure 3: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%"><p class="caption">
Figure 3: Simulation studies (two batch groups): the sum of R2 values
for each microbial variable before and after batch effect correction for
the balanced batch × treatment design.
</p>
</div>
<p>We estimated the proportion of variance explained by treatment and
batch effects for each variable using the <span class="math inline">\(R^2\)</span> value. removeBatchEffect and
PLSDA-batch had the best performance, with results very similar to the
ground-truth data. ComBat retained more batch variance of variables with
batch effects only, and with both batch and treatment effects,
indicating an incomplete removal of batch effects. This result is in
agreement with the overall pRDA evaluation described earlier. For
sPLSDA-batch, variables with no treatment effect (batch effects only)
included a slight amount of (spurious) treatment variance. This was also
observed in pRDA evaluation. However, sPLSDA-batch performed as well as
PLSDA-batch when the simulated data did not include variables with both
batch and treatment effects.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">auc_splsda</span><span class="op">)</span>, sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 3: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 3: Simulation studies (two batch groups): summary of
accuracy measurements before and after batch effect correction for the
balanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="11%">
<col width="12%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.984</td>
<td align="left">0.952</td>
<td align="left">0.950</td>
<td align="left">0.952</td>
<td align="left">0.952</td>
<td align="left">0.807</td>
<td align="left">0.957</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.674</td>
<td align="left">0.900</td>
<td align="left">0.910</td>
<td align="left">0.911</td>
<td align="left">0.910</td>
<td align="left">0.910</td>
<td align="left">0.934</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.799</td>
<td align="left">0.923</td>
<td align="left">0.927</td>
<td align="left">0.929</td>
<td align="left">0.929</td>
<td align="left">0.851</td>
<td align="left">0.944</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.944</td>
<td align="left">0.964</td>
<td align="left">0.968</td>
<td align="left">0.968</td>
<td align="left">0.969</td>
<td align="left">0.954</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>The results from the accuracy measures combined with variable
selection highlight the importance of removing batch effects as both F1
score and AUC largely improved compared to the original data.</p>
<p>Starting from the original data compared to the ground-truth data,
selected variables had a higher precision, lower recall and lower AUC,
indicating a smaller number of variables selected with an actual
treatment effect. Combined with univariate one-way ANOVA, SVA performed
best with the highest, and sometimes greater, accuracy measurements than
the ground-truth data. The other methods led to similar performance with
the exception of sPLSDA-batch, which selected more false positives than
the other methods. PLSDA-batch led to a slightly better AUC than the
other methods.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">auc_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 4: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 4: Simulation studies (two batch groups): summary of
accuracy measurements before and after batch effect correction for the
balanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="11%">
<col width="12%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.04</td>
<td align="left">0.08</td>
<td align="left">0.09</td>
<td align="left">0.08</td>
<td align="left">0.08</td>
<td align="left">0.11</td>
<td align="left">0.06</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.02</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.06</td>
<td align="left">0.04</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.01</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="unbalanced-batch-times-treatment-design">Unbalanced batch <span class="math inline">\(\times\)</span>
treatment design<a class="anchor" aria-label="anchor" href="#unbalanced-batch-times-treatment-design"></a>
</h3>
<p>The unbalanced design included 4 and 16 samples from batch1 and
batch2 respectively in trt1, 16 and 4 samples from batch1 and batch2 in
trt2.</p>
<p><strong>Table 5: Unbalanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation
study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">4</td>
<td align="center">16</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">16</td>
<td align="center">4</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">40</span></span>
<span><span class="va">p_total</span> <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">=</span> <span class="fl">100</span> </span>
<span><span class="va">p_bat_relevant</span> <span class="op">=</span> <span class="fl">200</span> </span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.wplsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.swplsdab</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                                            intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                            residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.swplsdab</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">r2.trt.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                       ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.swplsdab</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">r2.batch.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                           ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># auc (splsda)</span></span>
<span><span class="va">auc_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">data.cor.res</span> <span class="op">=</span> <span class="fu"><a href="../reference/corStruct.html">corStruct</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">300</span>, zero_prob <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nitr</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_mnegbinom.html">simData_mnegbinom</a></span><span class="op">(</span>batch.group <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                  mean.batch <span class="op">=</span> <span class="fl">7</span>, </span>
<span>                                  sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                  mean.trt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                                  sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                  mean.bg <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  sd.bg <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                  N <span class="op">=</span> <span class="fl">40</span>, </span>
<span>                                  p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                  p_trt_relevant <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                  p_bat_relevant <span class="op">=</span> <span class="fl">200</span>, </span>
<span>                                  percentage_overlap_samples <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                  percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  data.cor <span class="op">=</span> <span class="va">data.cor.res</span><span class="op">$</span><span class="va">data.cor</span>, </span>
<span>                                  disp <span class="op">=</span> <span class="fl">10</span>, prob_zero <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">raw_count</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">raw_count_clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  </span>
<span>  <span class="co">## log transformation</span></span>
<span>  <span class="va">data_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">data_log_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count_clean</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  </span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Original ###</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">data_log</span></span>
<span>  </span>
<span>  <span class="co">### Clean data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">data_log_clean</span></span>
<span>  </span>
<span>  <span class="co">#####</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'sample'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'otu'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.before_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">true.response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">true.response</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">before.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.before_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">before.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.before_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.before_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">clean.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.clean_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">clean.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.clean_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.clean_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rbe.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.rbe_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">rbe.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.rbe_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">combat.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.combat_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">combat.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.combat_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.combat_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### wPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.wplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                        balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.wplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.wplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.wplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.wplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.wplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.wplsda_batch</span><span class="op">)</span>, </span>
<span>                                      coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.wplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.wplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.wplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.wplsda_batch</span><span class="op">*</span><span class="va">recall_limma.wplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.wplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.wplsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.wplsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.wplsda_batch</span></span>
<span>  <span class="va">r2.batch.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.wplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.wplsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.wplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">wplsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.wplsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.wplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">wplsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.wplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.wplsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.swplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                         Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                         Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                         ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                         keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                         ncomp.bat <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                         balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.swplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.swplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.swplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                              data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.swplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.swplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.swplsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                       number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.swplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.swplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.swplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.swplsda_batch</span><span class="op">*</span><span class="va">recall_limma.swplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.swplsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.swplsda_batch</span>, </span>
<span>                                   <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.swplsda_batch</span></span>
<span>  <span class="va">r2.batch.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.swplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.swplsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.swplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">swplsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.swplsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.swplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                  <span class="va">swplsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.swplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.swplsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span><span class="op">)</span>, </span>
<span>                                     coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.plsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.plsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.plsda_batch</span><span class="op">*</span><span class="va">recall_limma.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.plsda_batch</span>, </span>
<span>                               <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.plsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.plsda_batch</span></span>
<span>  <span class="va">r2.batch.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.plsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.plsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.plsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">plsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.plsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                <span class="va">plsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.plsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                        Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.splsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.splsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.splsda_batch</span><span class="op">*</span><span class="va">recall_limma.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.splsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.splsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.splsda_batch</span></span>
<span>  <span class="va">r2.batch.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.splsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.splsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.splsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">splsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.splsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">splsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.splsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### SVA ###</span></span>
<span>  <span class="va">X.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/num.sv.html" class="external-link">num.sv</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, mod <span class="op">=</span> <span class="va">X.mod</span>, method <span class="op">=</span> <span class="st">'leek'</span><span class="op">)</span></span>
<span>  <span class="va">X.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/sva.html" class="external-link">sva</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod</span>, <span class="va">X.mod0</span>, n.sv <span class="op">=</span> <span class="va">X.sva.n</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X.mod.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod0</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/f.pvalue.html" class="external-link">f.pvalue</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod.batch</span>, <span class="va">X.mod0.batch</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">X.sva.p</span>, method <span class="op">=</span> <span class="st">'fdr'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">otu.sig.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X.sva.p.adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.sva</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.sva</span><span class="op">*</span><span class="va">recall_limma.sva</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">+</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `wPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.wplsda_batch</span>,</span>
<span>                            `swPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.swplsda_batch</span>,</span>
<span>                            SVA <span class="op">=</span> <span class="va">precision_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `wPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.wplsda_batch</span>,</span>
<span>                         `swPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.swplsda_batch</span>,</span>
<span>                         SVA <span class="op">=</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `wPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.wplsda_batch</span>,</span>
<span>                     `swPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.swplsda_batch</span>,</span>
<span>                     SVA <span class="op">=</span> <span class="va">F1_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># auc (splsda)</span></span>
<span>  <span class="va">auc_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">auc.before_splsda</span>, </span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="va">auc.clean_splsda</span>, </span>
<span>                       `removeBatchEffect` <span class="op">=</span> <span class="va">auc.rbe_splsda</span>, </span>
<span>                       ComBat <span class="op">=</span> <span class="va">auc.combat_splsda</span>, </span>
<span>                       `wPLSDA-batch` <span class="op">=</span> <span class="va">auc.wplsda_batch_splsda</span>, </span>
<span>                       `swPLSDA-batch` <span class="op">=</span> <span class="va">auc.swplsda_batch_splsda</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#print(i)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="figures-1">Figures<a class="anchor" aria-label="anchor" href="#figures-1"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `wPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.wplsdab</span><span class="op">)</span>,</span>
<span>                       `swPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.swplsdab</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-11-1.png" alt="Figure 4: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="70%"><p class="caption">
Figure 4: Simulation studies (two batch groups): comparison of explained
variance before and after batch effect correction for the unbalanced
batch × treatment design.
</p>
</div>
<p>For a strong unbalanced batch <span class="math inline">\(\times\)</span> treatment design, we observed the
presence of intersectional variance explained by both batch and
treatment effects, as expected. This source of variance is also present
in the ground-truth data but should be smaller compared to the
uncorrected data. Both unweighted PLSDA-batch and sPLSDA-batch performed
poorly for such design - for PLSDA-batch the intersectional variance
increased while for sPLSDA-batch the batch variance was not entirely
removed. The other methods were successful in removing batch variance.
removeBatchEffect and ComBat explained a proportion of variance by
treatment similar to the ground-truth data, while wPLSDA-batch and
swPLSDA-batch explained slightly less treatment variance.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co">## boxplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Treatment only'</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Batch only'</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'Treatment &amp; batch'</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p_total</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'No effect'</span></span>
<span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gclass</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment &amp; batch'</span>, </span>
<span>                                    <span class="st">'Treatment only'</span>, </span>
<span>                                    <span class="st">'Batch only'</span>, </span>
<span>                                    <span class="st">'No effect'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">before.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clean.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, </span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                              type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                   each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rbe.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                 each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">combat.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">wplsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.wplsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.wplsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">swplsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.swplsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.swplsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>,</span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.ggp</span>, <span class="va">clean.r2.df.ggp</span>,</span>
<span>                       <span class="va">rbe.r2.df.ggp</span>, <span class="va">combat.r2.df.ggp</span>,</span>
<span>                       <span class="va">wplsda_batch.r2.df.ggp</span>, <span class="va">swplsda_batch.r2.df.ggp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                               <span class="st">'Ground-truth data'</span>, </span>
<span>                               <span class="st">'removeBatchEffect'</span>, </span>
<span>                               <span class="st">'ComBat'</span>,</span>
<span>                               <span class="st">'wPLSDA-batch'</span>, </span>
<span>                               <span class="st">'swPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-12-1.png" alt="Figure 5: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%"><p class="caption">
Figure 5: Simulation studies (two batch groups): R2 values for each
microbial variable before and after batch effect correction for the
unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co">## barplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">before.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rbe.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combat.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wplsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.wplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.wplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">swplsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.swplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.swplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.bp</span>, <span class="va">clean.r2.df.bp</span>,</span>
<span>                      <span class="va">rbe.r2.df.bp</span>, <span class="va">combat.r2.df.bp</span>,</span>
<span>                      <span class="va">wplsda_batch.r2.df.bp</span>, <span class="va">swplsda_batch.r2.df.bp</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                              <span class="st">'Ground-truth data'</span>, </span>
<span>                              <span class="st">'removeBatchEffect'</span>, </span>
<span>                              <span class="st">'ComBat'</span>,</span>
<span>                              <span class="st">'wPLSDA-batch'</span>, </span>
<span>                              <span class="st">'swPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-13-1.png" alt="Figure 6: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%"><p class="caption">
Figure 6: Simulation studies (two batch groups): the sum of R2 values
for each microbial variable before and after batch effect correction for
the unbalanced batch × treatment design.
</p>
</div>
<p>We observed similar performance for removeBatchEffect and ComBat for
the unbalanced design compared to the balanced design. With wPLSDA-batch
and swPLSDA-batch, variables with both treatment and batch effects
explained less treatment variance after correction, compared to the
ground-truth data. However, for the other variables, wPLSDA-batch and
its sparse version performed as similar as the ground-truth data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">auc_splsda</span><span class="op">)</span>, sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 6 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 6 Simulation studies (two batch groups): summary of
accuracy measurements before and after batch effect correction for the
unbalanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="12%">
<col width="13%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.385</td>
<td align="left">0.973</td>
<td align="left">0.901</td>
<td align="left">0.834</td>
<td align="left">0.943</td>
<td align="left">0.943</td>
<td align="left">0.401</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.825</td>
<td align="left">0.895</td>
<td align="left">0.910</td>
<td align="left">0.919</td>
<td align="left">0.888</td>
<td align="left">0.862</td>
<td align="left">0.918</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.525</td>
<td align="left">0.932</td>
<td align="left">0.903</td>
<td align="left">0.873</td>
<td align="left">0.914</td>
<td align="left">0.900</td>
<td align="left">0.558</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.704</td>
<td align="left">0.967</td>
<td align="left">0.963</td>
<td align="left">0.962</td>
<td align="left">0.965</td>
<td align="left">0.954</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>In the unbalanced design, the precision of SVA is low and very
similar to the original data, indicating that the performance of SVA
heavily depends on the experimental design and is likely to overfit.
This may explain the somewhat inflated results of SVA in the balanced
design case. wPLSDA-batch performed best with results close to those
from the ground-truth data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">auc_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 7 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 7 Simulation studies (two batch groups): summary of
accuracy measurements before and after batch effect correction for the
unbalanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="12%">
<col width="13%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.01</td>
<td align="left">0.05</td>
<td align="left">0.09</td>
<td align="left">0.08</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.01</td>
<td align="left">0.03</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.06</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.01</td>
<td align="left">0.01</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="simulations-three-batch-groups">Simulations (three batch groups)<a class="anchor" aria-label="anchor" href="#simulations-three-batch-groups"></a>
</h2>
<div class="section level3">
<h3 id="balanced-batch-times-treatment-design-1">Balanced batch <span class="math inline">\(\times\)</span> treatment
design<a class="anchor" aria-label="anchor" href="#balanced-batch-times-treatment-design-1"></a>
</h3>
<p>The balanced batch <span class="math inline">\(\times\)</span>
treatment experimental design included 6 samples from three batches
respectively in each treatment group.</p>
<p><strong>Table 8: Balanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation
study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
<tr class="odd">
<td align="center">Batch3</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">36</span></span>
<span><span class="va">p_total</span> <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">=</span> <span class="fl">100</span> </span>
<span><span class="va">p_bat_relevant</span> <span class="op">=</span> <span class="fl">200</span> </span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                                            intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                            residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                       ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                           ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># auc (splsda)</span></span>
<span><span class="va">auc_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">data.cor.res</span> <span class="op">=</span> <span class="fu"><a href="../reference/corStruct.html">corStruct</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">300</span>, zero_prob <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nitr</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_mnegbinom.html">simData_mnegbinom</a></span><span class="op">(</span>batch.group <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                  mean.batch <span class="op">=</span> <span class="fl">7</span>, </span>
<span>                                  sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                  mean.trt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                                  sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                  mean.bg <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  sd.bg <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                  N <span class="op">=</span> <span class="fl">36</span>, </span>
<span>                                  p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                  p_trt_relevant <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                  p_bat_relevant <span class="op">=</span> <span class="fl">200</span>, </span>
<span>                                  percentage_overlap_samples <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  data.cor <span class="op">=</span> <span class="va">data.cor.res</span><span class="op">$</span><span class="va">data.cor</span>, </span>
<span>                                  disp <span class="op">=</span> <span class="fl">10</span>, prob_zero <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">raw_count</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">raw_count_clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  </span>
<span>  <span class="co">## log transformation</span></span>
<span>  <span class="va">data_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">data_log_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count_clean</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  </span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Original ###</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">data_log</span></span>
<span>  </span>
<span>  <span class="co">### Clean data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">data_log_clean</span></span>
<span>  </span>
<span>  <span class="co">#####</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'sample'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'otu'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.before_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">true.response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">true.response</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">before.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.before_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">before.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.before_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.before_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span><span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">clean.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.clean_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">clean.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.clean_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.clean_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rbe.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.rbe_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">rbe.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.rbe_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> </span>
<span>                                                  <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">combat.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.combat_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">combat.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.combat_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.combat_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span><span class="op">)</span>, </span>
<span>                                     coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.plsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.plsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.plsda_batch</span><span class="op">*</span><span class="va">recall_limma.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.plsda_batch</span>, </span>
<span>                               <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.plsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.plsda_batch</span></span>
<span>  <span class="va">r2.batch.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.plsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.plsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.plsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">plsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.plsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                <span class="va">plsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.plsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                        Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.splsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.splsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.splsda_batch</span><span class="op">*</span><span class="va">recall_limma.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.splsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.splsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.splsda_batch</span></span>
<span>  <span class="va">r2.batch.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.splsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.splsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.splsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">splsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.splsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">splsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.splsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### SVA ###</span></span>
<span>  <span class="va">X.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/num.sv.html" class="external-link">num.sv</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, mod <span class="op">=</span> <span class="va">X.mod</span>, method <span class="op">=</span> <span class="st">'leek'</span><span class="op">)</span></span>
<span>  <span class="va">X.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/sva.html" class="external-link">sva</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod</span>, <span class="va">X.mod0</span>, n.sv <span class="op">=</span> <span class="va">X.sva.n</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X.mod.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod0</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/f.pvalue.html" class="external-link">f.pvalue</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod.batch</span>, <span class="va">X.mod0.batch</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">X.sva.p</span>, method <span class="op">=</span> <span class="st">'fdr'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">otu.sig.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X.sva.p.adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.sva</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.sva</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.sva</span><span class="op">*</span><span class="va">recall_limma.sva</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">+</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `PLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.plsda_batch</span>,</span>
<span>                            `sPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.splsda_batch</span>,</span>
<span>                            SVA <span class="op">=</span> <span class="va">precision_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `PLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.plsda_batch</span>,</span>
<span>                         `sPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.splsda_batch</span>,</span>
<span>                         SVA <span class="op">=</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `PLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.plsda_batch</span>,</span>
<span>                     `sPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.splsda_batch</span>,</span>
<span>                     SVA <span class="op">=</span> <span class="va">F1_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># auc (splsda)</span></span>
<span>  <span class="va">auc_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">auc.before_splsda</span>, </span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="va">auc.clean_splsda</span>, </span>
<span>                       `removeBatchEffect` <span class="op">=</span> <span class="va">auc.rbe_splsda</span>, </span>
<span>                       ComBat <span class="op">=</span> <span class="va">auc.combat_splsda</span>, </span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="va">auc.plsda_batch_splsda</span>, </span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="va">auc.splsda_batch_splsda</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># print(i)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="figures-2">Figures<a class="anchor" aria-label="anchor" href="#figures-2"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-18-1.png" alt="Figure 7: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%"><p class="caption">
Figure 7: Simulation studies (three batch groups): comparison of
explained variance before and after batch effect correction for the
balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co">## boxplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Treatment only'</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Batch only'</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'Treatment &amp; batch'</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p_total</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'No effect'</span></span>
<span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gclass</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment &amp; batch'</span>, </span>
<span>                                    <span class="st">'Treatment only'</span>, </span>
<span>                                    <span class="st">'Batch only'</span>, </span>
<span>                                    <span class="st">'No effect'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">before.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clean.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, </span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                              type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                   each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rbe.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                 each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">combat.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.plsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.plsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">splsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.splsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.splsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.ggp</span>, <span class="va">clean.r2.df.ggp</span>,</span>
<span>                       <span class="va">rbe.r2.df.ggp</span>, <span class="va">combat.r2.df.ggp</span>,</span>
<span>                       <span class="va">plsda_batch.r2.df.ggp</span>, <span class="va">splsda_batch.r2.df.ggp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                               <span class="st">'Ground-truth data'</span>, </span>
<span>                               <span class="st">'removeBatchEffect'</span>, </span>
<span>                               <span class="st">'ComBat'</span>,</span>
<span>                               <span class="st">'PLSDA-batch'</span>, </span>
<span>                               <span class="st">'sPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-19-1.png" alt="Figure 8: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%"><p class="caption">
Figure 8: Simulation studies (three batch groups): R2 values for each
microbial variable before and after batch effect correction for the
balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co">## barplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">before.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rbe.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combat.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.plsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.plsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">splsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.splsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.splsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.bp</span>, <span class="va">clean.r2.df.bp</span>,</span>
<span>                      <span class="va">rbe.r2.df.bp</span>, <span class="va">combat.r2.df.bp</span>,</span>
<span>                      <span class="va">plsda_batch.r2.df.bp</span>, <span class="va">splsda_batch.r2.df.bp</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                              <span class="st">'Ground-truth data'</span>, </span>
<span>                              <span class="st">'removeBatchEffect'</span>, </span>
<span>                              <span class="st">'ComBat'</span>,</span>
<span>                              <span class="st">'PLSDA-batch'</span>, </span>
<span>                              <span class="st">'sPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-20-1.png" alt="Figure 9: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%"><p class="caption">
Figure 9: Simulation studies (three batch groups): the sum of R2 values
for each microbial variable before and after batch effect correction for
the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">auc_splsda</span><span class="op">)</span>, sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 9: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 9: Simulation studies (three batch groups): summary of
accuracy measurements before and after batch effect correction for the
balanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="11%">
<col width="12%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.986</td>
<td align="left">0.954</td>
<td align="left">0.949</td>
<td align="left">0.940</td>
<td align="left">0.957</td>
<td align="left">0.856</td>
<td align="left">0.964</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.667</td>
<td align="left">0.891</td>
<td align="left">0.902</td>
<td align="left">0.903</td>
<td align="left">0.896</td>
<td align="left">0.884</td>
<td align="left">0.934</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.795</td>
<td align="left">0.920</td>
<td align="left">0.923</td>
<td align="left">0.919</td>
<td align="left">0.924</td>
<td align="left">0.867</td>
<td align="left">0.948</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.940</td>
<td align="left">0.959</td>
<td align="left">0.964</td>
<td align="left">0.964</td>
<td align="left">0.964</td>
<td align="left">0.949</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">auc_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 10: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 10: Simulation studies (three batch groups): summary of
accuracy measurements before and after batch effect correction for the
balanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="11%">
<col width="12%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.03</td>
<td align="left">0.07</td>
<td align="left">0.07</td>
<td align="left">0.08</td>
<td align="left">0.06</td>
<td align="left">0.08</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.02</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.04</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.01</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="unbalanced-batch-times-treatment-design-1">Unbalanced batch <span class="math inline">\(\times\)</span>
treatment design<a class="anchor" aria-label="anchor" href="#unbalanced-batch-times-treatment-design-1"></a>
</h3>
<p>The unbalanced design included 2, 10 and 2 samples from batch1,
batch2 and batch3 respectively in trt1, 10, 2 and 10 samples from
batch1, batch2 and batch3 in trt2.</p>
<p><strong>Table 11: Unbalanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation
study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">2</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">Batch3</td>
<td align="center">2</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">36</span></span>
<span><span class="va">p_total</span> <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">=</span> <span class="fl">100</span> </span>
<span><span class="va">p_bat_relevant</span> <span class="op">=</span> <span class="fl">200</span> </span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.wplsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.swplsdab</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                                            intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                            residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.swplsdab</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">r2.trt.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                       ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.swplsdab</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">r2.batch.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                           ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># auc (splsda)</span></span>
<span><span class="va">auc_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">data.cor.res</span> <span class="op">=</span> <span class="fu"><a href="../reference/corStruct.html">corStruct</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">300</span>, zero_prob <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span> <span class="va">nitr</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_mnegbinom.html">simData_mnegbinom</a></span><span class="op">(</span>batch.group <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                                  mean.batch <span class="op">=</span> <span class="fl">7</span>, </span>
<span>                                  sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                  mean.trt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                                  sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                  mean.bg <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  sd.bg <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                  N <span class="op">=</span> <span class="fl">36</span>, </span>
<span>                                  p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                  p_trt_relevant <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                  p_bat_relevant <span class="op">=</span> <span class="fl">200</span>, </span>
<span>                                  percentage_overlap_samples <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, </span>
<span>                                  percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                                  data.cor <span class="op">=</span> <span class="va">data.cor.res</span><span class="op">$</span><span class="va">data.cor</span>, </span>
<span>                                  disp <span class="op">=</span> <span class="fl">10</span>, prob_zero <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                                  seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  <span class="va">raw_count</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">raw_count_clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  </span>
<span>  <span class="co">## log transformation</span></span>
<span>  <span class="va">data_log</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">data_log_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">raw_count_clean</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  </span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Original ###</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">data_log</span></span>
<span>  </span>
<span>  <span class="co">### Clean data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">data_log_clean</span></span>
<span>  </span>
<span>  <span class="co">#####</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span> <span class="op">=</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'sample'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'otu'</span>, <span class="fl">1</span><span class="op">:</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.before_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">true.response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">true.response</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">before.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.before_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">before.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.before_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.before_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">clean.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.clean_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">clean.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.clean_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.clean_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rbe.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.rbe_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">rbe.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.rbe_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.rbe_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">combat.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.combat_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, <span class="va">combat.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.combat_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.combat_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### wPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.wplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                        balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.wplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.wplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.wplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.wplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.wplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.wplsda_batch</span><span class="op">)</span>, </span>
<span>                                      coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.wplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.wplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.wplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.wplsda_batch</span><span class="op">*</span><span class="va">recall_limma.wplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.wplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.wplsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.wplsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.wplsda_batch</span></span>
<span>  <span class="va">r2.batch.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.wplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.wplsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.wplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">wplsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.wplsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.wplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">wplsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.wplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.wplsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.swplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                         Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                         Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                         ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                         keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                         ncomp.bat <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                         balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.swplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.swplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.swplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                              data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.swplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.swplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.swplsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                       number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.swplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.swplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.swplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.swplsda_batch</span><span class="op">*</span><span class="va">recall_limma.swplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.swplsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.swplsda_batch</span>, </span>
<span>                                   <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.swplsda_batch</span></span>
<span>  <span class="va">r2.batch.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.swplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.swplsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.swplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">swplsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.swplsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.swplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                  <span class="va">swplsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.swplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.swplsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span><span class="op">)</span>, </span>
<span>                                     coef <span class="op">=</span> <span class="fl">2</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.plsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.plsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.plsda_batch</span><span class="op">*</span><span class="va">recall_limma.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.plsda_batch</span>, </span>
<span>                               <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.plsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.plsda_batch</span></span>
<span>  <span class="va">r2.batch.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.plsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.plsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.plsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">plsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.plsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                <span class="va">plsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.plsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                        Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span><span class="op">)</span>, coef <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.splsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.splsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span><span class="va">true.trt</span><span class="op">]</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.splsda_batch</span><span class="op">*</span><span class="va">recall_limma.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.splsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.splsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.splsda_batch</span></span>
<span>  <span class="va">r2.batch.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.splsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># auc (sPLSDA)</span></span>
<span>  <span class="va">fit.splsda_batch_plsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.splsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">splsda_batch.predictor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">fit.splsda_batch_plsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">roc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">true.response</span>, </span>
<span>                                 <span class="va">splsda_batch.predictor</span>, auc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">auc.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="va">roc.splsda_batch_splsda</span><span class="op">$</span><span class="va">auc</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### SVA ###</span></span>
<span>  <span class="va">X.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/num.sv.html" class="external-link">num.sv</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, mod <span class="op">=</span> <span class="va">X.mod</span>, method <span class="op">=</span> <span class="st">'leek'</span><span class="op">)</span></span>
<span>  <span class="va">X.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/sva.html" class="external-link">sva</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod</span>, <span class="va">X.mod0</span>, n.sv <span class="op">=</span> <span class="va">X.sva.n</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X.mod.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.mod0.batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X.mod0</span>, <span class="va">X.sva</span><span class="op">$</span><span class="va">sv</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sva/man/f.pvalue.html" class="external-link">f.pvalue</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="va">X.mod.batch</span>, <span class="va">X.mod0.batch</span><span class="op">)</span></span>
<span>  <span class="va">X.sva.p.adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">X.sva.p</span>, method <span class="op">=</span> <span class="st">'fdr'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">otu.sig.sva</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X.sva.p.adj</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.sva</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.sva</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.sva</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.sva</span><span class="op">*</span><span class="va">recall_limma.sva</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">+</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.sva</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.sva</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `wPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.wplsda_batch</span>,</span>
<span>                            `swPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.swplsda_batch</span>,</span>
<span>                            SVA <span class="op">=</span> <span class="va">precision_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `wPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.wplsda_batch</span>,</span>
<span>                         `swPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.swplsda_batch</span>,</span>
<span>                         SVA <span class="op">=</span> <span class="va">recall_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `wPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.wplsda_batch</span>,</span>
<span>                     `swPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.swplsda_batch</span>,</span>
<span>                     SVA <span class="op">=</span> <span class="va">F1_limma.sva</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># auc (splsda)</span></span>
<span>  <span class="va">auc_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">auc.before_splsda</span>, </span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="va">auc.clean_splsda</span>, </span>
<span>                       `removeBatchEffect` <span class="op">=</span> <span class="va">auc.rbe_splsda</span>, </span>
<span>                       ComBat <span class="op">=</span> <span class="va">auc.combat_splsda</span>, </span>
<span>                       `wPLSDA-batch` <span class="op">=</span> <span class="va">auc.wplsda_batch_splsda</span>, </span>
<span>                       `swPLSDA-batch` <span class="op">=</span> <span class="va">auc.swplsda_batch_splsda</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#  print(i)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="figures-3">Figures<a class="anchor" aria-label="anchor" href="#figures-3"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `wPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.wplsdab</span><span class="op">)</span>,</span>
<span>                       `swPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.swplsdab</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-25-1.png" alt="Figure 10: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="70%"><p class="caption">
Figure 10: Simulation studies (three batch groups): comparison of
explained variance before and after batch effect correction for the
unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co">## boxplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Treatment only'</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'Batch only'</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'Treatment &amp; batch'</span></span>
<span><span class="va">gclass</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p_total</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">'No effect'</span></span>
<span></span>
<span><span class="va">gclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gclass</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment &amp; batch'</span>, </span>
<span>                                    <span class="st">'Treatment only'</span>, </span>
<span>                                    <span class="st">'Batch only'</span>, </span>
<span>                                    <span class="st">'No effect'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">before.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clean.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, </span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                              type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                   each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rbe.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                 each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">combat.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                                    each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">wplsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.wplsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.wplsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, </span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">swplsda_batch.r2.df.ggp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.swplsdab</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.swplsdab</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>,</span>
<span>                                  each <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">gclass</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.ggp</span>, <span class="va">clean.r2.df.ggp</span>,</span>
<span>                       <span class="va">rbe.r2.df.ggp</span>, <span class="va">combat.r2.df.ggp</span>,</span>
<span>                       <span class="va">wplsda_batch.r2.df.ggp</span>, <span class="va">swplsda_batch.r2.df.ggp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                               <span class="st">'Ground-truth data'</span>, </span>
<span>                               <span class="st">'removeBatchEffect'</span>, </span>
<span>                               <span class="st">'ComBat'</span>,</span>
<span>                               <span class="st">'wPLSDA-batch'</span>, </span>
<span>                               <span class="st">'swPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.ggp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.80</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-26-1.png" alt="Figure 11: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%"><p class="caption">
Figure 11: Simulation studies (three batch groups): R2 values for each
microbial variable before and after batch effect correction for the
unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co">## barplot</span></span>
<span><span class="co"># class</span></span>
<span><span class="va">before.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rbe.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combat.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wplsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.wplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.wplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">swplsda_batch.r2.df.bp</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>r2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.swplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.swplsdab</span><span class="op">)</span>, <span class="va">gclass</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span>, </span>
<span>             type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>,<span class="st">'Batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gclass</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">before.r2.df.bp</span>, <span class="va">clean.r2.df.bp</span>,</span>
<span>                      <span class="va">rbe.r2.df.bp</span>, <span class="va">combat.r2.df.bp</span>,</span>
<span>                      <span class="va">wplsda_batch.r2.df.bp</span>, <span class="va">swplsda_batch.r2.df.bp</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, </span>
<span>                              <span class="st">'Ground-truth data'</span>, </span>
<span>                              <span class="st">'removeBatchEffect'</span>, </span>
<span>                              <span class="st">'ComBat'</span>,</span>
<span>                              <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span><span class="op">$</span><span class="va">methods</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all.r2.df.bp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">r2</span>, fill <span class="op">=</span> <span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">methods</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dark gray'</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/colors.html" class="external-link">color.mixo</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_negative_binomial_files/figure-html/unnamed-chunk-27-1.png" alt="Figure 12: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%"><p class="caption">
Figure 12: Simulation studies (three batch groups): the sum of R2 values
for each microbial variable before and after batch effect correction for
the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">auc_splsda</span><span class="op">)</span>, sva <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 12: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 12: Simulation studies (three batch groups): summary of
accuracy measurements before and after batch effect correction for the
unbalanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="12%">
<col width="13%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.637</td>
<td align="left">0.972</td>
<td align="left">0.862</td>
<td align="left">0.834</td>
<td align="left">0.915</td>
<td align="left">0.863</td>
<td align="left">0.648</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.811</td>
<td align="left">0.884</td>
<td align="left">0.897</td>
<td align="left">0.904</td>
<td align="left">0.855</td>
<td align="left">0.844</td>
<td align="left">0.872</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.713</td>
<td align="left">0.925</td>
<td align="left">0.874</td>
<td align="left">0.863</td>
<td align="left">0.882</td>
<td align="left">0.850</td>
<td align="left">0.725</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.826</td>
<td align="left">0.963</td>
<td align="left">0.954</td>
<td align="left">0.955</td>
<td align="left">0.948</td>
<td align="left">0.923</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">auc_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'AUC'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span>, <span class="st">'SVA'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 13: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 13: Simulation studies (three batch groups): summary of
accuracy measurements before and after batch effect correction for the
unbalanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%">
<col width="17%">
<col width="17%">
<col width="17%">
<col width="6%">
<col width="12%">
<col width="13%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.12</td>
<td align="left">0.12</td>
<td align="left">0.08</td>
<td align="left">0.10</td>
<td align="left">0.08</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.16</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.07</td>
<td align="left">0.07</td>
<td align="left">0.04</td>
<td align="left">0.06</td>
<td align="left">0.11</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-hawinkel2019broken" class="csl-entry">
Hawinkel, Stijn, Federico Mattiello, Luc Bijnens, and Olivier Thas.
2019. <span>“A Broken Promise: Microbiome Differential Abundance Methods
Do Not Control the False Discovery Rate.”</span> <em>Briefings in
Bioinformatics</em> 20 (1): 210–21.
</div>
<div id="ref-mcgregor2020mdine" class="csl-entry">
McGregor, Kevin, Aurélie Labbe, and Celia MT Greenwood. 2020.
<span>“MDiNE: A Model to Estimate Differential Co-Occurrence Networks in
Microbiome Studies.”</span> <em>Bioinformatics</em> 36 (6): 1840–47.
</div>
<div id="ref-mcmurdie2014waste" class="csl-entry">
McMurdie, Paul J, and Susan Holmes. 2014. <span>“Waste Not, Want Not:
Why Rarefying Microbiome Data Is Inadmissible.”</span> <em>PLoS
Computational Biology</em> 10 (4): e1003531.
</div>
<div id="ref-quinn2018understanding" class="csl-entry">
Quinn, Thomas P, Ionas Erb, Mark F Richardson, and Tamsyn M Crowley.
2018. <span>“Understanding Sequencing Data as Compositions: An Outlook
and Review.”</span> <em>Bioinformatics</em> 34 (16): 2870–78.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yiwen Wang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
