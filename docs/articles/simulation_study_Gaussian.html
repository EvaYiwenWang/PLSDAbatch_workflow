<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batch Effects Management in Simulation Studies (Gaussian Distribution) • PLSDAbatch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Batch Effects Management in Simulation Studies (Gaussian Distribution)">
<meta property="og:description" content="PLSDAbatch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PLSDAbatch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/brief_vignette.html">PLSDA-batch Vignette</a>
    </li>
    <li>
      <a href="../articles/case_studies.html">Batch Effects Management in Case Studies</a>
    </li>
    <li>
      <a href="../articles/simulation_study_Gaussian.html">Batch Effects Management in Simulation Studies (Gaussian Distribution)</a>
    </li>
    <li>
      <a href="../articles/simulation_study_negative_binomial.html">Batch Effects Management in Simulation Studies (Negative Binomial Distribution)</a>
    </li>
    <li>
      <a href="../articles/supp_case_studies.html">Supplementary Materials for Batch Effects Management in Case Studies</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Batch Effects Management in Simulation Studies
(Gaussian Distribution)</h1>
                        <h4 data-toc-skip class="author">Yiwen (Eva)
Wang</h4>
                        <h4 data-toc-skip class="author">Agricultural
Genomics Institute at Shenzhen, Chinese Academy of Agricultural
Sciences, Shenzhen, China</h4>
                        <h4 data-toc-skip class="author"><a href="mailto:wangyiwen@caas.cn" class="email">wangyiwen@caas.cn</a></h4>
            
            <h4 data-toc-skip class="date">09 November, 2022</h4>
      
      
      <div class="hidden name"><code>simulation_study_Gaussian.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>We adapted the simulation strategy that is component-based and
multivariate from <span class="citation">(<a href="#ref-singh2019diablo" role="doc-biblioref">Singh et al. 2019</a>)</span>. We assumed the input
data after filtering follow a lognormal distribution inspired from <span class="citation">(<a href="#ref-weiss2017normalization" role="doc-biblioref">Weiss et al. 2017</a>)</span>, thus after Centered
Log Ratio (CLR) transformed follow a Gaussian distribution. Thus, we
simulated components from a Gaussian distribution across all samples.
The data matrix was generated based on the simulated components and
corresponding loading vectors for each variable. Each simulated dataset
included 300 variables and 40 samples grouped according to two
treatments (trt1 and trt2) and two batches (batch1 and batch2).
Different parameters including amount of batch and treatment variability
among samples, number of variables with batch and/or treatment effects,
balanced and unbalanced batch <span class="math inline">\(\times\)</span> treatment designs were considered
and summarised in the table below.</p>
<p><strong>Table 1: Summary of simulation scenarios (Gaussian
distribution).</strong> For a given choice of parameters reported in
this table, each simulation was repeated 50 times. <span class="math inline">\(M^{(trt)}, M^{(batch)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span> represent the
number of variables with treatment, batch, or both effects respectively.
<strong>Simulation 6</strong> includes parameters reflective of real
data.</p>
<table class="table">
<colgroup>
<col width="12%">
<col width="10%">
<col width="12%">
<col width="11%">
<col width="14%">
<col width="11%">
<col width="11%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th align="center">Parameters</th>
<th align="center"><span class="math inline">\(\mu_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma'_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\mu_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma'_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt \ \&amp; \
batch)}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Simulation 1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">{1,4,8}</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simulation 2</td>
<td align="center">{3,5,7}</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simulation 3</td>
<td align="center">3</td>
<td align="center">{1,2,4}</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simulation 4</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">{30,60,100,150}</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simulation 5</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">{30,60,100,150}</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center"><strong>Simulation 6</strong></td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">{0,18,30,42,60}</td>
</tr>
</tbody>
</table>
<p>We first generated two base components <span class="math inline">\(t^{(trt)}\)</span> and <span class="math inline">\(t^{(batch)}\)</span> to represent the underlying
treatment and batch variation across samples in the datasets. The
samples with trt1 or trt2 in the component <span class="math inline">\(t^{(trt)}\)</span> were generated from <span class="math inline">\(N(-\mu_{(trt)}, \sigma^{'2}_{(trt)})\)</span>
and <span class="math inline">\(N(\mu_{(trt)},
\sigma^{'2}_{(trt)})\)</span> respectively, where <span class="math inline">\(\sigma^{'2}_{(trt)}\)</span> refers to the
variability of treatment effect among samples, and similarly for the
batch component. We then sampled the corresponding loading vectors <span class="math inline">\(\alpha^{(trt)}\)</span> and <span class="math inline">\(\alpha^{(batch)}\)</span> from a uniform
distribution <span class="math inline">\([-0.3, -0.2]\cup
[0.2,0.3]\)</span> respectively and scaled them as an unit vector. We
subsequently constructed the treatment relevant matrix as <span class="math inline">\(X^{(trt)} =
t^{(trt)}(\alpha^{(trt)})^{\top}\)</span> and similarly for the batch
relevant matrix.</p>
<p>We also generated background noise <span class="math inline">\(E\)</span> (<span class="math inline">\(E \in
\mathbb{R}^{40 \times 300}\)</span>), where each element was randomly
sampled from <span class="math inline">\(N(0, 0.2^{2})\)</span>. The
final simulated dataset <span class="math inline">\(X_{result}\)</span>
was constructed based on the treatment, batch relevant matrices and
background noise. Starting with <span class="math inline">\(X_{result} =
E\)</span>, we then added different types of variables, such that:</p>
<p><span class="math display">\[X_{result}[ ,\mbox{variables}^{(trt)}] =
E[ ,\mbox{variables}^{(trt)}] + X^{(trt)}\]</span> <span class="math display">\[X_{result}[ ,\mbox{variables}^{(batch)}] =
X_{result}[ ,\mbox{variables}^{(batch)}] + X^{(batch)},\]</span> </p>
<p>where variables with treatment or batch effects were randomly indexed
in the data.</p>
<p>In addition to the data with batch effects, we also simulated a
ground-truth dataset that only included the background noise and
treatment but no batch effect to evaluate batch effect corrected
datasets.</p>
<p>In these simulation scenarios, for PLSDA-batch we set <span class="math inline">\(C-1\)</span> (or <span class="math inline">\(B-1\)</span>) components associated with treatment
(or batch) effects (where <span class="math inline">\(C\)</span> and
<span class="math inline">\(B\)</span> represent the total number of
treatment and batch groups respectively) as <span class="math inline">\(C-1\)</span> (<span class="math inline">\(B-1\)</span>) components are likely to explain
100% variance in <span class="math inline">\(Y\)</span>. The number of
variables with a true treatment effect (<span class="math inline">\(M^{(trt)}\)</span>) is set as the optimal number
to select on each treatment component in sPLSDA-batch.</p>
<p>To save space, here we only describe one scenario that we believe is
a representative of real data (<span class="math inline">\(M^{(trt \
\&amp; \ batch)} = 30\)</span>, simulation 6 in Table 1).</p>
</div>
<div class="section level2">
<h2 id="packages-installation-and-loading">Packages installation and loading<a class="anchor" aria-label="anchor" href="#packages-installation-and-loading"></a>
</h2>
<p>Install then load the following packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PLSDAbatch</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.mixOmics.org" class="external-link">mixOmics</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sva</span><span class="op">)</span> <span class="co">#ComBat</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioinf.wehi.edu.au/limma" class="external-link">limma</a></span><span class="op">)</span> <span class="co">#removeBatchEffect</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vegandevs/vegan" class="external-link">vegan</a></span><span class="op">)</span> <span class="co">#RDA</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulations">Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h2>
<div class="section level3">
<h3 id="balanced-batch-times-treatment-design">Balanced batch <span class="math inline">\(\times\)</span> treatment
design<a class="anchor" aria-label="anchor" href="#balanced-batch-times-treatment-design"></a>
</h3>
<p>The balanced batch <span class="math inline">\(\times\)</span>
treatment experimental design included 10 samples from two batches
respectively in each treatment group (see Table 2)</p>
<p><strong>Table 2: Balanced batch <span class="math inline">\(\times\)</span> treatment design</strong> in the
simulation study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">p_total</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="va">p_bat_relevant</span> <span class="op">&lt;-</span> <span class="fl">150</span></span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                                            intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                            residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                       ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.plsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                           ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span><span class="va">precision_splsda</span> <span class="op">&lt;-</span> <span class="va">recall_splsda</span> <span class="op">&lt;-</span> <span class="va">F1_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             plsda_batch <span class="op">=</span> <span class="cn">NA</span>, splsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nitr</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_Gaussian.html">simData_Gaussian</a></span><span class="op">(</span>mean.batch <span class="op">=</span> <span class="fl">7</span>, sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                 mean.trt <span class="op">=</span> <span class="fl">3</span>, sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                 N <span class="op">=</span> <span class="fl">40</span>, p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                 p_trt_relevant <span class="op">=</span> <span class="fl">60</span>, </span>
<span>                                 p_bat_relevant <span class="op">=</span> <span class="fl">150</span>, </span>
<span>                                 percentage_overlap_samples <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                                 percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.before</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> </span>
<span>                                                  <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                              keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.before_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.before</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.before</span><span class="op">*</span><span class="va">recall_splsda.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.before</span> <span class="op">+</span> <span class="va">recall_splsda.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                     design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.clean</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> </span>
<span>                                                <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                             keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.clean_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.clean</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.clean</span><span class="op">*</span><span class="va">recall_splsda.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.clean</span> <span class="op">+</span> <span class="va">recall_splsda.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.rbe</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                           keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.rbe_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.rbe</span><span class="op">*</span><span class="va">recall_splsda.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.rbe</span> <span class="op">+</span> <span class="va">recall_splsda.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.combat</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> </span>
<span>                                                  <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                              keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.combat_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.combat</span><span class="op">*</span><span class="va">recall_splsda.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.combat</span> <span class="op">+</span> <span class="va">recall_splsda.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.plsda_batch</span>, </span>
<span>                               <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.plsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.plsda_batch</span></span>
<span>  <span class="va">r2.batch.plsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.plsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                           design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.plsda_batch</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.plsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.plsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.plsda_batch</span><span class="op">*</span><span class="va">recall_limma.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.plsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.plsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                   keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.plsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.plsda_batch_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.plsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.plsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.plsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.plsda_batch</span><span class="op">*</span><span class="va">recall_splsda.plsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.plsda_batch</span> <span class="op">+</span> <span class="va">recall_splsda.plsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.plsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.plsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                                        Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.splsda_batch</span>, </span>
<span>                                <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.splsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.splsda_batch</span></span>
<span>  <span class="va">r2.batch.splsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.splsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.splsda_batch</span><span class="op">)</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.splsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.splsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.splsda_batch</span><span class="op">*</span><span class="va">recall_limma.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.splsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.splsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                    keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.splsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.splsda_batch_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.splsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.splsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.splsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.splsda_batch</span><span class="op">*</span><span class="va">recall_splsda.splsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.splsda_batch</span> <span class="op">+</span> <span class="va">recall_splsda.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.splsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.splsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `PLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.plsda_batch</span>,</span>
<span>                            `sPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `PLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.plsda_batch</span>,</span>
<span>                         `sPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `PLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.plsda_batch</span>,</span>
<span>                     `sPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">precision_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_splsda.before</span>, </span>
<span>                             `Ground-truth data` <span class="op">=</span> <span class="va">precision_splsda.clean</span>,</span>
<span>                             `removeBatchEffect` <span class="op">=</span> <span class="va">precision_splsda.rbe</span>,</span>
<span>                             ComBat <span class="op">=</span> <span class="va">precision_splsda.combat</span>,</span>
<span>                             `PLSDA-batch` <span class="op">=</span> <span class="va">precision_splsda.plsda_batch</span>,</span>
<span>                             `sPLSDA-batch` <span class="op">=</span> <span class="va">precision_splsda.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_splsda.before</span>, </span>
<span>                          `Ground-truth data` <span class="op">=</span> <span class="va">recall_splsda.clean</span>,</span>
<span>                          `removeBatchEffect` <span class="op">=</span> <span class="va">recall_splsda.rbe</span>,</span>
<span>                          ComBat <span class="op">=</span> <span class="va">recall_splsda.combat</span>,</span>
<span>                          `PLSDA-batch` <span class="op">=</span> <span class="va">recall_splsda.plsda_batch</span>,</span>
<span>                          `sPLSDA-batch` <span class="op">=</span> <span class="va">recall_splsda.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_splsda.before</span>, </span>
<span>                      `Ground-truth data` <span class="op">=</span> <span class="va">F1_splsda.clean</span>,</span>
<span>                      `removeBatchEffect` <span class="op">=</span> <span class="va">F1_splsda.rbe</span>,</span>
<span>                      ComBat <span class="op">=</span> <span class="va">F1_splsda.combat</span>,</span>
<span>                      `PLSDA-batch` <span class="op">=</span> <span class="va">F1_splsda.plsda_batch</span>,</span>
<span>                      `sPLSDA-batch` <span class="op">=</span> <span class="va">F1_splsda.splsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>As the simulation step takes time, so we use the saved data into
visulisation.</p>
</div>
<div class="section level3">
<h3 id="figures">Figures<a class="anchor" aria-label="anchor" href="#figures"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_Gaussian_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%"><p class="caption">
Figure 1: Simulation studies (Gaussian distribution): comparison of
explained variance before and after batch effect correction for the
balanced batch × treatment design.
</p>
</div>
<p>We first considered the proportion of variance explained by treatment
and batch effects before and after batch effect correction across all
variables using pRDA. Efficient batch effect correction methods should
generate data with a smaller proportion of batch associated variance and
larger proportion of treatment variance compared to the original data.
The figure shows that there was no intersection shared between treatment
and batch variation with a balanced batch <span class="math inline">\(\times\)</span> treatment design. All methods
successfully removed batch variation, but PLSDA-batch and sPLSDA-batch
preserved more proportion of treatment variance than removeBatchEffect
and ComBat. In addition, the data corrected by sPLSDA-batch included
almost as much proportion of treatment variance as the ground-truth
data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co"># color</span></span>
<span><span class="va">gcolor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gcolor</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">gcolor</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xlabs</span> <span class="op">=</span> <span class="st">'R2(variable, treatment)'</span></span>
<span><span class="va">ylabs</span> <span class="op">=</span> <span class="st">'R2(variable, batch)'</span></span>
<span><span class="va">edgex</span> <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="va">edgey</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="co"># scatterplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Before correction'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Ground-truth data'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'removeBatchEffect'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'ComBat'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.plsdab</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.plsdab</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'PLSDA-batch'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.splsdab</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.splsdab</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'sPLSDA-batch'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_Gaussian_files/figure-html/unnamed-chunk-5-1.png" alt="Figure 2: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%"><p class="caption">
Figure 2: Simulation studies (Gaussian distribution): R2 values for each
microbial variable before and after batch effect correction for the
balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also estimated the proportion of variance explained by treatment
and batch effects for each variable respectively using the <span class="math inline">\(R^2\)</span> value. The variables assigned with
both treatment and batch effects in the corrected data from
removeBatchEffect and ComBat presented less proportion of treatment
associated variance than in the ground truth data. This result agrees
with the pRDA evaluation that these two methods do not preserve enough
treatment variation. After PLSDA-batch correction, variables simulated
with only batch effects displayed some amount of treatment variation,
but only in the case where the batch effect variability among samples
was high. sPLSDA-batch outperformed all methods, with results similar to
the ground-truth data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_splsda</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'Multivariate selection'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 3: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 3: Simulation studies (Gaussian distribution): summary of
accuracy measures before and after batch correction for the balanced
batch × treatment design (mean).</caption>
<colgroup>
<col width="21%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="6%">
<col width="11%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.98</td>
<td align="left">0.95</td>
<td align="left">0.94</td>
<td align="left">0.93</td>
<td align="left">0.56</td>
<td align="left">0.86</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.74</td>
<td align="left">1.00</td>
<td align="left">0.87</td>
<td align="left">0.88</td>
<td align="left">1.00</td>
<td align="left">1.00</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.84</td>
<td align="left">0.98</td>
<td align="left">0.89</td>
<td align="left">0.89</td>
<td align="left">0.68</td>
<td align="left">0.92</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.89</td>
<td align="left">1.00</td>
<td align="left">0.92</td>
<td align="left">0.92</td>
<td align="left">0.92</td>
<td align="left">1.00</td>
</tr>
</tbody>
</table>
<p>When considering the measures of accuracy with univariate one-way
ANOVA, we observed that the corrected data from PLSDA-batch and
sPLSDA-batch led to higher recall and lower precision than the data from
removeBatchEffect and ComBat. However, the precision of sPLSDA-batch was
competitive to removeBatchEffect and ComBat. Moreover, sPLSDA-batch
achieved higher F1 scores and multivariate selection scores than
removeBatchEffect and ComBat.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'Multivariate selection'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'PLSDA-batch'</span>, <span class="st">'sPLSDA-batch'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 4: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 4: Simulation studies (Gaussian distribution): summary of
accuracy measures before and after batch correction for the balanced
batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="21%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="6%">
<col width="11%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.021</td>
<td align="left">0.031</td>
<td align="left">0.151</td>
<td align="left">0.160</td>
<td align="left">0.252</td>
<td align="left">0.110</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.095</td>
<td align="left">0.000</td>
<td align="left">0.098</td>
<td align="left">0.098</td>
<td align="left">0.021</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.065</td>
<td align="left">0.016</td>
<td align="left">0.118</td>
<td align="left">0.124</td>
<td align="left">0.200</td>
<td align="left">0.068</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.061</td>
<td align="left">0.000</td>
<td align="left">0.068</td>
<td align="left">0.069</td>
<td align="left">0.123</td>
<td align="left">0.005</td>
</tr>
</tbody>
</table>
<p>The standard deviations of the multivariate selection scores were all
smaller than the univariate selection scores for the different corrected
data, indicating a better stability of the variables selected by
multivariate sPLSDA compared to the one-way ANOVA univariate
selection.</p>
</div>
<div class="section level3">
<h3 id="unbalanced-batch-times-treatment-design">Unbalanced batch <span class="math inline">\(\times\)</span>
treatment design<a class="anchor" aria-label="anchor" href="#unbalanced-batch-times-treatment-design"></a>
</h3>
<p>The unbalanced design had 4 and 16 samples from batch1 and batch2
respectively in trt1, 16 and 4 samples from batch1 and batch2 in trt2
(see the table below).</p>
<p><strong>Table 5: Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</strong> in the
simulation study</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">4</td>
<td align="center">16</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">16</td>
<td align="center">4</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nitr</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">p_total</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">p_trt_relevant</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="va">p_bat_relevant</span> <span class="op">&lt;-</span> <span class="fl">150</span></span>
<span></span>
<span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">gvar.before</span> <span class="op">&lt;-</span> <span class="va">gvar.clean</span> <span class="op">&lt;-</span> <span class="va">gvar.rbe</span> <span class="op">&lt;-</span> <span class="va">gvar.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.wplsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.swplsdab</span> <span class="op">&lt;-</span> <span class="va">gvar.plsdab</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gvar.splsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="cn">NA</span>, batch <span class="op">=</span> <span class="cn">NA</span>,  </span>
<span>                             intersection <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                             residual <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="va">r2.trt.before</span> <span class="op">&lt;-</span> <span class="va">r2.trt.clean</span> <span class="op">&lt;-</span> <span class="va">r2.trt.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.trt.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.trt.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.trt.swplsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                         ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r2.batch.before</span> <span class="op">&lt;-</span> <span class="va">r2.batch.clean</span> <span class="op">&lt;-</span> <span class="va">r2.batch.rbe</span>  <span class="op">&lt;-</span> <span class="va">r2.batch.combat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">r2.batch.wplsdab</span> <span class="op">&lt;-</span> <span class="va">r2.batch.swplsdab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">p_total</span>, </span>
<span>                                                             ncol <span class="op">=</span> <span class="va">nitr</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span><span class="va">precision_limma</span> <span class="op">&lt;-</span> <span class="va">recall_limma</span> <span class="op">&lt;-</span> <span class="va">F1_limma</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span><span class="va">precision_splsda</span> <span class="op">&lt;-</span> <span class="va">recall_splsda</span> <span class="op">&lt;-</span> <span class="va">F1_splsda</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>before <span class="op">=</span> <span class="cn">NA</span>, clean <span class="op">=</span> <span class="cn">NA</span>, rbe <span class="op">=</span> <span class="cn">NA</span>, combat <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>             wplsda_batch <span class="op">=</span> <span class="cn">NA</span>, swplsda_batch <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nitr</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">### initial setup ###</span></span>
<span>  <span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simData_Gaussian.html">simData_Gaussian</a></span><span class="op">(</span>mean.batch <span class="op">=</span> <span class="fl">7</span>, sd.batch <span class="op">=</span> <span class="fl">8</span>, </span>
<span>                                 mean.trt <span class="op">=</span> <span class="fl">3</span>, sd.trt <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                 N <span class="op">=</span> <span class="fl">40</span>, p_total <span class="op">=</span> <span class="fl">300</span>, </span>
<span>                                 p_trt_relevant <span class="op">=</span> <span class="fl">60</span>, </span>
<span>                                 p_bat_relevant <span class="op">=</span> <span class="fl">150</span>, </span>
<span>                                 percentage_overlap_samples <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                                 percentage_overlap_variables <span class="op">=</span> <span class="fl">0.5</span>, seeds <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">data</span></span>
<span>  <span class="va">trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.trt</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">Y.bat</span></span>
<span>  <span class="va">true.trt</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.trt</span></span>
<span>  <span class="va">true.batch</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">true.batch</span></span>
<span>  </span>
<span>  <span class="va">Batch_Trt.factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Batch <span class="op">=</span> <span class="va">batch</span>, Treatment <span class="op">=</span> <span class="va">trt</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Before correction ###</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.before</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.before</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.before</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.before</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.before</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.before</span></span>
<span>  <span class="va">r2.batch.before</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.before</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>, design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.before</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.before</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.before</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.before</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.before</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.before</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.before</span><span class="op">*</span><span class="va">recall_limma.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">+</span> <span class="va">recall_limma.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.before_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, Y <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                              ncomp <span class="op">=</span> <span class="fl">1</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.before_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.before</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.before</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.before</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.before</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.before</span><span class="op">*</span><span class="va">recall_splsda.before</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.before</span> <span class="op">+</span> <span class="va">recall_splsda.before</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.before</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.before</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### Ground-truth data ###</span></span>
<span>  <span class="va">X.clean</span> <span class="op">&lt;-</span> <span class="va">simulation</span><span class="op">$</span><span class="va">cleanData</span></span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.clean</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.clean</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.clean</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.clean</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.clean</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.clean</span></span>
<span>  <span class="va">r2.batch.clean</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.clean</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.clean</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                     design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.clean</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.clean</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.clean</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.clean</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.clean</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.clean</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.clean</span><span class="op">*</span><span class="va">recall_limma.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">+</span> <span class="va">recall_limma.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.clean_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.clean</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                             keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.clean_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.clean</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.clean</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.clean</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.clean</span><span class="op">*</span><span class="va">recall_splsda.clean</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.clean</span> <span class="op">+</span> <span class="va">recall_splsda.clean</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.clean</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.clean</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### removeBatchEffect corrected data ###</span></span>
<span>  <span class="va">X.rbe</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/removeBatchEffect.html" class="external-link">removeBatchEffect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                              design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.rbe</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.rbe</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.rbe</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.rbe</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.rbe</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.rbe</span></span>
<span>  <span class="va">r2.batch.rbe</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.rbe</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.rbe</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.rbe</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.rbe</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.rbe</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.rbe</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.rbe</span><span class="op">*</span><span class="va">recall_limma.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">+</span> <span class="va">recall_limma.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.rbe_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.rbe</span>, Y <span class="op">=</span> <span class="va">trt</span>, </span>
<span>                           ncomp <span class="op">=</span> <span class="fl">1</span>, keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.rbe_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.rbe</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.rbe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.rbe</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.rbe</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.rbe</span><span class="op">*</span><span class="va">recall_splsda.rbe</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.rbe</span> <span class="op">+</span> <span class="va">recall_splsda.rbe</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.rbe</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.rbe</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### ComBat corrected data ###</span></span>
<span>  <span class="va">X.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sva/man/ComBat.html" class="external-link">ComBat</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, batch <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                       mod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.combat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.combat</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.combat</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.combat</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.combat</span>, <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.combat</span></span>
<span>  <span class="va">r2.batch.combat</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.combat</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.combat</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                      design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.combat</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.combat</span><span class="op">)</span>, number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.combat</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.combat</span><span class="op">)</span><span class="op">[</span><span class="va">fit.result.combat</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.combat</span><span class="op">*</span><span class="va">recall_limma.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">+</span> <span class="va">recall_limma.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.combat_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.combat</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                              keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.combat_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.combat</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.combat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.combat</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.combat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.combat</span><span class="op">*</span><span class="va">recall_splsda.combat</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.combat</span> <span class="op">+</span> <span class="va">recall_splsda.combat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.combat</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.combat</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### wPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.wplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                        balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.wplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.wplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.wplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.wplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.wplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.wplsda_batch</span>, <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.wplsda_batch</span>, </span>
<span>                                  <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.wplsda_batch</span></span>
<span>  <span class="va">r2.batch.wplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.wplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.wplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                            design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.wplsda_batch</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.wplsda_batch</span><span class="op">)</span>, </span>
<span>                                      number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.wplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.wplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.wplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.wplsda_batch</span><span class="op">*</span><span class="va">recall_limma.wplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.wplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.wplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.wplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                    keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.wplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.wplsda_batch_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.wplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.wplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.wplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.wplsda_batch</span><span class="op">*</span><span class="va">recall_splsda.wplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.wplsda_batch</span> <span class="op">+</span> <span class="va">recall_splsda.wplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.wplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.wplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### swPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.swplsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                         Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                         ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                         keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                         ncomp.bat <span class="op">=</span> <span class="fl">1</span>, balance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">X.swplsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.swplsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.swplsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                              data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.swplsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.swplsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co"># individual variance (R2)</span></span>
<span>  <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">fit.res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">trt</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res1</span><span class="op">)</span></span>
<span>    <span class="va">fit.res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">[</span> ,<span class="va">c</span><span class="op">]</span> <span class="op">~</span> <span class="va">batch</span><span class="op">)</span></span>
<span>    <span class="va">fit.summary2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit.res2</span><span class="op">)</span></span>
<span>    <span class="va">indiv.trt.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.trt.swplsda_batch</span>, </span>
<span>                                 <span class="va">fit.summary1</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>    <span class="va">indiv.batch.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">indiv.batch.swplsda_batch</span>, </span>
<span>                                   <span class="va">fit.summary2</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r2.trt.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.trt.swplsda_batch</span></span>
<span>  <span class="va">r2.batch.swplsdab</span><span class="op">[</span> ,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">indiv.batch.swplsda_batch</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">fit.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/lmFit.html" class="external-link">lmFit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.swplsda_batch</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                             design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/contrasts.fit.html" class="external-link">contrasts.fit</a></span><span class="op">(</span><span class="va">fit.swplsda_batch</span>, contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit.result.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/limma/man/toptable.html" class="external-link">topTable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ebayes.html" class="external-link">eBayes</a></span><span class="op">(</span><span class="va">fit.swplsda_batch</span><span class="op">)</span>, </span>
<span>                                       number <span class="op">=</span> <span class="va">p_total</span><span class="op">)</span></span>
<span>  <span class="va">otu.sig.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fit.result.swplsda_batch</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="va">fit.result.swplsda_batch</span><span class="op">$</span><span class="va">adj.P.Val</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">precision_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.sig.swplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.sig.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_limma.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_limma.swplsda_batch</span><span class="op">*</span><span class="va">recall_limma.swplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">+</span> <span class="va">recall_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">precision_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">precision_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_limma.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_limma.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">fit.swplsda_batch_splsda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mixOmics/man/splsda.html" class="external-link">splsda</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X.swplsda_batch</span>, Y <span class="op">=</span> <span class="va">trt</span>, ncomp <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                     keepX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">otu.dcn.swplsda_batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">fit.swplsda_batch_splsda</span><span class="op">$</span><span class="va">loadings</span><span class="op">$</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precision_splsda.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">otu.dcn.swplsda_batch</span><span class="op">)</span></span>
<span>  <span class="va">recall_splsda.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">otu.dcn.swplsda_batch</span><span class="op">)</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span></span>
<span>  <span class="va">F1_splsda.swplsda_batch</span> <span class="op">&lt;-</span> </span>
<span>    <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">precision_splsda.swplsda_batch</span><span class="op">*</span><span class="va">recall_splsda.swplsda_batch</span><span class="op">)</span><span class="op">/</span></span>
<span>    <span class="op">(</span><span class="va">precision_splsda.swplsda_batch</span> <span class="op">+</span> <span class="va">recall_splsda.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## replace NA value with 0</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">F1_splsda.swplsda_batch</span> <span class="op">==</span> <span class="st">'NaN'</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">F1_splsda.swplsda_batch</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### PLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.plsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                       Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                       ncomp.trt <span class="op">=</span> <span class="fl">1</span>, ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.plsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.plsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.plsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.plsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>, </span>
<span>                            data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.plsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.plsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  <span class="co">##############################################################################</span></span>
<span>  <span class="co">### sPLSDA-batch corrected data ###</span></span>
<span>  <span class="va">X.splsda_batch.correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PLSDA_batch.html">PLSDA_batch</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                        Y.trt <span class="op">=</span> <span class="va">trt</span>, Y.bat <span class="op">=</span> <span class="va">batch</span>, </span>
<span>                                        ncomp.trt <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                        keepX.trt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true.trt</span><span class="op">)</span>, </span>
<span>                                        ncomp.bat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">X.splsda_batch</span> <span class="op">&lt;-</span> <span class="va">X.splsda_batch.correct</span><span class="op">$</span><span class="va">X.nobatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># global variance (RDA)</span></span>
<span>  <span class="va">rda.splsda_batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/vegan/man/varpart.html" class="external-link">varpart</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X.splsda_batch</span><span class="op">)</span>, <span class="op">~</span> <span class="va">Treatment</span>, <span class="op">~</span> <span class="va">Batch</span>,</span>
<span>                             data <span class="op">=</span> <span class="va">Batch_Trt.factors</span><span class="op">)</span></span>
<span>  <span class="va">gvar.splsdab</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rda.splsda_batch</span><span class="op">$</span><span class="va">part</span><span class="op">$</span><span class="va">indfract</span><span class="op">$</span><span class="va">Adj.R.squared</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># summary</span></span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span>  <span class="va">precision_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_limma.before</span>, </span>
<span>                            `Ground-truth data` <span class="op">=</span> <span class="va">precision_limma.clean</span>,</span>
<span>                            `removeBatchEffect` <span class="op">=</span> <span class="va">precision_limma.rbe</span>,</span>
<span>                            ComBat <span class="op">=</span> <span class="va">precision_limma.combat</span>,</span>
<span>                            `wPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.wplsda_batch</span>,</span>
<span>                            `swPLSDA-batch` <span class="op">=</span> <span class="va">precision_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_limma.before</span>, </span>
<span>                         `Ground-truth data` <span class="op">=</span> <span class="va">recall_limma.clean</span>,</span>
<span>                         `removeBatchEffect` <span class="op">=</span> <span class="va">recall_limma.rbe</span>,</span>
<span>                         ComBat <span class="op">=</span> <span class="va">recall_limma.combat</span>,</span>
<span>                         `wPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.wplsda_batch</span>,</span>
<span>                         `swPLSDA-batch` <span class="op">=</span> <span class="va">recall_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_limma</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_limma.before</span>, </span>
<span>                     `Ground-truth data` <span class="op">=</span> <span class="va">F1_limma.clean</span>,</span>
<span>                     `removeBatchEffect` <span class="op">=</span> <span class="va">F1_limma.rbe</span>,</span>
<span>                     ComBat <span class="op">=</span> <span class="va">F1_limma.combat</span>,</span>
<span>                     `wPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.wplsda_batch</span>,</span>
<span>                     `swPLSDA-batch` <span class="op">=</span> <span class="va">F1_limma.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span>  <span class="va">precision_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">precision_splsda.before</span>, </span>
<span>                             `Ground-truth data` <span class="op">=</span> <span class="va">precision_splsda.clean</span>,</span>
<span>                             `removeBatchEffect` <span class="op">=</span> <span class="va">precision_splsda.rbe</span>,</span>
<span>                             ComBat <span class="op">=</span> <span class="va">precision_splsda.combat</span>,</span>
<span>                             `wPLSDA-batch` <span class="op">=</span> <span class="va">precision_splsda.wplsda_batch</span>,</span>
<span>                             `swPLSDA-batch` <span class="op">=</span> <span class="va">precision_splsda.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">recall_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">recall_splsda.before</span>, </span>
<span>                          `Ground-truth data` <span class="op">=</span> <span class="va">recall_splsda.clean</span>,</span>
<span>                          `removeBatchEffect` <span class="op">=</span> <span class="va">recall_splsda.rbe</span>,</span>
<span>                          ComBat <span class="op">=</span> <span class="va">recall_splsda.combat</span>,</span>
<span>                          `wPLSDA-batch` <span class="op">=</span> <span class="va">recall_splsda.wplsda_batch</span>,</span>
<span>                          `swPLSDA-batch` <span class="op">=</span> <span class="va">recall_splsda.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">F1_splsda</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="va">F1_splsda.before</span>, </span>
<span>                      `Ground-truth data` <span class="op">=</span> <span class="va">F1_splsda.clean</span>,</span>
<span>                      `removeBatchEffect` <span class="op">=</span> <span class="va">F1_splsda.rbe</span>,</span>
<span>                      ComBat <span class="op">=</span> <span class="va">F1_splsda.combat</span>,</span>
<span>                      `wPLSDA-batch` <span class="op">=</span> <span class="va">F1_splsda.wplsda_batch</span>,</span>
<span>                      `swPLSDA-batch` <span class="op">=</span> <span class="va">F1_splsda.swplsda_batch</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="figures-1">Figures<a class="anchor" aria-label="anchor" href="#figures-1"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># global variance (RDA)</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>`Before correction` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.before</span><span class="op">)</span>,</span>
<span>                       `Ground-truth data` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.clean</span><span class="op">)</span>,</span>
<span>                       removeBatchEffect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.rbe</span><span class="op">)</span>,</span>
<span>                       ComBat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.combat</span><span class="op">)</span>,</span>
<span>                       `wPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.wplsdab</span><span class="op">)</span>,</span>
<span>                       `swPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.swplsdab</span><span class="op">)</span>,</span>
<span>                       `PLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.plsdab</span><span class="op">)</span>,</span>
<span>                       `sPLSDA-batch` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">gvar.splsdab</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop.gvar.all</span><span class="op">[</span><span class="va">prop.gvar.all</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="va">prop.gvar.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">prop.gvar.all</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">prop.gvar.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Treatment'</span>, <span class="st">'Intersection'</span>, <span class="st">'Batch'</span>, <span class="st">'Residuals'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/partVar_plot.html">partVar_plot</a></span><span class="op">(</span>prop.df <span class="op">=</span> <span class="va">prop.gvar.all</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_Gaussian_files/figure-html/unnamed-chunk-10-1.png" alt="Figure 3: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="70%"><p class="caption">
Figure 3: Simulation studies (Gaussian distribution): comparison of
explained variance before and after batch effect correction for the
unbalanced batch × treatment design.
</p>
</div>
<p>With an unbalanced batch <span class="math inline">\(\times\)</span>
treatment design, we observed that certain amount of variance was shared
(intersection) and explained by both batch and treatment effects. Such
intersectional variance should exist even in the ground-truth data with
no batch effect, as it originates from treatment variation because of
the unbalanced design. Unweighted PLSDA-batch and sPLSDA-batch failed in
such design, as their corrected data still included a large amount of
batch variation (PLSDA-batch) or not included intersectional variance
(sPLSDA-batch), while the other methods removed batch variation
successfully. The corrected data from removeBatchEffect and ComBat
included less proportion of variance explained by treatment but more
intersectional variance compared to the ground-truth data. Although
wPLSDA-batch corrected data included the largest treatment variance,
swPLSDA-batch outperformed all methods with results similar to the
ground-truth data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># individual variance (R2)</span></span>
<span><span class="co"># color</span></span>
<span><span class="va">gcolor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">16</span><span class="op">)</span>, <span class="va">p_trt_relevant</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">17</span><span class="op">)</span>, <span class="op">(</span><span class="va">p_total</span> <span class="op">-</span> <span class="va">p_trt_relevant</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gcolor</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span></span>
<span><span class="va">gcolor</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">p_total</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">true.trt</span>, <span class="va">true.batch</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xlabs</span> <span class="op">=</span> <span class="st">'R2(variable, treatment)'</span></span>
<span><span class="va">ylabs</span> <span class="op">=</span> <span class="st">'R2(variable, batch)'</span></span>
<span><span class="va">edgex</span> <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="va">edgey</span> <span class="op">=</span> <span class="fl">0.6</span></span>
<span></span>
<span><span class="co"># scatterplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.before</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.before</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Before correction'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.clean</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.clean</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Ground-truth data'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.rbe</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.rbe</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'removeBatchEffect'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.combat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.combat</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'ComBat'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.wplsdab</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.wplsdab</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'wPLSDA-batch'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.trt.swplsdab</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">r2.batch.swplsdab</span><span class="op">)</span>, col <span class="op">=</span> <span class="va">gcolor</span>, </span>
<span>     xlab <span class="op">=</span> <span class="va">xlabs</span>, ylab <span class="op">=</span> <span class="va">ylabs</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gcolor</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgex</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">edgey</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">'swPLSDA-batch'</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">'topright'</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'No effect'</span>, <span class="st">'Treatment only'</span>, </span>
<span>                              <span class="st">'Batch only'</span>, <span class="st">'Treatment &amp; batch'</span><span class="op">)</span>, </span>
<span>       col <span class="op">=</span> <span class="fu"><a href="../reference/pb_color.html">pb_color</a></span><span class="op">(</span><span class="fl">15</span><span class="op">:</span><span class="fl">18</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="simulation_study_Gaussian_files/figure-html/unnamed-chunk-11-1.png" alt="Figure 4: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%"><p class="caption">
Figure 4: Simulation studies (Gaussian distribution): R2 values for each
microbial variable before and after batch effect correction for the
unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Based on the <span class="math inline">\(R^2\)</span> values,
variables assigned with both treatment and batch effects were segregated
into two groups depending on whether their abundance increased or
decreased consistently or not according to the two effects. We observed
similar results to those obtained from the balanced design.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span><span class="co">## mean</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">recall_limma</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">F1_limma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">precision_splsda</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'Multivariate selection'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_mean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                        <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                        <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span><span class="op">)</span></span>
<span><span class="va">acc_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_mean</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_mean</span>, caption <span class="op">=</span> <span class="st">'Table 6: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (mean).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 6: Simulation studies (Gaussian distribution): summary of
accuracy measures before and after batch correction for the unbalanced
batch × treatment design (mean).</caption>
<colgroup>
<col width="20%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="6%">
<col width="11%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.52</td>
<td align="left">0.96</td>
<td align="left">0.85</td>
<td align="left">0.80</td>
<td align="left">0.52</td>
<td align="left">0.80</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.72</td>
<td align="left">1.00</td>
<td align="left">0.86</td>
<td align="left">0.86</td>
<td align="left">0.99</td>
<td align="left">1.00</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.55</td>
<td align="left">0.98</td>
<td align="left">0.84</td>
<td align="left">0.81</td>
<td align="left">0.65</td>
<td align="left">0.88</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.73</td>
<td align="left">1.00</td>
<td align="left">0.88</td>
<td align="left">0.87</td>
<td align="left">0.89</td>
<td align="left">0.99</td>
</tr>
</tbody>
</table>
<p>When considering the measures of accuracy with univariate one-way
ANOVA, we observed that the corrected data from wPLSDA-batch and
swPLSDA-batch led to higher recall and lower precision than the data
from removeBatchEffect and ComBat. However, the precision of
swPLSDA-batch was competitive to removeBatchEffect and ComBat. Moreover,
weighted sPLSDA-batch achieved higher F1 scores and multivariate
selection scores than removeBatchEffect and ComBat.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sd</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">recall_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">F1_limma</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">precision_splsda</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1'</span>, <span class="st">'Multivariate selection'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">acc_sd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Before correction'</span>, <span class="st">'Ground-truth data'</span>, </span>
<span>                      <span class="st">'removeBatchEffect'</span>, <span class="st">'ComBat'</span>, </span>
<span>                      <span class="st">'wPLSDA-batch'</span>, <span class="st">'swPLSDA-batch'</span><span class="op">)</span></span>
<span><span class="va">acc_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">acc_sd</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">acc_sd</span>, caption <span class="op">=</span> <span class="st">'Table 7: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (standard deviation).'</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Table 7: Simulation studies (Gaussian distribution): summary of
accuracy measures before and after batch correction for the unbalanced
batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="20%">
<col width="16%">
<col width="16%">
<col width="16%">
<col width="6%">
<col width="11%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.325</td>
<td align="left">0.031</td>
<td align="left">0.176</td>
<td align="left">0.231</td>
<td align="left">0.232</td>
<td align="left">0.137</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.042</td>
<td align="left">0.000</td>
<td align="left">0.104</td>
<td align="left">0.100</td>
<td align="left">0.029</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.212</td>
<td align="left">0.017</td>
<td align="left">0.137</td>
<td align="left">0.177</td>
<td align="left">0.189</td>
<td align="left">0.092</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.051</td>
<td align="left">0.000</td>
<td align="left">0.069</td>
<td align="left">0.083</td>
<td align="left">0.148</td>
<td align="left">0.016</td>
</tr>
</tbody>
</table>
<p>The standard deviations of the multivariate selection scores were all
smaller than the univariate selection scores for the different corrected
data, indicating a better stability of the variables selected by
multivariate sPLSDA compared to the one-way ANOVA univariate
selection.</p>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-singh2019diablo" class="csl-entry">
Singh, Amrit, Casey P Shannon, Benoı̂t Gautier, Florian Rohart, Michaël
Vacher, Scott J Tebbutt, and Kim-Anh Lê Cao. 2019. <span>“DIABLO: An
Integrative Approach for Identifying Key Molecular Drivers from
Multi-Omics Assays.”</span> <em>Bioinformatics</em> 35 (17): 3055–62.
</div>
<div id="ref-weiss2017normalization" class="csl-entry">
Weiss, Sophie, Zhenjiang Zech Xu, Shyamal Peddada, Amnon Amir, Kyle
Bittinger, Antonio Gonzalez, Catherine Lozupone, et al. 2017.
<span>“Normalization and Microbial Differential Abundance Strategies
Depend Upon Data Characteristics.”</span> <em>Microbiome</em> 5 (1):
1–18.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yiwen Wang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
