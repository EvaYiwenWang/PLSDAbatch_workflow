<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Batch Effects Management in Simulation Studies (Negative Binomial Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data</title>
  <meta name="description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Batch Effects Management in Simulation Studies (Negative Binomial Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  <meta name="github-repo" content="EvaYiwenWang/PLSDAbatch_workflow" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Batch Effects Management in Simulation Studies (Negative Binomial Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data" />
  
  <meta name="twitter:description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  



<meta name="date" content="2023-05-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="batch-effects-management-in-simulation-studies-gaussian-distribution.html"/>
<link rel="next" href="references-4.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">PLSDA-batch</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Batch Effects Management in Case Studies</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#case-studies-description"><i class="fa fa-check"></i><b>1.2</b> Case studies description</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#packages-installation-and-loading"><i class="fa fa-check"></i><b>1.3</b> Packages installation and loading</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#data-pre-processing"><i class="fa fa-check"></i><b>1.4</b> Data pre-processing</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="index.html"><a href="index.html#pre-filtering"><i class="fa fa-check"></i><b>1.4.1</b> Pre-filtering</a></li>
<li class="chapter" data-level="1.4.2" data-path="index.html"><a href="index.html#transformation"><i class="fa fa-check"></i><b>1.4.2</b> Transformation</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#batch-effect-detection"><i class="fa fa-check"></i><b>1.5</b> Batch effect detection</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="index.html"><a href="index.html#pca"><i class="fa fa-check"></i><b>1.5.1</b> PCA</a></li>
<li class="chapter" data-level="1.5.2" data-path="index.html"><a href="index.html#boxplots-and-density-plots"><i class="fa fa-check"></i><b>1.5.2</b> Boxplots and density plots</a></li>
<li class="chapter" data-level="1.5.3" data-path="index.html"><a href="index.html#heatmap"><i class="fa fa-check"></i><b>1.5.3</b> Heatmap</a></li>
<li class="chapter" data-level="1.5.4" data-path="index.html"><a href="index.html#prda"><i class="fa fa-check"></i><b>1.5.4</b> pRDA</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#managing-batch-effects"><i class="fa fa-check"></i><b>1.6</b> Managing batch effects</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="index.html"><a href="index.html#accnt"><i class="fa fa-check"></i><b>1.6.1</b> Accounting for batch effects</a></li>
<li class="chapter" data-level="1.6.2" data-path="index.html"><a href="index.html#corrct"><i class="fa fa-check"></i><b>1.6.2</b> Correcting for batch effects</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#assessing-batch-effect-correction"><i class="fa fa-check"></i><b>1.7</b> Assessing batch effect correction</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="index.html"><a href="index.html#methods-that-detect-batch-effects"><i class="fa fa-check"></i><b>1.7.1</b> Methods that detect batch effects</a></li>
<li class="chapter" data-level="1.7.2" data-path="index.html"><a href="index.html#other-methods-1"><i class="fa fa-check"></i><b>1.7.2</b> Other methods</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="index.html"><a href="index.html#variable-selection"><i class="fa fa-check"></i><b>1.8</b> Variable selection</a></li>
<li class="chapter" data-level="1.9" data-path="index.html"><a href="index.html#summary"><i class="fa fa-check"></i><b>1.9</b> Summary</a></li>
<li class="chapter" data-level="1.10" data-path="index.html"><a href="index.html#references"><i class="fa fa-check"></i><b>1.10</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html"><i class="fa fa-check"></i><b>2</b> Supplementary Materials for Batch Effects Management in Case Studies</a>
<ul>
<li class="chapter" data-level="2.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#sponge-data"><i class="fa fa-check"></i><b>2.1</b> Sponge data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-1"><i class="fa fa-check"></i><b>2.1.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.1.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-1"><i class="fa fa-check"></i><b>2.1.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.1.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-1"><i class="fa fa-check"></i><b>2.1.3</b> Managing batch effects</a></li>
<li class="chapter" data-level="2.1.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#assessing-batch-effect-correction-1"><i class="fa fa-check"></i><b>2.1.4</b> Assessing batch effect correction</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#hfhs-data"><i class="fa fa-check"></i><b>2.2</b> HFHS data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-2"><i class="fa fa-check"></i><b>2.2.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.2.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-2"><i class="fa fa-check"></i><b>2.2.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.2.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-2"><i class="fa fa-check"></i><b>2.2.3</b> Managing batch effects</a></li>
<li class="chapter" data-level="2.2.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#assessing-batch-effect-correction-2"><i class="fa fa-check"></i><b>2.2.4</b> Assessing batch effect correction</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#hd-data"><i class="fa fa-check"></i><b>2.3</b> HD data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-3"><i class="fa fa-check"></i><b>2.3.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.3.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-3"><i class="fa fa-check"></i><b>2.3.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.3.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-3"><i class="fa fa-check"></i><b>2.3.3</b> Managing batch effects</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#references-1"><i class="fa fa-check"></i><b>2.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><i class="fa fa-check"></i><b>3</b> Batch Effects Management in Simulation Studies (Gaussian Distribution)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#simulations"><i class="fa fa-check"></i><b>3.2</b> Simulations</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#balanced-batch-times-treatment-design"><i class="fa fa-check"></i><b>3.2.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="3.2.2" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures"><i class="fa fa-check"></i><b>3.2.2</b> Figures</a></li>
<li class="chapter" data-level="3.2.3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#unbalanced-batch-times-treatment-design"><i class="fa fa-check"></i><b>3.2.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="3.2.4" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures-1"><i class="fa fa-check"></i><b>3.2.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#references-2"><i class="fa fa-check"></i><b>3.3</b> References</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><i class="fa fa-check"></i><b>4</b> Batch Effects Management in Simulation Studies (Negative Binomial Distribution)</a>
<ul>
<li class="chapter" data-level="4.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-two-batch-groups"><i class="fa fa-check"></i><b>4.2</b> Simulations (two batch groups)</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-1"><i class="fa fa-check"></i><b>4.2.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.2.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-2"><i class="fa fa-check"></i><b>4.2.2</b> Figures</a></li>
<li class="chapter" data-level="4.2.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-1"><i class="fa fa-check"></i><b>4.2.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.2.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-3"><i class="fa fa-check"></i><b>4.2.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-three-batch-groups"><i class="fa fa-check"></i><b>4.3</b> Simulations (three batch groups)</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-2"><i class="fa fa-check"></i><b>4.3.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.3.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-4"><i class="fa fa-check"></i><b>4.3.2</b> Figures</a></li>
<li class="chapter" data-level="4.3.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-2"><i class="fa fa-check"></i><b>4.3.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.3.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-5"><i class="fa fa-check"></i><b>4.3.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#references-3"><i class="fa fa-check"></i><b>4.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-4.html"><a href="references-4.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/EvaYiwenWang/PLSDAbatch_workflow" target="blank">Source codes on github</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="batch-effects-management-in-simulation-studies-negative-binomial-distribution" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Batch Effects Management in Simulation Studies (Negative Binomial Distribution)<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#batch-effects-management-in-simulation-studies-negative-binomial-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-2" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Introduction<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#introduction-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Microbiome data are multivariate with inherent correlation structure between microbial variables. The data are over-dispersed with a distribution close to a negative binomial distribution <span class="citation">(<a href="#ref-mcmurdie2014waste" role="doc-biblioref">McMurdie and Holmes 2014</a>; <a href="#ref-quinn2018understanding" role="doc-biblioref">Quinn et al. 2018</a>)</span>. Inspired by <span class="citation">(<a href="#ref-hawinkel2019broken" role="doc-biblioref">Hawinkel et al. 2019</a>)</span>, we simulated data from multivariate negative binomial distribution achieved with quantile-quantile transformation between multivariate normal and negative binomial distributions. To add treatment and batch effects, we used matrix factorisation to simulate the mean for modelling negative binomial distribution as a matrix <span class="math display">\[\Theta = \begin{bmatrix}
\theta_{11} &amp; ...  &amp; \theta_{1M}\\
...&amp; ... &amp; ... \\
\theta_{1N} &amp; ... &amp; \theta_{NM}
\end{bmatrix}\]</span> for <span class="math inline">\(N\)</span> samples and <span class="math inline">\(M\)</span> microbial variables as follows:</p>
<p><span class="math display">\[\Theta = exp(x_{(trt)}^{\top}\beta^{(trt)} + x_{(batch)}^{\top}\beta^{(batch)} + \epsilon)\]</span></p>
<p>where <span class="math inline">\(x_{(trt)}\)</span> and <span class="math inline">\(x_{(batch)}\)</span> represent the design vectors of treatment and batch effects respectively for each sample. <span class="math inline">\(\beta^{(trt)}\)</span> and <span class="math inline">\(\beta^{(batch)}\)</span> represent the regression coefficients of treatment and batch effects for each microbial variable, and <span class="math inline">\(\beta^{(trt)}_{j} \in N(\mu_{(trt)},\sigma_{(trt)}^{2})\)</span>, <span class="math inline">\(\beta^{(batch)}_{j} \in N(\mu_{(batch)},\sigma_{(batch)}^{2})\)</span>. <span class="math inline">\(\epsilon\)</span> contains the random noise that is independent and identically distributed (i.i.d) and <span class="math inline">\(\epsilon_{ij} \in N(0,\delta^{2})\)</span>, in which <span class="math inline">\(i = 1,2,...,N\)</span> samples, <span class="math inline">\(j = 1,2,..,M\)</span> variables.</p>
<p>The probability matrix <span class="math display">\[P = \begin{bmatrix}
p_{11} &amp; ...  &amp; p_{1M}\\
...&amp; ... &amp; ... \\
p_{1N} &amp; ... &amp; p_{NM}
\end{bmatrix}\]</span> for modelling negative binomial distribution is calculated as</p>
<p><span class="math display">\[p_{ij} = \frac{r}{r + \theta_{ij}}\]</span>
where <span class="math inline">\(p_{ij}\)</span> and <span class="math inline">\(\theta_{ij}\)</span> represent the probability of success in each trial and the mean for negative binomial distribution of sample <span class="math inline">\(i\)</span> and microbial variable <span class="math inline">\(j\)</span>, and <span class="math inline">\(r\)</span> is the dispersion parameter representing the number of successes.</p>
<p>We then simulated a data matrix based on multivariate normal distribution with mean <span class="math inline">\(0\)</span> and correlation matrix <span class="math inline">\(\Sigma\)</span>:</p>
<p><span class="math display">\[X^{normal} = N(0, \Sigma)\]</span></p>
<p>where the correlation matrix <span class="math inline">\(\Sigma\)</span> was simulated with the strategy adapted from <span class="citation">(<a href="#ref-mcgregor2020mdine" role="doc-biblioref">McGregor, Labbe, and Greenwood 2020</a>)</span> as follows: We first generated a lower-triangular matrix <span class="math inline">\(L\)</span>, in which the diagonal elements follow <span class="math inline">\(Unif(1.5, 2.5)\)</span>, and the other elements <span class="math inline">\(Unif(-1.5, 1.5)\)</span>. We randomly set the elements outside the diagonal of <span class="math inline">\(L\)</span> to zero with probability <span class="math inline">\(0.7\)</span>. A precision matrix, which is the inverse of covariance matrix was created as <span class="math inline">\(R^{-1} = LL^{\top}\)</span>. The corresponding correlation matrix <span class="math inline">\(\Sigma\)</span> to <span class="math inline">\(R\)</span> was then obtained. These parameters were set according to <span class="citation">(<a href="#ref-mcgregor2020mdine" role="doc-biblioref">McGregor, Labbe, and Greenwood 2020</a>)</span>.</p>
<p>Thereafter we used Cumulative Distribution Function (CDF) to achieve quantile-quantile transformation as:</p>
<p><span class="math display">\[CDF(x^{normal}_{ij}) = CDF(x^{nb}_{ij})\]</span></p>
<p>where <span class="math inline">\(CDF(x^{normal}_{ij})\)</span> represents the cumulative probability of <span class="math inline">\(x^{normal}_{ij}\)</span> for sample <span class="math inline">\(i\)</span> and variable <span class="math inline">\(j\)</span> that belongs to matrix <span class="math inline">\(X^{normal}\)</span> from multivariate normal distribution. <span class="math inline">\(CDF(x^{nb}_{ij})\)</span> represents the cumulative probability of each <span class="math inline">\(x^{nb}_{ij}\)</span> in matrix <span class="math inline">\(X^{nb}\)</span> from negative binomial distribution.</p>
<p>Based on the cumulative probability, we can simulate a data matrix <span class="math inline">\(X^{nb}\)</span> with multivariate negative binomial distribution:</p>
<p><span class="math display">\[X^{nb} = NB(r, P, \Sigma)\]</span></p>
<p>where <span class="math inline">\(r\)</span> represents the dispersion parameter, <span class="math inline">\(P\)</span> represents the probability matrix and <span class="math inline">\(\Sigma\)</span> the correlation matrix explaining the dependence structure between microbial variables.</p>
<p>We simulated datasets with different parameters including amount of batch and treatment effects (<span class="math inline">\(\mu_{(batch)}\)</span>, <span class="math inline">\(\mu_{(trt)}\)</span>) and variability among variables (<span class="math inline">\(\sigma_{(batch)}\)</span>, <span class="math inline">\(\sigma_{(trt)}\)</span>), number of variables with batch and/or treatment effects (<span class="math inline">\(M^{(batch)}\)</span>, <span class="math inline">\(M^{(trt)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span>), balanced and unbalanced batch <span class="math inline">\(\times\)</span> treatment designs, as summarised in the table below.</p>
<p><strong>Table 1: Summary of simulation scenarios (Negative Binomial distribution).</strong> For a given choice of parameters reported in this table, each simulation was repeated 50 times. <span class="math inline">\(M^{(trt)}, M^{(batch)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span> represent the number of variables with treatment, batch, or both effects respectively. Simu 6 includes parameters likely to represent real data according to our experience in analysing microbiome datasets.</p>
<table style="width:100%;">
<colgroup>
<col width="8%" />
<col width="10%" />
<col width="12%" />
<col width="11%" />
<col width="14%" />
<col width="11%" />
<col width="11%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center"><span class="math inline">\(\mu_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\mu_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Simu 1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">{1,4,8}</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simu 2</td>
<td align="center">{3,5,7}</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simu 3</td>
<td align="center">3</td>
<td align="center">{1,2,4}</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simu 4</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">{30,60,100,150}</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simu 5</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">{30,60,100,150}</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simu 6</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">{0,18,30,42,60}</td>
</tr>
</tbody>
</table>
<p>The microbial variables with treatment or batch effects were randomly indexed in the data with non-zero <span class="math inline">\(\beta^{(trt)}\)</span> or <span class="math inline">\(\beta^{(batch)}\)</span>. The background noise <span class="math inline">\(\epsilon_{ij}\)</span> was randomly sampled from <span class="math inline">\(N(0,0.2^{2})\)</span>, reflecting real microbiome datasets.</p>
<p>We also simulated datasets with different number of batch groups:</p>
<ol style="list-style-type: decimal">
<li>Two batch groups: Each dataset included 300 variables and 40 samples grouped according to two treatments (trt1 and trt2) and two batches (batch1 and batch2).<br />
</li>
<li>Three batch groups: Each dataset included 300 variables and 36 samples grouped according to two treatments (trt1 and trt2) and three batches (batch1, batch2 and batch3).</li>
</ol>
<p>In addition, we simulated a ground-truth dataset that only included treatment effects and background noise without batch effects to evaluate batch effect correction methods.</p>
<p>Our simulations generate over-dispersed count data with batch and treatment effects as well as correlation structure among variables, but without any compositional structure. We therefore only applied natural log transformation to the simulated data prior to analysis.</p>
<p>In these simulation scenarios, for PLSDA-batch we set <span class="math inline">\(C-1\)</span> (or <span class="math inline">\(B-1\)</span>) components associated with treatment (or batch) effects (where <span class="math inline">\(C\)</span> and <span class="math inline">\(B\)</span> represent the total number of treatment and batch groups respectively) as <span class="math inline">\(C-1\)</span> (<span class="math inline">\(B-1\)</span>) components are likely to explain 100% variance in <span class="math inline">\(Y\)</span>. The number of variables with a true treatment effect (<span class="math inline">\(M^{(trt)}\)</span>) is set as the optimal number to select on each treatment component in sPLSDA-batch.</p>
</div>
<div id="simulations-two-batch-groups" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Simulations (two batch groups)<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-two-batch-groups" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="balanced-batch-times-treatment-design-1" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Balanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The balanced batch <span class="math inline">\(\times\)</span> treatment experimental design included 10 samples from two batches respectively in each treatment group.</p>
<p><strong>Table 2: Balanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb252-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">40</span></span>
<span id="cb252-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-3" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">=</span> <span class="dv">300</span></span>
<span id="cb252-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-4" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">=</span> <span class="dv">100</span> </span>
<span id="cb252-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-5" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">=</span> <span class="dv">200</span> </span>
<span id="cb252-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-7" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb252-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-8" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> </span>
<span id="cb252-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-9" aria-hidden="true" tabindex="-1"></a>  gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb252-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-10" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab <span class="ot">&lt;-</span> gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb252-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb252-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb252-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-14" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb252-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-15" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> </span>
<span id="cb252-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-16" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb252-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-17" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab <span class="ot">&lt;-</span> r2.trt.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb252-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-18" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">ncol =</span> nitr))</span>
<span id="cb252-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-19" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> </span>
<span id="cb252-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-20" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb252-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-21" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab <span class="ot">&lt;-</span> r2.batch.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb252-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-22" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">ncol =</span> nitr))</span>
<span id="cb252-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-24" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-25" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb252-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb252-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb252-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>, </span>
<span id="cb252-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">sva =</span> <span class="cn">NA</span>)</span>
<span id="cb252-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-31" aria-hidden="true" tabindex="-1"></a><span class="co"># auc (splsda)</span></span>
<span id="cb252-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-32" aria-hidden="true" tabindex="-1"></a>auc_splsda <span class="ot">&lt;-</span> </span>
<span id="cb252-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb252-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb252-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb252-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-38" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">70</span>)</span>
<span id="cb252-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-39" aria-hidden="true" tabindex="-1"></a>data.cor.res <span class="ot">=</span> <span class="fu">corStruct</span>(<span class="at">p =</span> <span class="dv">300</span>, <span class="at">zero_prob =</span> <span class="fl">0.7</span>)</span>
<span id="cb252-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> nitr){</span>
<span id="cb252-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb252-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-43" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_mnegbinom</span>(<span class="at">batch.group =</span> <span class="dv">2</span>,</span>
<span id="cb252-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.batch =</span> <span class="dv">7</span>, </span>
<span id="cb252-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb252-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-46" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.trt =</span> <span class="dv">3</span>, </span>
<span id="cb252-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb252-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.bg =</span> <span class="dv">0</span>, </span>
<span id="cb252-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.bg =</span> <span class="fl">0.2</span>, </span>
<span id="cb252-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">N =</span> <span class="dv">40</span>, </span>
<span id="cb252-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb252-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-52" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_trt_relevant =</span> <span class="dv">100</span>, </span>
<span id="cb252-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-53" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_bat_relevant =</span> <span class="dv">200</span>, </span>
<span id="cb252-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_samples =</span> <span class="fl">0.5</span>, </span>
<span id="cb252-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, </span>
<span id="cb252-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data.cor =</span> data.cor.res<span class="sc">$</span>data.cor, </span>
<span id="cb252-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">disp =</span> <span class="dv">10</span>, <span class="at">prob_zero =</span> <span class="dv">0</span>, </span>
<span id="cb252-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-58" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">seeds =</span> i)</span>
<span id="cb252-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(i)</span>
<span id="cb252-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-61" aria-hidden="true" tabindex="-1"></a>  raw_count <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb252-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-62" aria-hidden="true" tabindex="-1"></a>  raw_count_clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb252-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log transformation</span></span>
<span id="cb252-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-65" aria-hidden="true" tabindex="-1"></a>  data_log <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb252-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-66" aria-hidden="true" tabindex="-1"></a>  data_log_clean <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count_clean <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb252-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-68" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb252-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-69" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb252-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-71" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb252-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-72" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb252-73"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-74"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-74" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb252-75"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-76"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Original </span><span class="al">###</span></span>
<span id="cb252-77"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-77" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> data_log</span>
<span id="cb252-78"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-79"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Clean data </span><span class="al">###</span></span>
<span id="cb252-80"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-80" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> data_log_clean</span>
<span id="cb252-81"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-82"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">#####</span></span>
<span id="cb252-83"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(X) <span class="ot">=</span> <span class="fu">rownames</span>(X.clean) <span class="ot">=</span> <span class="fu">names</span>(trt) <span class="ot">=</span> <span class="fu">names</span>(batch) <span class="ot">=</span> </span>
<span id="cb252-84"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;sample&#39;</span>, <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb252-85"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-86"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">=</span> <span class="fu">colnames</span>(X.clean) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&#39;otu&#39;</span>, <span class="dv">1</span><span class="sc">:</span>p_total)</span>
<span id="cb252-87"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-88"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb252-89"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-90"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-90" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-91"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-91" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-92"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-92" aria-hidden="true" tabindex="-1"></a>  gvar.before[i,] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-93"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-94"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-95"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-95" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-96"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-96" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb252-97"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-97" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> </span>
<span id="cb252-98"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb252-99"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-100"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-100" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb252-101"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span></span>
<span id="cb252-102"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb252-103"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-103" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb252-104"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb252-105"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-105" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb252-106"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-106" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb252-107"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-107" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb252-108"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-109"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-109" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-110"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-111"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-111" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-112"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-113"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-114"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-114" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-115"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-116"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-117"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-118"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-118" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-119"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-119" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-120"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb252-121"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-121" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-122"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-122" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-123"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-123" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-124"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-124" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-125"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-125" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-126"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-126" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-127"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-128"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-128" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb252-129"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-129" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb252-130"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-131"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-132"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-133"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-133" aria-hidden="true" tabindex="-1"></a>  fit.before_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-134"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-135"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-135" aria-hidden="true" tabindex="-1"></a>  true.response <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p_total)</span>
<span id="cb252-136"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-136" aria-hidden="true" tabindex="-1"></a>  true.response[true.trt] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb252-137"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-137" aria-hidden="true" tabindex="-1"></a>  before.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.before_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-138"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-138" aria-hidden="true" tabindex="-1"></a>  roc.before_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, before.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-139"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-139" aria-hidden="true" tabindex="-1"></a>  auc.before_splsda <span class="ot">&lt;-</span> roc.before_splsda<span class="sc">$</span>auc</span>
<span id="cb252-140"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-141"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-142"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-142" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-143"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-143" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb252-144"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-145"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-145" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-146"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-146" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-147"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-147" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-148"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-149"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-150"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-151"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-151" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-152"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-152" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb252-153"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-153" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> </span>
<span id="cb252-154"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb252-155"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-156"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-156" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean<span class="ot">&lt;-</span> </span>
<span id="cb252-157"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span></span>
<span id="cb252-158"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb252-159"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-159" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean<span class="ot">&lt;-</span> </span>
<span id="cb252-160"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span></span>
<span id="cb252-161"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb252-162"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-162" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb252-163"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-163" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb252-164"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-164" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb252-165"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-166"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-166" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-167"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-167" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-168"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-168" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-169"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-169" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-170"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-171"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-171" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-172"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-172" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-173"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-174"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-175"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-175" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-176"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-176" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-177"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-177" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb252-178"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-178" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-179"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-179" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-180"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-180" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-181"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-181" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-182"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-182" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-183"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-183" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-184"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-184" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-185"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-185" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb252-186"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-186" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb252-187"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-188"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-189"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-189" aria-hidden="true" tabindex="-1"></a>  fit.clean_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-190"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-191"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-191" aria-hidden="true" tabindex="-1"></a>  clean.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.clean_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-192"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-192" aria-hidden="true" tabindex="-1"></a>  roc.clean_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, clean.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-193"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-193" aria-hidden="true" tabindex="-1"></a>  auc.clean_splsda <span class="ot">&lt;-</span> roc.clean_splsda<span class="sc">$</span>auc</span>
<span id="cb252-194"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-195"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-195" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-196"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-196" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb252-197"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-197" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb252-198"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-198" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb252-199"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-200"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-200" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-201"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-201" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-202"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-202" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-203"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-203" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-204"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-205"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-206"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-206" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb252-207"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-207" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-208"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-208" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb252-209"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-209" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb252-210"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-210" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-211"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-211" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb252-212"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb252-213"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-213" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb252-214"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb252-215"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-215" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb252-216"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-216" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb252-217"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-218"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-218" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-219"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-220"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-220" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-221"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-221" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-222"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-223"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-223" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-224"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-224" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-225"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-226"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-227"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-227" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-228"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-228" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-229"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-229" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb252-230"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-230" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-231"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-231" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-232"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-232" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-233"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-233" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-234"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-234" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-235"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-235" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-236"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-236" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-237"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-237" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb252-238"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-238" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb252-239"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-240"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-241"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-241" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-242"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-242" aria-hidden="true" tabindex="-1"></a>  fit.rbe_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-243"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-244"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-244" aria-hidden="true" tabindex="-1"></a>  rbe.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.rbe_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-245"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-245" aria-hidden="true" tabindex="-1"></a>  roc.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, rbe.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-246"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-246" aria-hidden="true" tabindex="-1"></a>  auc.rbe_splsda <span class="ot">&lt;-</span> roc.rbe_splsda<span class="sc">$</span>auc</span>
<span id="cb252-247"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-247" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-248"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-248" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-249"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-249" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb252-250"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-250" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb252-251"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-251" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb252-252"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-252" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-253"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-253" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-254"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-254" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-255"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-255" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-256"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-256" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-257"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-258"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-259"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-259" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb252-260"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-260" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-261"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-261" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb252-262"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-262" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> </span>
<span id="cb252-263"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-263" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fl">0.05</span>]</span>
<span id="cb252-264"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-265"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-265" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb252-266"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb252-267"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb252-268"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-268" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb252-269"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb252-270"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb252-271"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-271" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb252-272"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-272" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb252-273"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-274"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-274" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-275"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-276"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-276" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-277"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-277" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-278"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-278" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-279"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-279" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-280"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-281"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-282"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-283"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-283" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-284"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-284" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-285"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-285" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb252-286"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-286" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-287"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-287" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-288"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-288" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-289"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-289" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-290"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-290" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-291"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-291" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-292"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-292" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-293"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-293" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb252-294"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-294" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb252-295"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-296"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-297"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-297" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-298"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-298" aria-hidden="true" tabindex="-1"></a>  fit.combat_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-299"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-300"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-300" aria-hidden="true" tabindex="-1"></a>  combat.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.combat_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-301"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-301" aria-hidden="true" tabindex="-1"></a>  roc.combat_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, combat.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-302"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-302" aria-hidden="true" tabindex="-1"></a>  auc.combat_splsda <span class="ot">&lt;-</span> roc.combat_splsda<span class="sc">$</span>auc</span>
<span id="cb252-303"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-304"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-305"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-305" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-306"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-306" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb252-307"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-307" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb252-308"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-308" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb252-309"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-309" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb252-310"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-310" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb252-311"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-311" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-312"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-312" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-313"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-313" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-314"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-314" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-315"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-315" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-316"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-317"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-318"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-318" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.plsda_batch)), </span>
<span id="cb252-319"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-319" aria-hidden="true" tabindex="-1"></a>                           <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-320"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-320" aria-hidden="true" tabindex="-1"></a>  fit.result.plsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.plsda_batch), </span>
<span id="cb252-321"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-321" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb252-322"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-322" aria-hidden="true" tabindex="-1"></a>  otu.sig.plsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.plsda_batch)[</span>
<span id="cb252-323"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-323" aria-hidden="true" tabindex="-1"></a>    fit.result.plsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb252-324"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-325"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-325" aria-hidden="true" tabindex="-1"></a>  precision_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-326"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb252-327"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.plsda_batch)</span>
<span id="cb252-328"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-328" aria-hidden="true" tabindex="-1"></a>  recall_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-329"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb252-330"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb252-331"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-331" aria-hidden="true" tabindex="-1"></a>  F1_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-332"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-332" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.plsda_batch<span class="sc">*</span>recall_limma.plsda_batch)<span class="sc">/</span></span>
<span id="cb252-333"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-333" aria-hidden="true" tabindex="-1"></a>    (precision_limma.plsda_batch <span class="sc">+</span> recall_limma.plsda_batch)</span>
<span id="cb252-334"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-335"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-335" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-336"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-336" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-337"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-337" aria-hidden="true" tabindex="-1"></a>    precision_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-338"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-338" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-339"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-339" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-340"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-340" aria-hidden="true" tabindex="-1"></a>    F1_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-341"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-341" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-342"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-342" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-343"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-343" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-344"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-344" aria-hidden="true" tabindex="-1"></a>  indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-345"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-345" aria-hidden="true" tabindex="-1"></a>  indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-346"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.plsda_batch))){</span>
<span id="cb252-347"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-347" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-348"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-348" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-349"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-349" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-350"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-350" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-351"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-351" aria-hidden="true" tabindex="-1"></a>    indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.plsda_batch, </span>
<span id="cb252-352"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-352" aria-hidden="true" tabindex="-1"></a>                               fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-353"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-353" aria-hidden="true" tabindex="-1"></a>    indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.plsda_batch, </span>
<span id="cb252-354"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-354" aria-hidden="true" tabindex="-1"></a>                                 fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-355"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-355" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-356"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-356" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.plsda_batch</span>
<span id="cb252-357"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-357" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.plsda_batch</span>
<span id="cb252-358"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-358" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-359"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-359" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-360"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-360" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.plsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-361"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-362"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-362" aria-hidden="true" tabindex="-1"></a>  plsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.plsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-363"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-363" aria-hidden="true" tabindex="-1"></a>  roc.plsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb252-364"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-364" aria-hidden="true" tabindex="-1"></a>                                plsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-365"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-365" aria-hidden="true" tabindex="-1"></a>  auc.plsda_batch_splsda <span class="ot">&lt;-</span> roc.plsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb252-366"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-367"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-367" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-368"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-368" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb252-369"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-369" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb252-370"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-370" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, </span>
<span id="cb252-371"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-371" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.bat =</span> batch, </span>
<span id="cb252-372"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-372" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb252-373"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-373" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb252-374"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-374" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb252-375"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-375" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb252-376"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-377"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-377" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb252-378"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-378" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb252-379"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-379" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb252-380"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-380" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb252-381"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-382"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-383"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-383" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.splsda_batch)), </span>
<span id="cb252-384"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-384" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb252-385"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-385" aria-hidden="true" tabindex="-1"></a>  fit.result.splsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.splsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb252-386"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-386" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb252-387"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-387" aria-hidden="true" tabindex="-1"></a>  otu.sig.splsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.splsda_batch)[</span>
<span id="cb252-388"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-388" aria-hidden="true" tabindex="-1"></a>    fit.result.splsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb252-389"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-390"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-390" aria-hidden="true" tabindex="-1"></a>  precision_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-391"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb252-392"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.splsda_batch)</span>
<span id="cb252-393"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-393" aria-hidden="true" tabindex="-1"></a>  recall_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-394"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-394" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb252-395"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-395" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb252-396"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-396" aria-hidden="true" tabindex="-1"></a>  F1_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb252-397"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-397" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.splsda_batch<span class="sc">*</span>recall_limma.splsda_batch)<span class="sc">/</span></span>
<span id="cb252-398"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-398" aria-hidden="true" tabindex="-1"></a>    (precision_limma.splsda_batch <span class="sc">+</span> recall_limma.splsda_batch)</span>
<span id="cb252-399"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-399" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-400"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-400" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-401"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-401" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-402"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-402" aria-hidden="true" tabindex="-1"></a>    precision_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-403"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-403" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-404"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-404" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-405"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-405" aria-hidden="true" tabindex="-1"></a>    F1_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-406"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-406" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-407"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-408"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-408" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-409"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb252-410"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-410" aria-hidden="true" tabindex="-1"></a>  indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-411"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-411" aria-hidden="true" tabindex="-1"></a>  indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb252-412"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-412" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.splsda_batch))){</span>
<span id="cb252-413"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-413" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb252-414"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-414" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb252-415"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-415" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb252-416"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-416" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb252-417"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-417" aria-hidden="true" tabindex="-1"></a>    indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.splsda_batch, </span>
<span id="cb252-418"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-418" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb252-419"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-419" aria-hidden="true" tabindex="-1"></a>    indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.splsda_batch, </span>
<span id="cb252-420"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-420" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb252-421"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-421" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-422"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-422" aria-hidden="true" tabindex="-1"></a>  r2.trt.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.splsda_batch</span>
<span id="cb252-423"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-423" aria-hidden="true" tabindex="-1"></a>  r2.batch.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.splsda_batch</span>
<span id="cb252-424"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-424" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-425"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb252-426"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-426" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.splsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb252-427"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-427" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-428"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-428" aria-hidden="true" tabindex="-1"></a>  splsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.splsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb252-429"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-429" aria-hidden="true" tabindex="-1"></a>  roc.splsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb252-430"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-430" aria-hidden="true" tabindex="-1"></a>                                 splsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb252-431"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-431" aria-hidden="true" tabindex="-1"></a>  auc.splsda_batch_splsda <span class="ot">&lt;-</span> roc.splsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb252-432"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-432" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-433"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-433" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb252-434"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-434" aria-hidden="true" tabindex="-1"></a>  <span class="do">### SVA </span><span class="al">###</span></span>
<span id="cb252-435"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-435" aria-hidden="true" tabindex="-1"></a>  X.mod <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb252-436"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-436" aria-hidden="true" tabindex="-1"></a>  X.mod0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb252-437"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-437" aria-hidden="true" tabindex="-1"></a>  X.sva.n <span class="ot">&lt;-</span> <span class="fu">num.sv</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">mod =</span> X.mod, <span class="at">method =</span> <span class="st">&#39;leek&#39;</span>)</span>
<span id="cb252-438"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-438" aria-hidden="true" tabindex="-1"></a>  X.sva <span class="ot">&lt;-</span> <span class="fu">sva</span>(<span class="fu">t</span>(X), X.mod, X.mod0, <span class="at">n.sv =</span> X.sva.n)</span>
<span id="cb252-439"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-439" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-440"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-440" aria-hidden="true" tabindex="-1"></a>  X.mod.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod, X.sva<span class="sc">$</span>sv)</span>
<span id="cb252-441"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-441" aria-hidden="true" tabindex="-1"></a>  X.mod0.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod0, X.sva<span class="sc">$</span>sv)</span>
<span id="cb252-442"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-442" aria-hidden="true" tabindex="-1"></a>  X.sva.p <span class="ot">&lt;-</span> <span class="fu">f.pvalue</span>(<span class="fu">t</span>(X), X.mod.batch, X.mod0.batch)</span>
<span id="cb252-443"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-443" aria-hidden="true" tabindex="-1"></a>  X.sva.p.adj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(X.sva.p, <span class="at">method =</span> <span class="st">&#39;fdr&#39;</span>)</span>
<span id="cb252-444"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-445"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-445" aria-hidden="true" tabindex="-1"></a>  otu.sig.sva <span class="ot">&lt;-</span> <span class="fu">which</span>(X.sva.p.adj <span class="sc">&lt;=</span> <span class="fl">0.05</span>)</span>
<span id="cb252-446"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-446" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-447"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-447" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-448"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-448" aria-hidden="true" tabindex="-1"></a>  precision_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb252-449"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(otu.sig.sva)</span>
<span id="cb252-450"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-450" aria-hidden="true" tabindex="-1"></a>  recall_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb252-451"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb252-452"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-452" aria-hidden="true" tabindex="-1"></a>  F1_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb252-453"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-453" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.sva<span class="sc">*</span>recall_limma.sva)<span class="sc">/</span></span>
<span id="cb252-454"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-454" aria-hidden="true" tabindex="-1"></a>    (precision_limma.sva <span class="sc">+</span> recall_limma.sva)</span>
<span id="cb252-455"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-456"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-456" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb252-457"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-457" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-458"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-458" aria-hidden="true" tabindex="-1"></a>    precision_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-459"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-459" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-460"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-460" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb252-461"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-461" aria-hidden="true" tabindex="-1"></a>    F1_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb252-462"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-462" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-463"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-463" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-464"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-464" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-465"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-465" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb252-466"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-466" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb252-467"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-467" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb252-468"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-468" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb252-469"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-469" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb252-470"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-470" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb252-471"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-471" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.plsda_batch,</span>
<span id="cb252-472"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-472" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.splsda_batch,</span>
<span id="cb252-473"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-473" aria-hidden="true" tabindex="-1"></a>                            <span class="at">SVA =</span> precision_limma.sva)</span>
<span id="cb252-474"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-474" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-475"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-475" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb252-476"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-476" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb252-477"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-477" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb252-478"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-478" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb252-479"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-479" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.plsda_batch,</span>
<span id="cb252-480"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-480" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.splsda_batch,</span>
<span id="cb252-481"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-481" aria-hidden="true" tabindex="-1"></a>                         <span class="at">SVA =</span> recall_limma.sva)</span>
<span id="cb252-482"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-482" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-483"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-483" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb252-484"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-484" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb252-485"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-485" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb252-486"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-486" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb252-487"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-487" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.plsda_batch,</span>
<span id="cb252-488"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-488" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.splsda_batch,</span>
<span id="cb252-489"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-489" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVA =</span> F1_limma.sva)</span>
<span id="cb252-490"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-490" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-491"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-491" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (splsda)</span></span>
<span id="cb252-492"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-492" aria-hidden="true" tabindex="-1"></a>  auc_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> auc.before_splsda, </span>
<span id="cb252-493"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-493" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> auc.clean_splsda, </span>
<span id="cb252-494"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-494" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> auc.rbe_splsda, </span>
<span id="cb252-495"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-495" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> auc.combat_splsda, </span>
<span id="cb252-496"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-496" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.plsda_batch_splsda, </span>
<span id="cb252-497"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-497" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.splsda_batch_splsda)</span>
<span id="cb252-498"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-498" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-499"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-499" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(i)</span></span>
<span id="cb252-500"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-500" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb252-501"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb252-501" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="figures-2" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Figures<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb253-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb253-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb253-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb253-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb253-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb253-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb253-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-9" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb253-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-10" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb253-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb253-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb253-13" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-111"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-111-1.png" alt="Figure 1: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%" />
<p class="caption">
Figure 4.1: Figure 1: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<p>Efficient batch effect correction methods should generate data with a null proportion of variance explained by batch effects, and a proportion of variance explained by treatment that is larger compared to the original data, as shown in the figure above original data and ground-truth data.</p>
<p>For a balanced batch <span class="math inline">\(\times\)</span> treatment design, we observed no intersection shared between treatment and batch variance, as expected. All methods successfully removed batch variance and preserved (or slightly increased) treatment variance (sPLSDA-batch), with the exception of ComBat where a very small amount of batch variance remained.</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb254-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb254-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="do">## boxplot</span></span>
<span id="cb254-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb254-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-5" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&#39;Treatment only&#39;</span>, p_trt_relevant), </span>
<span id="cb254-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="st">&#39;Batch only&#39;</span>, (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb254-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-7" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="st">&#39;Treatment &amp; batch&#39;</span></span>
<span id="cb254-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-8" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>p_total, <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="st">&#39;No effect&#39;</span></span>
<span id="cb254-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-10" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">factor</span>(gclass, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;Treatment &amp; batch&#39;</span>, </span>
<span id="cb254-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb254-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Batch only&#39;</span>, </span>
<span id="cb254-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-13" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;No effect&#39;</span>))</span>
<span id="cb254-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-15" aria-hidden="true" tabindex="-1"></a>before.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.before), </span>
<span id="cb254-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.before)), </span>
<span id="cb254-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-18" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-20" aria-hidden="true" tabindex="-1"></a>clean.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.clean), </span>
<span id="cb254-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-21" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">rowMeans</span>(r2.batch.clean)), </span>
<span id="cb254-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-22" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-23" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-24" aria-hidden="true" tabindex="-1"></a>                              <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-25" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), </span>
<span id="cb254-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-26" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rowMeans</span>(r2.batch.rbe)), </span>
<span id="cb254-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-28" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-29" aria-hidden="true" tabindex="-1"></a>                            <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-30" aria-hidden="true" tabindex="-1"></a>combat.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.combat), </span>
<span id="cb254-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-31" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.combat)), </span>
<span id="cb254-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-32" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-33" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-34" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-35" aria-hidden="true" tabindex="-1"></a>plsda_batch.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.plsdab), </span>
<span id="cb254-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-36" aria-hidden="true" tabindex="-1"></a>                                           <span class="fu">rowMeans</span>(r2.batch.plsdab)), </span>
<span id="cb254-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-37" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-38" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-39" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-40" aria-hidden="true" tabindex="-1"></a>splsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb254-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.splsdab), </span>
<span id="cb254-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-42" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.splsdab)), </span>
<span id="cb254-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-43" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb254-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb254-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-45" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb254-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-47" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.ggp, clean.r2.df.ggp,</span>
<span id="cb254-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-48" aria-hidden="true" tabindex="-1"></a>                       rbe.r2.df.ggp, combat.r2.df.ggp,</span>
<span id="cb254-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-49" aria-hidden="true" tabindex="-1"></a>                       plsda_batch.r2.df.ggp, splsda_batch.r2.df.ggp)</span>
<span id="cb254-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-51" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb254-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-52" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb254-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-53" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb254-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-54" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb254-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-55" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;PLSDA-batch&#39;</span>, </span>
<span id="cb254-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-56" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;sPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">600</span>)</span>
<span id="cb254-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-58" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.ggp<span class="sc">$</span>methods, </span>
<span id="cb254-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-59" aria-hidden="true" tabindex="-1"></a>                                <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.ggp<span class="sc">$</span>methods))</span>
<span id="cb254-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-61" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.ggp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb254-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.80</span>) <span class="sc">+</span></span>
<span id="cb254-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb254-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb254-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb254-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb254-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb254-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb254-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb254-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb254-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb254-71" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-112"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-112-1.png" alt="Figure 2: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.2: Figure 2: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb255-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="do">## barplot</span></span>
<span id="cb255-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-3" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb255-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-4" aria-hidden="true" tabindex="-1"></a>before.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.before), gclass, sum), </span>
<span id="cb255-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.before), gclass, sum)), </span>
<span id="cb255-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-10" aria-hidden="true" tabindex="-1"></a>clean.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.clean), gclass, sum), </span>
<span id="cb255-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.clean), gclass, sum)), </span>
<span id="cb255-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-16" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), gclass, sum), </span>
<span id="cb255-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-18" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.rbe), gclass, sum)), </span>
<span id="cb255-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-22" aria-hidden="true" tabindex="-1"></a>combat.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.combat), gclass, sum), </span>
<span id="cb255-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-24" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.combat), gclass, sum)), </span>
<span id="cb255-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-28" aria-hidden="true" tabindex="-1"></a>plsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.plsdab), gclass, sum), </span>
<span id="cb255-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-30" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.plsdab), gclass, sum)), </span>
<span id="cb255-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-34" aria-hidden="true" tabindex="-1"></a>splsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb255-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.splsdab), gclass, sum), </span>
<span id="cb255-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.splsdab), gclass, sum)), </span>
<span id="cb255-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb255-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb255-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-41" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.bp, clean.r2.df.bp,</span>
<span id="cb255-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-42" aria-hidden="true" tabindex="-1"></a>                      rbe.r2.df.bp, combat.r2.df.bp,</span>
<span id="cb255-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-43" aria-hidden="true" tabindex="-1"></a>                      plsda_batch.r2.df.bp, splsda_batch.r2.df.bp)</span>
<span id="cb255-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-46" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb255-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-47" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb255-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-48" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb255-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-49" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">8</span>)</span>
<span id="cb255-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-51" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.bp<span class="sc">$</span>methods, </span>
<span id="cb255-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-52" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.bp<span class="sc">$</span>methods))</span>
<span id="cb255-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-54" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.bp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb255-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> </span>
<span id="cb255-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb255-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb255-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb255-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb255-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb255-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb255-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb255-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb255-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb255-64" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-113"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-113-1.png" alt="Figure 3: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.3: Figure 3: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<p>We estimated the proportion of variance explained by treatment and batch effects for each variable using the <span class="math inline">\(R^2\)</span> value. removeBatchEffect and PLSDA-batch had the best performance, with results very similar to the ground-truth data. ComBat retained more batch variance of variables with batch effects only, and with both batch and treatment effects, indicating an incomplete removal of batch effects. This result is in agreement with the overall pRDA evaluation described earlier. For sPLSDA-batch, variables with no treatment effect (batch effects only) included a slight amount of (spurious) treatment variance. This was also observed in pRDA evaluation. However, sPLSDA-batch performed as well as PLSDA-batch when the simulated data did not include variables with both batch and treatment effects.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb256-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb256-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb256-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">c</span>(<span class="fu">colMeans</span>(auc_splsda), <span class="at">sva =</span> <span class="cn">NA</span>))</span>
<span id="cb256-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb256-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb256-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb256-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb256-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb256-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb256-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 3: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-114">Table 4.1: </span>Table 3: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.984</td>
<td align="left">0.952</td>
<td align="left">0.950</td>
<td align="left">0.952</td>
<td align="left">0.952</td>
<td align="left">0.807</td>
<td align="left">0.957</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.674</td>
<td align="left">0.900</td>
<td align="left">0.910</td>
<td align="left">0.911</td>
<td align="left">0.910</td>
<td align="left">0.910</td>
<td align="left">0.934</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.799</td>
<td align="left">0.923</td>
<td align="left">0.927</td>
<td align="left">0.929</td>
<td align="left">0.929</td>
<td align="left">0.851</td>
<td align="left">0.944</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.944</td>
<td align="left">0.964</td>
<td align="left">0.968</td>
<td align="left">0.968</td>
<td align="left">0.969</td>
<td align="left">0.954</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>The results from the accuracy measures combined with variable selection highlight the importance of removing batch effects as both F1 score and AUC largely improved compared to the original data.</p>
<p>Starting from the original data compared to the ground-truth data, selected variables had a higher precision, lower recall and lower AUC, indicating a smaller number of variables selected with an actual treatment effect. Combined with univariate one-way ANOVA, SVA performed best with the highest, and sometimes greater, accuracy measurements than the ground-truth data. The other methods led to similar performance with the exception of sPLSDA-batch, which selected more false positives than the other methods. PLSDA-batch led to a slightly better AUC than the other methods.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb257-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb257-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">c</span>(<span class="fu">apply</span>(auc_splsda, <span class="dv">2</span>, sd), <span class="cn">NA</span>))</span>
<span id="cb257-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb257-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb257-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb257-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb257-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb257-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb257-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 4: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-115">Table 4.2: </span>Table 4: Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.04</td>
<td align="left">0.08</td>
<td align="left">0.09</td>
<td align="left">0.08</td>
<td align="left">0.08</td>
<td align="left">0.11</td>
<td align="left">0.06</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.02</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.06</td>
<td align="left">0.04</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.01</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="unbalanced-batch-times-treatment-design-1" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The unbalanced design included 4 and 16 samples from batch1 and batch2 respectively in trt1, 16 and 4 samples from batch1 and batch2 in trt2.</p>
<p><strong>Table 5: Unbalanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">4</td>
<td align="center">16</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">16</td>
<td align="center">4</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb258-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">40</span></span>
<span id="cb258-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-3" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">=</span> <span class="dv">300</span></span>
<span id="cb258-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-4" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">=</span> <span class="dv">100</span> </span>
<span id="cb258-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-5" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">=</span> <span class="dv">200</span> </span>
<span id="cb258-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-7" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb258-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-8" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-9" aria-hidden="true" tabindex="-1"></a>  gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-10" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab <span class="ot">&lt;-</span> gvar.swplsdab <span class="ot">&lt;-</span> </span>
<span id="cb258-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-11" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab <span class="ot">&lt;-</span> gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb258-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb258-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-13" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb258-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-15" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb258-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-16" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-17" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-18" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab <span class="ot">&lt;-</span> r2.trt.swplsdab <span class="ot">&lt;-</span></span>
<span id="cb258-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-19" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab <span class="ot">&lt;-</span> r2.trt.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb258-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-20" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">ncol =</span> nitr))</span>
<span id="cb258-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-21" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-22" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-23" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab <span class="ot">&lt;-</span> r2.batch.swplsdab <span class="ot">&lt;-</span></span>
<span id="cb258-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-24" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab <span class="ot">&lt;-</span> r2.batch.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb258-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-25" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">ncol =</span> nitr))</span>
<span id="cb258-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-27" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-28" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb258-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb258-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb258-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>, </span>
<span id="cb258-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">sva =</span> <span class="cn">NA</span>)</span>
<span id="cb258-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-34" aria-hidden="true" tabindex="-1"></a><span class="co"># auc (splsda)</span></span>
<span id="cb258-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-35" aria-hidden="true" tabindex="-1"></a>auc_splsda <span class="ot">&lt;-</span> </span>
<span id="cb258-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb258-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb258-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb258-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-41" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">70</span>)</span>
<span id="cb258-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-42" aria-hidden="true" tabindex="-1"></a>data.cor.res <span class="ot">=</span> <span class="fu">corStruct</span>(<span class="at">p =</span> <span class="dv">300</span>, <span class="at">zero_prob =</span> <span class="fl">0.7</span>)</span>
<span id="cb258-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> nitr){</span>
<span id="cb258-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb258-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-46" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_mnegbinom</span>(<span class="at">batch.group =</span> <span class="dv">2</span>,</span>
<span id="cb258-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.batch =</span> <span class="dv">7</span>, </span>
<span id="cb258-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb258-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.trt =</span> <span class="dv">3</span>, </span>
<span id="cb258-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb258-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.bg =</span> <span class="dv">0</span>, </span>
<span id="cb258-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-52" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.bg =</span> <span class="fl">0.2</span>, </span>
<span id="cb258-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-53" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">N =</span> <span class="dv">40</span>, </span>
<span id="cb258-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb258-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_trt_relevant =</span> <span class="dv">100</span>, </span>
<span id="cb258-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_bat_relevant =</span> <span class="dv">200</span>, </span>
<span id="cb258-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_samples =</span> <span class="fl">0.2</span>, </span>
<span id="cb258-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-58" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, </span>
<span id="cb258-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-59" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data.cor =</span> data.cor.res<span class="sc">$</span>data.cor, </span>
<span id="cb258-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-60" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">disp =</span> <span class="dv">10</span>, <span class="at">prob_zero =</span> <span class="dv">0</span>, </span>
<span id="cb258-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-61" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">seeds =</span> i)</span>
<span id="cb258-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(i)</span>
<span id="cb258-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-64" aria-hidden="true" tabindex="-1"></a>  raw_count <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb258-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-65" aria-hidden="true" tabindex="-1"></a>  raw_count_clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb258-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log transformation</span></span>
<span id="cb258-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-68" aria-hidden="true" tabindex="-1"></a>  data_log <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb258-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-69" aria-hidden="true" tabindex="-1"></a>  data_log_clean <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count_clean <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb258-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-71" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb258-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-72" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb258-73"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-74"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-74" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb258-75"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-75" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb258-76"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-77"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-77" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb258-78"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-79"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Original </span><span class="al">###</span></span>
<span id="cb258-80"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-80" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> data_log</span>
<span id="cb258-81"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-82"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Clean data </span><span class="al">###</span></span>
<span id="cb258-83"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-83" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> data_log_clean</span>
<span id="cb258-84"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-85"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">#####</span></span>
<span id="cb258-86"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(X) <span class="ot">=</span> <span class="fu">rownames</span>(X.clean) <span class="ot">=</span> <span class="fu">names</span>(trt) <span class="ot">=</span> <span class="fu">names</span>(batch) <span class="ot">=</span> </span>
<span id="cb258-87"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;sample&#39;</span>, <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb258-88"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-89"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">=</span> <span class="fu">colnames</span>(X.clean) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&#39;otu&#39;</span>, <span class="dv">1</span><span class="sc">:</span>p_total)</span>
<span id="cb258-90"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-91"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb258-92"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-93"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-93" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-94"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-94" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-95"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-95" aria-hidden="true" tabindex="-1"></a>  gvar.before[i,] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-96"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-97"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-98"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-98" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-99"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-99" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-100"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-100" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> </span>
<span id="cb258-101"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-102"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-103"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-103" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb258-104"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span></span>
<span id="cb258-105"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb258-106"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-106" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb258-107"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span></span>
<span id="cb258-108"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-109"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-109" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb258-110"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-110" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb258-111"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-111" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb258-112"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-113"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-113" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-114"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-115"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-115" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-116"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-117"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-117" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-118"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-118" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-119"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-120"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-121"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-122"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-122" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-123"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-123" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-124"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-124" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb258-125"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-125" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-126"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-126" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-127"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-127" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-128"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-128" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-129"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-129" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-130"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-130" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-131"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-132"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-132" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb258-133"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-133" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb258-134"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-135"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-136"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-137"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-137" aria-hidden="true" tabindex="-1"></a>  fit.before_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-138"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-139"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-139" aria-hidden="true" tabindex="-1"></a>  true.response <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p_total)</span>
<span id="cb258-140"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-140" aria-hidden="true" tabindex="-1"></a>  true.response[true.trt] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb258-141"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-141" aria-hidden="true" tabindex="-1"></a>  before.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.before_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-142"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-142" aria-hidden="true" tabindex="-1"></a>  roc.before_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, before.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-143"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-143" aria-hidden="true" tabindex="-1"></a>  auc.before_splsda <span class="ot">&lt;-</span> roc.before_splsda<span class="sc">$</span>auc</span>
<span id="cb258-144"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-145"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-146"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-146" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-147"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-147" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb258-148"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-149"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-149" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-150"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-150" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-151"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-151" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-152"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-153"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-154"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-155"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-155" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-156"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-156" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-157"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-157" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-158"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-159"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-160"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-160" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-161"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span></span>
<span id="cb258-162"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb258-163"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-163" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-164"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb258-165"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-165" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb258-166"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-166" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb258-167"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-167" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb258-168"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-169"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-169" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-170"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-171"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-171" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-172"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-172" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-173"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-173" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-174"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-174" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-175"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-176"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-177"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-178"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-178" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-179"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-179" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-180"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-180" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb258-181"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-181" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-182"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-182" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-183"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-183" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-184"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-184" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-185"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-185" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-186"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-186" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-187"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-188"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-188" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb258-189"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-189" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb258-190"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-191"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-192"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-192" aria-hidden="true" tabindex="-1"></a>  fit.clean_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-193"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-194"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-194" aria-hidden="true" tabindex="-1"></a>  clean.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.clean_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-195"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-195" aria-hidden="true" tabindex="-1"></a>  roc.clean_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, clean.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-196"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-196" aria-hidden="true" tabindex="-1"></a>  auc.clean_splsda <span class="ot">&lt;-</span> roc.clean_splsda<span class="sc">$</span>auc</span>
<span id="cb258-197"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-198"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-198" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-199"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-199" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb258-200"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-200" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb258-201"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-201" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb258-202"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-203"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-203" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-204"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-204" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-205"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-205" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-206"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-206" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-207"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-208"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-208" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-209"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-209" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb258-210"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-210" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-211"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-211" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-212"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-212" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-213"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-214"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-214" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb258-215"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb258-216"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-216" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb258-217"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-218"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-218" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb258-219"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-219" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb258-220"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-221"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-221" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-222"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-223"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-223" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-224"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-224" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-225"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-225" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-226"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-226" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-227"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-228"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-229"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-230"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-230" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-231"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-231" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-232"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-232" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb258-233"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-233" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-234"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-234" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-235"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-235" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-236"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-236" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-237"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-237" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-238"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-238" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-239"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-239" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-240"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-240" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb258-241"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-241" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb258-242"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-243"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-244"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-245"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-245" aria-hidden="true" tabindex="-1"></a>  fit.rbe_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-246"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-247"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-247" aria-hidden="true" tabindex="-1"></a>  rbe.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.rbe_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-248"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-248" aria-hidden="true" tabindex="-1"></a>  roc.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, rbe.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-249"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-249" aria-hidden="true" tabindex="-1"></a>  auc.rbe_splsda <span class="ot">&lt;-</span> roc.rbe_splsda<span class="sc">$</span>auc</span>
<span id="cb258-250"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-250" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-251"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-251" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-252"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-252" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb258-253"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-253" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb258-254"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-254" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb258-255"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-256"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-257"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-257" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-258"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-258" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-259"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-259" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-260"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-260" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-261"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-262"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-262" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb258-263"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-263" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-264"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-264" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-265"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-265" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-266"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-267"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-267" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-268"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-268" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-269"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb258-270"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb258-271"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-271" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb258-272"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb258-273"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-274"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-274" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb258-275"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-275" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb258-276"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-277"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-277" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-278"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-278" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-279"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-279" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-280"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-281"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-281" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-282"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-282" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-283"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-284"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-285"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-286"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-286" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-287"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-287" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-288"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb258-289"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-289" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-290"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-290" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-291"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-291" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-292"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-292" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-293"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-293" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-294"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-294" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-295"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-295" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-296"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-296" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb258-297"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-297" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb258-298"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-299"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-300"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-300" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-301"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-301" aria-hidden="true" tabindex="-1"></a>  fit.combat_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-302"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-303"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-303" aria-hidden="true" tabindex="-1"></a>  combat.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.combat_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-304"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-304" aria-hidden="true" tabindex="-1"></a>  roc.combat_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, combat.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-305"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-305" aria-hidden="true" tabindex="-1"></a>  auc.combat_splsda <span class="ot">&lt;-</span> roc.combat_splsda<span class="sc">$</span>auc</span>
<span id="cb258-306"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-307"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-308"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-308" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-309"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-309" aria-hidden="true" tabindex="-1"></a>  <span class="do">### wPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb258-310"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-310" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb258-311"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-311" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb258-312"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-312" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>,</span>
<span id="cb258-313"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-313" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb258-314"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-314" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch <span class="ot">&lt;-</span> X.wplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb258-315"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-315" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-316"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-317"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-317" aria-hidden="true" tabindex="-1"></a>  rda.wplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.wplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-318"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-318" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-319"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-319" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab[i, ] <span class="ot">&lt;-</span> rda.wplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-320"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-321"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-321" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-322"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-322" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.wplsda_batch)), </span>
<span id="cb258-323"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-323" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-324"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-324" aria-hidden="true" tabindex="-1"></a>  fit.result.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.wplsda_batch), </span>
<span id="cb258-325"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-325" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-326"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-326" aria-hidden="true" tabindex="-1"></a>  otu.sig.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.wplsda_batch)[</span>
<span id="cb258-327"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-327" aria-hidden="true" tabindex="-1"></a>    fit.result.wplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-328"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-329"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-329" aria-hidden="true" tabindex="-1"></a>  precision_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-330"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb258-331"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.wplsda_batch)</span>
<span id="cb258-332"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-332" aria-hidden="true" tabindex="-1"></a>  recall_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-333"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb258-334"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-335"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-335" aria-hidden="true" tabindex="-1"></a>  F1_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-336"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-336" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.wplsda_batch<span class="sc">*</span>recall_limma.wplsda_batch)<span class="sc">/</span></span>
<span id="cb258-337"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-337" aria-hidden="true" tabindex="-1"></a>    (precision_limma.wplsda_batch <span class="sc">+</span> recall_limma.wplsda_batch)</span>
<span id="cb258-338"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-339"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-339" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-340"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-340" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-341"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-341" aria-hidden="true" tabindex="-1"></a>    precision_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-342"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-342" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-343"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-343" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-344"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-344" aria-hidden="true" tabindex="-1"></a>    F1_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-345"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-345" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-346"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-347"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-348"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-348" aria-hidden="true" tabindex="-1"></a>  indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-349"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-349" aria-hidden="true" tabindex="-1"></a>  indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-350"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-350" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.wplsda_batch))){</span>
<span id="cb258-351"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-351" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-352"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-352" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-353"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-353" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-354"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-354" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-355"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-355" aria-hidden="true" tabindex="-1"></a>    indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.wplsda_batch, </span>
<span id="cb258-356"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-356" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-357"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-357" aria-hidden="true" tabindex="-1"></a>    indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.wplsda_batch, </span>
<span id="cb258-358"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-358" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-359"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-359" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-360"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-360" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.wplsda_batch</span>
<span id="cb258-361"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-361" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.wplsda_batch</span>
<span id="cb258-362"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-363"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-363" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-364"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-364" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.wplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-365"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-366"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-366" aria-hidden="true" tabindex="-1"></a>  wplsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.wplsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-367"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-367" aria-hidden="true" tabindex="-1"></a>  roc.wplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb258-368"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-368" aria-hidden="true" tabindex="-1"></a>                                 wplsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-369"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-369" aria-hidden="true" tabindex="-1"></a>  auc.wplsda_batch_splsda <span class="ot">&lt;-</span> roc.wplsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb258-370"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-371"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-371" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-372"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-372" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb258-373"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-373" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb258-374"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-374" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Y.trt =</span> trt, </span>
<span id="cb258-375"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-375" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Y.bat =</span> batch, </span>
<span id="cb258-376"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-376" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb258-377"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-377" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb258-378"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-378" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.bat =</span> <span class="dv">1</span>,</span>
<span id="cb258-379"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-379" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb258-380"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-380" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch <span class="ot">&lt;-</span> X.swplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb258-381"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-382"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-383"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-383" aria-hidden="true" tabindex="-1"></a>  rda.swplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.swplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-384"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-384" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-385"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-385" aria-hidden="true" tabindex="-1"></a>  gvar.swplsdab[i, ] <span class="ot">&lt;-</span> rda.swplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-386"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-387"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-388"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-388" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.swplsda_batch)), </span>
<span id="cb258-389"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-389" aria-hidden="true" tabindex="-1"></a>                             <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-390"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-390" aria-hidden="true" tabindex="-1"></a>  fit.result.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.swplsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb258-391"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-391" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">number =</span> p_total)</span>
<span id="cb258-392"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-392" aria-hidden="true" tabindex="-1"></a>  otu.sig.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.swplsda_batch)[</span>
<span id="cb258-393"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-393" aria-hidden="true" tabindex="-1"></a>    fit.result.swplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-394"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-394" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-395"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-395" aria-hidden="true" tabindex="-1"></a>  precision_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-396"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb258-397"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.swplsda_batch)</span>
<span id="cb258-398"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-398" aria-hidden="true" tabindex="-1"></a>  recall_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-399"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb258-400"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-401"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-401" aria-hidden="true" tabindex="-1"></a>  F1_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-402"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-402" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.swplsda_batch<span class="sc">*</span>recall_limma.swplsda_batch)<span class="sc">/</span></span>
<span id="cb258-403"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-403" aria-hidden="true" tabindex="-1"></a>    (precision_limma.swplsda_batch <span class="sc">+</span> recall_limma.swplsda_batch)</span>
<span id="cb258-404"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-404" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-405"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-405" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-406"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-406" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-407"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-407" aria-hidden="true" tabindex="-1"></a>    precision_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-408"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-408" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-409"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-409" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-410"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-410" aria-hidden="true" tabindex="-1"></a>    F1_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-411"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-411" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-412"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-413"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-414"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-414" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-415"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-415" aria-hidden="true" tabindex="-1"></a>  indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-416"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-416" aria-hidden="true" tabindex="-1"></a>  indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-417"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-417" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.swplsda_batch))){</span>
<span id="cb258-418"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-418" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-419"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-419" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-420"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-420" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-421"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-421" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-422"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-422" aria-hidden="true" tabindex="-1"></a>    indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.swplsda_batch, </span>
<span id="cb258-423"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-423" aria-hidden="true" tabindex="-1"></a>                                 fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-424"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-424" aria-hidden="true" tabindex="-1"></a>    indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.swplsda_batch, </span>
<span id="cb258-425"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-425" aria-hidden="true" tabindex="-1"></a>                                   fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-426"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-426" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-427"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-427" aria-hidden="true" tabindex="-1"></a>  r2.trt.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.swplsda_batch</span>
<span id="cb258-428"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-428" aria-hidden="true" tabindex="-1"></a>  r2.batch.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.swplsda_batch</span>
<span id="cb258-429"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-430"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-431"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-431" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.swplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-432"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-432" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-433"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-433" aria-hidden="true" tabindex="-1"></a>  swplsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.swplsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-434"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-434" aria-hidden="true" tabindex="-1"></a>  roc.swplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb258-435"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-435" aria-hidden="true" tabindex="-1"></a>                                  swplsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-436"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-436" aria-hidden="true" tabindex="-1"></a>  auc.swplsda_batch_splsda <span class="ot">&lt;-</span> roc.swplsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb258-437"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-437" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-438"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-438" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-439"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-439" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb258-440"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-440" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb258-441"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-441" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb258-442"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-442" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb258-443"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-443" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb258-444"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-445"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-445" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-446"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-446" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-447"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-447" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-448"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-448" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-449"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-450"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-450" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-451"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-451" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.plsda_batch)), </span>
<span id="cb258-452"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-452" aria-hidden="true" tabindex="-1"></a>                           <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-453"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-453" aria-hidden="true" tabindex="-1"></a>  fit.result.plsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.plsda_batch), </span>
<span id="cb258-454"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-454" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb258-455"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-455" aria-hidden="true" tabindex="-1"></a>  otu.sig.plsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.plsda_batch)[</span>
<span id="cb258-456"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-456" aria-hidden="true" tabindex="-1"></a>    fit.result.plsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-457"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-457" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-458"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-458" aria-hidden="true" tabindex="-1"></a>  precision_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-459"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-459" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb258-460"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.plsda_batch)</span>
<span id="cb258-461"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-461" aria-hidden="true" tabindex="-1"></a>  recall_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-462"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb258-463"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-464"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-464" aria-hidden="true" tabindex="-1"></a>  F1_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-465"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-465" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.plsda_batch<span class="sc">*</span>recall_limma.plsda_batch)<span class="sc">/</span></span>
<span id="cb258-466"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-466" aria-hidden="true" tabindex="-1"></a>    (precision_limma.plsda_batch <span class="sc">+</span> recall_limma.plsda_batch)</span>
<span id="cb258-467"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-468"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-468" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-469"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-469" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-470"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-470" aria-hidden="true" tabindex="-1"></a>    precision_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-471"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-471" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-472"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-472" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-473"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-473" aria-hidden="true" tabindex="-1"></a>    F1_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-474"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-474" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-475"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-476"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-477"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-477" aria-hidden="true" tabindex="-1"></a>  indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-478"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-478" aria-hidden="true" tabindex="-1"></a>  indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-479"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-479" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.plsda_batch))){</span>
<span id="cb258-480"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-480" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-481"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-481" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-482"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-482" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-483"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-483" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-484"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-484" aria-hidden="true" tabindex="-1"></a>    indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.plsda_batch, </span>
<span id="cb258-485"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-485" aria-hidden="true" tabindex="-1"></a>                               fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-486"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-486" aria-hidden="true" tabindex="-1"></a>    indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.plsda_batch, </span>
<span id="cb258-487"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-487" aria-hidden="true" tabindex="-1"></a>                                 fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-488"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-488" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-489"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-489" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.plsda_batch</span>
<span id="cb258-490"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-490" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.plsda_batch</span>
<span id="cb258-491"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-492"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-492" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-493"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-493" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.plsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-494"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-495"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-495" aria-hidden="true" tabindex="-1"></a>  plsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.plsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-496"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-496" aria-hidden="true" tabindex="-1"></a>  roc.plsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb258-497"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-497" aria-hidden="true" tabindex="-1"></a>                                plsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-498"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-498" aria-hidden="true" tabindex="-1"></a>  auc.plsda_batch_splsda <span class="ot">&lt;-</span> roc.plsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb258-499"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-500"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-500" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-501"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-501" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb258-502"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-502" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb258-503"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-503" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, </span>
<span id="cb258-504"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-504" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.bat =</span> batch, </span>
<span id="cb258-505"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-505" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb258-506"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-506" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb258-507"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-507" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb258-508"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-508" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb258-509"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-510"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-510" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb258-511"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-511" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb258-512"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-512" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb258-513"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-513" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb258-514"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-515"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-515" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-516"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-516" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.splsda_batch)), </span>
<span id="cb258-517"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-517" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb258-518"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-518" aria-hidden="true" tabindex="-1"></a>  fit.result.splsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.splsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb258-519"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-519" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb258-520"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-520" aria-hidden="true" tabindex="-1"></a>  otu.sig.splsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.splsda_batch)[</span>
<span id="cb258-521"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-521" aria-hidden="true" tabindex="-1"></a>    fit.result.splsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb258-522"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-522" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-523"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-523" aria-hidden="true" tabindex="-1"></a>  precision_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-524"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb258-525"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.splsda_batch)</span>
<span id="cb258-526"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-526" aria-hidden="true" tabindex="-1"></a>  recall_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-527"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-527" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb258-528"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb258-529"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-529" aria-hidden="true" tabindex="-1"></a>  F1_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb258-530"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-530" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.splsda_batch<span class="sc">*</span>recall_limma.splsda_batch)<span class="sc">/</span></span>
<span id="cb258-531"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-531" aria-hidden="true" tabindex="-1"></a>    (precision_limma.splsda_batch <span class="sc">+</span> recall_limma.splsda_batch)</span>
<span id="cb258-532"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-532" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-533"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-533" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-534"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-534" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-535"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-535" aria-hidden="true" tabindex="-1"></a>    precision_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-536"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-536" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-537"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-537" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-538"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-538" aria-hidden="true" tabindex="-1"></a>    F1_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-539"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-539" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-540"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-541"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-541" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-542"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-542" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb258-543"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-543" aria-hidden="true" tabindex="-1"></a>  indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-544"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-544" aria-hidden="true" tabindex="-1"></a>  indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb258-545"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-545" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.splsda_batch))){</span>
<span id="cb258-546"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-546" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb258-547"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-547" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb258-548"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-548" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb258-549"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-549" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb258-550"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-550" aria-hidden="true" tabindex="-1"></a>    indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.splsda_batch, </span>
<span id="cb258-551"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-551" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb258-552"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-552" aria-hidden="true" tabindex="-1"></a>    indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.splsda_batch, </span>
<span id="cb258-553"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-553" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb258-554"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-554" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-555"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-555" aria-hidden="true" tabindex="-1"></a>  r2.trt.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.splsda_batch</span>
<span id="cb258-556"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-556" aria-hidden="true" tabindex="-1"></a>  r2.batch.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.splsda_batch</span>
<span id="cb258-557"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-557" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-558"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-558" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb258-559"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-559" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.splsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb258-560"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-560" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-561"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-561" aria-hidden="true" tabindex="-1"></a>  splsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.splsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb258-562"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-562" aria-hidden="true" tabindex="-1"></a>  roc.splsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb258-563"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-563" aria-hidden="true" tabindex="-1"></a>                                 splsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb258-564"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-564" aria-hidden="true" tabindex="-1"></a>  auc.splsda_batch_splsda <span class="ot">&lt;-</span> roc.splsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb258-565"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-566"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-566" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb258-567"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-567" aria-hidden="true" tabindex="-1"></a>  <span class="do">### SVA </span><span class="al">###</span></span>
<span id="cb258-568"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-568" aria-hidden="true" tabindex="-1"></a>  X.mod <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb258-569"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-569" aria-hidden="true" tabindex="-1"></a>  X.mod0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb258-570"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-570" aria-hidden="true" tabindex="-1"></a>  X.sva.n <span class="ot">&lt;-</span> <span class="fu">num.sv</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">mod =</span> X.mod, <span class="at">method =</span> <span class="st">&#39;leek&#39;</span>)</span>
<span id="cb258-571"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-571" aria-hidden="true" tabindex="-1"></a>  X.sva <span class="ot">&lt;-</span> <span class="fu">sva</span>(<span class="fu">t</span>(X), X.mod, X.mod0, <span class="at">n.sv =</span> X.sva.n)</span>
<span id="cb258-572"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-572" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-573"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-573" aria-hidden="true" tabindex="-1"></a>  X.mod.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod, X.sva<span class="sc">$</span>sv)</span>
<span id="cb258-574"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-574" aria-hidden="true" tabindex="-1"></a>  X.mod0.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod0, X.sva<span class="sc">$</span>sv)</span>
<span id="cb258-575"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-575" aria-hidden="true" tabindex="-1"></a>  X.sva.p <span class="ot">&lt;-</span> <span class="fu">f.pvalue</span>(<span class="fu">t</span>(X), X.mod.batch, X.mod0.batch)</span>
<span id="cb258-576"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-576" aria-hidden="true" tabindex="-1"></a>  X.sva.p.adj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(X.sva.p, <span class="at">method =</span> <span class="st">&#39;fdr&#39;</span>)</span>
<span id="cb258-577"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-577" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-578"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-578" aria-hidden="true" tabindex="-1"></a>  otu.sig.sva <span class="ot">&lt;-</span> <span class="fu">which</span>(X.sva.p.adj <span class="sc">&lt;=</span> <span class="fl">0.05</span>)</span>
<span id="cb258-579"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-579" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-580"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-580" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-581"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-581" aria-hidden="true" tabindex="-1"></a>  precision_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb258-582"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(otu.sig.sva)</span>
<span id="cb258-583"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-583" aria-hidden="true" tabindex="-1"></a>  recall_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb258-584"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb258-585"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-585" aria-hidden="true" tabindex="-1"></a>  F1_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb258-586"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-586" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.sva<span class="sc">*</span>recall_limma.sva)<span class="sc">/</span></span>
<span id="cb258-587"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-587" aria-hidden="true" tabindex="-1"></a>    (precision_limma.sva <span class="sc">+</span> recall_limma.sva)</span>
<span id="cb258-588"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-588" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-589"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-589" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb258-590"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-590" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-591"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-591" aria-hidden="true" tabindex="-1"></a>    precision_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-592"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-592" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-593"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-593" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb258-594"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-594" aria-hidden="true" tabindex="-1"></a>    F1_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-595"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-595" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-596"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-597"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-598"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb258-599"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-599" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb258-600"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-600" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb258-601"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-601" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb258-602"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-602" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb258-603"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-603" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb258-604"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-604" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.wplsda_batch,</span>
<span id="cb258-605"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-605" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.swplsda_batch,</span>
<span id="cb258-606"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-606" aria-hidden="true" tabindex="-1"></a>                            <span class="at">SVA =</span> precision_limma.sva)</span>
<span id="cb258-607"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-607" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-608"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-608" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb258-609"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-609" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb258-610"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-610" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb258-611"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-611" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb258-612"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-612" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.wplsda_batch,</span>
<span id="cb258-613"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-613" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.swplsda_batch,</span>
<span id="cb258-614"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-614" aria-hidden="true" tabindex="-1"></a>                         <span class="at">SVA =</span> recall_limma.sva)</span>
<span id="cb258-615"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-615" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-616"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-616" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb258-617"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-617" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb258-618"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-618" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb258-619"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-619" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb258-620"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-620" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.wplsda_batch,</span>
<span id="cb258-621"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-621" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.swplsda_batch,</span>
<span id="cb258-622"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-622" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVA =</span> F1_limma.sva)</span>
<span id="cb258-623"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-623" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-624"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-624" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (splsda)</span></span>
<span id="cb258-625"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-625" aria-hidden="true" tabindex="-1"></a>  auc_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> auc.before_splsda, </span>
<span id="cb258-626"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-626" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> auc.clean_splsda, </span>
<span id="cb258-627"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-627" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> auc.rbe_splsda, </span>
<span id="cb258-628"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-628" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> auc.combat_splsda, </span>
<span id="cb258-629"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-629" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.wplsda_batch_splsda, </span>
<span id="cb258-630"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-630" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.swplsda_batch_splsda)</span>
<span id="cb258-631"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-631" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-632"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-632" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(i)</span></span>
<span id="cb258-633"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-633" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-634"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb258-634" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="figures-3" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> Figures<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb259-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb259-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb259-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb259-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb259-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.wplsdab),</span>
<span id="cb259-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.swplsdab),</span>
<span id="cb259-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb259-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb259-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-11" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb259-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-12" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb259-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb259-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb259-15" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-118"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-118-1.png" alt="Figure 4: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="70%" />
<p class="caption">
Figure 4.4: Figure 4: Simulation studies (two batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<p>For a strong unbalanced batch <span class="math inline">\(\times\)</span> treatment design, we observed the presence of intersectional variance explained by both batch and treatment effects, as expected. This source of variance is also present in the ground-truth data but should be smaller compared to the uncorrected data. Both unweighted PLSDA-batch and sPLSDA-batch performed poorly for such design - for PLSDA-batch the intersectional variance increased while for sPLSDA-batch the batch variance was not entirely removed. The other methods were successful in removing batch variance. removeBatchEffect and ComBat explained a proportion of variance by treatment similar to the ground-truth data, while wPLSDA-batch and swPLSDA-batch explained slightly less treatment variance.</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb260-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb260-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="do">## boxplot</span></span>
<span id="cb260-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb260-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-5" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&#39;Treatment only&#39;</span>, p_trt_relevant), </span>
<span id="cb260-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="st">&#39;Batch only&#39;</span>, (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb260-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-7" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="st">&#39;Treatment &amp; batch&#39;</span></span>
<span id="cb260-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-8" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>p_total, <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="st">&#39;No effect&#39;</span></span>
<span id="cb260-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-10" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">factor</span>(gclass, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;Treatment &amp; batch&#39;</span>, </span>
<span id="cb260-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb260-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Batch only&#39;</span>, </span>
<span id="cb260-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-13" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;No effect&#39;</span>))</span>
<span id="cb260-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-15" aria-hidden="true" tabindex="-1"></a>before.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.before), </span>
<span id="cb260-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.before)), </span>
<span id="cb260-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb260-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-18" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-20" aria-hidden="true" tabindex="-1"></a>clean.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.clean), </span>
<span id="cb260-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-21" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">rowMeans</span>(r2.batch.clean)), </span>
<span id="cb260-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-22" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb260-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-23" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-24" aria-hidden="true" tabindex="-1"></a>                              <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-25" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), </span>
<span id="cb260-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-26" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rowMeans</span>(r2.batch.rbe)), </span>
<span id="cb260-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb260-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-28" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-29" aria-hidden="true" tabindex="-1"></a>                            <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-30" aria-hidden="true" tabindex="-1"></a>combat.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.combat), </span>
<span id="cb260-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-31" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.combat)), </span>
<span id="cb260-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-32" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb260-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-33" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-34" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-35" aria-hidden="true" tabindex="-1"></a>wplsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb260-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.wplsdab), </span>
<span id="cb260-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-37" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.wplsdab)), </span>
<span id="cb260-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb260-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-40" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-41" aria-hidden="true" tabindex="-1"></a>swplsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb260-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.swplsdab), </span>
<span id="cb260-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-43" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.swplsdab)), </span>
<span id="cb260-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-44" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>),</span>
<span id="cb260-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb260-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-46" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb260-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-48" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.ggp, clean.r2.df.ggp,</span>
<span id="cb260-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-49" aria-hidden="true" tabindex="-1"></a>                       rbe.r2.df.ggp, combat.r2.df.ggp,</span>
<span id="cb260-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-50" aria-hidden="true" tabindex="-1"></a>                       wplsda_batch.r2.df.ggp, swplsda_batch.r2.df.ggp)</span>
<span id="cb260-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-52" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb260-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-53" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb260-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-54" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb260-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-55" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb260-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-56" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;wPLSDA-batch&#39;</span>, </span>
<span id="cb260-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-57" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;swPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">600</span>)</span>
<span id="cb260-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-59" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.ggp<span class="sc">$</span>methods, </span>
<span id="cb260-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-60" aria-hidden="true" tabindex="-1"></a>                                <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.ggp<span class="sc">$</span>methods))</span>
<span id="cb260-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-62" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.ggp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb260-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.80</span>) <span class="sc">+</span></span>
<span id="cb260-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb260-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb260-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb260-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb260-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb260-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb260-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb260-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb260-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb260-72" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-119"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-119-1.png" alt="Figure 5: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.5: Figure 5: Simulation studies (two batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb261-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="do">## barplot</span></span>
<span id="cb261-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb261-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-4" aria-hidden="true" tabindex="-1"></a>before.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.before), gclass, sum), </span>
<span id="cb261-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.before), gclass, sum)), </span>
<span id="cb261-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-10" aria-hidden="true" tabindex="-1"></a>clean.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.clean), gclass, sum), </span>
<span id="cb261-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.clean), gclass, sum)), </span>
<span id="cb261-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-16" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), gclass, sum), </span>
<span id="cb261-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-18" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.rbe), gclass, sum)), </span>
<span id="cb261-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-22" aria-hidden="true" tabindex="-1"></a>combat.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.combat), gclass, sum), </span>
<span id="cb261-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-24" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.combat), gclass, sum)), </span>
<span id="cb261-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-28" aria-hidden="true" tabindex="-1"></a>wplsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.wplsdab), gclass, sum), </span>
<span id="cb261-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-30" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.wplsdab), gclass, sum)), </span>
<span id="cb261-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-34" aria-hidden="true" tabindex="-1"></a>swplsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb261-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.swplsdab), gclass, sum), </span>
<span id="cb261-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.swplsdab), gclass, sum)), </span>
<span id="cb261-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb261-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb261-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-41" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.bp, clean.r2.df.bp,</span>
<span id="cb261-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-42" aria-hidden="true" tabindex="-1"></a>                      rbe.r2.df.bp, combat.r2.df.bp,</span>
<span id="cb261-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-43" aria-hidden="true" tabindex="-1"></a>                      wplsda_batch.r2.df.bp, swplsda_batch.r2.df.bp)</span>
<span id="cb261-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-46" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb261-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-47" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb261-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-48" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb261-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-49" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb261-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-50" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;wPLSDA-batch&#39;</span>, </span>
<span id="cb261-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-51" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;swPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">8</span>)</span>
<span id="cb261-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-53" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.bp<span class="sc">$</span>methods, </span>
<span id="cb261-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-54" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.bp<span class="sc">$</span>methods))</span>
<span id="cb261-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.bp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb261-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> </span>
<span id="cb261-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb261-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb261-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb261-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb261-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb261-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb261-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb261-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb261-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb261-66" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-120"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-120-1.png" alt="Figure 6: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.6: Figure 6: Simulation studies (two batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<p>We observed similar performance for removeBatchEffect and ComBat for the unbalanced design compared to the balanced design. With wPLSDA-batch and swPLSDA-batch, variables with both treatment and batch effects explained less treatment variance after correction, compared to the ground-truth data. However, for the other variables, wPLSDA-batch and its sparse version performed as similar as the ground-truth data.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb262-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb262-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb262-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">c</span>(<span class="fu">colMeans</span>(auc_splsda), <span class="at">sva =</span> <span class="cn">NA</span>))</span>
<span id="cb262-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb262-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb262-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb262-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb262-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb262-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb262-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 6 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-121">Table 4.3: </span>Table 6 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="12%" />
<col width="13%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.385</td>
<td align="left">0.973</td>
<td align="left">0.901</td>
<td align="left">0.834</td>
<td align="left">0.943</td>
<td align="left">0.943</td>
<td align="left">0.401</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.825</td>
<td align="left">0.895</td>
<td align="left">0.910</td>
<td align="left">0.919</td>
<td align="left">0.888</td>
<td align="left">0.862</td>
<td align="left">0.918</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.525</td>
<td align="left">0.932</td>
<td align="left">0.903</td>
<td align="left">0.873</td>
<td align="left">0.914</td>
<td align="left">0.900</td>
<td align="left">0.558</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.704</td>
<td align="left">0.967</td>
<td align="left">0.963</td>
<td align="left">0.962</td>
<td align="left">0.965</td>
<td align="left">0.954</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>In the unbalanced design, the precision of SVA is low and very similar to the original data, indicating that the performance of SVA heavily depends on the experimental design and is likely to overfit. This may explain the somewhat inflated results of SVA in the balanced design case. wPLSDA-batch performed best with results close to those from the ground-truth data.</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb263-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb263-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">c</span>(<span class="fu">apply</span>(auc_splsda, <span class="dv">2</span>, sd), <span class="cn">NA</span>))</span>
<span id="cb263-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb263-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb263-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb263-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb263-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb263-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb263-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 7 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-122">Table 4.4: </span>Table 7 Simulation studies (two batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="12%" />
<col width="13%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.01</td>
<td align="left">0.05</td>
<td align="left">0.09</td>
<td align="left">0.08</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.01</td>
<td align="left">0.03</td>
<td align="left">0.05</td>
<td align="left">0.05</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.06</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.01</td>
<td align="left">0.01</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="simulations-three-batch-groups" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Simulations (three batch groups)<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-three-batch-groups" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="balanced-batch-times-treatment-design-2" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Balanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The balanced batch <span class="math inline">\(\times\)</span> treatment experimental design included 6 samples from three batches respectively in each treatment group.</p>
<p><strong>Table 8: Balanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
<tr class="odd">
<td align="center">Batch3</td>
<td align="center">6</td>
<td align="center">6</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb264-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">36</span></span>
<span id="cb264-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-3" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">=</span> <span class="dv">300</span></span>
<span id="cb264-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-4" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">=</span> <span class="dv">100</span> </span>
<span id="cb264-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-5" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">=</span> <span class="dv">200</span> </span>
<span id="cb264-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-7" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb264-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-8" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-9" aria-hidden="true" tabindex="-1"></a>  gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb264-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-10" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab <span class="ot">&lt;-</span> gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb264-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb264-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb264-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-14" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb264-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-15" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-16" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb264-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-17" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab <span class="ot">&lt;-</span> r2.trt.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb264-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-18" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">ncol =</span> nitr))</span>
<span id="cb264-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-19" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-20" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb264-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-21" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab <span class="ot">&lt;-</span> r2.batch.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb264-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-22" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">ncol =</span> nitr))</span>
<span id="cb264-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-24" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-25" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb264-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb264-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb264-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>, </span>
<span id="cb264-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">sva =</span> <span class="cn">NA</span>)</span>
<span id="cb264-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-31" aria-hidden="true" tabindex="-1"></a><span class="co"># auc (splsda)</span></span>
<span id="cb264-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-32" aria-hidden="true" tabindex="-1"></a>auc_splsda <span class="ot">&lt;-</span> </span>
<span id="cb264-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb264-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-34" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb264-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb264-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-38" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">70</span>)</span>
<span id="cb264-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-39" aria-hidden="true" tabindex="-1"></a>data.cor.res <span class="ot">=</span> <span class="fu">corStruct</span>(<span class="at">p =</span> <span class="dv">300</span>, <span class="at">zero_prob =</span> <span class="fl">0.7</span>)</span>
<span id="cb264-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> nitr){</span>
<span id="cb264-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb264-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-43" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_mnegbinom</span>(<span class="at">batch.group =</span> <span class="dv">3</span>,</span>
<span id="cb264-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.batch =</span> <span class="dv">7</span>, </span>
<span id="cb264-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb264-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-46" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.trt =</span> <span class="dv">3</span>, </span>
<span id="cb264-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb264-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.bg =</span> <span class="dv">0</span>, </span>
<span id="cb264-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.bg =</span> <span class="fl">0.2</span>, </span>
<span id="cb264-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">N =</span> <span class="dv">36</span>, </span>
<span id="cb264-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb264-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-52" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_trt_relevant =</span> <span class="dv">100</span>, </span>
<span id="cb264-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-53" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_bat_relevant =</span> <span class="dv">200</span>, </span>
<span id="cb264-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_samples =</span> <span class="fl">0.5</span>, </span>
<span id="cb264-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, </span>
<span id="cb264-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data.cor =</span> data.cor.res<span class="sc">$</span>data.cor, </span>
<span id="cb264-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">disp =</span> <span class="dv">10</span>, <span class="at">prob_zero =</span> <span class="dv">0</span>, </span>
<span id="cb264-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-58" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">seeds =</span> i)</span>
<span id="cb264-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(i)</span>
<span id="cb264-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-61" aria-hidden="true" tabindex="-1"></a>  raw_count <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb264-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-62" aria-hidden="true" tabindex="-1"></a>  raw_count_clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb264-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log transformation</span></span>
<span id="cb264-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-65" aria-hidden="true" tabindex="-1"></a>  data_log <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb264-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-66" aria-hidden="true" tabindex="-1"></a>  data_log_clean <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count_clean <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb264-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-68" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb264-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-69" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb264-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-71" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb264-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-72" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb264-73"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-74"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-74" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb264-75"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-76"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-76" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Original </span><span class="al">###</span></span>
<span id="cb264-77"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-77" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> data_log</span>
<span id="cb264-78"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-79"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Clean data </span><span class="al">###</span></span>
<span id="cb264-80"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-80" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> data_log_clean</span>
<span id="cb264-81"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-82"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">#####</span></span>
<span id="cb264-83"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(X) <span class="ot">=</span> <span class="fu">rownames</span>(X.clean) <span class="ot">=</span> <span class="fu">names</span>(trt) <span class="ot">=</span> <span class="fu">names</span>(batch) <span class="ot">=</span> </span>
<span id="cb264-84"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;sample&#39;</span>, <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb264-85"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-86"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">=</span> <span class="fu">colnames</span>(X.clean) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&#39;otu&#39;</span>, <span class="dv">1</span><span class="sc">:</span>p_total)</span>
<span id="cb264-87"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-88"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-88" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb264-89"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-90"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-90" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-91"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-91" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-92"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-92" aria-hidden="true" tabindex="-1"></a>  gvar.before[i,] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-93"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-94"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-95"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-95" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-96"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-96" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb264-97"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-97" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> </span>
<span id="cb264-98"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb264-99"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-100"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-100" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb264-101"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span></span>
<span id="cb264-102"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb264-103"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-103" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb264-104"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb264-105"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-105" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb264-106"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-106" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb264-107"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-107" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb264-108"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-109"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-109" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-110"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-111"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-111" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-112"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-113"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-114"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-114" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-115"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-116"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-117"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-118"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-118" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-119"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-119" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-120"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb264-121"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-121" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-122"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-122" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-123"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-123" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-124"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-124" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-125"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-125" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-126"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-126" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-127"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-128"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-128" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb264-129"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-129" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb264-130"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-131"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-132"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-133"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-133" aria-hidden="true" tabindex="-1"></a>  fit.before_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-134"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-135"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-135" aria-hidden="true" tabindex="-1"></a>  true.response <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p_total)</span>
<span id="cb264-136"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-136" aria-hidden="true" tabindex="-1"></a>  true.response[true.trt] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb264-137"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-137" aria-hidden="true" tabindex="-1"></a>  before.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.before_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-138"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-138" aria-hidden="true" tabindex="-1"></a>  roc.before_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, before.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-139"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-139" aria-hidden="true" tabindex="-1"></a>  auc.before_splsda <span class="ot">&lt;-</span> roc.before_splsda<span class="sc">$</span>auc</span>
<span id="cb264-140"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-141"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-142"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-142" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-143"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-143" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb264-144"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-145"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-145" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-146"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-146" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-147"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-147" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-148"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-149"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-150"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-151"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-151" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-152"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-152" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb264-153"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-153" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-154"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb264-155"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-156"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-156" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-157"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span></span>
<span id="cb264-158"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb264-159"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-159" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean<span class="ot">&lt;-</span> </span>
<span id="cb264-160"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb264-161"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-161" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb264-162"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-162" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb264-163"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-163" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb264-164"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-165"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-165" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-166"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-167"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-167" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-168"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-168" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-169"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-170"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-170" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-171"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-172"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-173"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-174"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-174" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-175"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-175" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-176"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-176" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb264-177"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-177" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-178"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-178" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-179"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-179" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-180"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-180" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-181"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-181" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-182"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-182" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-183"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-183" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-184"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-184" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb264-185"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-185" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb264-186"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-187"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-188"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-188" aria-hidden="true" tabindex="-1"></a>  fit.clean_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-189"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-190"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-190" aria-hidden="true" tabindex="-1"></a>  clean.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.clean_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-191"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-191" aria-hidden="true" tabindex="-1"></a>  roc.clean_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, clean.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-192"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-192" aria-hidden="true" tabindex="-1"></a>  auc.clean_splsda <span class="ot">&lt;-</span> roc.clean_splsda<span class="sc">$</span>auc</span>
<span id="cb264-193"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-194"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-194" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-195"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-195" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb264-196"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-196" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb264-197"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-197" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb264-198"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-199"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-200"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-200" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-201"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-201" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-202"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-202" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-203"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-204"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-205"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-205" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb264-206"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-206" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-207"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-207" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb264-208"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-208" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb264-209"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-210"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-210" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb264-211"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-211" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb264-212"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-212" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb264-213"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb264-214"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-214" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb264-215"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-215" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb264-216"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-217"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-217" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-218"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-218" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-219"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-219" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-220"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-220" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-221"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-221" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-222"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-222" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-223"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-223" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-224"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-224" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-225"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-226"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-226" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-227"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-227" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-228"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb264-229"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-229" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-230"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-230" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-231"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-231" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-232"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-232" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-233"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-233" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-234"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-234" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-235"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-236"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-236" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb264-237"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-237" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb264-238"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-239"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-240"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-241"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-241" aria-hidden="true" tabindex="-1"></a>  fit.rbe_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-242"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-243"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-243" aria-hidden="true" tabindex="-1"></a>  rbe.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.rbe_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-244"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-244" aria-hidden="true" tabindex="-1"></a>  roc.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, rbe.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-245"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-245" aria-hidden="true" tabindex="-1"></a>  auc.rbe_splsda <span class="ot">&lt;-</span> roc.rbe_splsda<span class="sc">$</span>auc</span>
<span id="cb264-246"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-247"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-247" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-248"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-248" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb264-249"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-249" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb264-250"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-250" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb264-251"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-252"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-253"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-253" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-254"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-254" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-255"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-255" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-256"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-257"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-257" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-258"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-258" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb264-259"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-259" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-260"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-260" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb264-261"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-261" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> </span>
<span id="cb264-262"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-262" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fl">0.05</span>]</span>
<span id="cb264-263"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-264"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-264" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb264-265"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb264-266"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb264-267"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-267" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb264-268"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb264-269"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb264-270"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-270" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb264-271"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-271" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb264-272"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-272" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-273"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-273" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-274"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-274" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-275"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-275" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-276"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-276" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-277"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-277" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-278"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-278" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-279"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-279" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-280"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-281"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-282"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-282" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-283"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-283" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-284"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-284" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb264-285"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-285" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-286"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-286" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-287"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-287" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-288"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-288" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-289"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-289" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-290"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-290" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-291"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-291" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-292"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-292" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb264-293"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-293" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb264-294"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-294" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-295"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-296"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-296" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-297"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-297" aria-hidden="true" tabindex="-1"></a>  fit.combat_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-298"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-299"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-299" aria-hidden="true" tabindex="-1"></a>  combat.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.combat_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-300"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-300" aria-hidden="true" tabindex="-1"></a>  roc.combat_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, combat.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-301"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-301" aria-hidden="true" tabindex="-1"></a>  auc.combat_splsda <span class="ot">&lt;-</span> roc.combat_splsda<span class="sc">$</span>auc</span>
<span id="cb264-302"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-303"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-304"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-304" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-305"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-305" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb264-306"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-306" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb264-307"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-307" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb264-308"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-308" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">2</span>)</span>
<span id="cb264-309"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-309" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb264-310"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-311"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-311" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-312"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-312" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-313"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-313" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-314"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-314" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-315"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-315" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-316"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-317"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-317" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.plsda_batch)), </span>
<span id="cb264-318"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-318" aria-hidden="true" tabindex="-1"></a>                           <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-319"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-319" aria-hidden="true" tabindex="-1"></a>  fit.result.plsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.plsda_batch), </span>
<span id="cb264-320"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-320" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb264-321"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-321" aria-hidden="true" tabindex="-1"></a>  otu.sig.plsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.plsda_batch)[</span>
<span id="cb264-322"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-322" aria-hidden="true" tabindex="-1"></a>    fit.result.plsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb264-323"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-323" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-324"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-324" aria-hidden="true" tabindex="-1"></a>  precision_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-325"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-325" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb264-326"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.plsda_batch)</span>
<span id="cb264-327"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-327" aria-hidden="true" tabindex="-1"></a>  recall_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-328"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb264-329"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb264-330"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-330" aria-hidden="true" tabindex="-1"></a>  F1_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-331"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-331" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.plsda_batch<span class="sc">*</span>recall_limma.plsda_batch)<span class="sc">/</span></span>
<span id="cb264-332"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-332" aria-hidden="true" tabindex="-1"></a>    (precision_limma.plsda_batch <span class="sc">+</span> recall_limma.plsda_batch)</span>
<span id="cb264-333"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-334"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-334" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-335"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-335" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-336"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-336" aria-hidden="true" tabindex="-1"></a>    precision_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-337"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-337" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-338"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-338" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-339"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-339" aria-hidden="true" tabindex="-1"></a>    F1_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-340"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-340" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-341"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-341" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-342"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-342" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-343"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-343" aria-hidden="true" tabindex="-1"></a>  indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-344"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-344" aria-hidden="true" tabindex="-1"></a>  indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-345"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.plsda_batch))){</span>
<span id="cb264-346"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-346" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-347"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-347" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-348"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-348" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-349"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-349" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-350"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-350" aria-hidden="true" tabindex="-1"></a>    indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.plsda_batch, </span>
<span id="cb264-351"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-351" aria-hidden="true" tabindex="-1"></a>                               fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-352"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-352" aria-hidden="true" tabindex="-1"></a>    indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.plsda_batch, </span>
<span id="cb264-353"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-353" aria-hidden="true" tabindex="-1"></a>                                 fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-354"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-354" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-355"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-355" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.plsda_batch</span>
<span id="cb264-356"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-356" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.plsda_batch</span>
<span id="cb264-357"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-358"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-358" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-359"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-359" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.plsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-360"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-361"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-361" aria-hidden="true" tabindex="-1"></a>  plsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.plsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-362"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-362" aria-hidden="true" tabindex="-1"></a>  roc.plsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb264-363"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-363" aria-hidden="true" tabindex="-1"></a>                                plsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-364"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-364" aria-hidden="true" tabindex="-1"></a>  auc.plsda_batch_splsda <span class="ot">&lt;-</span> roc.plsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb264-365"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-366"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-366" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-367"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-367" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb264-368"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-368" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb264-369"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-369" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, </span>
<span id="cb264-370"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-370" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.bat =</span> batch, </span>
<span id="cb264-371"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-371" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb264-372"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-372" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb264-373"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-373" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">2</span>)</span>
<span id="cb264-374"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-374" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb264-375"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-376"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb264-377"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-377" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb264-378"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-378" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb264-379"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-379" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb264-380"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-380" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-381"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-382"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-382" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.splsda_batch)), </span>
<span id="cb264-383"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-383" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb264-384"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-384" aria-hidden="true" tabindex="-1"></a>  fit.result.splsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.splsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb264-385"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-385" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb264-386"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-386" aria-hidden="true" tabindex="-1"></a>  otu.sig.splsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.splsda_batch)[</span>
<span id="cb264-387"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-387" aria-hidden="true" tabindex="-1"></a>    fit.result.splsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb264-388"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-388" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-389"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-389" aria-hidden="true" tabindex="-1"></a>  precision_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-390"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb264-391"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.splsda_batch)</span>
<span id="cb264-392"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-392" aria-hidden="true" tabindex="-1"></a>  recall_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-393"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb264-394"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-394" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb264-395"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-395" aria-hidden="true" tabindex="-1"></a>  F1_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb264-396"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-396" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.splsda_batch<span class="sc">*</span>recall_limma.splsda_batch)<span class="sc">/</span></span>
<span id="cb264-397"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-397" aria-hidden="true" tabindex="-1"></a>    (precision_limma.splsda_batch <span class="sc">+</span> recall_limma.splsda_batch)</span>
<span id="cb264-398"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-399"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-399" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-400"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-400" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-401"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-401" aria-hidden="true" tabindex="-1"></a>    precision_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-402"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-402" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-403"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-404"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-404" aria-hidden="true" tabindex="-1"></a>    F1_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-405"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-405" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-406"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-407"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-408"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb264-409"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-409" aria-hidden="true" tabindex="-1"></a>  indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-410"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-410" aria-hidden="true" tabindex="-1"></a>  indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb264-411"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-411" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.splsda_batch))){</span>
<span id="cb264-412"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-412" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb264-413"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-413" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb264-414"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-414" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb264-415"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-415" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb264-416"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-416" aria-hidden="true" tabindex="-1"></a>    indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.splsda_batch, </span>
<span id="cb264-417"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-417" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb264-418"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-418" aria-hidden="true" tabindex="-1"></a>    indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.splsda_batch, </span>
<span id="cb264-419"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-419" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb264-420"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-420" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-421"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-421" aria-hidden="true" tabindex="-1"></a>  r2.trt.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.splsda_batch</span>
<span id="cb264-422"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-422" aria-hidden="true" tabindex="-1"></a>  r2.batch.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.splsda_batch</span>
<span id="cb264-423"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-423" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-424"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-424" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb264-425"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-425" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.splsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb264-426"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-426" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-427"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-427" aria-hidden="true" tabindex="-1"></a>  splsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.splsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb264-428"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-428" aria-hidden="true" tabindex="-1"></a>  roc.splsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb264-429"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-429" aria-hidden="true" tabindex="-1"></a>                                 splsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb264-430"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-430" aria-hidden="true" tabindex="-1"></a>  auc.splsda_batch_splsda <span class="ot">&lt;-</span> roc.splsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb264-431"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-431" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-432"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-432" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb264-433"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-433" aria-hidden="true" tabindex="-1"></a>  <span class="do">### SVA </span><span class="al">###</span></span>
<span id="cb264-434"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-434" aria-hidden="true" tabindex="-1"></a>  X.mod <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb264-435"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-435" aria-hidden="true" tabindex="-1"></a>  X.mod0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb264-436"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-436" aria-hidden="true" tabindex="-1"></a>  X.sva.n <span class="ot">&lt;-</span> <span class="fu">num.sv</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">mod =</span> X.mod, <span class="at">method =</span> <span class="st">&#39;leek&#39;</span>)</span>
<span id="cb264-437"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-437" aria-hidden="true" tabindex="-1"></a>  X.sva <span class="ot">&lt;-</span> <span class="fu">sva</span>(<span class="fu">t</span>(X), X.mod, X.mod0, <span class="at">n.sv =</span> X.sva.n)</span>
<span id="cb264-438"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-438" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-439"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-439" aria-hidden="true" tabindex="-1"></a>  X.mod.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod, X.sva<span class="sc">$</span>sv)</span>
<span id="cb264-440"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-440" aria-hidden="true" tabindex="-1"></a>  X.mod0.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod0, X.sva<span class="sc">$</span>sv)</span>
<span id="cb264-441"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-441" aria-hidden="true" tabindex="-1"></a>  X.sva.p <span class="ot">&lt;-</span> <span class="fu">f.pvalue</span>(<span class="fu">t</span>(X), X.mod.batch, X.mod0.batch)</span>
<span id="cb264-442"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-442" aria-hidden="true" tabindex="-1"></a>  X.sva.p.adj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(X.sva.p, <span class="at">method =</span> <span class="st">&#39;fdr&#39;</span>)</span>
<span id="cb264-443"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-443" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-444"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-444" aria-hidden="true" tabindex="-1"></a>  otu.sig.sva <span class="ot">&lt;-</span> <span class="fu">which</span>(X.sva.p.adj <span class="sc">&lt;=</span> <span class="fl">0.05</span>)</span>
<span id="cb264-445"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-445" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-446"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-446" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-447"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-447" aria-hidden="true" tabindex="-1"></a>  precision_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb264-448"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(otu.sig.sva)</span>
<span id="cb264-449"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-449" aria-hidden="true" tabindex="-1"></a>  recall_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb264-450"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb264-451"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-451" aria-hidden="true" tabindex="-1"></a>  F1_limma.sva <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.sva<span class="sc">*</span>recall_limma.sva)<span class="sc">/</span></span>
<span id="cb264-452"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-452" aria-hidden="true" tabindex="-1"></a>    (precision_limma.sva <span class="sc">+</span> recall_limma.sva)</span>
<span id="cb264-453"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-453" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-454"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-454" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb264-455"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-455" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-456"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-456" aria-hidden="true" tabindex="-1"></a>    precision_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-457"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-457" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-458"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-458" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb264-459"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-459" aria-hidden="true" tabindex="-1"></a>    F1_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb264-460"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-460" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb264-461"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-462"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-463"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb264-464"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-464" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb264-465"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-465" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb264-466"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-466" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb264-467"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-467" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb264-468"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-468" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb264-469"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-469" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.plsda_batch,</span>
<span id="cb264-470"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-470" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.splsda_batch,</span>
<span id="cb264-471"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-471" aria-hidden="true" tabindex="-1"></a>                            <span class="at">SVA =</span> precision_limma.sva)</span>
<span id="cb264-472"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-472" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-473"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-473" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb264-474"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-474" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb264-475"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-475" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb264-476"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-476" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb264-477"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-477" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.plsda_batch,</span>
<span id="cb264-478"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-478" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.splsda_batch,</span>
<span id="cb264-479"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-479" aria-hidden="true" tabindex="-1"></a>                         <span class="at">SVA =</span> recall_limma.sva)</span>
<span id="cb264-480"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-480" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-481"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-481" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb264-482"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-482" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb264-483"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-483" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb264-484"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-484" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb264-485"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-485" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.plsda_batch,</span>
<span id="cb264-486"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-486" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.splsda_batch,</span>
<span id="cb264-487"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-487" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVA =</span> F1_limma.sva)</span>
<span id="cb264-488"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-488" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-489"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-489" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (splsda)</span></span>
<span id="cb264-490"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-490" aria-hidden="true" tabindex="-1"></a>  auc_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> auc.before_splsda, </span>
<span id="cb264-491"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-491" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> auc.clean_splsda, </span>
<span id="cb264-492"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-492" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> auc.rbe_splsda, </span>
<span id="cb264-493"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-493" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> auc.combat_splsda, </span>
<span id="cb264-494"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-494" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.plsda_batch_splsda, </span>
<span id="cb264-495"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-495" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.splsda_batch_splsda)</span>
<span id="cb264-496"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-497"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(i)</span></span>
<span id="cb264-498"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-498" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb264-499"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb264-499" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="figures-4" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Figures<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb265-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb265-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb265-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb265-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb265-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb265-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb265-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-9" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb265-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-10" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb265-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb265-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb265-13" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-125"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-125-1.png" alt="Figure 7: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%" />
<p class="caption">
Figure 4.7: Figure 7: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb266-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb266-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="do">## boxplot</span></span>
<span id="cb266-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-4" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb266-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-5" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&#39;Treatment only&#39;</span>, p_trt_relevant), </span>
<span id="cb266-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="st">&#39;Batch only&#39;</span>, (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb266-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-7" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="st">&#39;Treatment &amp; batch&#39;</span></span>
<span id="cb266-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-8" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>p_total, <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="st">&#39;No effect&#39;</span></span>
<span id="cb266-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-10" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">factor</span>(gclass, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;Treatment &amp; batch&#39;</span>, </span>
<span id="cb266-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb266-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Batch only&#39;</span>, </span>
<span id="cb266-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-13" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;No effect&#39;</span>))</span>
<span id="cb266-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-15" aria-hidden="true" tabindex="-1"></a>before.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.before), </span>
<span id="cb266-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.before)), </span>
<span id="cb266-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-18" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-20" aria-hidden="true" tabindex="-1"></a>clean.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.clean), </span>
<span id="cb266-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-21" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">rowMeans</span>(r2.batch.clean)), </span>
<span id="cb266-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-22" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-23" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-24" aria-hidden="true" tabindex="-1"></a>                              <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-25" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), </span>
<span id="cb266-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-26" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rowMeans</span>(r2.batch.rbe)), </span>
<span id="cb266-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-28" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-29" aria-hidden="true" tabindex="-1"></a>                            <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-30" aria-hidden="true" tabindex="-1"></a>combat.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.combat), </span>
<span id="cb266-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-31" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.combat)), </span>
<span id="cb266-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-32" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-33" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-34" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-35" aria-hidden="true" tabindex="-1"></a>plsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb266-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.plsdab), </span>
<span id="cb266-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-37" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.plsdab)), </span>
<span id="cb266-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-40" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-41" aria-hidden="true" tabindex="-1"></a>splsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb266-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.splsdab), </span>
<span id="cb266-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-43" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.splsdab)), </span>
<span id="cb266-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-44" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb266-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb266-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-46" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb266-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-48" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.ggp, clean.r2.df.ggp,</span>
<span id="cb266-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-49" aria-hidden="true" tabindex="-1"></a>                       rbe.r2.df.ggp, combat.r2.df.ggp,</span>
<span id="cb266-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-50" aria-hidden="true" tabindex="-1"></a>                       plsda_batch.r2.df.ggp, splsda_batch.r2.df.ggp)</span>
<span id="cb266-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-52" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb266-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-53" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb266-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-54" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb266-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-55" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb266-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-56" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;PLSDA-batch&#39;</span>, </span>
<span id="cb266-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-57" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;sPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">600</span>)</span>
<span id="cb266-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-59" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.ggp<span class="sc">$</span>methods, </span>
<span id="cb266-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-60" aria-hidden="true" tabindex="-1"></a>                                <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.ggp<span class="sc">$</span>methods))</span>
<span id="cb266-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-62" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.ggp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb266-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.80</span>) <span class="sc">+</span></span>
<span id="cb266-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb266-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb266-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb266-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb266-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb266-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb266-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb266-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb266-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb266-72" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-126"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-126-1.png" alt="Figure 8: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.8: Figure 8: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb267-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="do">## barplot</span></span>
<span id="cb267-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-3" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb267-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-4" aria-hidden="true" tabindex="-1"></a>before.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.before), gclass, sum),</span>
<span id="cb267-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.before), gclass, sum)), </span>
<span id="cb267-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-10" aria-hidden="true" tabindex="-1"></a>clean.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.clean), gclass, sum),</span>
<span id="cb267-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.clean), gclass, sum)), </span>
<span id="cb267-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-16" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), gclass, sum), </span>
<span id="cb267-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-18" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.rbe), gclass, sum)), </span>
<span id="cb267-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-22" aria-hidden="true" tabindex="-1"></a>combat.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.combat), gclass, sum),</span>
<span id="cb267-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-24" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.combat), gclass, sum)), </span>
<span id="cb267-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-28" aria-hidden="true" tabindex="-1"></a>plsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.plsdab), gclass, sum), </span>
<span id="cb267-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-30" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.plsdab), gclass, sum)), </span>
<span id="cb267-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-34" aria-hidden="true" tabindex="-1"></a>splsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb267-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.splsdab), gclass, sum), </span>
<span id="cb267-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.splsdab), gclass, sum)), </span>
<span id="cb267-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb267-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb267-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-41" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.bp, clean.r2.df.bp,</span>
<span id="cb267-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-42" aria-hidden="true" tabindex="-1"></a>                      rbe.r2.df.bp, combat.r2.df.bp,</span>
<span id="cb267-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-43" aria-hidden="true" tabindex="-1"></a>                      plsda_batch.r2.df.bp, splsda_batch.r2.df.bp)</span>
<span id="cb267-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-46" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb267-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-47" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb267-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-48" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb267-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-49" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb267-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-50" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;PLSDA-batch&#39;</span>, </span>
<span id="cb267-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-51" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;sPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">8</span>)</span>
<span id="cb267-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-53" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.bp<span class="sc">$</span>methods, </span>
<span id="cb267-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-54" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.bp<span class="sc">$</span>methods))</span>
<span id="cb267-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.bp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb267-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> </span>
<span id="cb267-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb267-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb267-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb267-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb267-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb267-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb267-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span></span>
<span id="cb267-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb267-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb267-66" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-127"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-127-1.png" alt="Figure 9: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.9: Figure 9: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb268-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb268-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb268-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">c</span>(<span class="fu">colMeans</span>(auc_splsda), <span class="at">sva =</span> <span class="cn">NA</span>))</span>
<span id="cb268-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb268-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb268-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb268-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb268-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb268-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb268-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 9: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-128">Table 4.5: </span>Table 9: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.986</td>
<td align="left">0.954</td>
<td align="left">0.949</td>
<td align="left">0.940</td>
<td align="left">0.957</td>
<td align="left">0.856</td>
<td align="left">0.964</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.667</td>
<td align="left">0.891</td>
<td align="left">0.902</td>
<td align="left">0.903</td>
<td align="left">0.896</td>
<td align="left">0.884</td>
<td align="left">0.934</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.795</td>
<td align="left">0.920</td>
<td align="left">0.923</td>
<td align="left">0.919</td>
<td align="left">0.924</td>
<td align="left">0.867</td>
<td align="left">0.948</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.940</td>
<td align="left">0.959</td>
<td align="left">0.964</td>
<td align="left">0.964</td>
<td align="left">0.964</td>
<td align="left">0.949</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb269-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb269-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">c</span>(<span class="fu">apply</span>(auc_splsda, <span class="dv">2</span>, sd), <span class="cn">NA</span>))</span>
<span id="cb269-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb269-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb269-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb269-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb269-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb269-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb269-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 10: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-129">Table 4.6: </span>Table 10: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the balanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.03</td>
<td align="left">0.07</td>
<td align="left">0.07</td>
<td align="left">0.08</td>
<td align="left">0.06</td>
<td align="left">0.08</td>
<td align="left">0.02</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.02</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.04</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.01</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="unbalanced-batch-times-treatment-design-2" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The unbalanced design included 2, 10 and 2 samples from batch1, batch2 and batch3 respectively in trt1, 10, 2 and 10 samples from batch1, batch2 and batch3 in trt2.</p>
<p><strong>Table 11: Unbalanced batch</strong> <span class="math inline">\(\times\)</span> treatment design in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">2</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">2</td>
</tr>
<tr class="odd">
<td align="center">Batch3</td>
<td align="center">2</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb270-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">36</span></span>
<span id="cb270-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-3" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">=</span> <span class="dv">300</span></span>
<span id="cb270-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-4" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">=</span> <span class="dv">100</span> </span>
<span id="cb270-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-5" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">=</span> <span class="dv">200</span> </span>
<span id="cb270-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-7" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb270-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-8" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-9" aria-hidden="true" tabindex="-1"></a>  gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-10" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab <span class="ot">&lt;-</span> gvar.swplsdab <span class="ot">&lt;-</span> </span>
<span id="cb270-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-11" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab <span class="ot">&lt;-</span> gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb270-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-12" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb270-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-13" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb270-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-15" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb270-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-16" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-17" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-18" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab <span class="ot">&lt;-</span> r2.trt.swplsdab <span class="ot">&lt;-</span></span>
<span id="cb270-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-19" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab <span class="ot">&lt;-</span> r2.trt.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb270-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-20" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">ncol =</span> nitr))</span>
<span id="cb270-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-21" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-22" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-23" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab <span class="ot">&lt;-</span> r2.batch.swplsdab <span class="ot">&lt;-</span></span>
<span id="cb270-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-24" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab <span class="ot">&lt;-</span> r2.batch.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb270-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-25" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">ncol =</span> nitr))</span>
<span id="cb270-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-27" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-28" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb270-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb270-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb270-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>, </span>
<span id="cb270-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">sva =</span> <span class="cn">NA</span>)</span>
<span id="cb270-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-34" aria-hidden="true" tabindex="-1"></a><span class="co"># auc (splsda)</span></span>
<span id="cb270-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-35" aria-hidden="true" tabindex="-1"></a>auc_splsda <span class="ot">&lt;-</span> </span>
<span id="cb270-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, </span>
<span id="cb270-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb270-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb270-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-41" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">70</span>)</span>
<span id="cb270-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-42" aria-hidden="true" tabindex="-1"></a>data.cor.res <span class="ot">=</span> <span class="fu">corStruct</span>(<span class="at">p =</span> <span class="dv">300</span>, <span class="at">zero_prob =</span> <span class="fl">0.7</span>)</span>
<span id="cb270-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span> nitr){</span>
<span id="cb270-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb270-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-46" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_mnegbinom</span>(<span class="at">batch.group =</span> <span class="dv">3</span>,</span>
<span id="cb270-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.batch =</span> <span class="dv">7</span>, </span>
<span id="cb270-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb270-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.trt =</span> <span class="dv">3</span>, </span>
<span id="cb270-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb270-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.bg =</span> <span class="dv">0</span>, </span>
<span id="cb270-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-52" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sd.bg =</span> <span class="fl">0.2</span>, </span>
<span id="cb270-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-53" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">N =</span> <span class="dv">36</span>, </span>
<span id="cb270-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb270-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_trt_relevant =</span> <span class="dv">100</span>, </span>
<span id="cb270-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">p_bat_relevant =</span> <span class="dv">200</span>, </span>
<span id="cb270-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_samples =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">6</span>, </span>
<span id="cb270-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-58" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, </span>
<span id="cb270-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-59" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data.cor =</span> data.cor.res<span class="sc">$</span>data.cor, </span>
<span id="cb270-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-60" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">disp =</span> <span class="dv">10</span>, <span class="at">prob_zero =</span> <span class="dv">0</span>, </span>
<span id="cb270-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-61" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">seeds =</span> i)</span>
<span id="cb270-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(i)</span>
<span id="cb270-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-64" aria-hidden="true" tabindex="-1"></a>  raw_count <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb270-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-65" aria-hidden="true" tabindex="-1"></a>  raw_count_clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb270-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## log transformation</span></span>
<span id="cb270-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-68" aria-hidden="true" tabindex="-1"></a>  data_log <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb270-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-69" aria-hidden="true" tabindex="-1"></a>  data_log_clean <span class="ot">&lt;-</span> <span class="fu">log</span>(raw_count_clean <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb270-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-71" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb270-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-72" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb270-73"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-74"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-74" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb270-75"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-75" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb270-76"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-77"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-77" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb270-78"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-79"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Original </span><span class="al">###</span></span>
<span id="cb270-80"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-80" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> data_log</span>
<span id="cb270-81"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-82"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Clean data </span><span class="al">###</span></span>
<span id="cb270-83"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-83" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> data_log_clean</span>
<span id="cb270-84"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-85"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-85" aria-hidden="true" tabindex="-1"></a>  <span class="do">#####</span></span>
<span id="cb270-86"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(X) <span class="ot">=</span> <span class="fu">rownames</span>(X.clean) <span class="ot">=</span> <span class="fu">names</span>(trt) <span class="ot">=</span> <span class="fu">names</span>(batch) <span class="ot">=</span> </span>
<span id="cb270-87"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">&#39;sample&#39;</span>, <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb270-88"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-89"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">=</span> <span class="fu">colnames</span>(X.clean) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&#39;otu&#39;</span>, <span class="dv">1</span><span class="sc">:</span>p_total)</span>
<span id="cb270-90"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-91"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb270-92"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-93"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-93" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-94"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-94" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-95"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-95" aria-hidden="true" tabindex="-1"></a>  gvar.before[i,] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-96"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-97"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-98"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-98" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-99"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-99" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-100"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-100" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> </span>
<span id="cb270-101"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-102"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-103"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-103" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb270-104"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span></span>
<span id="cb270-105"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb270-106"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-106" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb270-107"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.before))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb270-108"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-108" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> </span>
<span id="cb270-109"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-109" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb270-110"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-110" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb270-111"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-112"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-112" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-113"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-114"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-114" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-115"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-116"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-117"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-117" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-118"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-119"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-120"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-121"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-121" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-122"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-122" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-123"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb270-124"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-124" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-125"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-125" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-126"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-126" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-127"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-127" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-128"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-128" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-129"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-129" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-130"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-131"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-131" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb270-132"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-132" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb270-133"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-134"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-135"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-136"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-136" aria-hidden="true" tabindex="-1"></a>  fit.before_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-137"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-138"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-138" aria-hidden="true" tabindex="-1"></a>  true.response <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p_total)</span>
<span id="cb270-139"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-139" aria-hidden="true" tabindex="-1"></a>  true.response[true.trt] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb270-140"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-140" aria-hidden="true" tabindex="-1"></a>  before.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.before_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-141"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-141" aria-hidden="true" tabindex="-1"></a>  roc.before_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, before.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-142"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-142" aria-hidden="true" tabindex="-1"></a>  auc.before_splsda <span class="ot">&lt;-</span> roc.before_splsda<span class="sc">$</span>auc</span>
<span id="cb270-143"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-144"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-145"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-145" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-146"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-146" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb270-147"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-148"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-148" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-149"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-149" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-150"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-150" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-151"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-152"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-153"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-154"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-154" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-155"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-155" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-156"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-156" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-157"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-158"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-159"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-159" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-160"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span></span>
<span id="cb270-161"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb270-162"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-162" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-163"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.clean))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb270-164"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-164" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> </span>
<span id="cb270-165"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-165" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb270-166"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-166" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb270-167"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-168"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-168" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-169"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-170"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-170" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-171"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-172"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-172" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-173"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-173" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-174"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-174" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-175"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-176"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-177"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-177" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-178"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-178" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-179"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-179" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb270-180"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-180" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-181"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-181" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-182"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-182" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-183"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-183" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-184"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-184" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-185"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-185" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-186"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-187"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-187" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb270-188"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-188" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb270-189"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-190"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-191"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-191" aria-hidden="true" tabindex="-1"></a>  fit.clean_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-192"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-193"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-193" aria-hidden="true" tabindex="-1"></a>  clean.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.clean_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-194"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-194" aria-hidden="true" tabindex="-1"></a>  roc.clean_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, clean.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-195"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-195" aria-hidden="true" tabindex="-1"></a>  auc.clean_splsda <span class="ot">&lt;-</span> roc.clean_splsda<span class="sc">$</span>auc</span>
<span id="cb270-196"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-197"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-197" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-198"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-198" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb270-199"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-199" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb270-200"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-200" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb270-201"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-202"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-202" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-203"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-203" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-204"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-204" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-205"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-205" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-206"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-207"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-208"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-208" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb270-209"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-209" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-210"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-210" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-211"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-211" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-212"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-213"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-213" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb270-214"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb270-215"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-215" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb270-216"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-217"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-217" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb270-218"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-218" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb270-219"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-220"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-220" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-221"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-221" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-222"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-222" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-223"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-223" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-224"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-224" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-225"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-225" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-226"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-226" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-227"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-228"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-229"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-229" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-230"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-230" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-231"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-231" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb270-232"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-232" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-233"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-233" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-234"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-234" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-235"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-235" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-236"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-236" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-237"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-237" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-238"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-238" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-239"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-239" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb270-240"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-240" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb270-241"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-241" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-242"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-243"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-243" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-244"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-244" aria-hidden="true" tabindex="-1"></a>  fit.rbe_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-245"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-246"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-246" aria-hidden="true" tabindex="-1"></a>  rbe.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.rbe_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-247"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-247" aria-hidden="true" tabindex="-1"></a>  roc.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, rbe.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-248"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-248" aria-hidden="true" tabindex="-1"></a>  auc.rbe_splsda <span class="ot">&lt;-</span> roc.rbe_splsda<span class="sc">$</span>auc</span>
<span id="cb270-249"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-250"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-250" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-251"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-251" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb270-252"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-252" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb270-253"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-253" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb270-254"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-254" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-255"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-255" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-256"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-256" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-257"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-257" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-258"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-258" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-259"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-260"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-261"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-261" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb270-262"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-262" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-263"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-263" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-264"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-264" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-265"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-266"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-266" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-267"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-267" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-268"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb270-269"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb270-270"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-270" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-271"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.combat))<span class="sc">/</span></span>
<span id="cb270-272"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-273"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-273" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> </span>
<span id="cb270-274"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-274" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb270-275"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-275" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb270-276"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-277"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-277" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-278"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-278" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-279"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-279" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-280"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-281"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-281" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-282"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-282" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-283"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-284"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-285"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-286"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-286" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-287"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-287" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-288"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb270-289"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-289" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-290"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-290" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-291"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-291" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-292"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-292" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-293"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-293" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-294"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-294" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-295"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-295" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-296"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-296" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb270-297"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-297" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb270-298"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-299"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-300"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-300" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-301"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-301" aria-hidden="true" tabindex="-1"></a>  fit.combat_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-302"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-303"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-303" aria-hidden="true" tabindex="-1"></a>  combat.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.combat_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-304"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-304" aria-hidden="true" tabindex="-1"></a>  roc.combat_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, combat.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-305"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-305" aria-hidden="true" tabindex="-1"></a>  auc.combat_splsda <span class="ot">&lt;-</span> roc.combat_splsda<span class="sc">$</span>auc</span>
<span id="cb270-306"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-307"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-308"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-308" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-309"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-309" aria-hidden="true" tabindex="-1"></a>  <span class="do">### wPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb270-310"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-310" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb270-311"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-311" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb270-312"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-312" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">2</span>,</span>
<span id="cb270-313"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-313" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb270-314"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-314" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch <span class="ot">&lt;-</span> X.wplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb270-315"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-315" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-316"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-316" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-317"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-317" aria-hidden="true" tabindex="-1"></a>  rda.wplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.wplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-318"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-318" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-319"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-319" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab[i, ] <span class="ot">&lt;-</span> rda.wplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-320"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-321"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-321" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-322"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-322" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.wplsda_batch)), </span>
<span id="cb270-323"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-323" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-324"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-324" aria-hidden="true" tabindex="-1"></a>  fit.result.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.wplsda_batch), </span>
<span id="cb270-325"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-325" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-326"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-326" aria-hidden="true" tabindex="-1"></a>  otu.sig.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.wplsda_batch)[</span>
<span id="cb270-327"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-327" aria-hidden="true" tabindex="-1"></a>    fit.result.wplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-328"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-329"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-329" aria-hidden="true" tabindex="-1"></a>  precision_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-330"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb270-331"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.wplsda_batch)</span>
<span id="cb270-332"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-332" aria-hidden="true" tabindex="-1"></a>  recall_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-333"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb270-334"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-335"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-335" aria-hidden="true" tabindex="-1"></a>  F1_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-336"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-336" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.wplsda_batch<span class="sc">*</span>recall_limma.wplsda_batch)<span class="sc">/</span></span>
<span id="cb270-337"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-337" aria-hidden="true" tabindex="-1"></a>    (precision_limma.wplsda_batch <span class="sc">+</span> recall_limma.wplsda_batch)</span>
<span id="cb270-338"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-339"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-339" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-340"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-340" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-341"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-341" aria-hidden="true" tabindex="-1"></a>    precision_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-342"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-342" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-343"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-343" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-344"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-344" aria-hidden="true" tabindex="-1"></a>    F1_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-345"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-345" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-346"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-347"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-347" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-348"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-348" aria-hidden="true" tabindex="-1"></a>  indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-349"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-349" aria-hidden="true" tabindex="-1"></a>  indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-350"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-350" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.wplsda_batch))){</span>
<span id="cb270-351"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-351" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-352"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-352" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-353"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-353" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-354"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-354" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-355"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-355" aria-hidden="true" tabindex="-1"></a>    indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.wplsda_batch, </span>
<span id="cb270-356"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-356" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-357"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-357" aria-hidden="true" tabindex="-1"></a>    indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.wplsda_batch, </span>
<span id="cb270-358"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-358" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-359"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-359" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-360"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-360" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.wplsda_batch</span>
<span id="cb270-361"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-361" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.wplsda_batch</span>
<span id="cb270-362"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-363"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-363" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-364"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-364" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.wplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-365"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-366"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-366" aria-hidden="true" tabindex="-1"></a>  wplsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.wplsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-367"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-367" aria-hidden="true" tabindex="-1"></a>  roc.wplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb270-368"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-368" aria-hidden="true" tabindex="-1"></a>                                 wplsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-369"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-369" aria-hidden="true" tabindex="-1"></a>  auc.wplsda_batch_splsda <span class="ot">&lt;-</span> roc.wplsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb270-370"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-371"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-371" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-372"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-372" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb270-373"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-373" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb270-374"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-374" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Y.trt =</span> trt, </span>
<span id="cb270-375"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-375" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Y.bat =</span> batch, </span>
<span id="cb270-376"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-376" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb270-377"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-377" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb270-378"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-378" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.bat =</span> <span class="dv">2</span>,</span>
<span id="cb270-379"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-379" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb270-380"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-380" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch <span class="ot">&lt;-</span> X.swplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb270-381"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-382"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-383"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-383" aria-hidden="true" tabindex="-1"></a>  rda.swplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.swplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-384"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-384" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-385"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-385" aria-hidden="true" tabindex="-1"></a>  gvar.swplsdab[i, ] <span class="ot">&lt;-</span> rda.swplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-386"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-387"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-388"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-388" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.swplsda_batch)), </span>
<span id="cb270-389"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-389" aria-hidden="true" tabindex="-1"></a>                             <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-390"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-390" aria-hidden="true" tabindex="-1"></a>  fit.result.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.swplsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb270-391"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-391" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">number =</span> p_total)</span>
<span id="cb270-392"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-392" aria-hidden="true" tabindex="-1"></a>  otu.sig.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.swplsda_batch)[</span>
<span id="cb270-393"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-393" aria-hidden="true" tabindex="-1"></a>    fit.result.swplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-394"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-394" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-395"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-395" aria-hidden="true" tabindex="-1"></a>  precision_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-396"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb270-397"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.swplsda_batch)</span>
<span id="cb270-398"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-398" aria-hidden="true" tabindex="-1"></a>  recall_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-399"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb270-400"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-401"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-401" aria-hidden="true" tabindex="-1"></a>  F1_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-402"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-402" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.swplsda_batch<span class="sc">*</span>recall_limma.swplsda_batch)<span class="sc">/</span></span>
<span id="cb270-403"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-403" aria-hidden="true" tabindex="-1"></a>    (precision_limma.swplsda_batch <span class="sc">+</span> recall_limma.swplsda_batch)</span>
<span id="cb270-404"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-404" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-405"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-405" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-406"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-406" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-407"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-407" aria-hidden="true" tabindex="-1"></a>    precision_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-408"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-408" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-409"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-409" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-410"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-410" aria-hidden="true" tabindex="-1"></a>    F1_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-411"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-411" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-412"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-413"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-414"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-414" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-415"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-415" aria-hidden="true" tabindex="-1"></a>  indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-416"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-416" aria-hidden="true" tabindex="-1"></a>  indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-417"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-417" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.swplsda_batch))){</span>
<span id="cb270-418"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-418" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-419"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-419" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-420"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-420" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-421"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-421" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-422"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-422" aria-hidden="true" tabindex="-1"></a>    indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.swplsda_batch, </span>
<span id="cb270-423"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-423" aria-hidden="true" tabindex="-1"></a>                                 fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-424"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-424" aria-hidden="true" tabindex="-1"></a>    indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.swplsda_batch, </span>
<span id="cb270-425"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-425" aria-hidden="true" tabindex="-1"></a>                                   fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-426"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-426" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-427"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-427" aria-hidden="true" tabindex="-1"></a>  r2.trt.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.swplsda_batch</span>
<span id="cb270-428"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-428" aria-hidden="true" tabindex="-1"></a>  r2.batch.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.swplsda_batch</span>
<span id="cb270-429"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-430"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-431"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-431" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.swplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-432"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-432" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-433"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-433" aria-hidden="true" tabindex="-1"></a>  swplsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.swplsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-434"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-434" aria-hidden="true" tabindex="-1"></a>  roc.swplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb270-435"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-435" aria-hidden="true" tabindex="-1"></a>                                  swplsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-436"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-436" aria-hidden="true" tabindex="-1"></a>  auc.swplsda_batch_splsda <span class="ot">&lt;-</span> roc.swplsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb270-437"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-437" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-438"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-438" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-439"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-439" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb270-440"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-440" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb270-441"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-441" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb270-442"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-442" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">2</span>)</span>
<span id="cb270-443"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-443" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb270-444"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-445"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-445" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-446"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-446" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-447"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-447" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-448"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-448" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-449"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-450"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-450" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-451"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-451" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.plsda_batch)), </span>
<span id="cb270-452"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-452" aria-hidden="true" tabindex="-1"></a>                           <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-453"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-453" aria-hidden="true" tabindex="-1"></a>  fit.result.plsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.plsda_batch), </span>
<span id="cb270-454"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-454" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">coef =</span> <span class="dv">2</span>, <span class="at">number =</span> p_total)</span>
<span id="cb270-455"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-455" aria-hidden="true" tabindex="-1"></a>  otu.sig.plsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.plsda_batch)[</span>
<span id="cb270-456"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-456" aria-hidden="true" tabindex="-1"></a>    fit.result.plsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-457"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-457" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-458"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-458" aria-hidden="true" tabindex="-1"></a>  precision_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-459"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-459" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb270-460"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.plsda_batch)</span>
<span id="cb270-461"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-461" aria-hidden="true" tabindex="-1"></a>  recall_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-462"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.plsda_batch))<span class="sc">/</span></span>
<span id="cb270-463"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-464"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-464" aria-hidden="true" tabindex="-1"></a>  F1_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-465"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-465" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.plsda_batch<span class="sc">*</span>recall_limma.plsda_batch)<span class="sc">/</span></span>
<span id="cb270-466"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-466" aria-hidden="true" tabindex="-1"></a>    (precision_limma.plsda_batch <span class="sc">+</span> recall_limma.plsda_batch)</span>
<span id="cb270-467"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-468"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-468" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-469"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-469" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-470"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-470" aria-hidden="true" tabindex="-1"></a>    precision_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-471"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-471" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-472"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-472" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-473"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-473" aria-hidden="true" tabindex="-1"></a>    F1_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-474"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-474" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-475"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-476"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-477"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-477" aria-hidden="true" tabindex="-1"></a>  indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-478"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-478" aria-hidden="true" tabindex="-1"></a>  indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-479"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-479" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.plsda_batch))){</span>
<span id="cb270-480"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-480" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-481"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-481" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-482"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-482" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-483"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-483" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-484"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-484" aria-hidden="true" tabindex="-1"></a>    indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.plsda_batch, </span>
<span id="cb270-485"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-485" aria-hidden="true" tabindex="-1"></a>                               fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-486"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-486" aria-hidden="true" tabindex="-1"></a>    indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.plsda_batch, </span>
<span id="cb270-487"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-487" aria-hidden="true" tabindex="-1"></a>                                 fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-488"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-488" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-489"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-489" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.plsda_batch</span>
<span id="cb270-490"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-490" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.plsda_batch</span>
<span id="cb270-491"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-491" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-492"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-492" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-493"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-493" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.plsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-494"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-495"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-495" aria-hidden="true" tabindex="-1"></a>  plsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.plsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-496"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-496" aria-hidden="true" tabindex="-1"></a>  roc.plsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb270-497"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-497" aria-hidden="true" tabindex="-1"></a>                                plsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-498"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-498" aria-hidden="true" tabindex="-1"></a>  auc.plsda_batch_splsda <span class="ot">&lt;-</span> roc.plsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb270-499"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-499" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-500"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-500" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-501"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-501" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb270-502"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-502" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb270-503"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-503" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, </span>
<span id="cb270-504"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-504" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.bat =</span> batch, </span>
<span id="cb270-505"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-505" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb270-506"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-506" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb270-507"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-507" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">2</span>)</span>
<span id="cb270-508"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-508" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb270-509"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-509" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-510"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-510" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb270-511"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-511" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb270-512"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-512" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb270-513"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-513" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb270-514"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-515"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-515" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-516"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-516" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.splsda_batch)), </span>
<span id="cb270-517"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-517" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb270-518"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-518" aria-hidden="true" tabindex="-1"></a>  fit.result.splsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.splsda_batch), <span class="at">coef =</span> <span class="dv">2</span>, </span>
<span id="cb270-519"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-519" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb270-520"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-520" aria-hidden="true" tabindex="-1"></a>  otu.sig.splsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.splsda_batch)[</span>
<span id="cb270-521"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-521" aria-hidden="true" tabindex="-1"></a>    fit.result.splsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb270-522"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-522" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-523"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-523" aria-hidden="true" tabindex="-1"></a>  precision_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-524"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb270-525"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.splsda_batch)</span>
<span id="cb270-526"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-526" aria-hidden="true" tabindex="-1"></a>  recall_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-527"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-527" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(<span class="fu">colnames</span>(X)[true.trt], otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb270-528"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb270-529"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-529" aria-hidden="true" tabindex="-1"></a>  F1_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb270-530"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-530" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.splsda_batch<span class="sc">*</span>recall_limma.splsda_batch)<span class="sc">/</span></span>
<span id="cb270-531"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-531" aria-hidden="true" tabindex="-1"></a>    (precision_limma.splsda_batch <span class="sc">+</span> recall_limma.splsda_batch)</span>
<span id="cb270-532"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-532" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-533"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-533" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-534"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-534" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-535"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-535" aria-hidden="true" tabindex="-1"></a>    precision_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-536"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-536" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-537"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-537" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-538"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-538" aria-hidden="true" tabindex="-1"></a>    F1_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-539"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-539" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-540"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-541"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-541" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-542"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-542" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb270-543"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-543" aria-hidden="true" tabindex="-1"></a>  indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-544"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-544" aria-hidden="true" tabindex="-1"></a>  indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb270-545"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-545" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.splsda_batch))){</span>
<span id="cb270-546"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-546" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb270-547"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-547" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb270-548"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-548" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb270-549"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-549" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb270-550"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-550" aria-hidden="true" tabindex="-1"></a>    indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.splsda_batch, </span>
<span id="cb270-551"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-551" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb270-552"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-552" aria-hidden="true" tabindex="-1"></a>    indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.splsda_batch, </span>
<span id="cb270-553"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-553" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb270-554"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-554" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-555"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-555" aria-hidden="true" tabindex="-1"></a>  r2.trt.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.splsda_batch</span>
<span id="cb270-556"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-556" aria-hidden="true" tabindex="-1"></a>  r2.batch.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.splsda_batch</span>
<span id="cb270-557"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-557" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-558"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-558" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (sPLSDA)</span></span>
<span id="cb270-559"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-559" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch_plsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.splsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>)</span>
<span id="cb270-560"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-560" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-561"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-561" aria-hidden="true" tabindex="-1"></a>  splsda_batch.predictor <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">abs</span>(fit.splsda_batch_plsda<span class="sc">$</span>loadings<span class="sc">$</span>X))</span>
<span id="cb270-562"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-562" aria-hidden="true" tabindex="-1"></a>  roc.splsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">roc</span>(true.response, </span>
<span id="cb270-563"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-563" aria-hidden="true" tabindex="-1"></a>                                 splsda_batch.predictor, <span class="at">auc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-564"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-564" aria-hidden="true" tabindex="-1"></a>  auc.splsda_batch_splsda <span class="ot">&lt;-</span> roc.splsda_batch_splsda<span class="sc">$</span>auc</span>
<span id="cb270-565"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-566"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-566" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb270-567"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-567" aria-hidden="true" tabindex="-1"></a>  <span class="do">### SVA </span><span class="al">###</span></span>
<span id="cb270-568"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-568" aria-hidden="true" tabindex="-1"></a>  X.mod <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb270-569"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-569" aria-hidden="true" tabindex="-1"></a>  X.mod0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> <span class="fu">as.factor</span>(trt))</span>
<span id="cb270-570"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-570" aria-hidden="true" tabindex="-1"></a>  X.sva.n <span class="ot">&lt;-</span> <span class="fu">num.sv</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">mod =</span> X.mod, <span class="at">method =</span> <span class="st">&#39;leek&#39;</span>)</span>
<span id="cb270-571"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-571" aria-hidden="true" tabindex="-1"></a>  X.sva <span class="ot">&lt;-</span> <span class="fu">sva</span>(<span class="fu">t</span>(X), X.mod, X.mod0, <span class="at">n.sv =</span> X.sva.n)</span>
<span id="cb270-572"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-572" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-573"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-573" aria-hidden="true" tabindex="-1"></a>  X.mod.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod, X.sva<span class="sc">$</span>sv)</span>
<span id="cb270-574"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-574" aria-hidden="true" tabindex="-1"></a>  X.mod0.batch <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X.mod0, X.sva<span class="sc">$</span>sv)</span>
<span id="cb270-575"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-575" aria-hidden="true" tabindex="-1"></a>  X.sva.p <span class="ot">&lt;-</span> <span class="fu">f.pvalue</span>(<span class="fu">t</span>(X), X.mod.batch, X.mod0.batch)</span>
<span id="cb270-576"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-576" aria-hidden="true" tabindex="-1"></a>  X.sva.p.adj <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(X.sva.p, <span class="at">method =</span> <span class="st">&#39;fdr&#39;</span>)</span>
<span id="cb270-577"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-577" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-578"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-578" aria-hidden="true" tabindex="-1"></a>  otu.sig.sva <span class="ot">&lt;-</span> <span class="fu">which</span>(X.sva.p.adj <span class="sc">&lt;=</span> <span class="fl">0.05</span>)</span>
<span id="cb270-579"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-579" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-580"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-580" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-581"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-581" aria-hidden="true" tabindex="-1"></a>  precision_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb270-582"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(otu.sig.sva)</span>
<span id="cb270-583"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-583" aria-hidden="true" tabindex="-1"></a>  recall_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb270-584"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.sva))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb270-585"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-585" aria-hidden="true" tabindex="-1"></a>  F1_limma.sva <span class="ot">&lt;-</span> </span>
<span id="cb270-586"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-586" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.sva<span class="sc">*</span>recall_limma.sva)<span class="sc">/</span></span>
<span id="cb270-587"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-587" aria-hidden="true" tabindex="-1"></a>    (precision_limma.sva <span class="sc">+</span> recall_limma.sva)</span>
<span id="cb270-588"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-588" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-589"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-589" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb270-590"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-590" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-591"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-591" aria-hidden="true" tabindex="-1"></a>    precision_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-592"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-592" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-593"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-593" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.sva <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb270-594"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-594" aria-hidden="true" tabindex="-1"></a>    F1_limma.sva <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-595"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-595" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-596"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-597"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-597" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-598"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-598" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb270-599"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-599" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb270-600"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-600" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb270-601"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-601" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb270-602"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-602" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb270-603"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-603" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb270-604"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-604" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.wplsda_batch,</span>
<span id="cb270-605"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-605" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.swplsda_batch,</span>
<span id="cb270-606"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-606" aria-hidden="true" tabindex="-1"></a>                            <span class="at">SVA =</span> precision_limma.sva)</span>
<span id="cb270-607"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-607" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-608"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-608" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb270-609"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-609" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb270-610"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-610" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb270-611"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-611" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb270-612"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-612" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.wplsda_batch,</span>
<span id="cb270-613"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-613" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.swplsda_batch,</span>
<span id="cb270-614"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-614" aria-hidden="true" tabindex="-1"></a>                         <span class="at">SVA =</span> recall_limma.sva)</span>
<span id="cb270-615"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-615" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-616"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-616" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb270-617"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-617" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb270-618"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-618" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb270-619"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-619" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb270-620"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-620" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.wplsda_batch,</span>
<span id="cb270-621"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-621" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.swplsda_batch,</span>
<span id="cb270-622"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-622" aria-hidden="true" tabindex="-1"></a>                     <span class="at">SVA =</span> F1_limma.sva)</span>
<span id="cb270-623"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-623" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-624"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-624" aria-hidden="true" tabindex="-1"></a>  <span class="co"># auc (splsda)</span></span>
<span id="cb270-625"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-625" aria-hidden="true" tabindex="-1"></a>  auc_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> auc.before_splsda, </span>
<span id="cb270-626"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-626" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> auc.clean_splsda, </span>
<span id="cb270-627"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-627" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> auc.rbe_splsda, </span>
<span id="cb270-628"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-628" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> auc.combat_splsda, </span>
<span id="cb270-629"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-629" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.wplsda_batch_splsda, </span>
<span id="cb270-630"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-630" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> auc.swplsda_batch_splsda)</span>
<span id="cb270-631"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-631" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-632"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-632" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  print(i)</span></span>
<span id="cb270-633"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-633" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb270-634"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb270-634" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="figures-5" class="section level3 hasAnchor" number="4.3.4">
<h3><span class="header-section-number">4.3.4</span> Figures<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb271-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb271-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb271-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb271-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb271-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.wplsdab),</span>
<span id="cb271-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.swplsdab),</span>
<span id="cb271-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb271-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb271-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-11" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb271-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-12" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb271-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb271-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb271-15" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-132"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-132-1.png" alt="Figure 10: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="70%" />
<p class="caption">
Figure 4.10: Figure 10: Simulation studies (three batch groups): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb272-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb272-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="do">## boxplot</span></span>
<span id="cb272-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-4" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb272-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-5" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&#39;Treatment only&#39;</span>, p_trt_relevant), </span>
<span id="cb272-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="st">&#39;Batch only&#39;</span>, (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb272-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-7" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="st">&#39;Treatment &amp; batch&#39;</span></span>
<span id="cb272-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-8" aria-hidden="true" tabindex="-1"></a>gclass[<span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>p_total, <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="st">&#39;No effect&#39;</span></span>
<span id="cb272-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-10" aria-hidden="true" tabindex="-1"></a>gclass <span class="ot">&lt;-</span> <span class="fu">factor</span>(gclass, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;Treatment &amp; batch&#39;</span>, </span>
<span id="cb272-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-11" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb272-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-12" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;Batch only&#39;</span>, </span>
<span id="cb272-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-13" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;No effect&#39;</span>))</span>
<span id="cb272-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-15" aria-hidden="true" tabindex="-1"></a>before.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.before), </span>
<span id="cb272-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.before)), </span>
<span id="cb272-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb272-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-18" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-20" aria-hidden="true" tabindex="-1"></a>clean.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.clean), </span>
<span id="cb272-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-21" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">rowMeans</span>(r2.batch.clean)), </span>
<span id="cb272-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-22" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb272-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-23" aria-hidden="true" tabindex="-1"></a>                                                   <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-24" aria-hidden="true" tabindex="-1"></a>                              <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-25" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), </span>
<span id="cb272-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-26" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rowMeans</span>(r2.batch.rbe)), </span>
<span id="cb272-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-27" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb272-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-28" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-29" aria-hidden="true" tabindex="-1"></a>                            <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-30" aria-hidden="true" tabindex="-1"></a>combat.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.combat), </span>
<span id="cb272-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-31" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rowMeans</span>(r2.batch.combat)), </span>
<span id="cb272-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-32" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb272-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-33" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-34" aria-hidden="true" tabindex="-1"></a>                               <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-35" aria-hidden="true" tabindex="-1"></a>wplsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb272-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.wplsdab), </span>
<span id="cb272-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-37" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.wplsdab)), </span>
<span id="cb272-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), </span>
<span id="cb272-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-40" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-41" aria-hidden="true" tabindex="-1"></a>swplsda_batch.r2.df.ggp <span class="ot">&lt;-</span> </span>
<span id="cb272-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">rowMeans</span>(r2.trt.swplsdab), </span>
<span id="cb272-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-43" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rowMeans</span>(r2.batch.swplsdab)), </span>
<span id="cb272-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-44" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>),</span>
<span id="cb272-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">each =</span> <span class="dv">300</span>)),</span>
<span id="cb272-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-46" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">rep</span>(gclass,<span class="dv">2</span>))</span>
<span id="cb272-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-48" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.ggp, clean.r2.df.ggp,</span>
<span id="cb272-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-49" aria-hidden="true" tabindex="-1"></a>                       rbe.r2.df.ggp, combat.r2.df.ggp,</span>
<span id="cb272-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-50" aria-hidden="true" tabindex="-1"></a>                       wplsda_batch.r2.df.ggp, swplsda_batch.r2.df.ggp)</span>
<span id="cb272-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-52" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb272-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-53" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb272-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-54" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb272-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-55" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb272-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-56" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;wPLSDA-batch&#39;</span>, </span>
<span id="cb272-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-57" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;swPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">600</span>)</span>
<span id="cb272-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-59" aria-hidden="true" tabindex="-1"></a>all.r2.df.ggp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.ggp<span class="sc">$</span>methods, </span>
<span id="cb272-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-60" aria-hidden="true" tabindex="-1"></a>                                <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.ggp<span class="sc">$</span>methods))</span>
<span id="cb272-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-62" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.ggp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb272-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.80</span>) <span class="sc">+</span></span>
<span id="cb272-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb272-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb272-66"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb272-67"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb272-68"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb272-69"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb272-70"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb272-71"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb272-72"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb272-72" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-133"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-133-1.png" alt="Figure 11: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.11: Figure 11: Simulation studies (three batch groups): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb273-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="do">## barplot</span></span>
<span id="cb273-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-3" aria-hidden="true" tabindex="-1"></a><span class="co"># class</span></span>
<span id="cb273-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-4" aria-hidden="true" tabindex="-1"></a>before.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.before), gclass, sum), </span>
<span id="cb273-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.before), gclass, sum)), </span>
<span id="cb273-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-10" aria-hidden="true" tabindex="-1"></a>clean.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-11"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.clean), gclass, sum), </span>
<span id="cb273-12"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-12" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.clean), gclass, sum)), </span>
<span id="cb273-13"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-14"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-15"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-16"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-16" aria-hidden="true" tabindex="-1"></a>rbe.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-17"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), gclass, sum), </span>
<span id="cb273-18"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-18" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.rbe), gclass, sum)), </span>
<span id="cb273-19"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-20"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-21"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-22"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-22" aria-hidden="true" tabindex="-1"></a>combat.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-23"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.combat), gclass, sum), </span>
<span id="cb273-24"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-24" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.combat), gclass, sum)), </span>
<span id="cb273-25"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-26"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-27"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-28"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-28" aria-hidden="true" tabindex="-1"></a>wplsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-29"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.wplsdab), gclass, sum), </span>
<span id="cb273-30"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-30" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.wplsdab), gclass, sum)), </span>
<span id="cb273-31"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-32"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-32" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-33"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-34"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-34" aria-hidden="true" tabindex="-1"></a>swplsda_batch.r2.df.bp <span class="ot">&lt;-</span> </span>
<span id="cb273-35"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">r2 =</span> <span class="fu">c</span>(<span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.trt.swplsdab), gclass, sum), </span>
<span id="cb273-36"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-36" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">tapply</span>(<span class="fu">rowMeans</span>(r2.batch.swplsdab), gclass, sum)), </span>
<span id="cb273-37"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-37" aria-hidden="true" tabindex="-1"></a>             <span class="at">type =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>,<span class="st">&#39;Batch&#39;</span>), <span class="at">each =</span> <span class="dv">4</span>)),</span>
<span id="cb273-38"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-38" aria-hidden="true" tabindex="-1"></a>             <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">levels</span>(gclass),<span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(gclass)))</span>
<span id="cb273-39"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-40"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-41"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-41" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(before.r2.df.bp, clean.r2.df.bp,</span>
<span id="cb273-42"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-42" aria-hidden="true" tabindex="-1"></a>                      rbe.r2.df.bp, combat.r2.df.bp,</span>
<span id="cb273-43"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-43" aria-hidden="true" tabindex="-1"></a>                      wplsda_batch.r2.df.bp, swplsda_batch.r2.df.bp)</span>
<span id="cb273-44"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-45"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-46"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-46" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, </span>
<span id="cb273-47"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-47" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb273-48"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-48" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;removeBatchEffect&#39;</span>, </span>
<span id="cb273-49"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-49" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;ComBat&#39;</span>,</span>
<span id="cb273-50"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-50" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>), <span class="at">each =</span> <span class="dv">8</span>)</span>
<span id="cb273-51"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-52"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-52" aria-hidden="true" tabindex="-1"></a>all.r2.df.bp<span class="sc">$</span>methods <span class="ot">&lt;-</span> <span class="fu">factor</span>(all.r2.df.bp<span class="sc">$</span>methods, </span>
<span id="cb273-53"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-53" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">unique</span>(all.r2.df.bp<span class="sc">$</span>methods))</span>
<span id="cb273-54"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-55"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-55" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all.r2.df.bp, <span class="fu">aes</span>(<span class="at">x =</span> type, <span class="at">y =</span> r2, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb273-56"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span> </span>
<span id="cb273-57"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb273-58"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb273-59"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb273-60"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb273-61"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb273-62"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb273-63"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;right&quot;</span>) <span class="sc">+</span> <span class="fu">facet_grid</span>(class <span class="sc">~</span> methods) <span class="sc">+</span> </span>
<span id="cb273-64"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&#39;dark gray&#39;</span>, <span class="fu">color.mixo</span>(<span class="dv">4</span>), </span>
<span id="cb273-65"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb273-65" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">color.mixo</span>(<span class="dv">5</span>), <span class="fu">color.mixo</span>(<span class="dv">9</span>)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-134"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-134-1.png" alt="Figure 12: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%" />
<p class="caption">
Figure 4.12: Figure 12: Simulation studies (three batch groups): the sum of R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb274-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb274-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb274-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">c</span>(<span class="fu">colMeans</span>(auc_splsda), <span class="at">sva =</span> <span class="cn">NA</span>))</span>
<span id="cb274-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb274-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb274-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb274-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb274-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb274-10"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb274-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 12: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-135">Table 4.7: </span>Table 12: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (mean).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="12%" />
<col width="13%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.637</td>
<td align="left">0.972</td>
<td align="left">0.862</td>
<td align="left">0.834</td>
<td align="left">0.915</td>
<td align="left">0.863</td>
<td align="left">0.648</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.811</td>
<td align="left">0.884</td>
<td align="left">0.897</td>
<td align="left">0.904</td>
<td align="left">0.855</td>
<td align="left">0.844</td>
<td align="left">0.872</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.713</td>
<td align="left">0.925</td>
<td align="left">0.874</td>
<td align="left">0.863</td>
<td align="left">0.882</td>
<td align="left">0.850</td>
<td align="left">0.725</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.826</td>
<td align="left">0.963</td>
<td align="left">0.954</td>
<td align="left">0.955</td>
<td align="left">0.948</td>
<td align="left">0.923</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb275-2"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb275-3"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">c</span>(<span class="fu">apply</span>(auc_splsda, <span class="dv">2</span>, sd), <span class="cn">NA</span>))</span>
<span id="cb275-4"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;AUC&#39;</span>)</span>
<span id="cb275-5"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb275-6"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb275-7"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>, <span class="st">&#39;SVA&#39;</span>)</span>
<span id="cb275-8"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb275-9"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#cb275-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 13: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-136">Table 4.8: </span>Table 13: Simulation studies (three batch groups): summary of accuracy measurements before and after batch effect correction for the unbalanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="9%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="6%" />
<col width="12%" />
<col width="13%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
<th align="left">SVA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.12</td>
<td align="left">0.12</td>
<td align="left">0.08</td>
<td align="left">0.10</td>
<td align="left">0.08</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.04</td>
<td align="left">0.03</td>
<td align="left">0.16</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.03</td>
<td align="left">0.03</td>
<td align="left">0.07</td>
<td align="left">0.07</td>
<td align="left">0.04</td>
<td align="left">0.06</td>
<td align="left">0.11</td>
</tr>
<tr class="even">
<td align="left">AUC</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">0.02</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="references-3" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> References<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#references-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
<h3>References<a href="references-4.html#references-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-hawinkel2019broken" class="csl-entry">
Hawinkel, Stijn, Federico Mattiello, Luc Bijnens, and Olivier Thas. 2019. <span>“A Broken Promise: Microbiome Differential Abundance Methods Do Not Control the False Discovery Rate.”</span> <em>Briefings in Bioinformatics</em> 20 (1): 210–21.
</div>
<div id="ref-mcgregor2020mdine" class="csl-entry">
McGregor, Kevin, Aurélie Labbe, and Celia MT Greenwood. 2020. <span>“MDiNE: A Model to Estimate Differential Co-Occurrence Networks in Microbiome Studies.”</span> <em>Bioinformatics</em> 36 (6): 1840–47.
</div>
<div id="ref-mcmurdie2014waste" class="csl-entry">
McMurdie, Paul J, and Susan Holmes. 2014. <span>“Waste Not, Want Not: Why Rarefying Microbiome Data Is Inadmissible.”</span> <em>PLoS Computational Biology</em> 10 (4): e1003531.
</div>
<div id="ref-quinn2018understanding" class="csl-entry">
Quinn, Thomas P, Ionas Erb, Mark F Richardson, and Tamsyn M Crowley. 2018. <span>“Understanding Sequencing Data as Compositions: An Outlook and Review.”</span> <em>Bioinformatics</em> 34 (16): 2870–78.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references-4.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PLSDAbatch_workflow.pdf", "PLSDAbatch_workflow.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
