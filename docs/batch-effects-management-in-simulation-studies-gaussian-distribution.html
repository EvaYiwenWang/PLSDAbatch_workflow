<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Batch Effects Management in Simulation Studies (Gaussian Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data</title>
  <meta name="description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Batch Effects Management in Simulation Studies (Gaussian Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  <meta name="github-repo" content="EvaYiwenWang/PLSDAbatch_workflow" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Batch Effects Management in Simulation Studies (Gaussian Distribution) | PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data" />
  
  <meta name="twitter:description" content="Vignette for paper ‘PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data’." />
  



<meta name="date" content="2023-05-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="supplementary-materials-for-batch-effects-management-in-case-studies.html"/>
<link rel="next" href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">PLSDA-batch</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Batch Effects Management in Case Studies</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#case-studies-description"><i class="fa fa-check"></i><b>1.2</b> Case studies description</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#packages-installation-and-loading"><i class="fa fa-check"></i><b>1.3</b> Packages installation and loading</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#data-pre-processing"><i class="fa fa-check"></i><b>1.4</b> Data pre-processing</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="index.html"><a href="index.html#pre-filtering"><i class="fa fa-check"></i><b>1.4.1</b> Pre-filtering</a></li>
<li class="chapter" data-level="1.4.2" data-path="index.html"><a href="index.html#transformation"><i class="fa fa-check"></i><b>1.4.2</b> Transformation</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#batch-effect-detection"><i class="fa fa-check"></i><b>1.5</b> Batch effect detection</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="index.html"><a href="index.html#pca"><i class="fa fa-check"></i><b>1.5.1</b> PCA</a></li>
<li class="chapter" data-level="1.5.2" data-path="index.html"><a href="index.html#boxplots-and-density-plots"><i class="fa fa-check"></i><b>1.5.2</b> Boxplots and density plots</a></li>
<li class="chapter" data-level="1.5.3" data-path="index.html"><a href="index.html#heatmap"><i class="fa fa-check"></i><b>1.5.3</b> Heatmap</a></li>
<li class="chapter" data-level="1.5.4" data-path="index.html"><a href="index.html#prda"><i class="fa fa-check"></i><b>1.5.4</b> pRDA</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#managing-batch-effects"><i class="fa fa-check"></i><b>1.6</b> Managing batch effects</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="index.html"><a href="index.html#accnt"><i class="fa fa-check"></i><b>1.6.1</b> Accounting for batch effects</a></li>
<li class="chapter" data-level="1.6.2" data-path="index.html"><a href="index.html#corrct"><i class="fa fa-check"></i><b>1.6.2</b> Correcting for batch effects</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#assessing-batch-effect-correction"><i class="fa fa-check"></i><b>1.7</b> Assessing batch effect correction</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="index.html"><a href="index.html#methods-that-detect-batch-effects"><i class="fa fa-check"></i><b>1.7.1</b> Methods that detect batch effects</a></li>
<li class="chapter" data-level="1.7.2" data-path="index.html"><a href="index.html#other-methods-1"><i class="fa fa-check"></i><b>1.7.2</b> Other methods</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="index.html"><a href="index.html#variable-selection"><i class="fa fa-check"></i><b>1.8</b> Variable selection</a></li>
<li class="chapter" data-level="1.9" data-path="index.html"><a href="index.html#summary"><i class="fa fa-check"></i><b>1.9</b> Summary</a></li>
<li class="chapter" data-level="1.10" data-path="index.html"><a href="index.html#references"><i class="fa fa-check"></i><b>1.10</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html"><i class="fa fa-check"></i><b>2</b> Supplementary Materials for Batch Effects Management in Case Studies</a>
<ul>
<li class="chapter" data-level="2.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#sponge-data"><i class="fa fa-check"></i><b>2.1</b> Sponge data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-1"><i class="fa fa-check"></i><b>2.1.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.1.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-1"><i class="fa fa-check"></i><b>2.1.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.1.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-1"><i class="fa fa-check"></i><b>2.1.3</b> Managing batch effects</a></li>
<li class="chapter" data-level="2.1.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#assessing-batch-effect-correction-1"><i class="fa fa-check"></i><b>2.1.4</b> Assessing batch effect correction</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#hfhs-data"><i class="fa fa-check"></i><b>2.2</b> HFHS data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-2"><i class="fa fa-check"></i><b>2.2.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.2.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-2"><i class="fa fa-check"></i><b>2.2.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.2.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-2"><i class="fa fa-check"></i><b>2.2.3</b> Managing batch effects</a></li>
<li class="chapter" data-level="2.2.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#assessing-batch-effect-correction-2"><i class="fa fa-check"></i><b>2.2.4</b> Assessing batch effect correction</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#hd-data"><i class="fa fa-check"></i><b>2.3</b> HD data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#data-pre-processing-3"><i class="fa fa-check"></i><b>2.3.1</b> Data pre-processing</a></li>
<li class="chapter" data-level="2.3.2" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#batch-effect-detection-3"><i class="fa fa-check"></i><b>2.3.2</b> Batch effect detection</a></li>
<li class="chapter" data-level="2.3.3" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#managing-batch-effects-3"><i class="fa fa-check"></i><b>2.3.3</b> Managing batch effects</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="supplementary-materials-for-batch-effects-management-in-case-studies.html"><a href="supplementary-materials-for-batch-effects-management-in-case-studies.html#references-1"><i class="fa fa-check"></i><b>2.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><i class="fa fa-check"></i><b>3</b> Batch Effects Management in Simulation Studies (Gaussian Distribution)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#simulations"><i class="fa fa-check"></i><b>3.2</b> Simulations</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#balanced-batch-times-treatment-design"><i class="fa fa-check"></i><b>3.2.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="3.2.2" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures"><i class="fa fa-check"></i><b>3.2.2</b> Figures</a></li>
<li class="chapter" data-level="3.2.3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#unbalanced-batch-times-treatment-design"><i class="fa fa-check"></i><b>3.2.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="3.2.4" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures-1"><i class="fa fa-check"></i><b>3.2.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="batch-effects-management-in-simulation-studies-gaussian-distribution.html"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#references-2"><i class="fa fa-check"></i><b>3.3</b> References</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><i class="fa fa-check"></i><b>4</b> Batch Effects Management in Simulation Studies (Negative Binomial Distribution)</a>
<ul>
<li class="chapter" data-level="4.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-two-batch-groups"><i class="fa fa-check"></i><b>4.2</b> Simulations (two batch groups)</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-1"><i class="fa fa-check"></i><b>4.2.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.2.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-2"><i class="fa fa-check"></i><b>4.2.2</b> Figures</a></li>
<li class="chapter" data-level="4.2.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-1"><i class="fa fa-check"></i><b>4.2.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.2.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-3"><i class="fa fa-check"></i><b>4.2.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#simulations-three-batch-groups"><i class="fa fa-check"></i><b>4.3</b> Simulations (three batch groups)</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#balanced-batch-times-treatment-design-2"><i class="fa fa-check"></i><b>4.3.1</b> Balanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.3.2" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-4"><i class="fa fa-check"></i><b>4.3.2</b> Figures</a></li>
<li class="chapter" data-level="4.3.3" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#unbalanced-batch-times-treatment-design-2"><i class="fa fa-check"></i><b>4.3.3</b> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</a></li>
<li class="chapter" data-level="4.3.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#figures-5"><i class="fa fa-check"></i><b>4.3.4</b> Figures</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html"><a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html#references-3"><i class="fa fa-check"></i><b>4.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-4.html"><a href="references-4.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/EvaYiwenWang/PLSDAbatch_workflow" target="blank">Source codes on github</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">PLSDA-batch: a multivariate framework to correct for batch effects in microbiome data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="batch-effects-management-in-simulation-studies-gaussian-distribution" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Batch Effects Management in Simulation Studies (Gaussian Distribution)<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#batch-effects-management-in-simulation-studies-gaussian-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-1" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Introduction<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#introduction-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We adapted the simulation strategy that is component-based and multivariate from <span class="citation">(<a href="#ref-singh2019diablo" role="doc-biblioref">Singh et al. 2019</a>)</span>. We assumed the input data after filtering follow a lognormal distribution inspired from <span class="citation">(<a href="#ref-weiss2017normalization" role="doc-biblioref">Weiss et al. 2017</a>)</span>, thus after Centered Log Ratio (CLR) transformed follow a Gaussian distribution. Thus, we simulated components from a Gaussian distribution across all samples. The data matrix was generated based on the simulated components and corresponding loading vectors for each variable. Each simulated dataset included 300 variables and 40 samples grouped according to two treatments (trt1 and trt2) and two batches (batch1 and batch2). Different parameters including amount of batch and treatment variability among samples, number of variables with batch and/or treatment effects, balanced and unbalanced batch <span class="math inline">\(\times\)</span> treatment designs were considered and summarised in the table below.</p>
<p><strong>Table 1: Summary of simulation scenarios (Gaussian distribution).</strong> For a given choice of parameters reported in this table, each simulation was repeated 50 times. <span class="math inline">\(M^{(trt)}, M^{(batch)}\)</span> and <span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span> represent the number of variables with treatment, batch, or both effects respectively. <strong>Simu 6</strong> includes parameters reflective of real data.</p>
<table>
<colgroup>
<col width="8%" />
<col width="10%" />
<col width="13%" />
<col width="11%" />
<col width="14%" />
<col width="11%" />
<col width="11%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center"><span class="math inline">\(\mu_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma&#39;_{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(\mu_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(\sigma&#39;_{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(batch)}\)</span></th>
<th align="center"><span class="math inline">\(M^{(trt \ \&amp; \ batch)}\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Simu 1</td>
<td align="center">3</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">{1,4,8}</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simu 2</td>
<td align="center">{3,5,7}</td>
<td align="center">1</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simu 3</td>
<td align="center">3</td>
<td align="center">{1,2,4}</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">Simu 4</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">{30,60,100,150}</td>
<td align="center">150</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">Simu 5</td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">{30,60,100,150}</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center"><strong>Simu 6</strong></td>
<td align="center">3</td>
<td align="center">2</td>
<td align="center">7</td>
<td align="center">8</td>
<td align="center">60</td>
<td align="center">150</td>
<td align="center">{0,18,30,42,60}</td>
</tr>
</tbody>
</table>
<p>We first generated two base components <span class="math inline">\(t^{(trt)}\)</span> and <span class="math inline">\(t^{(batch)}\)</span> to represent the underlying treatment and batch variation across samples in the datasets. The samples with trt1 or trt2 in the component <span class="math inline">\(t^{(trt)}\)</span> were generated from <span class="math inline">\(N(-\mu_{(trt)}, \sigma^{&#39;2}_{(trt)})\)</span> and <span class="math inline">\(N(\mu_{(trt)}, \sigma^{&#39;2}_{(trt)})\)</span> respectively, where <span class="math inline">\(\sigma^{&#39;2}_{(trt)}\)</span> refers to the variability of treatment effect among samples, and similarly for the batch component. We then sampled the corresponding loading vectors <span class="math inline">\(\alpha^{(trt)}\)</span> and <span class="math inline">\(\alpha^{(batch)}\)</span> from a uniform distribution <span class="math inline">\([-0.3, -0.2]\cup [0.2,0.3]\)</span> respectively and scaled them as an unit vector. We subsequently constructed the treatment relevant matrix as <span class="math inline">\(X^{(trt)} = t^{(trt)}(\alpha^{(trt)})^{\top}\)</span> and similarly for the batch relevant matrix.</p>
<p>We also generated background noise <span class="math inline">\(E\)</span> (<span class="math inline">\(E \in \mathbb{R}^{40 \times 300}\)</span>), where each element was randomly sampled from <span class="math inline">\(N(0, 0.2^{2})\)</span>. The final simulated dataset <span class="math inline">\(X_{result}\)</span> was constructed based on the treatment, batch relevant matrices and background noise. Starting with <span class="math inline">\(X_{result} = E\)</span>, we then added different types of variables, such that:</p>
<p><span class="math display">\[X_{result}[ ,\mbox{variables}^{(trt)}] = E[ ,\mbox{variables}^{(trt)}] + X^{(trt)}\]</span>
<span class="math display">\[X_{result}[ ,\mbox{variables}^{(batch)}] = X_{result}[ ,\mbox{variables}^{(batch)}] + X^{(batch)},\]</span> </p>
<p>where variables with treatment or batch effects were randomly indexed in the data.</p>
<p>In addition to the data with batch effects, we also simulated a ground-truth dataset that only included the background noise and treatment but no batch effect to evaluate batch effect corrected datasets.</p>
<p>In these simulation scenarios, for PLSDA-batch we set <span class="math inline">\(C-1\)</span> (or <span class="math inline">\(B-1\)</span>) components associated with treatment (or batch) effects (where <span class="math inline">\(C\)</span> and <span class="math inline">\(B\)</span> represent the total number of treatment and batch groups respectively) as <span class="math inline">\(C-1\)</span> (<span class="math inline">\(B-1\)</span>) components are likely to explain 100% variance in <span class="math inline">\(Y\)</span>. The number of variables with a true treatment effect (<span class="math inline">\(M^{(trt)}\)</span>) is set as the optimal number to select on each treatment component in sPLSDA-batch.</p>
<p>To save space, here we only describe one scenario that we believe is a representative of real data (<span class="math inline">\(M^{(trt \ \&amp; \ batch)} = 30\)</span>, simu 6 in Table 1).</p>
</div>
<div id="simulations" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Simulations<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#simulations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="balanced-batch-times-treatment-design" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Balanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#balanced-batch-times-treatment-design" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The balanced batch <span class="math inline">\(\times\)</span> treatment experimental design included 10 samples from two batches respectively in each treatment group (see Table 2)</p>
<p><strong>Table 2: Balanced batch <span class="math inline">\(\times\)</span> treatment design</strong> in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">10</td>
<td align="center">10</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb240-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-2" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb240-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-3" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb240-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-4" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb240-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-6" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb240-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-7" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb240-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-8" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab <span class="ot">&lt;-</span> gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb240-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb240-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb240-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-12" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb240-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-13" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb240-14"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-14" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab <span class="ot">&lt;-</span> r2.trt.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb240-15"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-15" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">ncol =</span> nitr))</span>
<span id="cb240-16"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-16" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb240-17"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-17" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab <span class="ot">&lt;-</span> r2.batch.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb240-18"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-18" aria-hidden="true" tabindex="-1"></a>                                                           <span class="at">ncol =</span> nitr))</span>
<span id="cb240-19"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-20"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-20" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-21"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-21" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb240-22"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb240-23"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb240-24"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-25"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-25" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-26"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-26" aria-hidden="true" tabindex="-1"></a>precision_splsda <span class="ot">&lt;-</span> recall_splsda <span class="ot">&lt;-</span> F1_splsda <span class="ot">&lt;-</span> </span>
<span id="cb240-27"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb240-28"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">plsda_batch =</span> <span class="cn">NA</span>, <span class="at">splsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb240-29"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-30"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(nitr)){</span>
<span id="cb240-31"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb240-32"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-32" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_Gaussian</span>(<span class="at">mean.batch =</span> <span class="dv">7</span>, <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb240-33"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-33" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mean.trt =</span> <span class="dv">3</span>, <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb240-34"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-34" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">N =</span> <span class="dv">40</span>, <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb240-35"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-35" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p_trt_relevant =</span> <span class="dv">60</span>, </span>
<span id="cb240-36"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-36" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p_bat_relevant =</span> <span class="dv">150</span>, </span>
<span id="cb240-37"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">percentage_overlap_samples =</span> <span class="fl">0.5</span>,</span>
<span id="cb240-38"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, <span class="at">seeds =</span> i)</span>
<span id="cb240-39"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-40"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-40" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb240-41"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-41" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb240-42"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-42" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb240-43"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-43" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb240-44"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-44" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb240-45"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-46"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-46" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb240-47"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-48"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb240-49"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-50"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-50" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-51"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-51" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-52"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-52" aria-hidden="true" tabindex="-1"></a>  gvar.before[i, ] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-53"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-54"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-55"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-55" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-56"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-56" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-57"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb240-58"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-58" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-59"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-59" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-60"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-60" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-61"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-61" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-62"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-62" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-63"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-63" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-64"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-65"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-65" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb240-66"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-66" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb240-67"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-68"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-69"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-69" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-70"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-70" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.before, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-71"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-71" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">number =</span> p_total)</span>
<span id="cb240-72"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-72" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> </span>
<span id="cb240-73"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-73" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fl">0.05</span>]</span>
<span id="cb240-74"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-75"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-75" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.before))<span class="sc">/</span></span>
<span id="cb240-76"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb240-77"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-77" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.before))<span class="sc">/</span></span>
<span id="cb240-78"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-79"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-79" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb240-80"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-80" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb240-81"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-82"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-83"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-84"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-84" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-85"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-86"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-87"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-87" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-88"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-89"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-90"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-91"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-91" aria-hidden="true" tabindex="-1"></a>  fit.before_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-92"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-92" aria-hidden="true" tabindex="-1"></a>                              <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-93"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-93" aria-hidden="true" tabindex="-1"></a>  otu.dcn.before <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.before_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-94"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-95"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-95" aria-hidden="true" tabindex="-1"></a>  precision_splsda.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.before))<span class="sc">/</span></span>
<span id="cb240-96"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.before)</span>
<span id="cb240-97"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-97" aria-hidden="true" tabindex="-1"></a>  recall_splsda.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.before))<span class="sc">/</span></span>
<span id="cb240-98"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-99"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-99" aria-hidden="true" tabindex="-1"></a>  F1_splsda.before <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.before<span class="sc">*</span>recall_splsda.before)<span class="sc">/</span></span>
<span id="cb240-100"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-100" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.before <span class="sc">+</span> recall_splsda.before)</span>
<span id="cb240-101"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-102"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-102" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-103"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-104"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-104" aria-hidden="true" tabindex="-1"></a>    F1_splsda.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-105"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-106"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-107"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-107" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb240-108"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-108" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb240-109"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-109" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb240-110"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-111"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-111" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-112"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-112" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-113"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-113" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-114"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-115"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-116"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-116" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-117"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-117" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-118"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb240-119"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-119" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-120"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-120" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-121"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-121" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-122"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-122" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-123"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-123" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-124"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-124" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-125"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-126"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-126" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb240-127"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-127" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb240-128"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-129"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-130"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-130" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), </span>
<span id="cb240-131"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-131" aria-hidden="true" tabindex="-1"></a>                     <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-132"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-132" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.clean, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-133"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-133" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">number =</span> p_total)</span>
<span id="cb240-134"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-134" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> </span>
<span id="cb240-135"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-135" aria-hidden="true" tabindex="-1"></a>                                                <span class="fl">0.05</span>]</span>
<span id="cb240-136"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-137"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-137" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.clean))<span class="sc">/</span></span>
<span id="cb240-138"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb240-139"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-139" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.clean))<span class="sc">/</span></span>
<span id="cb240-140"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-141"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-141" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb240-142"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-142" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb240-143"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-144"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-144" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-145"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-146"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-146" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-147"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-148"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-149"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-149" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-150"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-151"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-152"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-153"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-153" aria-hidden="true" tabindex="-1"></a>  fit.clean_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-154"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-155"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-155" aria-hidden="true" tabindex="-1"></a>  otu.dcn.clean <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.clean_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-156"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-157"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-157" aria-hidden="true" tabindex="-1"></a>  precision_splsda.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.clean))<span class="sc">/</span></span>
<span id="cb240-158"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.clean)</span>
<span id="cb240-159"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-159" aria-hidden="true" tabindex="-1"></a>  recall_splsda.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.clean))<span class="sc">/</span></span>
<span id="cb240-160"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-161"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-161" aria-hidden="true" tabindex="-1"></a>  F1_splsda.clean <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.clean<span class="sc">*</span>recall_splsda.clean)<span class="sc">/</span></span>
<span id="cb240-162"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-162" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.clean <span class="sc">+</span> recall_splsda.clean)</span>
<span id="cb240-163"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-164"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-164" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-165"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-165" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-166"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-166" aria-hidden="true" tabindex="-1"></a>    F1_splsda.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-167"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-167" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-168"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-169"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-169" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb240-170"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-170" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb240-171"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-171" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb240-172"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-172" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb240-173"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-174"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-175"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-175" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-176"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-176" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-177"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-177" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-178"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-179"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-180"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-180" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-181"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-181" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-182"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb240-183"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-183" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-184"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-184" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-185"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-185" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-186"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-186" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-187"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-187" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-188"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-188" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-189"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-190"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-190" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb240-191"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-191" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb240-192"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-193"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-194"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-194" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb240-195"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-195" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-196"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-196" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.rbe, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-197"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-197" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">number =</span> p_total)</span>
<span id="cb240-198"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-198" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb240-199"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-200"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-200" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb240-201"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb240-202"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-202" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb240-203"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-204"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-204" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb240-205"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-205" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb240-206"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-207"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-207" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-208"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-208" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-209"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-209" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-210"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-210" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-211"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-211" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-212"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-212" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-213"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-213" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-214"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-215"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-216"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-216" aria-hidden="true" tabindex="-1"></a>  fit.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-217"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-217" aria-hidden="true" tabindex="-1"></a>                           <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-218"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-218" aria-hidden="true" tabindex="-1"></a>  otu.dcn.rbe <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.rbe_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-219"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-220"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-220" aria-hidden="true" tabindex="-1"></a>  precision_splsda.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.rbe))<span class="sc">/</span></span>
<span id="cb240-221"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.rbe)</span>
<span id="cb240-222"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-222" aria-hidden="true" tabindex="-1"></a>  recall_splsda.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.rbe))<span class="sc">/</span></span>
<span id="cb240-223"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-224"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-224" aria-hidden="true" tabindex="-1"></a>  F1_splsda.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.rbe<span class="sc">*</span>recall_splsda.rbe)<span class="sc">/</span></span>
<span id="cb240-225"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-225" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.rbe <span class="sc">+</span> recall_splsda.rbe)</span>
<span id="cb240-226"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-227"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-227" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-228"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-229"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-229" aria-hidden="true" tabindex="-1"></a>    F1_splsda.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-230"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-231"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-232"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-232" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb240-233"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-233" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb240-234"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-234" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb240-235"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-235" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb240-236"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-237"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-238"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-238" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-239"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-239" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-240"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-240" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-241"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-241" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-242"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-243"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-243" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-244"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-244" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-245"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-245" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb240-246"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-246" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-247"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-247" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-248"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-248" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-249"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-249" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-250"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-250" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-251"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-251" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-252"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-252" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-253"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-253" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb240-254"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-254" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb240-255"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-256"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-257"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-257" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb240-258"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-258" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-259"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-259" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.combat, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-260"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-260" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">number =</span> p_total)</span>
<span id="cb240-261"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-261" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> </span>
<span id="cb240-262"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-262" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fl">0.05</span>]</span>
<span id="cb240-263"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-264"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-264" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.combat))<span class="sc">/</span></span>
<span id="cb240-265"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb240-266"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-266" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.combat))<span class="sc">/</span></span>
<span id="cb240-267"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-268"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-268" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb240-269"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-269" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb240-270"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-271"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-271" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-272"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-273"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-273" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-274"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-274" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-275"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-276"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-276" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-277"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-277" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-278"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-279"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-280"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-280" aria-hidden="true" tabindex="-1"></a>  fit.combat_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-281"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-281" aria-hidden="true" tabindex="-1"></a>                              <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-282"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-282" aria-hidden="true" tabindex="-1"></a>  otu.dcn.combat <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.combat_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-283"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-283" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-284"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-284" aria-hidden="true" tabindex="-1"></a>  precision_splsda.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.combat))<span class="sc">/</span></span>
<span id="cb240-285"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.combat)</span>
<span id="cb240-286"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-286" aria-hidden="true" tabindex="-1"></a>  recall_splsda.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.combat))<span class="sc">/</span></span>
<span id="cb240-287"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb240-288"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-288" aria-hidden="true" tabindex="-1"></a>  F1_splsda.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.combat<span class="sc">*</span>recall_splsda.combat)<span class="sc">/</span></span>
<span id="cb240-289"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-289" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.combat <span class="sc">+</span> recall_splsda.combat)</span>
<span id="cb240-290"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-291"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-291" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-292"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-292" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-293"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-293" aria-hidden="true" tabindex="-1"></a>    F1_splsda.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-294"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-294" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-295"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-296"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-296" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb240-297"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-297" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb240-298"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-298" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb240-299"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-299" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb240-300"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-300" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb240-301"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-301" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb240-302"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.plsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb240-303"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-304"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-304" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-305"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-305" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-306"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-306" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-307"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-307" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-308"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-308" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-309"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-310"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-310" aria-hidden="true" tabindex="-1"></a>  indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-311"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-311" aria-hidden="true" tabindex="-1"></a>  indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-312"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-312" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.plsda_batch))){</span>
<span id="cb240-313"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-313" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-314"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-314" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-315"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-315" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.plsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-316"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-316" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-317"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-317" aria-hidden="true" tabindex="-1"></a>    indiv.trt.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.plsda_batch, </span>
<span id="cb240-318"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-318" aria-hidden="true" tabindex="-1"></a>                               fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-319"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-319" aria-hidden="true" tabindex="-1"></a>    indiv.batch.plsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.plsda_batch, </span>
<span id="cb240-320"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-320" aria-hidden="true" tabindex="-1"></a>                                 fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-321"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-321" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-322"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-322" aria-hidden="true" tabindex="-1"></a>  r2.trt.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.plsda_batch</span>
<span id="cb240-323"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-323" aria-hidden="true" tabindex="-1"></a>  r2.batch.plsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.plsda_batch</span>
<span id="cb240-324"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-325"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-326"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-326" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.plsda_batch)), </span>
<span id="cb240-327"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-327" aria-hidden="true" tabindex="-1"></a>                           <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-328"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-328" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.plsda_batch, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-329"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-329" aria-hidden="true" tabindex="-1"></a>  fit.result.plsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.plsda_batch), <span class="at">number =</span> p_total)</span>
<span id="cb240-330"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-330" aria-hidden="true" tabindex="-1"></a>  otu.sig.plsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.plsda_batch)[</span>
<span id="cb240-331"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-331" aria-hidden="true" tabindex="-1"></a>    fit.result.plsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb240-332"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-332" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-333"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-333" aria-hidden="true" tabindex="-1"></a>  precision_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-334"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-334" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.plsda_batch))<span class="sc">/</span><span class="fu">length</span>(otu.sig.plsda_batch)</span>
<span id="cb240-335"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-335" aria-hidden="true" tabindex="-1"></a>  recall_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-336"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-336" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.plsda_batch))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb240-337"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-337" aria-hidden="true" tabindex="-1"></a>  F1_limma.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-338"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-338" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.plsda_batch<span class="sc">*</span>recall_limma.plsda_batch)<span class="sc">/</span></span>
<span id="cb240-339"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-339" aria-hidden="true" tabindex="-1"></a>    (precision_limma.plsda_batch <span class="sc">+</span> recall_limma.plsda_batch)</span>
<span id="cb240-340"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-341"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-341" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-342"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-342" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-343"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-343" aria-hidden="true" tabindex="-1"></a>    precision_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-344"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-344" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-345"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-346"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-346" aria-hidden="true" tabindex="-1"></a>    F1_limma.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-347"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-347" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-348"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-348" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-349"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-349" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-350"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-350" aria-hidden="true" tabindex="-1"></a>  fit.plsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.plsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-351"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-351" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-352"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-352" aria-hidden="true" tabindex="-1"></a>  otu.dcn.plsda_batch <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.plsda_batch_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-353"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-353" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-354"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-354" aria-hidden="true" tabindex="-1"></a>  precision_splsda.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-355"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.plsda_batch))<span class="sc">/</span><span class="fu">length</span>(otu.dcn.plsda_batch)</span>
<span id="cb240-356"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-356" aria-hidden="true" tabindex="-1"></a>  recall_splsda.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-357"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.plsda_batch))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb240-358"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-358" aria-hidden="true" tabindex="-1"></a>  F1_splsda.plsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-359"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-359" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_splsda.plsda_batch<span class="sc">*</span>recall_splsda.plsda_batch)<span class="sc">/</span></span>
<span id="cb240-360"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-360" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.plsda_batch <span class="sc">+</span> recall_splsda.plsda_batch)</span>
<span id="cb240-361"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-362"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-362" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-363"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-363" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.plsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-364"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-364" aria-hidden="true" tabindex="-1"></a>    F1_splsda.plsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-365"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-365" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-366"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-367"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-367" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb240-368"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-368" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb240-369"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-369" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb240-370"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-370" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, </span>
<span id="cb240-371"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-371" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.bat =</span> batch, </span>
<span id="cb240-372"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-372" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb240-373"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-373" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb240-374"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-374" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb240-375"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-375" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb240-376"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.splsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb240-377"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-378"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-378" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb240-379"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-379" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb240-380"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-380" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb240-381"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-381" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb240-382"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-382" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-383"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-383" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb240-384"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-384" aria-hidden="true" tabindex="-1"></a>  indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-385"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-385" aria-hidden="true" tabindex="-1"></a>  indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb240-386"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-386" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.splsda_batch))){</span>
<span id="cb240-387"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-387" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb240-388"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-388" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb240-389"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-389" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.splsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb240-390"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-390" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb240-391"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-391" aria-hidden="true" tabindex="-1"></a>    indiv.trt.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.splsda_batch, </span>
<span id="cb240-392"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-392" aria-hidden="true" tabindex="-1"></a>                                fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb240-393"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-393" aria-hidden="true" tabindex="-1"></a>    indiv.batch.splsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.splsda_batch, </span>
<span id="cb240-394"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-394" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb240-395"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-395" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-396"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-396" aria-hidden="true" tabindex="-1"></a>  r2.trt.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.splsda_batch</span>
<span id="cb240-397"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-397" aria-hidden="true" tabindex="-1"></a>  r2.batch.splsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.splsda_batch</span>
<span id="cb240-398"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-399"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-399" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-400"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-400" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.splsda_batch)), </span>
<span id="cb240-401"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-401" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb240-402"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-402" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.splsda_batch, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb240-403"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-403" aria-hidden="true" tabindex="-1"></a>  fit.result.splsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.splsda_batch), </span>
<span id="cb240-404"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-404" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb240-405"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-405" aria-hidden="true" tabindex="-1"></a>  otu.sig.splsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.splsda_batch)[</span>
<span id="cb240-406"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-406" aria-hidden="true" tabindex="-1"></a>    fit.result.splsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb240-407"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-408"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-408" aria-hidden="true" tabindex="-1"></a>  precision_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-409"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-409" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.splsda_batch))<span class="sc">/</span></span>
<span id="cb240-410"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-410" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.splsda_batch)</span>
<span id="cb240-411"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-411" aria-hidden="true" tabindex="-1"></a>  recall_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-412"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.splsda_batch))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb240-413"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-413" aria-hidden="true" tabindex="-1"></a>  F1_limma.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-414"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-414" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.splsda_batch<span class="sc">*</span>recall_limma.splsda_batch)<span class="sc">/</span></span>
<span id="cb240-415"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-415" aria-hidden="true" tabindex="-1"></a>    (precision_limma.splsda_batch <span class="sc">+</span> recall_limma.splsda_batch)</span>
<span id="cb240-416"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-416" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-417"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-417" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-418"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-418" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-419"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-419" aria-hidden="true" tabindex="-1"></a>    precision_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-420"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-420" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-421"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-421" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-422"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-422" aria-hidden="true" tabindex="-1"></a>    F1_limma.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-423"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-423" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-424"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-424" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-425"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-425" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-426"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-426" aria-hidden="true" tabindex="-1"></a>  fit.splsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.splsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb240-427"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-427" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb240-428"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-428" aria-hidden="true" tabindex="-1"></a>  otu.dcn.splsda_batch <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.splsda_batch_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb240-429"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-430"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-430" aria-hidden="true" tabindex="-1"></a>  precision_splsda.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-431"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.splsda_batch))<span class="sc">/</span></span>
<span id="cb240-432"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.splsda_batch)</span>
<span id="cb240-433"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-433" aria-hidden="true" tabindex="-1"></a>  recall_splsda.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-434"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.splsda_batch))<span class="sc">/</span><span class="fu">length</span>(true.trt)</span>
<span id="cb240-435"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-435" aria-hidden="true" tabindex="-1"></a>  F1_splsda.splsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb240-436"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-436" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_splsda.splsda_batch<span class="sc">*</span>recall_splsda.splsda_batch)<span class="sc">/</span></span>
<span id="cb240-437"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-437" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.splsda_batch <span class="sc">+</span> recall_splsda.splsda_batch)</span>
<span id="cb240-438"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-438" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-439"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-439" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb240-440"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-440" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.splsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb240-441"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-441" aria-hidden="true" tabindex="-1"></a>    F1_splsda.splsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb240-442"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-442" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-443"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-443" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-444"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-444" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb240-445"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-445" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb240-446"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-446" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb240-447"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-447" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb240-448"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-448" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb240-449"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-449" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb240-450"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-450" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.plsda_batch,</span>
<span id="cb240-451"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-451" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.splsda_batch)</span>
<span id="cb240-452"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-452" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-453"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-453" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb240-454"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-454" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb240-455"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-455" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb240-456"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-456" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb240-457"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-457" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.plsda_batch,</span>
<span id="cb240-458"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-458" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.splsda_batch)</span>
<span id="cb240-459"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-459" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-460"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-460" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb240-461"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-461" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb240-462"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-462" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb240-463"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-463" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb240-464"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-464" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.plsda_batch,</span>
<span id="cb240-465"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-465" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.splsda_batch)</span>
<span id="cb240-466"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-467"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-468"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-468" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb240-469"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-469" aria-hidden="true" tabindex="-1"></a>  precision_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.before, </span>
<span id="cb240-470"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-470" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.clean,</span>
<span id="cb240-471"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-471" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.rbe,</span>
<span id="cb240-472"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-472" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ComBat =</span> precision_splsda.combat,</span>
<span id="cb240-473"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-473" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.plsda_batch,</span>
<span id="cb240-474"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-474" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.splsda_batch)</span>
<span id="cb240-475"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-476"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-476" aria-hidden="true" tabindex="-1"></a>  recall_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.before, </span>
<span id="cb240-477"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-477" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.clean,</span>
<span id="cb240-478"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-478" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.rbe,</span>
<span id="cb240-479"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-479" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ComBat =</span> recall_splsda.combat,</span>
<span id="cb240-480"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-480" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.plsda_batch,</span>
<span id="cb240-481"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-481" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.splsda_batch)</span>
<span id="cb240-482"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-482" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-483"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-483" aria-hidden="true" tabindex="-1"></a>  F1_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.before, </span>
<span id="cb240-484"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-484" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.clean,</span>
<span id="cb240-485"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-485" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.rbe,</span>
<span id="cb240-486"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-486" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ComBat =</span> F1_splsda.combat,</span>
<span id="cb240-487"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-487" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.plsda_batch,</span>
<span id="cb240-488"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-488" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.splsda_batch)</span>
<span id="cb240-489"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-489" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb240-490"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb240-490" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As the simulation step takes time, so we use the saved data into visulisation.</p>
</div>
<div id="figures" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Figures<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb241-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb241-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb241-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb241-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb241-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb241-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb241-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-9" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb241-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-10" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb241-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb241-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb241-13" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-99"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-99-1.png" alt="Figure 1: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design." width="70%" />
<p class="caption">
Figure 3.1: Figure 1: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<p>We first considered the proportion of variance explained by treatment and batch effects before and after batch effect correction across all variables using pRDA. Efficient batch effect correction methods should generate data with a smaller proportion of batch associated variance and larger proportion of treatment variance compared to the original data. The figure shows that there was no intersection shared between treatment and batch variation with a balanced batch <span class="math inline">\(\times\)</span> treatment design. All methods successfully removed batch variation, but PLSDA-batch and sPLSDA-batch preserved more proportion of treatment variance than removeBatchEffect and ComBat. In addition, the data corrected by sPLSDA-batch included almost as much proportion of treatment variance as the ground-truth data.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb242-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb242-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-3" aria-hidden="true" tabindex="-1"></a><span class="co"># color</span></span>
<span id="cb242-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-4" aria-hidden="true" tabindex="-1"></a>gcolor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">pb_color</span>(<span class="dv">16</span>), p_trt_relevant), </span>
<span id="cb242-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="fu">pb_color</span>(<span class="dv">17</span>), (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb242-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-6" aria-hidden="true" tabindex="-1"></a>gcolor[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="fu">pb_color</span>(<span class="dv">18</span>)</span>
<span id="cb242-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-7" aria-hidden="true" tabindex="-1"></a>gcolor[<span class="fu">setdiff</span>(<span class="fu">seq_len</span>(p_total), <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="fu">pb_color</span>(<span class="dv">15</span>)</span>
<span id="cb242-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-9" aria-hidden="true" tabindex="-1"></a>xlabs <span class="ot">=</span> <span class="st">&#39;R2(variable, treatment)&#39;</span></span>
<span id="cb242-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-10" aria-hidden="true" tabindex="-1"></a>ylabs <span class="ot">=</span> <span class="st">&#39;R2(variable, batch)&#39;</span></span>
<span id="cb242-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-11" aria-hidden="true" tabindex="-1"></a>edgex <span class="ot">=</span> <span class="fl">0.7</span></span>
<span id="cb242-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-12" aria-hidden="true" tabindex="-1"></a>edgey <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb242-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-14"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-14" aria-hidden="true" tabindex="-1"></a><span class="co"># scatterplot</span></span>
<span id="cb242-15"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb242-16"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.before), <span class="fu">rowMeans</span>(r2.batch.before), <span class="at">col =</span> gcolor, </span>
<span id="cb242-17"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-18"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb242-19"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;Before correction&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-20"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-20" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-21"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-21" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-22"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb242-23"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-24"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.clean), <span class="fu">rowMeans</span>(r2.batch.clean), <span class="at">col =</span> gcolor, </span>
<span id="cb242-25"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-26"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb242-27"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-27" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;Ground-truth data&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-28"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-28" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-29"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-29" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-30"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb242-31"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-32"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), <span class="fu">rowMeans</span>(r2.batch.rbe), <span class="at">col =</span> gcolor, </span>
<span id="cb242-33"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-34"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-34" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb242-35"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-35" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-36"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-36" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-37"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-37" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-38"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb242-39"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-40"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.combat), <span class="fu">rowMeans</span>(r2.batch.combat), <span class="at">col =</span> gcolor, </span>
<span id="cb242-41"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-41" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-42"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-42" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;ComBat&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-43"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-43" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-44"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-44" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-45"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb242-46"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-47"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-47" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.plsdab), <span class="fu">rowMeans</span>(r2.batch.plsdab), <span class="at">col =</span> gcolor, </span>
<span id="cb242-48"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-48" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-49"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-49" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-50"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-50" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-51"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-51" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-52"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-52" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb242-53"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-54"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-54" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.splsdab), <span class="fu">rowMeans</span>(r2.batch.splsdab), <span class="at">col =</span> gcolor, </span>
<span id="cb242-55"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-55" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb242-56"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-56" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;sPLSDA-batch&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb242-57"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-57" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb242-58"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-58" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb242-59"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb242-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-100"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-100-1.png" alt="Figure 2: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design." width="100%" />
<p class="caption">
Figure 3.2: Figure 2: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the balanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code></pre></div>
<p>We also estimated the proportion of variance explained by treatment and batch effects for each variable respectively using the <span class="math inline">\(R^2\)</span> value. The variables assigned with both treatment and batch effects in the corrected data from removeBatchEffect and ComBat presented less proportion of treatment associated variance than in the ground truth data. This result agrees with the pRDA evaluation that these two methods do not preserve enough treatment variation. After PLSDA-batch correction, variables simulated with only batch effects displayed some amount of treatment variation, but only in the case where the batch effect variability among samples was high. sPLSDA-batch outperformed all methods, with results similar to the ground-truth data.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb244-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb244-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb244-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">colMeans</span>(precision_splsda))</span>
<span id="cb244-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;Multivariate selection&#39;</span>)</span>
<span id="cb244-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb244-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb244-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>)</span>
<span id="cb244-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb244-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb244-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 3: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-101">Table 3.1: </span>Table 3: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (mean).</caption>
<colgroup>
<col width="21%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="6%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.98</td>
<td align="left">0.95</td>
<td align="left">0.94</td>
<td align="left">0.93</td>
<td align="left">0.56</td>
<td align="left">0.86</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.74</td>
<td align="left">1.00</td>
<td align="left">0.87</td>
<td align="left">0.88</td>
<td align="left">1.00</td>
<td align="left">1.00</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.84</td>
<td align="left">0.98</td>
<td align="left">0.89</td>
<td align="left">0.89</td>
<td align="left">0.68</td>
<td align="left">0.92</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.89</td>
<td align="left">1.00</td>
<td align="left">0.92</td>
<td align="left">0.92</td>
<td align="left">0.92</td>
<td align="left">1.00</td>
</tr>
</tbody>
</table>
<p>When considering the measures of accuracy with univariate one-way ANOVA, we observed that the corrected data from PLSDA-batch and sPLSDA-batch led to higher recall and lower precision than the data from removeBatchEffect and ComBat. However, the precision of sPLSDA-batch was competitive to removeBatchEffect and ComBat. Moreover, sPLSDA-batch achieved higher F1 scores and multivariate selection scores than removeBatchEffect and ComBat.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb245-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb245-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(precision_splsda, <span class="dv">2</span>, sd))</span>
<span id="cb245-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;Multivariate selection&#39;</span>)</span>
<span id="cb245-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb245-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb245-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;PLSDA-batch&#39;</span>, <span class="st">&#39;sPLSDA-batch&#39;</span>)</span>
<span id="cb245-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb245-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb245-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 4: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-102">Table 3.2: </span>Table 4: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the balanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="21%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="6%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">PLSDA-batch</th>
<th align="left">sPLSDA-batch</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.021</td>
<td align="left">0.031</td>
<td align="left">0.151</td>
<td align="left">0.160</td>
<td align="left">0.252</td>
<td align="left">0.110</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.095</td>
<td align="left">0.000</td>
<td align="left">0.098</td>
<td align="left">0.098</td>
<td align="left">0.021</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.065</td>
<td align="left">0.016</td>
<td align="left">0.118</td>
<td align="left">0.124</td>
<td align="left">0.200</td>
<td align="left">0.068</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.061</td>
<td align="left">0.000</td>
<td align="left">0.068</td>
<td align="left">0.069</td>
<td align="left">0.123</td>
<td align="left">0.005</td>
</tr>
</tbody>
</table>
<p>The standard deviations of the multivariate selection scores were all smaller than the univariate selection scores for the different corrected data, indicating a better stability of the variables selected by multivariate sPLSDA compared to the one-way ANOVA univariate selection.</p>
</div>
<div id="unbalanced-batch-times-treatment-design" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Unbalanced batch <span class="math inline">\(\times\)</span> treatment design<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#unbalanced-batch-times-treatment-design" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The unbalanced design had 4 and 16 samples from batch1 and batch2 respectively in trt1, 16 and 4 samples from batch1 and batch2 in trt2 (see the table below).</p>
<p><strong>Table 5: Unbalanced batch <span class="math inline">\(\times\)</span> treatment design</strong> in the simulation study</p>
<table>
<thead>
<tr class="header">
<th align="center"></th>
<th align="center">Trt1</th>
<th align="center">Trt2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Batch1</td>
<td align="center">4</td>
<td align="center">16</td>
</tr>
<tr class="even">
<td align="center">Batch2</td>
<td align="center">16</td>
<td align="center">4</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-1" aria-hidden="true" tabindex="-1"></a>nitr <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb246-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-2" aria-hidden="true" tabindex="-1"></a>p_total <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb246-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-3" aria-hidden="true" tabindex="-1"></a>p_trt_relevant <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb246-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-4" aria-hidden="true" tabindex="-1"></a>p_bat_relevant <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb246-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-6" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb246-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-7" aria-hidden="true" tabindex="-1"></a>gvar.before <span class="ot">&lt;-</span> gvar.clean <span class="ot">&lt;-</span> gvar.rbe <span class="ot">&lt;-</span> gvar.combat <span class="ot">&lt;-</span> </span>
<span id="cb246-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-8" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab <span class="ot">&lt;-</span> gvar.swplsdab <span class="ot">&lt;-</span> gvar.plsdab <span class="ot">&lt;-</span> </span>
<span id="cb246-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-9" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> <span class="cn">NA</span>, <span class="at">batch =</span> <span class="cn">NA</span>,  </span>
<span id="cb246-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">intersection =</span> <span class="cn">NA</span>, </span>
<span id="cb246-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">residual =</span> <span class="cn">NA</span>)</span>
<span id="cb246-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-13" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb246-14"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-14" aria-hidden="true" tabindex="-1"></a>r2.trt.before <span class="ot">&lt;-</span> r2.trt.clean <span class="ot">&lt;-</span> r2.trt.rbe  <span class="ot">&lt;-</span> r2.trt.combat <span class="ot">&lt;-</span> </span>
<span id="cb246-15"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-15" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab <span class="ot">&lt;-</span> r2.trt.swplsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb246-16"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-16" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">ncol =</span> nitr))</span>
<span id="cb246-17"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-17" aria-hidden="true" tabindex="-1"></a>r2.batch.before <span class="ot">&lt;-</span> r2.batch.clean <span class="ot">&lt;-</span> r2.batch.rbe  <span class="ot">&lt;-</span> r2.batch.combat <span class="ot">&lt;-</span> </span>
<span id="cb246-18"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-18" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab <span class="ot">&lt;-</span> r2.batch.swplsdab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> p_total, </span>
<span id="cb246-19"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-19" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">ncol =</span> nitr))</span>
<span id="cb246-20"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-21"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-21" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-22"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-22" aria-hidden="true" tabindex="-1"></a>precision_limma <span class="ot">&lt;-</span> recall_limma <span class="ot">&lt;-</span> F1_limma <span class="ot">&lt;-</span> </span>
<span id="cb246-23"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb246-24"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb246-25"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-26"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-26" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-27"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-27" aria-hidden="true" tabindex="-1"></a>precision_splsda <span class="ot">&lt;-</span> recall_splsda <span class="ot">&lt;-</span> F1_splsda <span class="ot">&lt;-</span> </span>
<span id="cb246-28"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">before =</span> <span class="cn">NA</span>, <span class="at">clean =</span> <span class="cn">NA</span>, <span class="at">rbe =</span> <span class="cn">NA</span>, <span class="at">combat =</span> <span class="cn">NA</span>, </span>
<span id="cb246-29"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">wplsda_batch =</span> <span class="cn">NA</span>, <span class="at">swplsda_batch =</span> <span class="cn">NA</span>)</span>
<span id="cb246-30"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-31"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(nitr)){</span>
<span id="cb246-32"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">### initial setup </span><span class="al">###</span></span>
<span id="cb246-33"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-33" aria-hidden="true" tabindex="-1"></a>  simulation <span class="ot">&lt;-</span> <span class="fu">simData_Gaussian</span>(<span class="at">mean.batch =</span> <span class="dv">7</span>, <span class="at">sd.batch =</span> <span class="dv">8</span>, </span>
<span id="cb246-34"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-34" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mean.trt =</span> <span class="dv">3</span>, <span class="at">sd.trt =</span> <span class="dv">2</span>, </span>
<span id="cb246-35"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-35" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">N =</span> <span class="dv">40</span>, <span class="at">p_total =</span> <span class="dv">300</span>, </span>
<span id="cb246-36"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-36" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p_trt_relevant =</span> <span class="dv">60</span>, </span>
<span id="cb246-37"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p_bat_relevant =</span> <span class="dv">150</span>, </span>
<span id="cb246-38"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">percentage_overlap_samples =</span> <span class="fl">0.2</span>,</span>
<span id="cb246-39"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">percentage_overlap_variables =</span> <span class="fl">0.5</span>, <span class="at">seeds =</span> i)</span>
<span id="cb246-40"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-41"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-41" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> simulation<span class="sc">$</span>data</span>
<span id="cb246-42"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-42" aria-hidden="true" tabindex="-1"></a>  trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.trt</span>
<span id="cb246-43"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-43" aria-hidden="true" tabindex="-1"></a>  batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>Y.bat</span>
<span id="cb246-44"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-44" aria-hidden="true" tabindex="-1"></a>  true.trt <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.trt</span>
<span id="cb246-45"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-45" aria-hidden="true" tabindex="-1"></a>  true.batch <span class="ot">&lt;-</span> simulation<span class="sc">$</span>true.batch</span>
<span id="cb246-46"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-47"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-47" aria-hidden="true" tabindex="-1"></a>  Batch_Trt.factors <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Batch =</span> batch, <span class="at">Treatment =</span> trt)</span>
<span id="cb246-48"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-49"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-49" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Before correction </span><span class="al">###</span></span>
<span id="cb246-50"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-51"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-51" aria-hidden="true" tabindex="-1"></a>  rda.before <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-52"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-52" aria-hidden="true" tabindex="-1"></a>  gvar.before[i, ] <span class="ot">&lt;-</span> rda.before<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-53"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-54"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-55"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-55" aria-hidden="true" tabindex="-1"></a>  indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-56"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-56" aria-hidden="true" tabindex="-1"></a>  indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-57"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X))){</span>
<span id="cb246-58"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-58" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-59"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-59" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-60"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-60" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-61"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-61" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-62"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-62" aria-hidden="true" tabindex="-1"></a>    indiv.trt.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.before, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-63"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-63" aria-hidden="true" tabindex="-1"></a>    indiv.batch.before <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.before, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-64"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-65"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-65" aria-hidden="true" tabindex="-1"></a>  r2.trt.before[ ,i] <span class="ot">&lt;-</span>  indiv.trt.before</span>
<span id="cb246-66"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-66" aria-hidden="true" tabindex="-1"></a>  r2.batch.before[ ,i] <span class="ot">&lt;-</span>  indiv.batch.before</span>
<span id="cb246-67"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-68"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-69"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-69" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X)), <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-70"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-70" aria-hidden="true" tabindex="-1"></a>  fit.before <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.before, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-71"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-71" aria-hidden="true" tabindex="-1"></a>  fit.result.before <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.before), <span class="at">number =</span> p_total)</span>
<span id="cb246-72"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-72" aria-hidden="true" tabindex="-1"></a>  otu.sig.before <span class="ot">&lt;-</span> </span>
<span id="cb246-73"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.before)[fit.result.before<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-74"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-75"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-75" aria-hidden="true" tabindex="-1"></a>  precision_limma.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.before))<span class="sc">/</span></span>
<span id="cb246-76"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.before)</span>
<span id="cb246-77"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-77" aria-hidden="true" tabindex="-1"></a>  recall_limma.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.before))<span class="sc">/</span></span>
<span id="cb246-78"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-79"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-79" aria-hidden="true" tabindex="-1"></a>  F1_limma.before <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.before<span class="sc">*</span>recall_limma.before)<span class="sc">/</span></span>
<span id="cb246-80"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-80" aria-hidden="true" tabindex="-1"></a>    (precision_limma.before <span class="sc">+</span> recall_limma.before)</span>
<span id="cb246-81"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-82"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-82" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-83"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-84"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-84" aria-hidden="true" tabindex="-1"></a>    precision_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-85"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-86"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-87"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-87" aria-hidden="true" tabindex="-1"></a>    F1_limma.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-88"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-89"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-90"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-91"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-91" aria-hidden="true" tabindex="-1"></a>  fit.before_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X, <span class="at">Y =</span> trt, </span>
<span id="cb246-92"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-92" aria-hidden="true" tabindex="-1"></a>                              <span class="at">ncomp =</span> <span class="dv">1</span>, <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-93"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-93" aria-hidden="true" tabindex="-1"></a>  otu.dcn.before <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.before_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-94"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-95"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-95" aria-hidden="true" tabindex="-1"></a>  precision_splsda.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.before))<span class="sc">/</span></span>
<span id="cb246-96"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.before)</span>
<span id="cb246-97"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-97" aria-hidden="true" tabindex="-1"></a>  recall_splsda.before <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.before))<span class="sc">/</span></span>
<span id="cb246-98"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-99"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-99" aria-hidden="true" tabindex="-1"></a>  F1_splsda.before <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.before<span class="sc">*</span>recall_splsda.before)<span class="sc">/</span></span>
<span id="cb246-100"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-100" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.before <span class="sc">+</span> recall_splsda.before)</span>
<span id="cb246-101"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-102"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-102" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-103"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.before <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-104"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-104" aria-hidden="true" tabindex="-1"></a>    F1_splsda.before <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-105"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-106"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-107"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-107" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-108"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-108" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Ground-truth data </span><span class="al">###</span></span>
<span id="cb246-109"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-109" aria-hidden="true" tabindex="-1"></a>  X.clean <span class="ot">&lt;-</span> simulation<span class="sc">$</span>cleanData</span>
<span id="cb246-110"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-111"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-111" aria-hidden="true" tabindex="-1"></a>  rda.clean <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.clean), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-112"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-112" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-113"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-113" aria-hidden="true" tabindex="-1"></a>  gvar.clean[i, ] <span class="ot">&lt;-</span> rda.clean<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-114"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-115"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-115" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-116"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-116" aria-hidden="true" tabindex="-1"></a>  indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-117"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-117" aria-hidden="true" tabindex="-1"></a>  indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-118"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.clean))){</span>
<span id="cb246-119"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-119" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-120"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-120" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-121"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-121" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.clean)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-122"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-122" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-123"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-123" aria-hidden="true" tabindex="-1"></a>    indiv.trt.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.clean, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-124"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-124" aria-hidden="true" tabindex="-1"></a>    indiv.batch.clean <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.clean, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-125"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-126"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-126" aria-hidden="true" tabindex="-1"></a>  r2.trt.clean[ ,i] <span class="ot">&lt;-</span>  indiv.trt.clean</span>
<span id="cb246-127"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-127" aria-hidden="true" tabindex="-1"></a>  r2.batch.clean[ ,i] <span class="ot">&lt;-</span>  indiv.batch.clean</span>
<span id="cb246-128"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-129"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-130"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-130" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.clean)), </span>
<span id="cb246-131"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-131" aria-hidden="true" tabindex="-1"></a>                     <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-132"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-132" aria-hidden="true" tabindex="-1"></a>  fit.clean <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.clean, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-133"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-133" aria-hidden="true" tabindex="-1"></a>  fit.result.clean <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.clean), <span class="at">number =</span> p_total)</span>
<span id="cb246-134"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-134" aria-hidden="true" tabindex="-1"></a>  otu.sig.clean <span class="ot">&lt;-</span> </span>
<span id="cb246-135"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.clean)[fit.result.clean<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-136"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-137"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-137" aria-hidden="true" tabindex="-1"></a>  precision_limma.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.clean))<span class="sc">/</span></span>
<span id="cb246-138"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.clean)</span>
<span id="cb246-139"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-139" aria-hidden="true" tabindex="-1"></a>  recall_limma.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.clean))<span class="sc">/</span></span>
<span id="cb246-140"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-141"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-141" aria-hidden="true" tabindex="-1"></a>  F1_limma.clean <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.clean<span class="sc">*</span>recall_limma.clean)<span class="sc">/</span></span>
<span id="cb246-142"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-142" aria-hidden="true" tabindex="-1"></a>    (precision_limma.clean <span class="sc">+</span> recall_limma.clean)</span>
<span id="cb246-143"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-144"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-144" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-145"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-146"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-146" aria-hidden="true" tabindex="-1"></a>    precision_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-147"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-148"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-149"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-149" aria-hidden="true" tabindex="-1"></a>    F1_limma.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-150"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-151"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-152"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-153"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-153" aria-hidden="true" tabindex="-1"></a>  fit.clean_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.clean, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb246-154"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-155"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-155" aria-hidden="true" tabindex="-1"></a>  otu.dcn.clean <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.clean_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-156"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-157"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-157" aria-hidden="true" tabindex="-1"></a>  precision_splsda.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.clean))<span class="sc">/</span></span>
<span id="cb246-158"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.clean)</span>
<span id="cb246-159"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-159" aria-hidden="true" tabindex="-1"></a>  recall_splsda.clean <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.clean))<span class="sc">/</span></span>
<span id="cb246-160"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-161"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-161" aria-hidden="true" tabindex="-1"></a>  F1_splsda.clean <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.clean<span class="sc">*</span>recall_splsda.clean)<span class="sc">/</span></span>
<span id="cb246-162"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-162" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.clean <span class="sc">+</span> recall_splsda.clean)</span>
<span id="cb246-163"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-164"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-164" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-165"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-165" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.clean <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-166"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-166" aria-hidden="true" tabindex="-1"></a>    F1_splsda.clean <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-167"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-167" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-168"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-169"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-169" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-170"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-170" aria-hidden="true" tabindex="-1"></a>  <span class="do">### removeBatchEffect corrected data </span><span class="al">###</span></span>
<span id="cb246-171"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-171" aria-hidden="true" tabindex="-1"></a>  X.rbe <span class="ot">&lt;-</span><span class="fu">t</span>(<span class="fu">removeBatchEffect</span>(<span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb246-172"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-172" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb246-173"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-174"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-175"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-175" aria-hidden="true" tabindex="-1"></a>  rda.rbe <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.rbe), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-176"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-176" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-177"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-177" aria-hidden="true" tabindex="-1"></a>  gvar.rbe[i, ] <span class="ot">&lt;-</span> rda.rbe<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-178"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-179"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-180"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-180" aria-hidden="true" tabindex="-1"></a>  indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-181"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-181" aria-hidden="true" tabindex="-1"></a>  indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-182"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.rbe))){</span>
<span id="cb246-183"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-183" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-184"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-184" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-185"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-185" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.rbe)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-186"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-186" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-187"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-187" aria-hidden="true" tabindex="-1"></a>    indiv.trt.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.rbe, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-188"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-188" aria-hidden="true" tabindex="-1"></a>    indiv.batch.rbe <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.rbe, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-189"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-190"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-190" aria-hidden="true" tabindex="-1"></a>  r2.trt.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.trt.rbe</span>
<span id="cb246-191"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-191" aria-hidden="true" tabindex="-1"></a>  r2.batch.rbe[ ,i] <span class="ot">&lt;-</span>  indiv.batch.rbe</span>
<span id="cb246-192"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-193"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-194"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-194" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.rbe)), </span>
<span id="cb246-195"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-195" aria-hidden="true" tabindex="-1"></a>                   <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-196"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-196" aria-hidden="true" tabindex="-1"></a>  fit.rbe <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.rbe, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-197"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-197" aria-hidden="true" tabindex="-1"></a>  fit.result.rbe <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.rbe), <span class="at">number =</span> p_total)</span>
<span id="cb246-198"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-198" aria-hidden="true" tabindex="-1"></a>  otu.sig.rbe <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.rbe)[fit.result.rbe<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-199"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-200"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-200" aria-hidden="true" tabindex="-1"></a>  precision_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb246-201"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.rbe)</span>
<span id="cb246-202"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-202" aria-hidden="true" tabindex="-1"></a>  recall_limma.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.rbe))<span class="sc">/</span></span>
<span id="cb246-203"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-204"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-204" aria-hidden="true" tabindex="-1"></a>  F1_limma.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.rbe<span class="sc">*</span>recall_limma.rbe)<span class="sc">/</span></span>
<span id="cb246-205"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-205" aria-hidden="true" tabindex="-1"></a>    (precision_limma.rbe <span class="sc">+</span> recall_limma.rbe)</span>
<span id="cb246-206"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-207"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-207" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-208"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-208" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-209"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-209" aria-hidden="true" tabindex="-1"></a>    precision_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-210"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-210" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-211"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-211" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-212"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-212" aria-hidden="true" tabindex="-1"></a>    F1_limma.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-213"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-213" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-214"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-215"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-216"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-216" aria-hidden="true" tabindex="-1"></a>  fit.rbe_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.rbe, <span class="at">Y =</span> trt, </span>
<span id="cb246-217"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-217" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncomp =</span> <span class="dv">1</span>, <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-218"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-218" aria-hidden="true" tabindex="-1"></a>  otu.dcn.rbe <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.rbe_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-219"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-220"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-220" aria-hidden="true" tabindex="-1"></a>  precision_splsda.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.rbe))<span class="sc">/</span></span>
<span id="cb246-221"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.rbe)</span>
<span id="cb246-222"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-222" aria-hidden="true" tabindex="-1"></a>  recall_splsda.rbe <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.rbe))<span class="sc">/</span></span>
<span id="cb246-223"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-224"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-224" aria-hidden="true" tabindex="-1"></a>  F1_splsda.rbe <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.rbe<span class="sc">*</span>recall_splsda.rbe)<span class="sc">/</span></span>
<span id="cb246-225"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-225" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.rbe <span class="sc">+</span> recall_splsda.rbe)</span>
<span id="cb246-226"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-227"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-227" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-228"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-228" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.rbe <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-229"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-229" aria-hidden="true" tabindex="-1"></a>    F1_splsda.rbe <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-230"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-230" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-231"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-232"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-232" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-233"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-233" aria-hidden="true" tabindex="-1"></a>  <span class="do">### ComBat corrected data </span><span class="al">###</span></span>
<span id="cb246-234"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-234" aria-hidden="true" tabindex="-1"></a>  X.combat <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">ComBat</span>(<span class="at">dat =</span> <span class="fu">t</span>(X), <span class="at">batch =</span> batch, </span>
<span id="cb246-235"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-235" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mod =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="fu">as.factor</span>(trt))))</span>
<span id="cb246-236"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-237"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-238"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-238" aria-hidden="true" tabindex="-1"></a>  rda.combat <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.combat), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-239"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-239" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-240"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-240" aria-hidden="true" tabindex="-1"></a>  gvar.combat[i, ] <span class="ot">&lt;-</span> rda.combat<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-241"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-241" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-242"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-243"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-243" aria-hidden="true" tabindex="-1"></a>  indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-244"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-244" aria-hidden="true" tabindex="-1"></a>  indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-245"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-245" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.combat))){</span>
<span id="cb246-246"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-246" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-247"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-247" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-248"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-248" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.combat)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-249"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-249" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-250"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-250" aria-hidden="true" tabindex="-1"></a>    indiv.trt.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.combat, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-251"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-251" aria-hidden="true" tabindex="-1"></a>    indiv.batch.combat <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.combat, fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-252"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-252" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-253"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-253" aria-hidden="true" tabindex="-1"></a>  r2.trt.combat[ ,i] <span class="ot">&lt;-</span>  indiv.trt.combat</span>
<span id="cb246-254"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-254" aria-hidden="true" tabindex="-1"></a>  r2.batch.combat[ ,i] <span class="ot">&lt;-</span>  indiv.batch.combat</span>
<span id="cb246-255"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-256"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-257"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-257" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.combat)), </span>
<span id="cb246-258"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-258" aria-hidden="true" tabindex="-1"></a>                      <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-259"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-259" aria-hidden="true" tabindex="-1"></a>  fit.combat <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.combat, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-260"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-260" aria-hidden="true" tabindex="-1"></a>  fit.result.combat <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.combat), <span class="at">number =</span> p_total)</span>
<span id="cb246-261"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-261" aria-hidden="true" tabindex="-1"></a>  otu.sig.combat <span class="ot">&lt;-</span> </span>
<span id="cb246-262"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fit.result.combat)[fit.result.combat<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-263"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-263" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-264"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-264" aria-hidden="true" tabindex="-1"></a>  precision_limma.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.combat))<span class="sc">/</span></span>
<span id="cb246-265"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.combat)</span>
<span id="cb246-266"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-266" aria-hidden="true" tabindex="-1"></a>  recall_limma.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.combat))<span class="sc">/</span></span>
<span id="cb246-267"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-268"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-268" aria-hidden="true" tabindex="-1"></a>  F1_limma.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_limma.combat<span class="sc">*</span>recall_limma.combat)<span class="sc">/</span></span>
<span id="cb246-269"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-269" aria-hidden="true" tabindex="-1"></a>    (precision_limma.combat <span class="sc">+</span> recall_limma.combat)</span>
<span id="cb246-270"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-271"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-271" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-272"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-272" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-273"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-273" aria-hidden="true" tabindex="-1"></a>    precision_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-274"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-274" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-275"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-275" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-276"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-276" aria-hidden="true" tabindex="-1"></a>    F1_limma.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-277"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-277" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-278"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-279"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-279" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-280"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-280" aria-hidden="true" tabindex="-1"></a>  fit.combat_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.combat, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb246-281"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-281" aria-hidden="true" tabindex="-1"></a>                              <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-282"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-282" aria-hidden="true" tabindex="-1"></a>  otu.dcn.combat <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.combat_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-283"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-283" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-284"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-284" aria-hidden="true" tabindex="-1"></a>  precision_splsda.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.combat))<span class="sc">/</span></span>
<span id="cb246-285"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.combat)</span>
<span id="cb246-286"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-286" aria-hidden="true" tabindex="-1"></a>  recall_splsda.combat <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.combat))<span class="sc">/</span></span>
<span id="cb246-287"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-288"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-288" aria-hidden="true" tabindex="-1"></a>  F1_splsda.combat <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">*</span>precision_splsda.combat<span class="sc">*</span>recall_splsda.combat)<span class="sc">/</span></span>
<span id="cb246-289"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-289" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.combat <span class="sc">+</span> recall_splsda.combat)</span>
<span id="cb246-290"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-291"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-291" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-292"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-292" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.combat <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-293"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-293" aria-hidden="true" tabindex="-1"></a>    F1_splsda.combat <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-294"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-294" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-295"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-296"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-296" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-297"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-297" aria-hidden="true" tabindex="-1"></a>  <span class="do">### wPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb246-298"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-298" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb246-299"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-299" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb246-300"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-300" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>,</span>
<span id="cb246-301"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-301" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb246-302"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-302" aria-hidden="true" tabindex="-1"></a>  X.wplsda_batch <span class="ot">&lt;-</span> X.wplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb246-303"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.wplsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb246-304"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-305"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-305" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-306"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-306" aria-hidden="true" tabindex="-1"></a>  rda.wplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.wplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-307"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-307" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-308"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-308" aria-hidden="true" tabindex="-1"></a>  gvar.wplsdab[i, ] <span class="ot">&lt;-</span> rda.wplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-309"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-309" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-310"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-310" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-311"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-311" aria-hidden="true" tabindex="-1"></a>  indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-312"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-312" aria-hidden="true" tabindex="-1"></a>  indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-313"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-313" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.wplsda_batch))){</span>
<span id="cb246-314"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-314" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-315"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-315" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-316"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-316" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.wplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-317"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-317" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-318"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-318" aria-hidden="true" tabindex="-1"></a>    indiv.trt.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.wplsda_batch, fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-319"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-319" aria-hidden="true" tabindex="-1"></a>    indiv.batch.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.wplsda_batch, </span>
<span id="cb246-320"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-320" aria-hidden="true" tabindex="-1"></a>                                  fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-321"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-321" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-322"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-322" aria-hidden="true" tabindex="-1"></a>  r2.trt.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.wplsda_batch</span>
<span id="cb246-323"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-323" aria-hidden="true" tabindex="-1"></a>  r2.batch.wplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.wplsda_batch</span>
<span id="cb246-324"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-325"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-326"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-326" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.wplsda_batch)), </span>
<span id="cb246-327"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-327" aria-hidden="true" tabindex="-1"></a>                            <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-328"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-328" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.wplsda_batch, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-329"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-329" aria-hidden="true" tabindex="-1"></a>  fit.result.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.wplsda_batch), </span>
<span id="cb246-330"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-330" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">number =</span> p_total)</span>
<span id="cb246-331"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-331" aria-hidden="true" tabindex="-1"></a>  otu.sig.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.wplsda_batch)[</span>
<span id="cb246-332"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-332" aria-hidden="true" tabindex="-1"></a>    fit.result.wplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-333"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-334"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-334" aria-hidden="true" tabindex="-1"></a>  precision_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-335"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb246-336"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-336" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.wplsda_batch)</span>
<span id="cb246-337"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-337" aria-hidden="true" tabindex="-1"></a>  recall_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-338"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.wplsda_batch))<span class="sc">/</span></span>
<span id="cb246-339"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-340"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-340" aria-hidden="true" tabindex="-1"></a>  F1_limma.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-341"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-341" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.wplsda_batch<span class="sc">*</span>recall_limma.wplsda_batch)<span class="sc">/</span></span>
<span id="cb246-342"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-342" aria-hidden="true" tabindex="-1"></a>    (precision_limma.wplsda_batch <span class="sc">+</span> recall_limma.wplsda_batch)</span>
<span id="cb246-343"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-344"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-344" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-345"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-345" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-346"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-346" aria-hidden="true" tabindex="-1"></a>    precision_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-347"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-347" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-348"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-348" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-349"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-349" aria-hidden="true" tabindex="-1"></a>    F1_limma.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-350"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-350" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-351"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-352"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-352" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-353"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-353" aria-hidden="true" tabindex="-1"></a>  fit.wplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.wplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb246-354"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-354" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-355"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-355" aria-hidden="true" tabindex="-1"></a>  otu.dcn.wplsda_batch <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.wplsda_batch_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-356"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-357"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-357" aria-hidden="true" tabindex="-1"></a>  precision_splsda.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-358"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.wplsda_batch))<span class="sc">/</span></span>
<span id="cb246-359"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.wplsda_batch)</span>
<span id="cb246-360"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-360" aria-hidden="true" tabindex="-1"></a>  recall_splsda.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-361"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.wplsda_batch))<span class="sc">/</span></span>
<span id="cb246-362"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-363"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-363" aria-hidden="true" tabindex="-1"></a>  F1_splsda.wplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-364"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-364" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_splsda.wplsda_batch<span class="sc">*</span>recall_splsda.wplsda_batch)<span class="sc">/</span></span>
<span id="cb246-365"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-365" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.wplsda_batch <span class="sc">+</span> recall_splsda.wplsda_batch)</span>
<span id="cb246-366"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-367"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-367" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-368"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-368" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.wplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-369"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-369" aria-hidden="true" tabindex="-1"></a>    F1_splsda.wplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-370"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-370" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-371"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-372"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-372" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-373"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-373" aria-hidden="true" tabindex="-1"></a>  <span class="do">### swPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb246-374"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-374" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb246-375"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-375" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb246-376"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-376" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb246-377"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-377" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb246-378"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-378" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">ncomp.bat =</span> <span class="dv">1</span>, <span class="at">balance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb246-379"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-379" aria-hidden="true" tabindex="-1"></a>  X.swplsda_batch <span class="ot">&lt;-</span> X.swplsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb246-380"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.swplsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb246-381"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-381" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-382"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-382" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-383"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-383" aria-hidden="true" tabindex="-1"></a>  rda.swplsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.swplsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-384"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-384" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-385"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-385" aria-hidden="true" tabindex="-1"></a>  gvar.swplsdab[i, ] <span class="ot">&lt;-</span> rda.swplsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-386"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-387"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># individual variance (R2)</span></span>
<span id="cb246-388"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-388" aria-hidden="true" tabindex="-1"></a>  indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-389"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-389" aria-hidden="true" tabindex="-1"></a>  indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb246-390"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-390" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(c <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(X.swplsda_batch))){</span>
<span id="cb246-391"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-391" aria-hidden="true" tabindex="-1"></a>    fit.res1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> trt)</span>
<span id="cb246-392"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-392" aria-hidden="true" tabindex="-1"></a>    fit.summary1 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res1)</span>
<span id="cb246-393"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-393" aria-hidden="true" tabindex="-1"></a>    fit.res2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">scale</span>(X.swplsda_batch)[ ,c] <span class="sc">~</span> batch)</span>
<span id="cb246-394"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-394" aria-hidden="true" tabindex="-1"></a>    fit.summary2 <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit.res2)</span>
<span id="cb246-395"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-395" aria-hidden="true" tabindex="-1"></a>    indiv.trt.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.trt.swplsda_batch, </span>
<span id="cb246-396"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-396" aria-hidden="true" tabindex="-1"></a>                                 fit.summary1<span class="sc">$</span>r.squared)</span>
<span id="cb246-397"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-397" aria-hidden="true" tabindex="-1"></a>    indiv.batch.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">c</span>(indiv.batch.swplsda_batch, </span>
<span id="cb246-398"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-398" aria-hidden="true" tabindex="-1"></a>                                   fit.summary2<span class="sc">$</span>r.squared)</span>
<span id="cb246-399"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-399" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-400"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-400" aria-hidden="true" tabindex="-1"></a>  r2.trt.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.trt.swplsda_batch</span>
<span id="cb246-401"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-401" aria-hidden="true" tabindex="-1"></a>  r2.batch.swplsdab[ ,i] <span class="ot">&lt;-</span>  indiv.batch.swplsda_batch</span>
<span id="cb246-402"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-402" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-403"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-403" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-404"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-404" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">lmFit</span>(<span class="fu">t</span>(<span class="fu">scale</span>(X.swplsda_batch)), </span>
<span id="cb246-405"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-405" aria-hidden="true" tabindex="-1"></a>                             <span class="at">design =</span> <span class="fu">model.matrix</span>( <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">as.factor</span>(trt)))</span>
<span id="cb246-406"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-406" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">contrasts.fit</span>(fit.swplsda_batch, <span class="at">contrasts =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb246-407"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-407" aria-hidden="true" tabindex="-1"></a>  fit.result.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">topTable</span>(<span class="fu">eBayes</span>(fit.swplsda_batch), </span>
<span id="cb246-408"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-408" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">number =</span> p_total)</span>
<span id="cb246-409"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-409" aria-hidden="true" tabindex="-1"></a>  otu.sig.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">rownames</span>(fit.result.swplsda_batch)[</span>
<span id="cb246-410"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-410" aria-hidden="true" tabindex="-1"></a>    fit.result.swplsda_batch<span class="sc">$</span>adj.P.Val <span class="sc">&lt;=</span> <span class="fl">0.05</span>]</span>
<span id="cb246-411"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-411" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-412"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-412" aria-hidden="true" tabindex="-1"></a>  precision_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-413"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb246-414"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.sig.swplsda_batch)</span>
<span id="cb246-415"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-415" aria-hidden="true" tabindex="-1"></a>  recall_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-416"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.sig.swplsda_batch))<span class="sc">/</span></span>
<span id="cb246-417"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-418"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-418" aria-hidden="true" tabindex="-1"></a>  F1_limma.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-419"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-419" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_limma.swplsda_batch<span class="sc">*</span>recall_limma.swplsda_batch)<span class="sc">/</span></span>
<span id="cb246-420"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-420" aria-hidden="true" tabindex="-1"></a>    (precision_limma.swplsda_batch <span class="sc">+</span> recall_limma.swplsda_batch)</span>
<span id="cb246-421"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-421" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-422"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-422" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-423"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-423" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(precision_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-424"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-424" aria-hidden="true" tabindex="-1"></a>    precision_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-425"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-425" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-426"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-426" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_limma.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-427"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-427" aria-hidden="true" tabindex="-1"></a>    F1_limma.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-428"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-428" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-429"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-430"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-431"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-431" aria-hidden="true" tabindex="-1"></a>  fit.swplsda_batch_splsda <span class="ot">&lt;-</span> <span class="fu">splsda</span>(<span class="at">X =</span> X.swplsda_batch, <span class="at">Y =</span> trt, <span class="at">ncomp =</span> <span class="dv">1</span>, </span>
<span id="cb246-432"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-432" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">keepX =</span> <span class="fu">length</span>(true.trt))</span>
<span id="cb246-433"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-433" aria-hidden="true" tabindex="-1"></a>  otu.dcn.swplsda_batch <span class="ot">&lt;-</span> <span class="fu">which</span>(fit.swplsda_batch_splsda<span class="sc">$</span>loadings<span class="sc">$</span>X[ ,<span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb246-434"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-434" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-435"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-435" aria-hidden="true" tabindex="-1"></a>  precision_splsda.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-436"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-436" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.swplsda_batch))<span class="sc">/</span></span>
<span id="cb246-437"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(otu.dcn.swplsda_batch)</span>
<span id="cb246-438"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-438" aria-hidden="true" tabindex="-1"></a>  recall_splsda.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-439"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-439" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">intersect</span>(true.trt, otu.dcn.swplsda_batch))<span class="sc">/</span></span>
<span id="cb246-440"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(true.trt)</span>
<span id="cb246-441"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-441" aria-hidden="true" tabindex="-1"></a>  F1_splsda.swplsda_batch <span class="ot">&lt;-</span> </span>
<span id="cb246-442"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-442" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span><span class="sc">*</span>precision_splsda.swplsda_batch<span class="sc">*</span>recall_splsda.swplsda_batch)<span class="sc">/</span></span>
<span id="cb246-443"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-443" aria-hidden="true" tabindex="-1"></a>    (precision_splsda.swplsda_batch <span class="sc">+</span> recall_splsda.swplsda_batch)</span>
<span id="cb246-444"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-444" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-445"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-445" aria-hidden="true" tabindex="-1"></a>  <span class="do">## replace NA value with 0</span></span>
<span id="cb246-446"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-446" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(F1_splsda.swplsda_batch <span class="sc">==</span> <span class="st">&#39;NaN&#39;</span>){</span>
<span id="cb246-447"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-447" aria-hidden="true" tabindex="-1"></a>    F1_splsda.swplsda_batch <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb246-448"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-448" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-449"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-450"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-450" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-451"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-451" aria-hidden="true" tabindex="-1"></a>  <span class="do">### PLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb246-452"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-452" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb246-453"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-453" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb246-454"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-454" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ncomp.trt =</span> <span class="dv">1</span>, <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb246-455"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-455" aria-hidden="true" tabindex="-1"></a>  X.plsda_batch <span class="ot">&lt;-</span> X.plsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb246-456"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.plsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb246-457"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-457" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-458"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-458" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-459"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-459" aria-hidden="true" tabindex="-1"></a>  rda.plsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.plsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch, </span>
<span id="cb246-460"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-460" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-461"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-461" aria-hidden="true" tabindex="-1"></a>  gvar.plsdab[i, ] <span class="ot">&lt;-</span> rda.plsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-462"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-463"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-463" aria-hidden="true" tabindex="-1"></a>  <span class="do">##############################################################################</span></span>
<span id="cb246-464"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-464" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sPLSDA-batch corrected data </span><span class="al">###</span></span>
<span id="cb246-465"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-465" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch.correct <span class="ot">&lt;-</span> <span class="fu">PLSDA_batch</span>(<span class="at">X =</span> X, </span>
<span id="cb246-466"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-466" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">Y.trt =</span> trt, <span class="at">Y.bat =</span> batch, </span>
<span id="cb246-467"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-467" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.trt =</span> <span class="dv">1</span>, </span>
<span id="cb246-468"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-468" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">keepX.trt =</span> <span class="fu">length</span>(true.trt), </span>
<span id="cb246-469"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-469" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">ncomp.bat =</span> <span class="dv">1</span>)</span>
<span id="cb246-470"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-470" aria-hidden="true" tabindex="-1"></a>  X.splsda_batch <span class="ot">&lt;-</span> X.splsda_batch.correct<span class="sc">$</span>X.nobatch</span>
<span id="cb246-471"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X.splsda_batch) <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(p_total)</span>
<span id="cb246-472"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-472" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-473"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-473" aria-hidden="true" tabindex="-1"></a>  <span class="co"># global variance (RDA)</span></span>
<span id="cb246-474"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-474" aria-hidden="true" tabindex="-1"></a>  rda.splsda_batch <span class="ot">=</span> <span class="fu">varpart</span>(<span class="fu">scale</span>(X.splsda_batch), <span class="sc">~</span> Treatment, <span class="sc">~</span> Batch,</span>
<span id="cb246-475"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-475" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> Batch_Trt.factors)</span>
<span id="cb246-476"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-476" aria-hidden="true" tabindex="-1"></a>  gvar.splsdab[i, ] <span class="ot">&lt;-</span> rda.splsda_batch<span class="sc">$</span>part<span class="sc">$</span>indfract<span class="sc">$</span>Adj.R.squared</span>
<span id="cb246-477"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-477" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-478"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-479"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summary</span></span>
<span id="cb246-480"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-480" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (ANOVA)</span></span>
<span id="cb246-481"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-481" aria-hidden="true" tabindex="-1"></a>  precision_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_limma.before, </span>
<span id="cb246-482"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-482" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_limma.clean,</span>
<span id="cb246-483"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-483" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_limma.rbe,</span>
<span id="cb246-484"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-484" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ComBat =</span> precision_limma.combat,</span>
<span id="cb246-485"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-485" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.wplsda_batch,</span>
<span id="cb246-486"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-486" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_limma.swplsda_batch)</span>
<span id="cb246-487"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-487" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-488"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-488" aria-hidden="true" tabindex="-1"></a>  recall_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_limma.before, </span>
<span id="cb246-489"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-489" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_limma.clean,</span>
<span id="cb246-490"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-490" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_limma.rbe,</span>
<span id="cb246-491"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-491" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ComBat =</span> recall_limma.combat,</span>
<span id="cb246-492"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-492" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.wplsda_batch,</span>
<span id="cb246-493"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-493" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_limma.swplsda_batch)</span>
<span id="cb246-494"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-494" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-495"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-495" aria-hidden="true" tabindex="-1"></a>  F1_limma[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_limma.before, </span>
<span id="cb246-496"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-496" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_limma.clean,</span>
<span id="cb246-497"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-497" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_limma.rbe,</span>
<span id="cb246-498"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-498" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ComBat =</span> F1_limma.combat,</span>
<span id="cb246-499"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-499" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.wplsda_batch,</span>
<span id="cb246-500"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-500" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_limma.swplsda_batch)</span>
<span id="cb246-501"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-501" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-502"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-503"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-503" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision &amp; recall &amp; F1 (sPLSDA)</span></span>
<span id="cb246-504"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-504" aria-hidden="true" tabindex="-1"></a>  precision_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.before, </span>
<span id="cb246-505"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-505" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.clean,</span>
<span id="cb246-506"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-506" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.rbe,</span>
<span id="cb246-507"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-507" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ComBat =</span> precision_splsda.combat,</span>
<span id="cb246-508"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-508" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.wplsda_batch,</span>
<span id="cb246-509"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-509" aria-hidden="true" tabindex="-1"></a>                             <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> precision_splsda.swplsda_batch)</span>
<span id="cb246-510"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-510" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-511"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-511" aria-hidden="true" tabindex="-1"></a>  recall_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.before, </span>
<span id="cb246-512"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-512" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.clean,</span>
<span id="cb246-513"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-513" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.rbe,</span>
<span id="cb246-514"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-514" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ComBat =</span> recall_splsda.combat,</span>
<span id="cb246-515"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-515" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.wplsda_batch,</span>
<span id="cb246-516"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-516" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> recall_splsda.swplsda_batch)</span>
<span id="cb246-517"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-517" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-518"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-518" aria-hidden="true" tabindex="-1"></a>  F1_splsda[i, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.before, </span>
<span id="cb246-519"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-519" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.clean,</span>
<span id="cb246-520"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-520" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">removeBatchEffect</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.rbe,</span>
<span id="cb246-521"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-521" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ComBat =</span> F1_splsda.combat,</span>
<span id="cb246-522"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-522" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.wplsda_batch,</span>
<span id="cb246-523"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-523" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> F1_splsda.swplsda_batch)</span>
<span id="cb246-524"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-524" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb246-525"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb246-525" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="figures-1" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Figures<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#figures-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># global variance (RDA)</span></span>
<span id="cb247-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-2" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="st">`</span><span class="at">Before correction</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.before),</span>
<span id="cb247-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">Ground-truth data</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.clean),</span>
<span id="cb247-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">removeBatchEffect =</span> <span class="fu">colMeans</span>(gvar.rbe),</span>
<span id="cb247-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ComBat =</span> <span class="fu">colMeans</span>(gvar.combat),</span>
<span id="cb247-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">wPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.wplsdab),</span>
<span id="cb247-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">swPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.swplsdab),</span>
<span id="cb247-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">PLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.plsdab),</span>
<span id="cb247-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">`</span><span class="at">sPLSDA-batch</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">colMeans</span>(gvar.splsdab))</span>
<span id="cb247-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-11" aria-hidden="true" tabindex="-1"></a>prop.gvar.all[prop.gvar.all <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb247-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-12" aria-hidden="true" tabindex="-1"></a>prop.gvar.all <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(prop.gvar.all, <span class="dv">1</span>, <span class="cf">function</span>(x){x<span class="sc">/</span><span class="fu">sum</span>(x)}))</span>
<span id="cb247-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(prop.gvar.all) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Treatment&#39;</span>, <span class="st">&#39;Intersection&#39;</span>, <span class="st">&#39;Batch&#39;</span>, <span class="st">&#39;Residuals&#39;</span>)</span>
<span id="cb247-14"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-15"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb247-15" aria-hidden="true" tabindex="-1"></a><span class="fu">partVar_plot</span>(<span class="at">prop.df =</span> prop.gvar.all)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-105"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-105-1.png" alt="Figure 3: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design." width="60%" />
<p class="caption">
Figure 3.3: Figure 3: Simulation studies (Gaussian distribution): comparison of explained variance before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<p>With an unbalanced batch <span class="math inline">\(\times\)</span> treatment design, we observed that certain amount of variance was shared (intersection) and explained by both batch and treatment effects. Such intersectional variance should exist even in the ground-truth data with no batch effect, as it originates from treatment variation because of the unbalanced design. Unweighted PLSDA-batch and sPLSDA-batch failed in such design, as their corrected data still included a large amount of batch variation (PLSDA-batch) or not included intersectional variance (sPLSDA-batch), while the other methods removed batch variation successfully. The corrected data from removeBatchEffect and ComBat included less proportion of variance explained by treatment but more intersectional variance compared to the ground-truth data. Although wPLSDA-batch corrected data included the largest treatment variance, swPLSDA-batch outperformed all methods with results similar to the ground-truth data.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="do">################################################################################</span></span>
<span id="cb248-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="co"># individual variance (R2)</span></span>
<span id="cb248-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="co"># color</span></span>
<span id="cb248-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-4" aria-hidden="true" tabindex="-1"></a>gcolor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">pb_color</span>(<span class="dv">16</span>), p_trt_relevant), </span>
<span id="cb248-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-5" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="fu">pb_color</span>(<span class="dv">17</span>), (p_total <span class="sc">-</span> p_trt_relevant)))</span>
<span id="cb248-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-6" aria-hidden="true" tabindex="-1"></a>gcolor[<span class="fu">intersect</span>(true.trt, true.batch)] <span class="ot">=</span> <span class="fu">pb_color</span>(<span class="dv">18</span>)</span>
<span id="cb248-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-7" aria-hidden="true" tabindex="-1"></a>gcolor[<span class="fu">setdiff</span>(<span class="fu">seq_len</span>(p_total), <span class="fu">union</span>(true.trt, true.batch))] <span class="ot">=</span> <span class="fu">pb_color</span>(<span class="dv">15</span>)</span>
<span id="cb248-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-9" aria-hidden="true" tabindex="-1"></a>xlabs <span class="ot">=</span> <span class="st">&#39;R2(variable, treatment)&#39;</span></span>
<span id="cb248-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-10" aria-hidden="true" tabindex="-1"></a>ylabs <span class="ot">=</span> <span class="st">&#39;R2(variable, batch)&#39;</span></span>
<span id="cb248-11"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-11" aria-hidden="true" tabindex="-1"></a>edgex <span class="ot">=</span> <span class="fl">0.7</span></span>
<span id="cb248-12"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-12" aria-hidden="true" tabindex="-1"></a>edgey <span class="ot">=</span> <span class="fl">0.6</span></span>
<span id="cb248-13"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-14"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-14" aria-hidden="true" tabindex="-1"></a><span class="co"># scatterplot</span></span>
<span id="cb248-15"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-15" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>))</span>
<span id="cb248-16"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.before), <span class="fu">rowMeans</span>(r2.batch.before), <span class="at">col =</span> gcolor, </span>
<span id="cb248-17"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-18"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb248-19"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;Before correction&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-20"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-20" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-21"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-21" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-22"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb248-23"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-24"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.clean), <span class="fu">rowMeans</span>(r2.batch.clean), <span class="at">col =</span> gcolor, </span>
<span id="cb248-25"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-26"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb248-27"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-27" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;Ground-truth data&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-28"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-28" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-29"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-29" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-30"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb248-31"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-32"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.rbe), <span class="fu">rowMeans</span>(r2.batch.rbe), <span class="at">col =</span> gcolor, </span>
<span id="cb248-33"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-34"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-34" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), </span>
<span id="cb248-35"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-35" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-36"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-36" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-37"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-37" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-38"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-38" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb248-39"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-40"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-40" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.combat), <span class="fu">rowMeans</span>(r2.batch.combat), <span class="at">col =</span> gcolor, </span>
<span id="cb248-41"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-41" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-42"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-42" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;ComBat&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-43"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-43" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-44"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-44" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-45"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-45" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb248-46"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-47"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-47" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.wplsdab), <span class="fu">rowMeans</span>(r2.batch.wplsdab), <span class="at">col =</span> gcolor, </span>
<span id="cb248-48"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-48" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-49"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-49" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-50"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-50" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-51"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-51" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-52"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-52" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb248-53"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-54"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-54" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">rowMeans</span>(r2.trt.swplsdab), <span class="fu">rowMeans</span>(r2.batch.swplsdab), <span class="at">col =</span> gcolor, </span>
<span id="cb248-55"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-55" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> xlabs, <span class="at">ylab =</span> ylabs, <span class="at">pch =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(gcolor)),</span>
<span id="cb248-56"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-56" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgex), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, edgey), <span class="at">main =</span> <span class="st">&#39;swPLSDA-batch&#39;</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span>
<span id="cb248-57"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-57" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&#39;No effect&#39;</span>, <span class="st">&#39;Treatment only&#39;</span>, </span>
<span id="cb248-58"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-58" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;Batch only&#39;</span>, <span class="st">&#39;Treatment &amp; batch&#39;</span>), </span>
<span id="cb248-59"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb248-59" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">pb_color</span>(<span class="dv">15</span><span class="sc">:</span><span class="dv">18</span>), <span class="at">pch =</span> <span class="fu">seq_len</span>(<span class="dv">4</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-106"></span>
<img src="PLSDAbatch_workflow_files/figure-html/unnamed-chunk-106-1.png" alt="Figure 4: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design." width="100%" />
<p class="caption">
Figure 3.4: Figure 4: Simulation studies (Gaussian distribution): R2 values for each microbial variable before and after batch effect correction for the unbalanced batch × treatment design.
</p>
</div>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code></pre></div>
<p>Based on the <span class="math inline">\(R^2\)</span> values, variables assigned with both treatment and batch effects were segregated into two groups depending on whether their abundance increased or decreased consistently or not according to the two effects. We observed similar results to those obtained from the balanced design.</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precision &amp; recall &amp; F1 (ANOVA &amp; sPLSDA)</span></span>
<span id="cb250-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="do">## mean</span></span>
<span id="cb250-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-3" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">colMeans</span>(precision_limma), <span class="fu">colMeans</span>(recall_limma), </span>
<span id="cb250-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">colMeans</span>(F1_limma), <span class="fu">colMeans</span>(precision_splsda))</span>
<span id="cb250-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;Multivariate selection&#39;</span>)</span>
<span id="cb250-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_mean) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb250-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb250-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>)</span>
<span id="cb250-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-9" aria-hidden="true" tabindex="-1"></a>acc_mean <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_mean, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb250-10"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb250-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_mean, <span class="at">caption =</span> <span class="st">&#39;Table 6: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (mean).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-107">Table 3.3: </span>Table 6: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (mean).</caption>
<colgroup>
<col width="20%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.52</td>
<td align="left">0.96</td>
<td align="left">0.85</td>
<td align="left">0.80</td>
<td align="left">0.52</td>
<td align="left">0.80</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.72</td>
<td align="left">1.00</td>
<td align="left">0.86</td>
<td align="left">0.86</td>
<td align="left">0.99</td>
<td align="left">1.00</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.55</td>
<td align="left">0.98</td>
<td align="left">0.84</td>
<td align="left">0.81</td>
<td align="left">0.65</td>
<td align="left">0.88</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.73</td>
<td align="left">1.00</td>
<td align="left">0.88</td>
<td align="left">0.87</td>
<td align="left">0.89</td>
<td align="left">0.99</td>
</tr>
</tbody>
</table>
<p>When considering the measures of accuracy with univariate one-way ANOVA, we observed that the corrected data from wPLSDA-batch and swPLSDA-batch led to higher recall and lower precision than the data from removeBatchEffect and ComBat. However, the precision of swPLSDA-batch was competitive to removeBatchEffect and ComBat. Moreover, weighted sPLSDA-batch achieved higher F1 scores and multivariate selection scores than removeBatchEffect and ComBat.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="do">## sd</span></span>
<span id="cb251-2"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-2" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">apply</span>(precision_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(recall_limma, <span class="dv">2</span>, sd), </span>
<span id="cb251-3"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">apply</span>(F1_limma, <span class="dv">2</span>, sd), <span class="fu">apply</span>(precision_splsda, <span class="dv">2</span>, sd))</span>
<span id="cb251-4"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>, <span class="st">&#39;F1&#39;</span>, <span class="st">&#39;Multivariate selection&#39;</span>)</span>
<span id="cb251-5"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-5" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(acc_sd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Before correction&#39;</span>, <span class="st">&#39;Ground-truth data&#39;</span>, </span>
<span id="cb251-6"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;removeBatchEffect&#39;</span>, <span class="st">&#39;ComBat&#39;</span>, </span>
<span id="cb251-7"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;wPLSDA-batch&#39;</span>, <span class="st">&#39;swPLSDA-batch&#39;</span>)</span>
<span id="cb251-8"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-8" aria-hidden="true" tabindex="-1"></a>acc_sd <span class="ot">&lt;-</span> <span class="fu">format</span>(acc_sd, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb251-9"><a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#cb251-9" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(acc_sd, <span class="at">caption =</span> <span class="st">&#39;Table 7: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (standard deviation).&#39;</span>)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-108">Table 3.4: </span>Table 7: Simulation studies (Gaussian distribution): summary of accuracy measures before and after batch correction for the unbalanced batch × treatment design (standard deviation).</caption>
<colgroup>
<col width="20%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="6%" />
<col width="11%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">Before correction</th>
<th align="left">Ground-truth data</th>
<th align="left">removeBatchEffect</th>
<th align="left">ComBat</th>
<th align="left">wPLSDA-batch</th>
<th align="left">swPLSDA-batch</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Precision</td>
<td align="left">0.325</td>
<td align="left">0.031</td>
<td align="left">0.176</td>
<td align="left">0.231</td>
<td align="left">0.232</td>
<td align="left">0.137</td>
</tr>
<tr class="even">
<td align="left">Recall</td>
<td align="left">0.042</td>
<td align="left">0.000</td>
<td align="left">0.104</td>
<td align="left">0.100</td>
<td align="left">0.029</td>
<td align="left">0.000</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="left">0.212</td>
<td align="left">0.017</td>
<td align="left">0.137</td>
<td align="left">0.177</td>
<td align="left">0.189</td>
<td align="left">0.092</td>
</tr>
<tr class="even">
<td align="left">Multivariate selection</td>
<td align="left">0.051</td>
<td align="left">0.000</td>
<td align="left">0.069</td>
<td align="left">0.083</td>
<td align="left">0.148</td>
<td align="left">0.016</td>
</tr>
</tbody>
</table>
<p>The standard deviations of the multivariate selection scores were all smaller than the univariate selection scores for the different corrected data, indicating a better stability of the variables selected by multivariate sPLSDA compared to the one-way ANOVA univariate selection.</p>
</div>
</div>
<div id="references-2" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> References<a href="batch-effects-management-in-simulation-studies-gaussian-distribution.html#references-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
<h3>References<a href="references-4.html#references-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-singh2019diablo" class="csl-entry">
Singh, Amrit, Casey P Shannon, Benoı̂t Gautier, Florian Rohart, Michaël Vacher, Scott J Tebbutt, and Kim-Anh Lê Cao. 2019. <span>“DIABLO: An Integrative Approach for Identifying Key Molecular Drivers from Multi-Omics Assays.”</span> <em>Bioinformatics</em> 35 (17): 3055–62.
</div>
<div id="ref-weiss2017normalization" class="csl-entry">
Weiss, Sophie, Zhenjiang Zech Xu, Shyamal Peddada, Amnon Amir, Kyle Bittinger, Antonio Gonzalez, Catherine Lozupone, et al. 2017. <span>“Normalization and Microbial Differential Abundance Strategies Depend Upon Data Characteristics.”</span> <em>Microbiome</em> 5 (1): 1–18.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="supplementary-materials-for-batch-effects-management-in-case-studies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="batch-effects-management-in-simulation-studies-negative-binomial-distribution.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["PLSDAbatch_workflow.pdf", "PLSDAbatch_workflow.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
